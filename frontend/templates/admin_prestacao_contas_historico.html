<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico - Prestação de Contas - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- SECURITY: DOMPurify para sanitização de HTML -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- SECURITY: Utilitários de segurança -->
    <script src="/static/js/security.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' }
                    }
                }
            }
        }
    </script>
    <style>
        .markdown-body { font-family: 'Times New Roman', Georgia, serif; font-size: 14px; line-height: 1.8; color: #1f2937; }
        .markdown-body h2 { font-family: 'Arial', sans-serif; font-weight: 700; font-size: 1.1em; text-align: center; margin: 1.5em 0 0.75em; }
        .markdown-body p { text-align: justify; text-indent: 2em; margin-bottom: 1em; }
        .markdown-body blockquote { margin: 1.5em 3em; padding: 0.5em 1em; border-left: 4px solid #d1d5db; background: #f9fafb; font-style: italic; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-500 hover:text-teal-600">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Histórico - Prestação de Contas</h1>
                    <p class="text-sm text-gray-500">Visualize prompts enviados e resultados</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div id="lista-geracoes" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando histórico...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Texto Expandido -->
    <div id="modal-expand" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-2xl w-full max-w-5xl max-h-[95vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 id="expand-titulo" class="text-lg font-semibold text-gray-800">Texto Expandido</h3>
                <button onclick="fecharExpand()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-4">
                <pre id="expand-conteudo" class="text-sm whitespace-pre-wrap p-4 rounded-lg"></pre>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end gap-2">
                <button onclick="copiarExpand()" class="px-4 py-2 text-sm text-teal-600 hover:bg-teal-50 rounded-lg">
                    <i class="fas fa-copy mr-1"></i>Copiar
                </button>
                <button onclick="fecharExpand()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Upload de Documentos Faltantes -->
    <div id="modal-upload" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-800">Anexar Documentos</h2>
                    <button onclick="fecharModalUpload()" class="p-2 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p id="upload-processo" class="text-sm text-gray-500 mt-1"></p>
            </div>

            <div class="p-6">
                <div id="upload-docs-lista" class="space-y-3 mb-4"></div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-teal-400 transition-colors">
                    <input type="file" id="input-arquivos" multiple accept=".pdf,.jpg,.jpeg,.png"
                           class="hidden" onchange="arquivosSelecionados(this.files)">
                    <label for="input-arquivos" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600">Clique para selecionar ou arraste os arquivos</p>
                        <p class="text-sm text-gray-400 mt-1">PDF, JPG ou PNG</p>
                    </label>
                </div>

                <div id="arquivos-selecionados" class="mt-4 space-y-2"></div>

                <div id="upload-erro" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
                <div id="upload-sucesso" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700"></div>
            </div>

            <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="fecharModalUpload()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Cancelar
                </button>
                <button id="btn-enviar-upload" onclick="enviarDocumentos()" disabled
                        class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i>Enviar e Reprocessar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="modal-detalhes" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-800">Detalhes da Análise</h2>
                <button onclick="fecharModal()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button onclick="mostrarTab('parecer')" id="tab-parecer" class="px-4 py-2 border-b-2 border-teal-600 text-teal-600 font-medium">
                        Parecer
                    </button>
                    <button onclick="mostrarTab('dados')" id="tab-dados" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Dados Coletados
                    </button>
                    <button onclick="mostrarTab('logs')" id="tab-logs" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Logs IA
                    </button>
                    <button onclick="mostrarTab('raw')" id="tab-raw" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Resposta Bruta
                    </button>
                </div>

                <!-- Conteúdo das Tabs -->
                <div id="conteudo-parecer" class="tab-content">
                    <!-- Badge do Parecer -->
                    <div id="parecer-badge" class="mb-4 text-center"></div>
                    <!-- Fundamentação -->
                    <div class="bg-white rounded-lg p-4 overflow-x-auto border prose max-w-none">
                        <div id="texto-fundamentacao" class="markdown-body"></div>
                    </div>
                    <!-- Irregularidades ou Perguntas -->
                    <div id="extras-parecer" class="mt-4"></div>
                </div>

                <div id="conteudo-dados" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 mb-3"><i class="fas fa-file-invoice-dollar mr-2"></i>Extrato Subconta</h3>
                            <div id="dados-subconta" class="text-sm space-y-2"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 mb-3"><i class="fas fa-file-alt mr-2"></i>Documentos Analisados</h3>
                            <div id="dados-documentos" class="text-sm space-y-2"></div>
                        </div>
                    </div>
                    <!-- Textos Extraídos -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h3 class="font-semibold text-blue-800 mb-3"><i class="fas fa-file-contract mr-2"></i>Textos Extraídos</h3>
                        <div id="textos-extraidos" class="space-y-3"></div>
                    </div>
                </div>

                <div id="conteudo-logs" class="tab-content hidden">
                    <div id="logs-container" class="space-y-3"></div>
                </div>

                <div id="conteudo-raw" class="tab-content hidden">
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre id="texto-raw" class="text-sm text-green-400 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 flex justify-between items-center">
                <div id="info-geracao" class="text-sm text-gray-500"></div>
                <button onclick="fecharModal()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/prestacao-admin';
        let geracoesCache = [];

        /**
         * SECURITY: Sanitiza markdown antes de renderizar.
         * Usa DOMPurify para remover scripts maliciosos.
         */
        function safeMarkedParse(markdownText) {
            if (!markdownText) return '';
            const rawHtml = marked.parse(markdownText);
            return DOMPurify.sanitize(rawHtml, {
                ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'b', 'i', 'u',
                               'ul', 'ol', 'li', 'blockquote', 'pre', 'code', 'table', 'thead', 'tbody',
                               'tr', 'th', 'td', 'a', 'span', 'div', 'hr'],
                ALLOWED_ATTR: ['class', 'id', 'href', 'target', 'rel'],
                ALLOW_DATA_ATTR: false
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarGeracoes();
        });

        function getToken() {
            return localStorage.getItem('access_token');
        }

        async function carregarGeracoes() {
            try {
                const response = await fetch(`${API_BASE}/geracoes?limit=100`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar');

                geracoesCache = await response.json();
                renderizarGeracoes();
            } catch (error) {
                console.error(error);
                document.getElementById('lista-geracoes').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar histórico</p>
                    </div>`;
            }
        }

        function renderizarGeracoes() {
            const container = document.getElementById('lista-geracoes');

            if (geracoesCache.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Nenhuma análise encontrada</p>
                    </div>`;
                return;
            }

            // SECURITY: escapeHtml para dados do servidor
            container.innerHTML = geracoesCache.map(g => {
                const parecerBadge = getParecrBadgeClasses(g.parecer, g.status);
                const aguardandoDocumentos = g.status === 'aguardando_documentos' || g.status === 'aguardando_nota_fiscal';
                const podeAnexar = g.permite_anexar === true;
                const expirado = g.estado_expirado === true;

                // Calcular tempo restante
                let tempoRestanteHtml = '';
                if (aguardandoDocumentos && g.estado_expira_em && !expirado) {
                    const expiraEm = new Date(g.estado_expira_em);
                    const agora = new Date();
                    const diffMs = expiraEm - agora;
                    const diffHoras = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    if (diffHoras > 0) {
                        tempoRestanteHtml = `<span class="text-amber-600"><i class="fas fa-clock mr-1"></i>${diffHoras}h ${diffMinutos}min restantes</span>`;
                    } else if (diffMinutos > 0) {
                        tempoRestanteHtml = `<span class="text-red-600"><i class="fas fa-clock mr-1"></i>${diffMinutos}min restantes</span>`;
                    }
                }

                return `
                    <div class="bg-white rounded-xl border ${aguardandoDocumentos ? 'border-amber-300' : 'border-gray-200'} p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between cursor-pointer" onclick="verDetalhes(${parseInt(g.id) || 0})">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full ${escapeHtml(parecerBadge.bgIcon)} flex items-center justify-center">
                                    <i class="fas ${escapeHtml(parecerBadge.icon)} ${escapeHtml(parecerBadge.iconColor)}"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${escapeHtml(g.numero_cnj)}</p>
                                    <p class="text-sm text-gray-500">Prestação de Contas</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${escapeHtml(parecerBadge.badge)}">
                                    ${escapeHtml(parecerBadge.label)}
                                </span>
                                <p class="text-sm text-gray-500 mt-1">${escapeHtml(new Date(g.criado_em).toLocaleDateString('pt-BR'))}</p>
                                <p class="text-xs text-gray-400">${escapeHtml(new Date(g.criado_em).toLocaleTimeString('pt-BR'))}</p>
                            </div>
                        </div>

                        ${aguardandoDocumentos ? `
                        <div class="mt-3 p-3 rounded-lg ${expirado ? 'bg-gray-50 border border-gray-200' : 'bg-amber-50 border border-amber-200'}">
                            <div class="flex items-start gap-2">
                                <i class="fas ${expirado ? 'fa-clock text-gray-400' : 'fa-exclamation-triangle text-amber-500'} mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="text-sm ${expirado ? 'text-gray-600' : 'text-amber-800'} font-medium">
                                        ${expirado ? 'Estado expirado - será reprocessado' : 'Documentos faltantes'}
                                    </p>
                                    ${g.mensagem_erro_usuario ? `<p class="text-sm ${expirado ? 'text-gray-500' : 'text-amber-700'} mt-1">${escapeHtml(g.mensagem_erro_usuario)}</p>` : ''}
                                    ${g.documentos_faltantes && g.documentos_faltantes.length > 0 ? `
                                        <div class="mt-2 flex flex-wrap gap-1">
                                            ${g.documentos_faltantes.map(doc => `
                                                <span class="inline-block px-2 py-0.5 rounded text-xs ${expirado ? 'bg-gray-200 text-gray-600' : 'bg-amber-200 text-amber-800'}">
                                                    ${escapeHtml(formatarNomeDocumento(doc))}
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    ${tempoRestanteHtml ? `<p class="text-xs mt-2">${tempoRestanteHtml}</p>` : ''}
                                </div>
                            </div>
                            ${podeAnexar ? `
                            <button onclick="event.stopPropagation(); abrirModalUpload(${parseInt(g.id) || 0}, '${escapeHtml(g.numero_cnj)}', ${JSON.stringify(g.documentos_faltantes || []).replace(/"/g, '&quot;')})"
                                    class="mt-3 w-full px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-upload mr-2"></i>Anexar Documentos Faltantes
                            </button>
                            ` : ''}
                            ${expirado ? `
                            <p class="mt-2 text-xs text-gray-500 italic">
                                <i class="fas fa-info-circle mr-1"></i>Ao anexar documentos, a análise será reprocessada do início.
                            </p>
                            ` : ''}
                        </div>
                        ` : ''}

                        <div class="mt-3 flex items-center gap-4 text-xs text-gray-500">
                            <span><i class="fas fa-robot mr-1"></i> ${escapeHtml(g.modelo_usado || 'N/A')}</span>
                            ${g.tempo_processamento_ms ? `<span><i class="fas fa-clock mr-1"></i> ${escapeHtml((g.tempo_processamento_ms / 1000).toFixed(1))}s</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getParecrBadgeClasses(parecer, status) {
            // Verificar status especiais primeiro
            if (status === 'aguardando_documentos' || status === 'aguardando_nota_fiscal') {
                return {
                    badge: 'bg-amber-100 text-amber-800',
                    bgIcon: 'bg-amber-100',
                    icon: 'fa-file-upload',
                    iconColor: 'text-amber-600',
                    label: 'AGUARDANDO DOCS'
                };
            }

            switch (parecer) {
                case 'favoravel':
                    return {
                        badge: 'bg-green-100 text-green-800',
                        bgIcon: 'bg-green-100',
                        icon: 'fa-check-circle',
                        iconColor: 'text-green-600',
                        label: 'FAVORÁVEL'
                    };
                case 'desfavoravel':
                    return {
                        badge: 'bg-red-100 text-red-800',
                        bgIcon: 'bg-red-100',
                        icon: 'fa-times-circle',
                        iconColor: 'text-red-600',
                        label: 'DESFAVORÁVEL'
                    };
                case 'duvida':
                    return {
                        badge: 'bg-amber-100 text-amber-800',
                        bgIcon: 'bg-amber-100',
                        icon: 'fa-question-circle',
                        iconColor: 'text-amber-600',
                        label: 'DÚVIDA'
                    };
                default:
                    return {
                        badge: 'bg-gray-100 text-gray-800',
                        bgIcon: 'bg-gray-100',
                        icon: 'fa-file-alt',
                        iconColor: 'text-gray-600',
                        label: parecer || 'PROCESSANDO'
                    };
            }
        }

        function formatarNomeDocumento(doc) {
            const nomes = {
                'extrato_subconta': 'Extrato Subconta',
                'notas_fiscais': 'Notas Fiscais',
                'nota_fiscal': 'Nota Fiscal',
                'comprovantes': 'Comprovantes',
                'peticao_prestacao': 'Petição Prestação',
                'laudos': 'Laudos',
                'orcamentos': 'Orçamentos'
            };
            return nomes[doc] || doc;
        }

        async function verDetalhes(id) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar detalhes');

                const geracao = await response.json();

                // Preenche Parecer
                preencherParecer(geracao);

                // Preenche Dados Coletados
                preencherDados(geracao);

                // Preenche Logs IA
                preencherLogs(geracao.logs_ia || []);

                // Raw Response
                document.getElementById('texto-raw').textContent = geracao.resposta_ia_bruta || 'Não disponível';

                // Info rodapé
                document.getElementById('info-geracao').innerHTML = `
                    <strong>${geracao.numero_cnj}</strong> |
                    ${new Date(geracao.criado_em).toLocaleString('pt-BR')} |
                    ${(geracao.logs_ia || []).length} chamadas IA
                `;

                mostrarTab('parecer');
                document.getElementById('modal-detalhes').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('Erro ao carregar detalhes');
            }
        }

        function preencherParecer(geracao) {
            const parecerBadge = getParecrBadgeClasses(geracao.parecer);

            // Badge - SECURITY: escapeHtml
            document.getElementById('parecer-badge').innerHTML = `
                <span class="inline-block px-6 py-2 rounded-full text-lg font-bold ${escapeHtml(parecerBadge.badge)}">
                    <i class="fas ${escapeHtml(parecerBadge.icon)} mr-2"></i>${escapeHtml(parecerBadge.label)}
                </span>
            `;

            // Fundamentação - SECURITY: safeMarkedParse
            const fundamentacao = geracao.fundamentacao || 'Fundamentação não disponível';
            document.getElementById('texto-fundamentacao').innerHTML = safeMarkedParse(fundamentacao);

            // Extras (Irregularidades ou Perguntas) - SECURITY: escapeHtml
            let extrasHtml = '';

            if (geracao.parecer === 'desfavoravel' && geracao.irregularidades?.length > 0) {
                extrasHtml = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Irregularidades Identificadas</h4>
                        <ul class="list-disc list-inside text-red-700 space-y-1">
                            ${geracao.irregularidades.map(i => `<li>${escapeHtml(i)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else if (geracao.parecer === 'duvida' && geracao.perguntas_usuario?.length > 0) {
                extrasHtml = `
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <h4 class="font-semibold text-amber-800 mb-2"><i class="fas fa-question-circle mr-2"></i>Perguntas para o Usuário</h4>
                        <ul class="list-disc list-inside text-amber-700 space-y-1">
                            ${geracao.perguntas_usuario.map(p => `<li>${escapeHtml(p)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            document.getElementById('extras-parecer').innerHTML = extrasHtml;
        }

        function preencherDados(geracao) {
            // Subconta - SECURITY: escapeHtml
            let subcontaHtml = '<p class="text-gray-400">Dados não disponíveis</p>';
            if (geracao.extrato_subconta_texto) {
                const textoTruncado = geracao.extrato_subconta_texto.substring(0, 2000);
                subcontaHtml = `
                    <div class="max-h-40 overflow-y-auto bg-white p-2 rounded border text-xs">
                        <pre class="whitespace-pre-wrap">${escapeHtml(textoTruncado)}${geracao.extrato_subconta_texto.length > 2000 ? '...' : ''}</pre>
                    </div>
                    <button onclick="expandirTextoGeracao('extrato_subconta')" class="mt-2 text-xs text-teal-600 hover:text-teal-700">
                        <i class="fas fa-expand mr-1"></i>Ver completo
                    </button>
                `;
            }
            document.getElementById('dados-subconta').innerHTML = subcontaHtml;

            // Documentos - SECURITY: escapeHtml
            let docsHtml = '';
            const docs = geracao.documentos_anexos || [];
            if (docs.length > 0) {
                docsHtml = `<p class="text-gray-600 mb-2">${parseInt(docs.length) || 0} documento(s) analisado(s)</p>`;
                docs.forEach((doc, i) => {
                    docsHtml += `
                        <div class="bg-white p-2 rounded border mb-2">
                            <p class="font-medium text-sm">${escapeHtml(doc.tipo || 'Documento ' + (i + 1))}</p>
                            <p class="text-xs text-gray-500">${escapeHtml(doc.data || '')}</p>
                        </div>
                    `;
                });
            } else {
                docsHtml = '<p class="text-gray-400">Nenhum documento anexo</p>';
            }
            document.getElementById('dados-documentos').innerHTML = docsHtml;

            // Textos Extraídos
            let textosHtml = '';

            if (geracao.peticao_inicial_texto) {
                textosHtml += criarCaixaTexto('Petição Inicial', geracao.peticao_inicial_texto, 'peticao_inicial');
            }
            if (geracao.peticao_prestacao_texto) {
                textosHtml += criarCaixaTexto('Petição de Prestação', geracao.peticao_prestacao_texto, 'peticao_prestacao');
            }

            document.getElementById('textos-extraidos').innerHTML = textosHtml || '<p class="text-gray-400">Nenhum texto extraído disponível</p>';
        }

        function criarCaixaTexto(titulo, texto, id) {
            // SECURITY: escapeHtml para conteúdo
            const textoTruncado = texto.substring(0, 500);
            return `
                <div class="bg-white rounded border p-3">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-700">${escapeHtml(titulo)}</h4>
                        <button onclick="expandirTextoGeracao('${escapeHtml(id)}')" class="text-xs text-teal-600 hover:text-teal-700">
                            <i class="fas fa-expand mr-1"></i>Expandir
                        </button>
                    </div>
                    <div class="max-h-32 overflow-y-auto text-xs text-gray-600">
                        <pre class="whitespace-pre-wrap">${escapeHtml(textoTruncado)}${texto.length > 500 ? '...' : ''}</pre>
                    </div>
                </div>
            `;
        }

        // Armazena dados da geração atual
        let geracaoAtual = null;

        async function verDetalhes(id) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar detalhes');

                geracaoAtual = await response.json();

                // Preenche Parecer
                preencherParecer(geracaoAtual);

                // Preenche Dados Coletados
                preencherDados(geracaoAtual);

                // Preenche Logs IA
                preencherLogs(geracaoAtual.logs_ia || []);

                // Raw Response
                document.getElementById('texto-raw').textContent = geracaoAtual.resposta_ia_bruta || 'Não disponível';

                // Info rodapé - SECURITY: escapeHtml
                document.getElementById('info-geracao').innerHTML = `
                    <strong>${escapeHtml(geracaoAtual.numero_cnj)}</strong> |
                    ${escapeHtml(new Date(geracaoAtual.criado_em).toLocaleString('pt-BR'))} |
                    ${parseInt((geracaoAtual.logs_ia || []).length) || 0} chamadas IA
                `;

                mostrarTab('parecer');
                document.getElementById('modal-detalhes').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('Erro ao carregar detalhes');
            }
        }

        function expandirTextoGeracao(tipo) {
            if (!geracaoAtual) return;

            let texto = '';
            let titulo = '';

            switch (tipo) {
                case 'extrato_subconta':
                    texto = geracaoAtual.extrato_subconta_texto || '';
                    titulo = 'Extrato da Subconta';
                    break;
                case 'peticao_inicial':
                    texto = geracaoAtual.peticao_inicial_texto || '';
                    titulo = 'Petição Inicial';
                    break;
                case 'peticao_prestacao':
                    texto = geracaoAtual.peticao_prestacao_texto || '';
                    titulo = 'Petição de Prestação de Contas';
                    break;
            }

            document.getElementById('expand-titulo').textContent = titulo;
            document.getElementById('expand-conteudo').textContent = texto;
            document.getElementById('expand-conteudo').className = 'text-sm whitespace-pre-wrap p-4 rounded-lg bg-gray-50 text-gray-700 border';
            document.getElementById('modal-expand').classList.remove('hidden');
        }

        function preencherLogs(logs) {
            if (logs.length === 0) {
                document.getElementById('logs-container').innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum log registrado</p>';
                return;
            }

            const etapaLabels = {
                'identificacao_peticao': 'Identificação de Petição',
                'analise_final': 'Análise Final',
                'analise_xml': 'Análise XML',
                'extracao_documento': 'Extração de Documento'
            };

            // SECURITY: escapeHtml para dados do servidor
            let html = '';
            logs.forEach((log, i) => {
                const etapaLabel = etapaLabels[log.etapa] || log.etapa;
                html += `
                    <div class="bg-white rounded-lg border overflow-hidden">
                        <div onclick="toggleLog(${i})" class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50">
                            <div class="flex items-center gap-2">
                                <i class="fas ${log.sucesso ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                <span class="font-medium text-sm">${escapeHtml(etapaLabel)}</span>
                                ${log.tempo_ms ? `<span class="text-xs text-gray-400">${parseInt(log.tempo_ms) || 0}ms</span>` : ''}
                            </div>
                            <i id="chevron-${i}" class="fas fa-chevron-down text-gray-400 text-xs transition-transform"></i>
                        </div>
                        <div id="log-${i}" class="hidden border-t p-4 space-y-4 bg-gray-50">
                            ${log.erro ? `<div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-700">${escapeHtml(log.erro)}</div>` : ''}
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm text-gray-600 font-medium">Prompt Enviado</p>
                                    <button onclick="expandirTexto('prompt', ${i}, event)" class="text-xs text-teal-600 hover:text-teal-700">
                                        <i class="fas fa-expand mr-1"></i>Expandir
                                    </button>
                                </div>
                                <pre id="prompt-${i}" class="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-auto max-h-48 whitespace-pre-wrap">${escapeHtml(log.prompt_enviado || 'N/A')}</pre>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm text-gray-600 font-medium">Resposta IA</p>
                                    <button onclick="expandirTexto('resposta', ${i}, event)" class="text-xs text-teal-600 hover:text-teal-700">
                                        <i class="fas fa-expand mr-1"></i>Expandir
                                    </button>
                                </div>
                                <pre id="resposta-${i}" class="bg-green-50 text-green-800 p-4 rounded-lg text-sm overflow-auto max-h-48 border border-green-200 whitespace-pre-wrap">${escapeHtml(log.resposta_ia || 'N/A')}</pre>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('logs-container').innerHTML = html;
        }

        function toggleLog(index) {
            const el = document.getElementById(`log-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);
            el.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        function mostrarTab(tab) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('border-teal-600', 'text-teal-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${tab}`).classList.add('border-teal-600', 'text-teal-600');
            document.getElementById(`conteudo-${tab}`).classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        function expandirTexto(tipo, index, event) {
            event.stopPropagation();
            const el = document.getElementById(`${tipo}-${index}`);
            const conteudo = el.textContent;

            const expandEl = document.getElementById('expand-conteudo');
            expandEl.textContent = conteudo;

            if (tipo === 'prompt') {
                document.getElementById('expand-titulo').textContent = 'Prompt Enviado';
                expandEl.className = 'text-sm whitespace-pre-wrap p-4 rounded-lg bg-gray-900 text-gray-100';
            } else {
                document.getElementById('expand-titulo').textContent = 'Resposta IA';
                expandEl.className = 'text-sm whitespace-pre-wrap p-4 rounded-lg bg-green-50 text-green-800 border border-green-200';
            }

            document.getElementById('modal-expand').classList.remove('hidden');
        }

        function fecharExpand() {
            document.getElementById('modal-expand').classList.add('hidden');
        }

        function copiarExpand() {
            const texto = document.getElementById('expand-conteudo').textContent;
            navigator.clipboard.writeText(texto).then(() => {
                alert('Copiado!');
            });
        }

        // =====================================================
        // UPLOAD DE DOCUMENTOS FALTANTES
        // =====================================================

        let uploadGeracaoId = null;
        let uploadNumeroCnj = null;
        let uploadDocsFaltantes = [];
        let arquivosParaEnviar = [];

        function abrirModalUpload(geracaoId, numeroCnj, docsFaltantes) {
            uploadGeracaoId = geracaoId;
            uploadNumeroCnj = numeroCnj;
            uploadDocsFaltantes = docsFaltantes || [];
            arquivosParaEnviar = [];

            // Preencher informações
            document.getElementById('upload-processo').textContent = `Processo: ${numeroCnj}`;

            // Mostrar lista de documentos faltantes
            let docsHtml = '<p class="text-sm text-gray-600 mb-2">Documentos necessários:</p>';
            uploadDocsFaltantes.forEach(doc => {
                docsHtml += `
                    <div class="flex items-center gap-2 p-2 bg-amber-50 rounded border border-amber-200">
                        <i class="fas fa-file-alt text-amber-500"></i>
                        <span class="text-sm text-amber-800">${escapeHtml(formatarNomeDocumento(doc))}</span>
                    </div>
                `;
            });
            document.getElementById('upload-docs-lista').innerHTML = docsHtml;

            // Limpar estado
            document.getElementById('arquivos-selecionados').innerHTML = '';
            document.getElementById('upload-erro').classList.add('hidden');
            document.getElementById('upload-sucesso').classList.add('hidden');
            document.getElementById('btn-enviar-upload').disabled = true;
            document.getElementById('input-arquivos').value = '';

            // Mostrar modal
            document.getElementById('modal-upload').classList.remove('hidden');
        }

        function fecharModalUpload() {
            document.getElementById('modal-upload').classList.add('hidden');
            uploadGeracaoId = null;
            uploadNumeroCnj = null;
            uploadDocsFaltantes = [];
            arquivosParaEnviar = [];
        }

        function arquivosSelecionados(files) {
            arquivosParaEnviar = Array.from(files);

            // Mostrar arquivos selecionados
            let html = '';
            arquivosParaEnviar.forEach((file, i) => {
                const tamanhoKb = (file.size / 1024).toFixed(1);
                html += `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-pdf text-red-500"></i>
                            <span class="text-sm">${escapeHtml(file.name)}</span>
                            <span class="text-xs text-gray-400">(${tamanhoKb} KB)</span>
                        </div>
                        <button onclick="removerArquivo(${i})" class="text-red-500 hover:text-red-700 p-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            document.getElementById('arquivos-selecionados').innerHTML = html;

            // Habilitar botão se há arquivos
            document.getElementById('btn-enviar-upload').disabled = arquivosParaEnviar.length === 0;
        }

        function removerArquivo(index) {
            arquivosParaEnviar.splice(index, 1);
            arquivosSelecionados(arquivosParaEnviar);
        }

        async function enviarDocumentos() {
            if (!uploadGeracaoId || arquivosParaEnviar.length === 0) return;

            const btnEnviar = document.getElementById('btn-enviar-upload');
            const erroDiv = document.getElementById('upload-erro');
            const sucessoDiv = document.getElementById('upload-sucesso');

            // Esconder mensagens anteriores
            erroDiv.classList.add('hidden');
            sucessoDiv.classList.add('hidden');

            // Mostrar loading
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';

            try {
                const formData = new FormData();
                formData.append('geracao_id', uploadGeracaoId);
                arquivosParaEnviar.forEach(file => {
                    formData.append('arquivos', file);
                });

                const response = await fetch(`${API_BASE}/upload-documentos-faltantes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Erro ao enviar documentos');
                }

                // Sucesso
                sucessoDiv.innerHTML = `
                    <i class="fas fa-check-circle mr-2"></i>
                    ${escapeHtml(data.mensagem || 'Documentos enviados com sucesso!')}
                    ${data.reprocessando ? '<br><span class="text-xs">A análise será reprocessada.</span>' : ''}
                `;
                sucessoDiv.classList.remove('hidden');

                // Recarregar lista após 2 segundos
                setTimeout(() => {
                    fecharModalUpload();
                    carregarGeracoes();
                }, 2000);

            } catch (error) {
                console.error('Erro ao enviar:', error);
                erroDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${escapeHtml(error.message)}`;
                erroDiv.classList.remove('hidden');
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="fas fa-upload mr-2"></i>Enviar e Reprocessar';
            }
        }
    </script>
</body>
</html>
