<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Gerações - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Marked.js para renderizar markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }
                    }
                }
            }
        }
    </script>
    <style>
        .markdown-body { font-family: 'Times New Roman', Georgia, serif; font-size: 14px; line-height: 1.8; color: #1f2937; }
        .markdown-body h2 { font-family: 'Arial', sans-serif; font-weight: 700; font-size: 1.1em; text-align: center; margin: 1.5em 0 0.75em; }
        .markdown-body p { text-align: justify; text-indent: 2em; margin-bottom: 1em; }
        .markdown-body blockquote { margin: 1.5em 3em; padding: 0.5em 1em; border-left: 4px solid #d1d5db; background: #f9fafb; font-style: italic; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-500 hover:text-primary-600">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Histórico de Gerações</h1>
                    <p class="text-sm text-gray-500">Visualize prompts enviados e resultados</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div id="lista-geracoes" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando histórico...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Detalhes -->
    <div id="modal-detalhes" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-800">Detalhes da Geração</h2>
                <button onclick="fecharModal()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-4 flex-wrap">
                    <button onclick="mostrarTab('prompt')" id="tab-prompt" class="px-4 py-2 border-b-2 border-primary-600 text-primary-600 font-medium">
                        Prompt Enviado
                    </button>
                    <button onclick="mostrarTab('resumo')" id="tab-resumo" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Resumo Consolidado
                    </button>
                    <button onclick="mostrarTab('markdown')" id="tab-markdown" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Minuta (Markdown)
                    </button>
                    <button onclick="mostrarTab('chat')" id="tab-chat" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-comments mr-1"></i>Edições Chat
                    </button>
                    <button onclick="mostrarTab('versoes')" id="tab-versoes" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-history mr-1"></i>Versões <span id="versoes-badge" class="hidden bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-xs ml-1">0</span>
                    </button>
                    <button onclick="mostrarTab('resultado')" id="tab-resultado" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Resultado (Raw)
                    </button>
                </div>
                
                <!-- Conteúdo das Tabs -->
                <div id="conteudo-prompt" class="tab-content">
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre id="texto-prompt" class="text-sm text-gray-100 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <div id="conteudo-resumo" class="tab-content hidden">
                    <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto prose max-w-none">
                        <pre id="texto-resumo" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <div id="conteudo-resultado" class="tab-content hidden">
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre id="texto-resultado" class="text-sm text-green-400 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <div id="conteudo-markdown" class="tab-content hidden">
                    <div class="bg-white rounded-lg p-4 overflow-x-auto border prose max-w-none">
                        <div id="texto-markdown" class="markdown-body"></div>
                    </div>
                </div>

                <div id="conteudo-chat" class="tab-content hidden">
                    <div id="chat-container" class="space-y-4"></div>
                </div>

                <div id="conteudo-versoes" class="tab-content hidden">
                    <div id="versoes-container" class="space-y-4"></div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 flex justify-between items-center">
                <div id="info-geracao" class="text-sm text-gray-500"></div>
                <div class="flex gap-3">
                    <button id="btn-download-docx" onclick="baixarDocx()" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 hidden">
                        <i class="fas fa-file-word mr-2"></i>Baixar DOCX
                    </button>
                    <button onclick="fecharModal()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/gerador-pecas-admin';
        let geracoesCache = [];
        let geracaoAtual = null;

        document.addEventListener('DOMContentLoaded', () => {
            carregarGeracoes();
        });

        function getToken() {
            return localStorage.getItem('access_token');
        }

        async function carregarGeracoes() {
            try {
                const response = await fetch(`${API_BASE}/geracoes?limit=100`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar');
                
                geracoesCache = await response.json();
                renderizarGeracoes();
            } catch (error) {
                console.error(error);
                document.getElementById('lista-geracoes').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar histórico</p>
                    </div>`;
            }
        }

        function renderizarGeracoes() {
            const container = document.getElementById('lista-geracoes');
            
            if (geracoesCache.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Nenhuma geração encontrada</p>
                    </div>`;
                return;
            }

            container.innerHTML = geracoesCache.map(g => `
                <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="verDetalhes(${g.id})">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                                <i class="fas fa-file-alt text-primary-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${g.numero_cnj_formatado || g.numero_cnj}</p>
                                <p class="text-sm text-gray-500">${formatarTipoPeca(g.tipo_peca)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">${new Date(g.criado_em).toLocaleDateString('pt-BR')}</p>
                            <p class="text-xs text-gray-400">${new Date(g.criado_em).toLocaleTimeString('pt-BR')}</p>
                            ${g.tempo_processamento ? `<p class="text-xs text-green-600 mt-1">⏱️ ${g.tempo_processamento}s</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="mt-3 flex items-center gap-4 text-xs text-gray-500">
                        <span><i class="fas fa-robot mr-1"></i> ${g.modelo_usado || 'N/A'}</span>
                        ${g.prompt_enviado ? '<span class="text-green-600"><i class="fas fa-check mr-1"></i> Prompt salvo</span>' : '<span class="text-gray-400"><i class="fas fa-times mr-1"></i> Sem prompt</span>'}
                    </div>
                </div>
            `).join('');
        }

        async function verDetalhes(id) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar detalhes');

                const geracao = await response.json();
                geracaoAtual = geracao;

                document.getElementById('texto-prompt').textContent = geracao.prompt_enviado || 'Prompt não disponível';
                document.getElementById('texto-resumo').textContent = geracao.resumo_consolidado || 'Resumo não disponível';

                // Detecta se é markdown (string) ou JSON (object)
                const conteudo = geracao.conteudo_gerado;
                const isMarkdown = typeof conteudo === 'string';

                if (isMarkdown && conteudo) {
                    // Renderiza markdown
                    document.getElementById('texto-markdown').innerHTML = marked.parse(conteudo);
                    document.getElementById('texto-resultado').textContent = conteudo;
                    // Mostra botão de download DOCX
                    document.getElementById('btn-download-docx').classList.remove('hidden');
                } else if (conteudo) {
                    // JSON antigo
                    document.getElementById('texto-markdown').innerHTML = '<p class="text-gray-500">Esta geração usa formato JSON antigo. Veja a aba "Resultado (Raw)".</p>';
                    document.getElementById('texto-resultado').textContent = JSON.stringify(conteudo, null, 2);
                    document.getElementById('btn-download-docx').classList.add('hidden');
                } else {
                    document.getElementById('texto-markdown').innerHTML = '<p class="text-gray-500">Conteúdo não disponível</p>';
                    document.getElementById('texto-resultado').textContent = 'Resultado não disponível';
                    document.getElementById('btn-download-docx').classList.add('hidden');
                }

                // Renderiza histórico de chat
                renderizarHistoricoChat(geracao.historico_chat || []);

                document.getElementById('info-geracao').innerHTML = `
                    <strong>${geracao.numero_cnj_formatado || geracao.numero_cnj}</strong> |
                    ${formatarTipoPeca(geracao.tipo_peca)} |
                    ${new Date(geracao.criado_em).toLocaleString('pt-BR')}
                    ${isMarkdown ? ' | <span class="text-green-600">Markdown</span>' : ' | <span class="text-amber-600">JSON</span>'}
                    ${geracao.historico_chat && geracao.historico_chat.length > 0 ? ` | <span class="text-purple-600"><i class="fas fa-comments"></i> ${geracao.historico_chat.length} edições</span>` : ''}
                `;

                // Carrega versões
                carregarVersoes(id);

                // Mostra a tab de markdown por padrão se for markdown
                mostrarTab(isMarkdown ? 'markdown' : 'prompt');
                document.getElementById('modal-detalhes').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('Erro ao carregar detalhes');
            }
        }

        async function baixarDocx() {
            if (!geracaoAtual || !geracaoAtual.conteudo_gerado) {
                alert('Conteúdo não disponível para download');
                return;
            }

            const btn = document.getElementById('btn-download-docx');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
            btn.disabled = true;

            try {
                // Chama endpoint de conversão para DOCX
                const response = await fetch('/gerador-pecas/api/exportar-docx', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        markdown: geracaoAtual.conteudo_gerado,
                        tipo_peca: geracaoAtual.tipo_peca || 'peca',
                        numero_processo: geracaoAtual.numero_cnj
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Erro ao gerar DOCX');
                }

                const data = await response.json();

                // Faz download do arquivo
                const downloadUrl = data.url_download + `?token=${encodeURIComponent(getToken())}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = '';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('Erro ao baixar DOCX:', error);
                alert('Erro ao gerar DOCX: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function mostrarTab(tab) {
            // Remove active de todas as tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('border-primary-600', 'text-primary-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Esconde todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Ativa a tab selecionada
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${tab}`).classList.add('border-primary-600', 'text-primary-600');
            document.getElementById(`conteudo-${tab}`).classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        function formatarTipoPeca(tipo) {
            const labels = {
                'contestacao': 'Contestação',
                'recurso_apelacao': 'Recurso de Apelação',
                'contrarrazoes': 'Contrarrazões',
                'parecer': 'Parecer Jurídico'
            };
            return labels[tipo] || tipo || 'Não definido';
        }

        function renderizarHistoricoChat(historico) {
            const container = document.getElementById('chat-container');

            if (!historico || historico.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-comments text-4xl mb-4"></i>
                        <p>Nenhuma edição via chat foi realizada</p>
                        <p class="text-sm mt-2">O usuário não solicitou alterações após a geração inicial</p>
                    </div>`;
                return;
            }

            let html = `
                <div class="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                    <p class="text-purple-800 font-medium"><i class="fas fa-info-circle mr-2"></i>Histórico de Edições</p>
                    <p class="text-purple-600 text-sm mt-1">O usuário solicitou ${historico.length} alteração(ões) via chat após a geração inicial.</p>
                </div>
            `;

            historico.forEach((msg, index) => {
                const isUser = msg.role === 'user';
                const bgClass = isUser ? 'bg-blue-50 border-blue-200' : 'bg-green-50 border-green-200';
                const iconClass = isUser ? 'fa-user text-blue-600' : 'fa-robot text-green-600';
                const labelClass = isUser ? 'text-blue-700' : 'text-green-700';
                const label = isUser ? 'Usuário' : 'Assistente IA';

                html += `
                    <div class="rounded-lg border p-4 ${bgClass}">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas ${iconClass}"></i>
                            <span class="font-medium ${labelClass}">${label}</span>
                            <span class="text-xs text-gray-400 ml-auto">#${index + 1}</span>
                        </div>
                        <div class="text-gray-700 text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function carregarVersoes(geracaoId) {
            const container = document.getElementById('versoes-container');
            const badge = document.getElementById('versoes-badge');

            try {
                const response = await fetch(`${API_BASE}/geracoes/${geracaoId}/versoes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar versões');

                const data = await response.json();

                // Atualiza badge
                if (data.total_versoes > 0) {
                    badge.textContent = data.total_versoes;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                renderizarVersoes(data.versoes);
            } catch (error) {
                console.error('Erro ao carregar versões:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar versões</p>
                    </div>`;
            }
        }

        function renderizarVersoes(versoes) {
            const container = document.getElementById('versoes-container');

            if (!versoes || versoes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-history text-4xl mb-4"></i>
                        <p>Nenhuma versão salva</p>
                        <p class="text-sm mt-2">As versões são criadas quando o usuário edita a peça via chat</p>
                    </div>`;
                return;
            }

            let html = `
                <div class="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                    <p class="text-purple-800 font-medium"><i class="fas fa-info-circle mr-2"></i>Histórico de Versões</p>
                    <p class="text-purple-600 text-sm mt-1">Esta geração possui ${versoes.length} versão(ões) salva(s).</p>
                </div>
            `;

            versoes.forEach((versao, index) => {
                const tipoLabel = {
                    'geracao_inicial': 'Versão Inicial',
                    'edicao_chat': 'Edição via Chat',
                    'edicao_manual': 'Edição Manual',
                    'restauracao': 'Restauração'
                }[versao.tipo_alteracao] || versao.tipo_alteracao;

                const tipoClass = {
                    'geracao_inicial': 'bg-green-100 text-green-700',
                    'edicao_chat': 'bg-blue-100 text-blue-700',
                    'edicao_manual': 'bg-amber-100 text-amber-700',
                    'restauracao': 'bg-purple-100 text-purple-700'
                }[versao.tipo_alteracao] || 'bg-gray-100 text-gray-700';

                const dataFormatada = versao.criado_em
                    ? new Date(versao.criado_em).toLocaleString('pt-BR')
                    : 'Data não disponível';

                html += `
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
                            <div class="flex items-center gap-3">
                                <span class="text-lg font-semibold text-gray-700">v${versao.numero_versao}</span>
                                <span class="px-2 py-1 text-xs rounded-full ${tipoClass}">${tipoLabel}</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${dataFormatada}
                            </div>
                        </div>
                        ${versao.descricao ? `
                            <div class="px-4 py-2 bg-blue-50 border-b border-blue-100">
                                <p class="text-sm text-blue-700"><i class="fas fa-comment mr-1"></i>${escapeHtml(versao.descricao)}</p>
                            </div>
                        ` : ''}
                        <div class="p-4">
                            <button onclick="verConteudoVersao(${versao.id}, ${versao.numero_versao})"
                                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 text-sm">
                                <i class="fas fa-eye mr-1"></i>Ver Conteúdo
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        let versaoModalAberta = null;

        async function verConteudoVersao(versaoId, numeroVersao) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${geracaoAtual.id}/versoes/${versaoId}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar versão');

                const versao = await response.json();

                // Abre um modal secundário ou substitui o conteúdo
                const conteudo = versao.conteudo_markdown || 'Conteúdo não disponível';

                // Mostra na tab de markdown temporariamente
                document.getElementById('texto-markdown').innerHTML = `
                    <div class="mb-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-purple-800 font-medium">Visualizando: Versão ${numeroVersao}</p>
                        <button onclick="voltarParaVersaoAtual()" class="mt-2 px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                            <i class="fas fa-arrow-left mr-1"></i>Voltar para versão atual
                        </button>
                    </div>
                ` + marked.parse(conteudo);

                mostrarTab('markdown');
                versaoModalAberta = versaoId;

            } catch (error) {
                console.error('Erro ao ver versão:', error);
                alert('Erro ao carregar conteúdo da versão');
            }
        }

        function voltarParaVersaoAtual() {
            if (geracaoAtual && geracaoAtual.conteudo_gerado) {
                document.getElementById('texto-markdown').innerHTML = marked.parse(geracaoAtual.conteudo_gerado);
            }
            versaoModalAberta = null;
        }
    </script>
</body>
</html>
