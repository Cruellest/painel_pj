<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Gerações - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SECURITY: DOMPurify para sanitização de HTML -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Marked.js para renderizar markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- SECURITY: Utilitários de segurança -->
    <script src="/static/js/security.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }
                    }
                }
            }
        }
    </script>
    <style>
        .markdown-body { font-family: 'Times New Roman', Georgia, serif; font-size: 14px; line-height: 1.8; color: #1f2937; }
        .markdown-body h2 { font-family: 'Arial', sans-serif; font-weight: 700; font-size: 1.1em; text-align: center; margin: 1.5em 0 0.75em; }
        .markdown-body p { text-align: justify; text-indent: 2em; margin-bottom: 1em; }
        .markdown-body blockquote { margin: 1.5em 3em; padding: 0.5em 1em; border-left: 4px solid #d1d5db; background: #f9fafb; font-style: italic; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-500 hover:text-primary-600">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Histórico de Gerações</h1>
                    <p class="text-sm text-gray-500">Visualize prompts enviados e resultados</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div id="lista-geracoes" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando histórico...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Detalhes -->
    <div id="modal-detalhes" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-800">Detalhes da Geração</h2>
                <button onclick="fecharModal()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-4 flex-wrap">
                    <button onclick="mostrarTab('prompt')" id="tab-prompt" class="px-4 py-2 border-b-2 border-primary-600 text-primary-600 font-medium">
                        Prompt Enviado
                    </button>
                    <button onclick="mostrarTab('resumo')" id="tab-resumo" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Resumo Consolidado
                    </button>
                    <button onclick="mostrarTab('markdown')" id="tab-markdown" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Minuta (Markdown)
                    </button>
                    <button onclick="mostrarTab('chat')" id="tab-chat" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-comments mr-1"></i>Edições Chat
                    </button>
                    <button onclick="mostrarTab('versoes')" id="tab-versoes" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-history mr-1"></i>Versões <span id="versoes-badge" class="hidden bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-xs ml-1">0</span>
                    </button>
                    <button onclick="mostrarTab('resultado')" id="tab-resultado" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Resultado (Raw)
                    </button>
                </div>
                
                <!-- Conteúdo das Tabs -->
                <div id="conteudo-prompt" class="tab-content">
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre id="texto-prompt" class="text-sm text-gray-100 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <div id="conteudo-resumo" class="tab-content hidden">
                    <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto prose max-w-none">
                        <pre id="texto-resumo" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <div id="conteudo-resultado" class="tab-content hidden">
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre id="texto-resultado" class="text-sm text-green-400 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <div id="conteudo-markdown" class="tab-content hidden">
                    <div class="bg-white rounded-lg p-4 overflow-x-auto border prose max-w-none">
                        <div id="texto-markdown" class="markdown-body"></div>
                    </div>
                </div>

                <div id="conteudo-chat" class="tab-content hidden">
                    <div id="chat-container" class="space-y-4"></div>
                </div>

                <div id="conteudo-versoes" class="tab-content hidden">
                    <div id="versoes-container" class="space-y-4"></div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 flex justify-between items-center">
                <div id="info-geracao" class="text-sm text-gray-500"></div>
                <div class="flex gap-3">
                    <button id="btn-download-docx" onclick="baixarDocx()" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 hidden">
                        <i class="fas fa-file-word mr-2"></i>Baixar DOCX
                    </button>
                    <button onclick="fecharModal()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/gerador-pecas-admin';
        let geracoesCache = [];
        let geracaoAtual = null;

        // Fuso horário de Mato Grosso do Sul (UTC-04:00)
        const TIMEZONE = 'America/Campo_Grande';

        function formatarData(dataISO) {
            if (!dataISO) return '-';
            return new Date(dataISO).toLocaleDateString('pt-BR', { timeZone: TIMEZONE });
        }

        function formatarHora(dataISO) {
            if (!dataISO) return '-';
            return new Date(dataISO).toLocaleTimeString('pt-BR', { timeZone: TIMEZONE });
        }

        function formatarDataHora(dataISO) {
            if (!dataISO) return '-';
            return new Date(dataISO).toLocaleString('pt-BR', { timeZone: TIMEZONE });
        }

        // SECURITY: Configura marked para sanitizar output via DOMPurify
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // SECURITY: Wrapper seguro para marked que sanitiza o HTML resultante
        function safeMarkedParse(markdown) {
            if (!markdown) return '';
            const rawHtml = marked.parse(markdown);
            // Sanitiza com DOMPurify permitindo apenas tags seguras
            return DOMPurify.sanitize(rawHtml, {
                ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'hr',
                               'ul', 'ol', 'li', 'strong', 'em', 'b', 'i', 'u',
                               'blockquote', 'pre', 'code', 'table', 'thead', 'tbody',
                               'tr', 'th', 'td', 'a', 'span', 'div'],
                ALLOWED_ATTR: ['class', 'id', 'href', 'target', 'rel'],
                ALLOW_DATA_ATTR: false
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarGeracoes();
        });

        function getToken() {
            return localStorage.getItem('access_token');
        }

        async function carregarGeracoes() {
            try {
                const response = await fetch(`${API_BASE}/geracoes?limit=100`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar');
                
                geracoesCache = await response.json();
                renderizarGeracoes();
            } catch (error) {
                console.error(error);
                document.getElementById('lista-geracoes').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar histórico</p>
                    </div>`;
            }
        }

        function formatarTempo(segundos) {
            if (!segundos) return null;
            const s = parseInt(segundos);
            if (s < 60) {
                return `${s}s`;
            } else {
                const min = Math.floor(s / 60);
                const sec = s % 60;
                return `${min}m ${sec}s`;
            }
        }

        function renderizarGeracoes() {
            const container = document.getElementById('lista-geracoes');

            if (geracoesCache.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Nenhuma geração encontrada</p>
                    </div>`;
                return;
            }

            // SECURITY: Sanitiza dados de usuário antes de renderizar
            container.innerHTML = geracoesCache.map(g => `
                <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="verDetalhes(${parseInt(g.id) || 0})">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                                <i class="fas fa-file-alt text-primary-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${escapeHtml(g.numero_cnj_formatado || g.numero_cnj)}</p>
                                <p class="text-sm text-gray-500">${escapeHtml(formatarTipoPeca(g.tipo_peca))}</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-4">
                            ${g.tempo_processamento ? `
                                <div class="bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-1.5 text-center" title="Tempo total de geração">
                                    <p class="text-emerald-700 font-semibold text-sm"><i class="fas fa-stopwatch mr-1"></i>${escapeHtml(formatarTempo(g.tempo_processamento))}</p>
                                </div>
                            ` : ''}
                            <div>
                                <p class="text-sm text-gray-500">${escapeHtml(formatarData(g.criado_em))}</p>
                                <p class="text-xs text-gray-400">${escapeHtml(formatarHora(g.criado_em))}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 flex items-center gap-4 text-xs text-gray-500 flex-wrap">
                        <span><i class="fas fa-robot mr-1"></i> ${escapeHtml(g.modelo_usado || 'N/A')}</span>
                        ${g.prompt_enviado ? '<span class="text-green-600"><i class="fas fa-check mr-1"></i> Prompt salvo</span>' : '<span class="text-gray-400"><i class="fas fa-times mr-1"></i> Sem prompt</span>'}
                        ${formatarModoAtivacao(g)}
                    </div>
                </div>
            `).join('');
        }

        function formatarModoAtivacao(g) {
            const modo = g.modo_ativacao_agente2;
            const det = g.modulos_ativados_det || 0;
            const llm = g.modulos_ativados_llm || 0;

            if (modo === 'semi_automatico') {
                // Modo semi-automático: det = módulos confirmados do preview, llm = módulos adicionados manualmente
                const totalIncluidos = det + llm;
                const manuais = llm;
                const confirmados = det;
                return `<span class="bg-amber-100 text-amber-700 px-2 py-1 rounded-full cursor-pointer hover:bg-amber-200 transition-colors inline-flex items-center gap-1"
                    title="Modo Semi-Automático: Clique para ver auditoria completa&#10;• ${confirmados} argumento(s) confirmado(s) pelo usuário&#10;• ${manuais} argumento(s) adicionado(s) manualmente&#10;Todos marcados com [HUMAN_VALIDATED]"
                    onclick="event.stopPropagation(); verDetalhesCuradoria(${g.id})">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Curadoria Humana</span>
                    <span class="bg-amber-500 text-white px-1.5 py-0.5 rounded text-xs font-bold">${totalIncluidos}</span>
                </span>`;
            } else if (modo === 'fast_path') {
                return `<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full" title="100% determinístico, sem LLM">
                    <i class="fas fa-bolt mr-1"></i>Fast Path (${det} módulos)
                </span>`;
            } else if (modo === 'misto') {
                return `<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full" title="Modo misto: ${det} determinístico + ${llm} LLM">
                    <i class="fas fa-random mr-1"></i>Misto (${det} det + ${llm} LLM)
                </span>`;
            } else if (modo === 'llm') {
                return `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full" title="100% LLM">
                    <i class="fas fa-brain mr-1"></i>LLM (${llm} módulos)
                </span>`;
            }
            // Gerações anteriores à implementação do tracking de modo
            return `<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full" title="Modo de ativação não registrado (geração anterior ao tracking)">
                <i class="fas fa-question-circle mr-1"></i>Modo não registrado
            </span>`;
        }

        async function verDetalhesCuradoria(geracaoId) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${geracaoId}/curadoria`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        alert('Detalhes de curadoria não disponíveis para esta geração.');
                        return;
                    }
                    throw new Error('Erro ao carregar detalhes de curadoria');
                }

                const dados = await response.json();
                mostrarModalCuradoria(dados);
            } catch (error) {
                console.error('Erro ao carregar detalhes de curadoria:', error);
                alert('Erro ao carregar detalhes de curadoria');
            }
        }

        function mostrarModalCuradoria(dados) {
            // Remove modal existente se houver
            let modal = document.getElementById('modal-curadoria-detalhes');
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = 'modal-curadoria-detalhes';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            const metadata = dados.metadata || {};
            const modulosIncluidos = dados.modulos_incluidos || [];
            const modulosExcluidos = dados.modulos_excluidos || [];
            const glossario = dados.glossario || {};
            const explicacao = dados.explicacao_processo || {};

            // Separa módulos por tipo de decisão
            const confirmados = modulosIncluidos.filter(m => m.tipo_decisao === 'confirmado');
            const manuais = modulosIncluidos.filter(m => m.tipo_decisao === 'manual');

            // Função para gerar HTML de um módulo expandível
            const renderModulo = (m, corBg, corText, corBadge) => `
                <div class="border ${corBg} rounded-lg mb-2 overflow-hidden">
                    <div class="p-3 cursor-pointer flex items-start justify-between gap-2 hover:bg-opacity-80"
                         onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.expand-icon').classList.toggle('fa-chevron-down'); this.querySelector('.expand-icon').classList.toggle('fa-chevron-up');">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-medium ${corText}">${escapeHtml(m.titulo)}</span>
                                <span class="${corBadge} px-2 py-0.5 rounded text-xs font-mono">${escapeHtml(m.tag || '')}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                                <span class="bg-gray-200 px-2 py-0.5 rounded">${escapeHtml(m.categoria || 'Outros')}</span>
                                ${m.subcategoria ? `<span class="bg-gray-100 px-2 py-0.5 rounded">${escapeHtml(m.subcategoria)}</span>` : ''}
                                ${m.ordem ? `<span class="text-gray-400">#${m.ordem}</span>` : ''}
                            </div>
                            <p class="text-xs ${corText} mt-1 opacity-75">${escapeHtml(m.decisao_explicacao || '')}</p>
                        </div>
                        <i class="fas fa-chevron-down expand-icon text-gray-400 mt-1"></i>
                    </div>
                    <div class="hidden border-t border-gray-200 p-3 bg-white">
                        <div class="mb-2">
                            <span class="text-xs font-semibold text-gray-600">Por que ${m.status_final === 'incluido' ? 'incluído' : 'excluído'}:</span>
                            <p class="text-xs text-gray-700 mt-1">${escapeHtml(m.motivo_inclusao || m.motivo_exclusao || '-')}</p>
                        </div>
                        <div>
                            <span class="text-xs font-semibold text-gray-600">Conteúdo do argumento:</span>
                            <div class="mt-1 p-2 bg-gray-50 rounded text-xs text-gray-700 max-h-40 overflow-y-auto whitespace-pre-wrap font-mono">${escapeHtml(m.conteudo || '(Conteúdo não disponível)')}</div>
                        </div>
                    </div>
                </div>
            `;

            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="p-5 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-amber-50 to-orange-50">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-amber-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-clipboard-check text-white text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Auditoria da Curadoria</h2>
                                <p class="text-sm text-amber-700">Modo Semi-Automático — Validação Humana</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('modal-curadoria-detalhes').remove()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="p-5 overflow-y-auto flex-1">
                        <!-- Explicação do Processo (colapsável) -->
                        <div class="mb-5 bg-blue-50 border border-blue-200 rounded-xl overflow-hidden">
                            <div class="p-4 cursor-pointer flex items-center justify-between hover:bg-blue-100"
                                 onclick="document.getElementById('explicacao-processo').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-down'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-up');">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-info-circle text-blue-600"></i>
                                    <span class="font-semibold text-blue-800">${escapeHtml(explicacao.titulo || 'Como funciona o Modo Semi-Automático')}</span>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon text-blue-400"></i>
                            </div>
                            <div id="explicacao-processo" class="hidden border-t border-blue-200 p-4 bg-white">
                                <ol class="space-y-2 text-sm text-gray-700">
                                    ${(explicacao.etapas || []).map(e => `<li class="flex items-start gap-2"><i class="fas fa-arrow-right text-blue-400 mt-1"></i><span>${escapeHtml(e)}</span></li>`).join('')}
                                </ol>
                                <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <p class="text-sm text-green-800 font-medium">
                                        <i class="fas fa-shield-alt mr-2"></i>${escapeHtml(explicacao.garantia || '')}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Estatísticas Resumidas -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center relative group">
                                <p class="text-3xl font-bold text-blue-600">${metadata.total_preview || 0}</p>
                                <p class="text-xs text-blue-700 font-medium">Sugestões do Sistema</p>
                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                    Argumentos sugeridos automaticamente pelo sistema antes da revisão
                                </div>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center relative group">
                                <p class="text-3xl font-bold text-green-600">${metadata.total_confirmados || 0}</p>
                                <p class="text-xs text-green-700 font-medium">Confirmados</p>
                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                    Sugestões do sistema que você confirmou
                                </div>
                            </div>
                            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 text-center relative group">
                                <p class="text-3xl font-bold text-amber-600">${metadata.total_manuais || 0}</p>
                                <p class="text-xs text-amber-700 font-medium">Adicionados por Você</p>
                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                    Argumentos que você adicionou manualmente
                                </div>
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-center relative group">
                                <p class="text-3xl font-bold text-red-600">${metadata.total_excluidos || 0}</p>
                                <p class="text-xs text-red-700 font-medium">Removidos por Você</p>
                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                    Sugestões do sistema que você removeu
                                </div>
                            </div>
                        </div>

                        ${metadata.preview_timestamp ? `
                            <p class="text-xs text-gray-500 mb-4 flex items-center gap-2">
                                <i class="fas fa-clock"></i>
                                <span>Sugestões geradas em: <strong>${escapeHtml(formatarDataHora(metadata.preview_timestamp))}</strong></span>
                            </p>
                        ` : ''}

                        <!-- Seção: INCLUÍDOS NA PEÇA FINAL -->
                        <div class="mb-5">
                            <div class="flex items-center gap-2 mb-3 pb-2 border-b border-green-200">
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-green-800">INCLUÍDOS NA PEÇA FINAL</h3>
                                    <p class="text-xs text-green-600">${modulosIncluidos.length} argumento(s) validado(s) pelo usuário</p>
                                </div>
                            </div>

                            ${confirmados.length > 0 ? `
                                <!-- Confirmados (sugestões aceitas) -->
                                <div class="mb-4">
                                    <div class="flex items-center gap-2 mb-2 cursor-pointer"
                                         onclick="document.getElementById('secao-confirmados').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-down'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-up');">
                                        <i class="fas fa-thumbs-up text-green-500"></i>
                                        <span class="text-sm font-semibold text-gray-700">Sugestões Confirmadas (${confirmados.length})</span>
                                        <span class="text-xs text-gray-400">— Você aceitou estas sugestões do sistema</span>
                                        <i class="fas fa-chevron-up toggle-icon text-gray-400 ml-auto"></i>
                                    </div>
                                    <div id="secao-confirmados" class="ml-6">
                                        ${confirmados.map(m => renderModulo(m, 'border-green-200 bg-green-50', 'text-green-800', 'bg-green-200 text-green-800')).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${manuais.length > 0 ? `
                                <!-- Adicionados manualmente -->
                                <div class="mb-4">
                                    <div class="flex items-center gap-2 mb-2 cursor-pointer"
                                         onclick="document.getElementById('secao-manuais').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-down'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-up');">
                                        <i class="fas fa-plus-circle text-amber-500"></i>
                                        <span class="text-sm font-semibold text-gray-700">Adicionados Manualmente (${manuais.length})</span>
                                        <span class="text-xs text-gray-400">— Você incluiu estes argumentos que não estavam na sugestão</span>
                                        <i class="fas fa-chevron-up toggle-icon text-gray-400 ml-auto"></i>
                                    </div>
                                    <div id="secao-manuais" class="ml-6">
                                        ${manuais.map(m => renderModulo(m, 'border-amber-200 bg-amber-50', 'text-amber-800', 'bg-amber-200 text-amber-800')).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${modulosIncluidos.length === 0 ? `
                                <p class="text-sm text-gray-500 italic ml-6">Nenhum argumento incluído</p>
                            ` : ''}
                        </div>

                        <!-- Seção: EXCLUÍDOS DA PEÇA FINAL -->
                        ${modulosExcluidos.length > 0 ? `
                            <div class="mb-5">
                                <div class="flex items-center gap-2 mb-3 pb-2 border-b border-red-200">
                                    <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-times text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-red-800">EXCLUÍDOS DA PEÇA FINAL</h3>
                                        <p class="text-xs text-red-600">${modulosExcluidos.length} argumento(s) removido(s) pelo usuário</p>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <div class="flex items-center gap-2 mb-2 cursor-pointer"
                                         onclick="document.getElementById('secao-excluidos').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-down'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-up');">
                                        <i class="fas fa-ban text-red-500"></i>
                                        <span class="text-sm font-semibold text-gray-700">Sugestões Removidas (${modulosExcluidos.length})</span>
                                        <span class="text-xs text-gray-400">— Você rejeitou estas sugestões do sistema</span>
                                        <i class="fas fa-chevron-down toggle-icon text-gray-400 ml-auto"></i>
                                    </div>
                                    <div id="secao-excluidos" class="ml-6 hidden">
                                        ${modulosExcluidos.map(m => renderModulo(m, 'border-red-200 bg-red-50', 'text-red-800', 'bg-red-200 text-red-800')).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Ordem das Categorias -->
                        ${metadata.categorias_ordem && metadata.categorias_ordem.length > 0 ? `
                            <div class="mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-sort-amount-down text-purple-500"></i>
                                    <span class="text-sm font-semibold text-gray-700">Ordem das Seções na Peça</span>
                                </div>
                                <div class="flex flex-wrap gap-2 ml-6">
                                    ${metadata.categorias_ordem.map((cat, i) => `
                                        <span class="bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-2">
                                            <span class="bg-purple-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                            ${escapeHtml(cat)}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Glossário de Termos -->
                        <div class="mt-6 bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                            <div class="p-3 cursor-pointer flex items-center justify-between hover:bg-gray-100"
                                 onclick="document.getElementById('glossario-termos').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-down'); this.querySelector('.toggle-icon').classList.toggle('fa-chevron-up');">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-book text-gray-500"></i>
                                    <span class="font-semibold text-gray-700 text-sm">Glossário de Termos</span>
                                </div>
                                <i class="fas fa-chevron-down toggle-icon text-gray-400"></i>
                            </div>
                            <div id="glossario-termos" class="hidden border-t border-gray-200 p-4 bg-white">
                                <dl class="space-y-2 text-sm">
                                    ${Object.entries(glossario).map(([termo, descricao]) => `
                                        <div class="flex gap-2">
                                            <dt class="font-mono bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-700 whitespace-nowrap">${escapeHtml(termo)}</dt>
                                            <dd class="text-gray-600 text-xs">${escapeHtml(descricao)}</dd>
                                        </div>
                                    `).join('')}
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
                        <p class="text-xs text-gray-500">
                            <i class="fas fa-shield-alt mr-1"></i>
                            Total: <strong>${modulosIncluidos.length}</strong> incluído(s), <strong>${modulosExcluidos.length}</strong> excluído(s)
                        </p>
                        <button onclick="document.getElementById('modal-curadoria-detalhes').remove()" class="px-5 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors">
                            Fechar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function verDetalhes(id) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar detalhes');

                const geracao = await response.json();
                geracaoAtual = geracao;

                document.getElementById('texto-prompt').textContent = geracao.prompt_enviado || 'Prompt não disponível';
                document.getElementById('texto-resumo').textContent = geracao.resumo_consolidado || 'Resumo não disponível';

                // Detecta se é markdown (string) ou JSON (object)
                const conteudo = geracao.conteudo_gerado;
                const isMarkdown = typeof conteudo === 'string';

                if (isMarkdown && conteudo) {
                    // SECURITY: Renderiza markdown com sanitização
                    document.getElementById('texto-markdown').innerHTML = safeMarkedParse(conteudo);
                    document.getElementById('texto-resultado').textContent = conteudo;
                    // Mostra botão de download DOCX
                    document.getElementById('btn-download-docx').classList.remove('hidden');
                } else if (conteudo) {
                    // JSON antigo
                    document.getElementById('texto-markdown').innerHTML = '<p class="text-gray-500">Esta geração usa formato JSON antigo. Veja a aba "Resultado (Raw)".</p>';
                    document.getElementById('texto-resultado').textContent = JSON.stringify(conteudo, null, 2);
                    document.getElementById('btn-download-docx').classList.add('hidden');
                } else {
                    document.getElementById('texto-markdown').innerHTML = '<p class="text-gray-500">Conteúdo não disponível</p>';
                    document.getElementById('texto-resultado').textContent = 'Resultado não disponível';
                    document.getElementById('btn-download-docx').classList.add('hidden');
                }

                // Renderiza histórico de chat
                renderizarHistoricoChat(geracao.historico_chat || []);

                // SECURITY: Sanitiza dados de usuário
                document.getElementById('info-geracao').innerHTML = `
                    <strong>${escapeHtml(geracao.numero_cnj_formatado || geracao.numero_cnj)}</strong> |
                    ${escapeHtml(formatarTipoPeca(geracao.tipo_peca))} |
                    ${escapeHtml(formatarDataHora(geracao.criado_em))}
                    ${geracao.tempo_processamento ? ` | <span class="text-emerald-600"><i class="fas fa-stopwatch"></i> ${escapeHtml(formatarTempo(geracao.tempo_processamento))}</span>` : ''}
                    ${isMarkdown ? ' | <span class="text-green-600">Markdown</span>' : ' | <span class="text-amber-600">JSON</span>'}
                    ${geracao.historico_chat && geracao.historico_chat.length > 0 ? ` | <span class="text-purple-600"><i class="fas fa-comments"></i> ${parseInt(geracao.historico_chat.length) || 0} edições</span>` : ''}
                `;

                // Carrega versões
                carregarVersoes(id);

                // Mostra a tab de markdown por padrão se for markdown
                mostrarTab(isMarkdown ? 'markdown' : 'prompt');
                document.getElementById('modal-detalhes').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('Erro ao carregar detalhes');
            }
        }

        async function baixarDocx() {
            if (!geracaoAtual || !geracaoAtual.conteudo_gerado) {
                alert('Conteúdo não disponível para download');
                return;
            }

            const btn = document.getElementById('btn-download-docx');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
            btn.disabled = true;

            try {
                // Chama endpoint de conversão para DOCX
                const response = await fetch('/gerador-pecas/api/exportar-docx', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        markdown: geracaoAtual.conteudo_gerado,
                        tipo_peca: geracaoAtual.tipo_peca || 'peca',
                        numero_processo: geracaoAtual.numero_cnj
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Erro ao gerar DOCX');
                }

                const data = await response.json();

                // Faz download do arquivo
                const downloadUrl = data.url_download + `?token=${encodeURIComponent(getToken())}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = '';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('Erro ao baixar DOCX:', error);
                alert('Erro ao gerar DOCX: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function mostrarTab(tab) {
            // Remove active de todas as tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('border-primary-600', 'text-primary-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Esconde todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Ativa a tab selecionada
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${tab}`).classList.add('border-primary-600', 'text-primary-600');
            document.getElementById(`conteudo-${tab}`).classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        function formatarTipoPeca(tipo) {
            const labels = {
                'contestacao': 'Contestação',
                'recurso_apelacao': 'Recurso de Apelação',
                'contrarrazoes': 'Contrarrazões',
                'parecer': 'Parecer Jurídico'
            };
            // Trata null, undefined, "null" (string), e strings vazias
            if (!tipo || tipo === 'null' || tipo === 'undefined') {
                return 'Não informado';
            }
            return labels[tipo] || tipo;
        }

        function renderizarHistoricoChat(historico) {
            const container = document.getElementById('chat-container');

            if (!historico || historico.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-comments text-4xl mb-4"></i>
                        <p>Nenhuma edição via chat foi realizada</p>
                        <p class="text-sm mt-2">O usuário não solicitou alterações após a geração inicial</p>
                    </div>`;
                return;
            }

            let html = `
                <div class="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                    <p class="text-purple-800 font-medium"><i class="fas fa-info-circle mr-2"></i>Histórico de Edições</p>
                    <p class="text-purple-600 text-sm mt-1">O usuário solicitou ${historico.length} alteração(ões) via chat após a geração inicial.</p>
                </div>
            `;

            historico.forEach((msg, index) => {
                const isUser = msg.role === 'user';
                const bgClass = isUser ? 'bg-blue-50 border-blue-200' : 'bg-green-50 border-green-200';
                const iconClass = isUser ? 'fa-user text-blue-600' : 'fa-robot text-green-600';
                const labelClass = isUser ? 'text-blue-700' : 'text-green-700';
                const label = isUser ? 'Usuário' : 'Assistente IA';

                html += `
                    <div class="rounded-lg border p-4 ${bgClass}">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas ${iconClass}"></i>
                            <span class="font-medium ${labelClass}">${label}</span>
                            <span class="text-xs text-gray-400 ml-auto">#${index + 1}</span>
                        </div>
                        <div class="text-gray-700 text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function carregarVersoes(geracaoId) {
            const container = document.getElementById('versoes-container');
            const badge = document.getElementById('versoes-badge');

            try {
                const response = await fetch(`${API_BASE}/geracoes/${geracaoId}/versoes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar versões');

                const data = await response.json();

                // Atualiza badge
                if (data.total_versoes > 0) {
                    badge.textContent = data.total_versoes;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                renderizarVersoes(data.versoes);
            } catch (error) {
                console.error('Erro ao carregar versões:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar versões</p>
                    </div>`;
            }
        }

        function renderizarVersoes(versoes) {
            const container = document.getElementById('versoes-container');

            if (!versoes || versoes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-history text-4xl mb-4"></i>
                        <p>Nenhuma versão salva</p>
                        <p class="text-sm mt-2">As versões são criadas quando o usuário edita a peça via chat</p>
                    </div>`;
                return;
            }

            let html = `
                <div class="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                    <p class="text-purple-800 font-medium"><i class="fas fa-info-circle mr-2"></i>Histórico de Versões</p>
                    <p class="text-purple-600 text-sm mt-1">Esta geração possui ${versoes.length} versão(ões) salva(s).</p>
                </div>
            `;

            versoes.forEach((versao, index) => {
                const tipoLabel = {
                    'geracao_inicial': 'Versão Inicial',
                    'edicao_chat': 'Edição via Chat',
                    'edicao_manual': 'Edição Manual',
                    'restauracao': 'Restauração'
                }[versao.tipo_alteracao] || versao.tipo_alteracao;

                const tipoClass = {
                    'geracao_inicial': 'bg-green-100 text-green-700',
                    'edicao_chat': 'bg-blue-100 text-blue-700',
                    'edicao_manual': 'bg-amber-100 text-amber-700',
                    'restauracao': 'bg-purple-100 text-purple-700'
                }[versao.tipo_alteracao] || 'bg-gray-100 text-gray-700';

                const dataFormatada = versao.criado_em
                    ? formatarDataHora(versao.criado_em)
                    : 'Data não disponível';

                html += `
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
                            <div class="flex items-center gap-3">
                                <span class="text-lg font-semibold text-gray-700">v${versao.numero_versao}</span>
                                <span class="px-2 py-1 text-xs rounded-full ${tipoClass}">${tipoLabel}</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${dataFormatada}
                            </div>
                        </div>
                        ${versao.descricao ? `
                            <div class="px-4 py-2 bg-blue-50 border-b border-blue-100">
                                <p class="text-sm text-blue-700"><i class="fas fa-comment mr-1"></i>${escapeHtml(versao.descricao)}</p>
                            </div>
                        ` : ''}
                        <div class="p-4">
                            <button onclick="verConteudoVersao(${versao.id}, ${versao.numero_versao})"
                                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 text-sm">
                                <i class="fas fa-eye mr-1"></i>Ver Conteúdo
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        let versaoModalAberta = null;

        async function verConteudoVersao(versaoId, numeroVersao) {
            try {
                const response = await fetch(`${API_BASE}/geracoes/${geracaoAtual.id}/versoes/${versaoId}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar versão');

                const versao = await response.json();

                // Abre um modal secundário ou substitui o conteúdo
                const conteudo = versao.conteudo_markdown || 'Conteúdo não disponível';

                // SECURITY: Mostra na tab de markdown com sanitização
                document.getElementById('texto-markdown').innerHTML = `
                    <div class="mb-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-purple-800 font-medium">Visualizando: Versão ${escapeHtml(String(numeroVersao))}</p>
                        <button onclick="voltarParaVersaoAtual()" class="mt-2 px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                            <i class="fas fa-arrow-left mr-1"></i>Voltar para versão atual
                        </button>
                    </div>
                ` + safeMarkedParse(conteudo);

                mostrarTab('markdown');
                versaoModalAberta = versaoId;

            } catch (error) {
                console.error('Erro ao ver versão:', error);
                alert('Erro ao carregar conteúdo da versão');
            }
        }

        function voltarParaVersaoAtual() {
            if (geracaoAtual && geracaoAtual.conteudo_gerado) {
                // SECURITY: Usa sanitização
                document.getElementById('texto-markdown').innerHTML = safeMarkedParse(geracaoAtual.conteudo_gerado);
            }
            versaoModalAberta = null;
        }
    </script>
</body>
</html>
