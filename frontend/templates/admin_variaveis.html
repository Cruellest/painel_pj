<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Variaveis - Portal PGE-MS</title>
    <!-- VERSAO: 2026-01-19-v2 - campos uso JSON e uso Prompts separados -->
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Animacoes para categorias colapsiveis */
        .categoria-icon {
            transition: transform 0.2s ease-in-out;
        }
        .categoria-conteudo {
            transition: all 0.2s ease-in-out;
        }
        .categoria-grupo:hover > div:first-child {
            filter: brightness(0.97);
        }
        /* Tooltip para slug completo */
        .slug-display {
            position: relative;
        }
        .slug-display:hover .slug-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .slug-tooltip {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #1f2937;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            z-index: 10;
            margin-bottom: 4px;
        }
        .slug-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 12px;
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10 w-auto">
                    </a>
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="font-semibold text-gray-800">Painel de Variaveis</h1>
                        <p class="text-xs text-gray-500">Variaveis de extracao do sistema</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <a href="/admin/categorias-resumo-json" class="text-gray-500 hover:text-gray-700 transition-colors text-sm">
                        <i class="fas fa-file-code mr-1"></i> Categorias JSON
                    </a>
                    <a href="/admin/prompts-modulos" class="text-gray-500 hover:text-gray-700 transition-colors text-sm">
                        <i class="fas fa-puzzle-piece mr-1"></i> Prompts Modulares
                    </a>
                    <button onclick="abrirGlossario()" class="flex items-center gap-1 px-2 py-1 text-sm text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Glossário de Conceitos">
                        <i class="fas fa-book"></i>
                        <span class="hidden sm:inline">Glossário</span>
                    </button>
                    <button onclick="abrirModalAjuda()" class="text-gray-500 hover:text-blue-600 transition-colors" title="Ajuda Rápida">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-hashtag text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total de Variaveis</p>
                        <p id="total-variaveis" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-link text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Em Uso</p>
                        <p id="variaveis-em-uso" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-unlink text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Sem Uso</p>
                        <p id="variaveis-sem-uso" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-layer-group text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tipos</p>
                        <p id="total-tipos" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input
                            type="text"
                            id="busca-variavel"
                            placeholder="Buscar por slug (com ou sem prefixo) ou label..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                    </div>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="filtro-tipo" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">Todos os tipos</option>
                        <option value="text">Texto</option>
                        <option value="number">Numero</option>
                        <option value="date">Data</option>
                        <option value="boolean">Sim/Nao</option>
                        <option value="choice">Escolha Unica</option>
                        <option value="list">Lista</option>
                        <option value="currency">Valor Monetario</option>
                    </select>
                    <select id="filtro-categoria" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">Todas as categorias</option>
                    </select>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" id="mostrar-inativas" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <span class="text-sm text-gray-600">Mostrar inativas</span>
                    </label>
                    <button
                        onclick="criarVariavel()"
                        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2"
                    >
                        <i class="fas fa-plus"></i>
                        Nova Variavel
                    </button>
                </div>
            </div>
            <!-- Controles de Expandir/Recolher -->
            <div id="controles-grupos" class="mt-3 pt-3 border-t border-gray-100 flex items-center justify-between hidden">
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <i class="fas fa-layer-group"></i>
                    <span id="info-grupos">Agrupado por categoria</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="expandirTodosGrupos()" class="px-2 py-1 text-xs text-gray-600 hover:bg-gray-100 rounded transition-colors">
                        <i class="fas fa-expand-alt mr-1"></i> Expandir todas
                    </button>
                    <button onclick="recolherTodosGrupos()" class="px-2 py-1 text-xs text-gray-600 hover:bg-gray-100 rounded transition-colors">
                        <i class="fas fa-compress-alt mr-1"></i> Recolher todas
                    </button>
                </div>
            </div>
        </div>

        <!-- Container de Variaveis (agrupado por categoria) -->
        <div id="variaveis-container" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <style>
                .variaveis-table td { white-space: nowrap; vertical-align: middle; }
                .variaveis-table .col-slug { min-width: 180px; max-width: 280px; }
                .variaveis-table .col-label { min-width: 150px; max-width: 250px; }
                .variaveis-table .col-slug .slug-text,
                .variaveis-table .col-label .label-text {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    display: block;
                }
            </style>
            <!-- Conteudo sera renderizado via JS -->
            <div id="variaveis-content" class="divide-y divide-gray-100">
                <div class="px-4 py-8 text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Carregando variaveis...</p>
                </div>
            </div>
        </div>

        <!-- Paginacao -->
        <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-gray-500">
                Mostrando <span id="pag-inicio">0</span> - <span id="pag-fim">0</span> de <span id="pag-total">0</span> variaveis
            </div>
            <div class="flex gap-2">
                <button
                    id="btn-anterior"
                    onclick="paginaAnterior()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button
                    id="btn-proxima"
                    onclick="proximaPagina()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

    </main>

    <!-- Modal de Detalhes da Variavel -->
    <div id="modal-detalhe" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
                <h2 id="modal-detalhe-titulo" class="text-lg font-semibold text-gray-800">Detalhes da Variavel</h2>
                <button onclick="fecharModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Slug</label>
                        <p id="detalhe-slug" class="text-gray-800 font-mono bg-gray-50 px-2 py-1 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Tipo</label>
                        <p id="detalhe-tipo" class="text-gray-800">-</p>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Label</label>
                        <p id="detalhe-label" class="text-gray-800">-</p>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Descricao</label>
                        <p id="detalhe-descricao" class="text-gray-800">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Categoria</label>
                        <p id="detalhe-categoria" class="text-gray-800">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Criado em</label>
                        <p id="detalhe-criado-em" class="text-gray-800">-</p>
                    </div>
                    <div id="detalhe-opcoes-container" class="col-span-2 hidden">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Opcoes</label>
                        <div id="detalhe-opcoes" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Prompts que usam esta variavel -->
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="font-medium text-gray-800 mb-3">
                        <i class="fas fa-puzzle-piece text-indigo-500 mr-2"></i>
                        Prompts que usam esta variavel
                    </h3>
                    <div id="detalhe-prompts" class="space-y-2">
                        <p class="text-gray-400 text-sm">Nenhum prompt usa esta variavel.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div id="modal-ajuda" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                    Conceitos do Sistema de Variaveis
                </h2>
                <button onclick="fecharModalAjuda()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <!-- Variaveis -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-hashtag text-blue-500 mr-2"></i>Variaveis
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Variaveis sao dados extraidos automaticamente dos documentos do processo pela IA.
                        Cada variavel tem um <strong>slug</strong> (identificador tecnico unico) e pode ser
                        usada em regras deterministicas para ativar prompts.
                    </p>
                    <div class="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                        <strong>Exemplo:</strong> <code class="bg-gray-200 px-1 rounded">peticao_tipo_acao</code> = tipo de acao extraido da peticao
                    </div>
                </div>

                <!-- Grupos -->
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-layer-group text-purple-500 mr-2"></i>Grupos (Categorias)
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Grupos organizam documentos por codigo do TJ-MS (ex: 500, 510, 9500).
                        Cada variavel pertence a um grupo e e extraida dos documentos desse grupo.
                        O grupo define o <strong>namespace</strong> das variaveis (ex: <code class="bg-gray-200 px-1 rounded">peticao_</code>).
                    </p>
                </div>

                <!-- Fonte de Verdade -->
                <div class="border-l-4 border-indigo-500 pl-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-crosshairs text-indigo-500 mr-2"></i>Fonte de Verdade
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Define <strong>qual documento especifico</strong> deve ser usado para extrair uma variavel.
                        E util quando um grupo tem varios tipos de documentos (ex: peticao inicial vs contestacao).
                    </p>
                    <div class="mt-3 grid grid-cols-2 gap-3">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h4 class="text-xs font-semibold text-gray-700 mb-1">Codigo Especifico</h4>
                            <p class="text-xs text-gray-500">
                                Filtra por codigo do documento (ex: <code class="bg-gray-200 px-1 rounded">9500</code>).
                                Rapido mas limitado quando varios tipos usam o mesmo codigo.
                            </p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h4 class="text-xs font-semibold text-gray-700 mb-1">Tipo Logico (LLM)</h4>
                            <p class="text-xs text-gray-500">
                                A IA classifica semanticamente qual e o tipo de documento
                                (ex: "peticao inicial", "parecer NAT"). Ideal quando codigos sao ambiguos.
                            </p>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-amber-600 bg-amber-50 p-2 rounded">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Fonte de Verdade e OPCIONAL.</strong> Se nao definida, extrai de qualquer documento do grupo.
                    </div>
                </div>

                <!-- Hierarquia de Override -->
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-sitemap text-green-500 mr-2"></i>Hierarquia de Override
                    </h3>
                    <p class="text-gray-600 text-sm mb-3">
                        A fonte de verdade pode ser definida em tres niveis, onde cada nivel sobrescreve o anterior:
                    </p>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                            1. Grupo
                        </span>
                        <i class="fas fa-arrow-right text-gray-300"></i>
                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                            2. Pergunta
                        </span>
                        <i class="fas fa-arrow-right text-gray-300"></i>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                            3. Variavel
                        </span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Ao definir fonte de verdade aqui na variavel, voce sobrescreve a configuracao do grupo e da pergunta de origem.
                    </p>
                </div>

                <!-- Uso em Prompts -->
                <div class="border-l-4 border-yellow-500 pl-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-puzzle-piece text-yellow-500 mr-2"></i>Uso em Prompts
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Variaveis podem ser usadas em <strong>regras deterministicas</strong> para ativar prompts.
                        A coluna "Uso" indica se a variavel esta sendo usada em algum prompt.
                        Variaveis em uso nao podem ser desativadas.
                    </p>
                </div>

                <!-- Dependencias -->
                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-link text-orange-500 mr-2"></i>Dependencias Condicionais
                    </h3>
                    <p class="text-gray-600 text-sm">
                        Variaveis podem depender de outras. O icone <i class="fas fa-caret-right text-gray-400"></i>
                        indica que uma variavel depende de outra (ex: so extrair <code class="bg-gray-200 px-1 rounded">valor_causa</code>
                        se <code class="bg-gray-200 px-1 rounded">tem_valor_causa</code> = Sim).
                    </p>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center">
                <button onclick="fecharModalAjuda(); abrirGlossario();" class="text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                    <i class="fas fa-book mr-1"></i> Ver Glossário Completo
                </button>
                <button onclick="fecharModalAjuda()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    Entendi
                </button>
            </div>
        </div>
    </div>

    <!-- Modal do Glossário de Conceitos -->
    <div id="modal-glossario" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden m-4 h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-indigo-50 to-purple-50">
                <div class="flex items-center gap-3">
                    <i class="fas fa-book text-indigo-600 text-xl"></i>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">Glossário de Conceitos</h2>
                        <p class="text-xs text-gray-500">Documentação completa do sistema</p>
                    </div>
                </div>
                <button onclick="fecharGlossario()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Busca e Navegação -->
            <div class="px-6 py-3 border-b border-gray-100 bg-gray-50">
                <div class="flex items-center gap-4">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input
                            type="text"
                            id="glossario-busca"
                            placeholder="Buscar no glossário..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            onkeyup="buscarNoGlossario(this.value)"
                        >
                    </div>
                    <div class="flex gap-2 text-xs">
                        <button onclick="irParaSecao('documentos-e-extração')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">Documentos</button>
                        <button onclick="irParaSecao('prompts-e-ativação')" class="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors">Prompts</button>
                        <button onclick="irParaSecao('termos-ambíguos---como-diferenciar')" class="px-2 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200 transition-colors">Ambiguidades</button>
                    </div>
                </div>
            </div>

            <!-- Conteúdo -->
            <div id="glossario-conteudo" class="flex-1 overflow-y-auto p-6 prose prose-sm max-w-none">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>Carregando glossário...</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-3 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-xs text-gray-500">
                <span><i class="fas fa-info-circle mr-1"></i> Use Ctrl+F para buscar no documento</span>
                <button onclick="fecharGlossario()" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- CSS para renderização do Markdown -->
    <style>
        #glossario-conteudo h1 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        #glossario-conteudo h2 { font-size: 1.25rem; font-weight: 600; color: #374151; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        #glossario-conteudo h3 { font-size: 1rem; font-weight: 600; color: #4b5563; margin-top: 1rem; margin-bottom: 0.5rem; }
        #glossario-conteudo h4 { font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-top: 0.75rem; margin-bottom: 0.25rem; }
        #glossario-conteudo p { margin-bottom: 0.75rem; color: #4b5563; line-height: 1.6; }
        #glossario-conteudo code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875em; color: #7c3aed; }
        #glossario-conteudo pre { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1rem 0; }
        #glossario-conteudo pre code { background: transparent; color: inherit; padding: 0; }
        #glossario-conteudo table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.875rem; }
        #glossario-conteudo th { background: #f9fafb; padding: 0.5rem; text-align: left; font-weight: 600; border: 1px solid #e5e7eb; }
        #glossario-conteudo td { padding: 0.5rem; border: 1px solid #e5e7eb; }
        #glossario-conteudo ul, #glossario-conteudo ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        #glossario-conteudo li { margin-bottom: 0.25rem; color: #4b5563; }
        #glossario-conteudo hr { border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }
        #glossario-conteudo strong { color: #1f2937; }
        #glossario-conteudo blockquote { border-left: 4px solid #6366f1; padding-left: 1rem; margin: 1rem 0; color: #6b7280; font-style: italic; }
        #glossario-conteudo .highlight { background: #fef08a; padding: 0.125rem 0.25rem; border-radius: 0.125rem; }
    </style>

    <!-- Modal de Criar/Editar Variavel -->
    <div id="modal-variavel" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-primary-50 to-blue-50">
                <h2 id="modal-variavel-titulo" class="text-lg font-semibold text-gray-800">Nova Variavel</h2>
                <button onclick="fecharModalVariavel()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="form-variavel" class="p-6 space-y-4 overflow-y-auto flex-1">
                <input type="hidden" id="variavel-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Slug *</label>
                    <input
                        type="text"
                        id="variavel-slug"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="nome_da_variavel"
                        required
                    >
                    <p class="text-xs text-gray-400 mt-1">Identificador unico em snake_case</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label *</label>
                    <input
                        type="text"
                        id="variavel-label"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Nome de exibicao"
                        required
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                    <select
                        id="variavel-tipo"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        required
                    >
                        <option value="text">Texto</option>
                        <option value="number">Numero</option>
                        <option value="date">Data</option>
                        <option value="boolean">Sim/Nao</option>
                        <option value="choice">Escolha Unica</option>
                        <option value="list">Lista</option>
                        <option value="currency">Valor Monetario</option>
                    </select>
                </div>

                <div id="opcoes-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Opcoes</label>
                    <textarea
                        id="variavel-opcoes"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Uma opcao por linha"
                        rows="3"
                    ></textarea>
                    <p class="text-xs text-gray-400 mt-1">Uma opcao por linha</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descricao</label>
                    <textarea
                        id="variavel-descricao"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Descricao opcional"
                        rows="2"
                    ></textarea>
                </div>

                <!-- Fonte de Verdade (opcional) -->
                <div class="pt-3 border-t border-gray-200">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-crosshairs text-indigo-500 text-sm"></i>
                        <span class="text-sm font-medium text-gray-700">Fonte de Verdade</span>
                        <span class="text-xs text-gray-400">(opcional - override do grupo)</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Código específico</label>
                            <input type="text" id="variavel-fonte-codigo"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                placeholder="ex: 9500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Tipo lógico (LLM)</label>
                            <input type="text" id="variavel-fonte-tipo"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                placeholder="ex: petição inicial">
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Se vazio, usa configuração do grupo</p>
                </div>
            </form>

            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button
                    type="button"
                    onclick="fecharModalVariavel()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                >
                    Cancelar
                </button>
                <button
                    type="button"
                    onclick="salvarVariavel()"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                >
                    <i class="fas fa-save mr-1"></i>
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let variaveis = [];
        let categorias = [];
        let paginaAtual = 0;
        const itensPorPagina = 200;
        let totalVariaveis = 0;

        // Funcao auxiliar para obter o token
        function getToken() {
            return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        }

        // Verificar autenticacao
        async function verificarAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // Carregar resumo
        async function carregarResumo() {
            try {
                const response = await fetch('/admin/api/extraction/variaveis/resumo', {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar resumo');
                const data = await response.json();

                document.getElementById('total-variaveis').textContent = data.total || 0;
                document.getElementById('variaveis-em-uso').textContent = data.variaveis_com_uso || 0;
                document.getElementById('variaveis-sem-uso').textContent = data.variaveis_sem_uso || 0;
                document.getElementById('total-tipos').textContent = Object.keys(data.distribuicao_tipos || {}).length;
            } catch (error) {
                console.error('Erro ao carregar resumo:', error);
            }
        }

        // Carregar categorias para filtro e modal
        async function carregarCategorias() {
            try {
                const mostrarInativas = document.getElementById('mostrar-inativas').checked;
                // Busca apenas categorias que possuem variáveis; inclui inativas se checkbox marcado
                let url = '/admin/api/categorias-resumo-json?apenas_com_variaveis=true';
                if (mostrarInativas) {
                    url += '&apenas_ativos=false';
                }
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) return;
                categorias = await response.json();

                // Popular select de filtro (ordena por nome)
                const selectFiltro = document.getElementById('filtro-categoria');
                const valorAtual = selectFiltro.value; // Preserva seleção atual
                selectFiltro.innerHTML = '<option value="">Todas as categorias</option>';
                categorias
                    .sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'))
                    .forEach(cat => {
                        selectFiltro.innerHTML += `<option value="${cat.id}">${cat.nome}</option>`;
                    });
                // Restaura seleção se ainda existir
                if (valorAtual && [...selectFiltro.options].some(o => o.value === valorAtual)) {
                    selectFiltro.value = valorAtual;
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carregar variaveis
        async function carregarVariaveis() {
            try {
                const busca = document.getElementById('busca-variavel').value;
                const tipo = document.getElementById('filtro-tipo').value;
                const categoriaId = document.getElementById('filtro-categoria').value;
                const mostrarInativas = document.getElementById('mostrar-inativas').checked;

                let url = `/admin/api/extraction/variaveis?limit=${itensPorPagina}&offset=${paginaAtual * itensPorPagina}`;
                if (busca) url += `&busca=${encodeURIComponent(busca)}`;
                if (tipo) url += `&tipo=${tipo}`;
                if (categoriaId) url += `&categoria_id=${categoriaId}`;
                if (mostrarInativas) url += `&apenas_ativos=false`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar variaveis');
                variaveis = await response.json();

                renderizarTabela();
                atualizarPaginacao();
            } catch (error) {
                console.error('Erro ao carregar variaveis:', error);
                document.getElementById('variaveis-content').innerHTML = `
                    <div class="px-6 py-12 text-center text-red-400">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Erro ao carregar variaveis</p>
                    </div>
                `;
            }
        }

        // ==========================================
        // Agrupamento por Categoria
        // ==========================================

        // Chave para persistencia do estado de colapso no localStorage
        const STORAGE_KEY_GRUPOS = 'variaveis_grupos_expandidos';

        // Carrega estado de colapso do localStorage
        function carregarEstadoGrupos() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY_GRUPOS);
                return saved ? JSON.parse(saved) : {};
            } catch {
                return {};
            }
        }

        // Salva estado de colapso no localStorage
        function salvarEstadoGrupos(estado) {
            try {
                localStorage.setItem(STORAGE_KEY_GRUPOS, JSON.stringify(estado));
            } catch {
                // Ignora erros de localStorage
            }
        }

        // Remove o prefixo da categoria do slug para exibicao
        function removerPrefixoSlug(slug, categoriaNome) {
            if (!slug || !categoriaNome) return slug;

            // Normaliza o nome da categoria para o formato do prefixo (snake_case)
            const prefixoEsperado = categoriaNome.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-z0-9]+/g, '_') // Substitui nao-alfanumericos por _
                .replace(/^_+|_+$/g, '') // Remove _ do inicio/fim
                + '_';

            // Verifica se o slug comeca com o prefixo
            if (slug.toLowerCase().startsWith(prefixoEsperado)) {
                return slug.substring(prefixoEsperado.length);
            }

            // Fallback: tenta com o nome direto
            const prefixoSimples = categoriaNome.toLowerCase().replace(/\s+/g, '_') + '_';
            if (slug.toLowerCase().startsWith(prefixoSimples)) {
                return slug.substring(prefixoSimples.length);
            }

            return slug; // Retorna slug completo se nao bater
        }

        // Copia o slug completo para a area de transferencia
        function copiarSlug(slug) {
            navigator.clipboard.writeText(slug).then(() => {
                // Feedback visual opcional
                const tooltip = event.target.closest('.slug-display')?.querySelector('.slug-tooltip');
                if (tooltip) {
                    const textoOriginal = tooltip.textContent;
                    tooltip.textContent = 'Copiado!';
                    setTimeout(() => { tooltip.textContent = textoOriginal; }, 1000);
                }
            }).catch(err => {
                console.error('Erro ao copiar:', err);
            });
        }

        // Cores para categorias
        const coresCategoria = [
            'blue', 'purple', 'teal', 'pink', 'cyan', 'amber', 'lime', 'rose', 'indigo', 'emerald'
        ];

        // Renderiza variaveis agrupadas por categoria
        function renderizarTabela() {
            const container = document.getElementById('variaveis-content');
            const busca = document.getElementById('busca-variavel').value.toLowerCase().trim();
            const filtroCategoria = document.getElementById('filtro-categoria').value;

            if (variaveis.length === 0) {
                container.innerHTML = `
                    <div class="px-6 py-12 text-center text-gray-400">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Nenhuma variavel encontrada</p>
                    </div>
                `;
                document.getElementById('controles-grupos').classList.add('hidden');
                return;
            }

            // Agrupa variaveis por categoria
            const grupos = {};
            const semCategoria = [];

            variaveis.forEach(v => {
                const catNome = v.categoria_nome || '';
                if (catNome) {
                    if (!grupos[catNome]) {
                        grupos[catNome] = {
                            nome: catNome,
                            id: v.categoria_id,
                            variaveis: [],
                            emUso: 0,
                            semUso: 0
                        };
                    }
                    grupos[catNome].variaveis.push(v);
                    const temUso = v.em_uso_json || (v.uso_count_prompts || v.uso_count || 0) > 0;
                    if (temUso) {
                        grupos[catNome].emUso++;
                    } else {
                        grupos[catNome].semUso++;
                    }
                } else {
                    semCategoria.push(v);
                }
            });

            // Se tem filtro de categoria especifico, nao agrupa
            if (filtroCategoria) {
                container.innerHTML = renderizarTabelaSimples(variaveis, true);
                document.getElementById('controles-grupos').classList.add('hidden');
                return;
            }

            // Ordena categorias alfabeticamente
            const categoriasOrdenadas = Object.keys(grupos).sort((a, b) =>
                a.localeCompare(b, 'pt-BR')
            );

            // Se so tem variaveis sem categoria, renderiza tabela simples
            if (categoriasOrdenadas.length === 0) {
                container.innerHTML = renderizarTabelaSimples(variaveis, false);
                document.getElementById('controles-grupos').classList.add('hidden');
                return;
            }

            // Carrega estado de colapso salvo
            const estadoGrupos = carregarEstadoGrupos();

            // Se ha busca ativa, todos os grupos com match devem estar expandidos
            const temBusca = busca.length > 0;

            let html = '';

            categoriasOrdenadas.forEach((catNome, idx) => {
                const grupo = grupos[catNome];
                const cor = coresCategoria[idx % coresCategoria.length];
                const catId = `cat-${catNome.replace(/[^a-zA-Z0-9]/g, '_')}`;

                // Determina se o grupo deve estar expandido
                let expandido = estadoGrupos[catId] === true; // Padrao: colapsado
                if (temBusca) {
                    // Com busca ativa, expande automaticamente
                    expandido = true;
                }

                html += `
                    <div class="categoria-grupo" data-categoria="${catNome}">
                        <div class="px-4 py-3 bg-${cor}-50 border-b border-${cor}-100 cursor-pointer hover:bg-${cor}-100 transition-colors flex items-center justify-between"
                             onclick="toggleGrupo('${catId}')">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-chevron-down text-${cor}-500 transition-transform categoria-icon"
                                   id="icon-${catId}"
                                   style="transform: rotate(${expandido ? '0' : '-90'}deg)"></i>
                                <span class="font-medium text-${cor}-800">${catNome}</span>
                                <span class="px-2 py-0.5 text-xs bg-${cor}-200 text-${cor}-800 rounded-full">
                                    ${grupo.variaveis.length} ${grupo.variaveis.length === 1 ? 'variavel' : 'variaveis'}
                                </span>
                            </div>
                            <div class="flex items-center gap-3 text-xs">
                                <span class="flex items-center gap-1 text-green-600" title="Em uso">
                                    <i class="fas fa-check-circle"></i> ${grupo.emUso}
                                </span>
                                <span class="flex items-center gap-1 text-gray-400" title="Sem uso">
                                    <i class="fas fa-times-circle"></i> ${grupo.semUso}
                                </span>
                            </div>
                        </div>
                        <div class="categoria-conteudo" id="${catId}" style="display: ${expandido ? 'block' : 'none'}">
                            ${renderizarTabelaSimples(grupo.variaveis, true)}
                        </div>
                    </div>
                `;
            });

            // Adiciona variaveis sem categoria no final
            if (semCategoria.length > 0) {
                const catId = 'cat-sem-categoria';
                const expandido = estadoGrupos[catId] === true;

                html += `
                    <div class="categoria-grupo" data-categoria="">
                        <div class="px-4 py-3 bg-gray-100 border-b border-gray-200 cursor-pointer hover:bg-gray-200 transition-colors flex items-center justify-between"
                             onclick="toggleGrupo('${catId}')">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-chevron-down text-gray-500 transition-transform categoria-icon"
                                   id="icon-${catId}"
                                   style="transform: rotate(${expandido ? '0' : '-90'}deg)"></i>
                                <span class="font-medium text-gray-700">Sem categoria</span>
                                <span class="px-2 py-0.5 text-xs bg-gray-200 text-gray-700 rounded-full">
                                    ${semCategoria.length} ${semCategoria.length === 1 ? 'variavel' : 'variaveis'}
                                </span>
                            </div>
                        </div>
                        <div class="categoria-conteudo" id="${catId}" style="display: ${expandido ? 'block' : 'none'}">
                            ${renderizarTabelaSimples(semCategoria, false)}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Mostra controles de expandir/recolher
            const numGrupos = categoriasOrdenadas.length + (semCategoria.length > 0 ? 1 : 0);
            document.getElementById('info-grupos').textContent = `${numGrupos} ${numGrupos === 1 ? 'categoria' : 'categorias'}`;
            document.getElementById('controles-grupos').classList.remove('hidden');
        }

        // Renderiza tabela simples (dentro de um grupo ou quando nao ha agrupamento)
        function renderizarTabelaSimples(vars, ocultarCategoria) {
            if (vars.length === 0) return '';

            let html = `
                <table class="w-full variaveis-table">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-slug">Slug</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-label">Label</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            ${!ocultarCategoria ? '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>' : ''}
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Uso</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acoes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            vars.forEach(v => {
                // Recuo horizontal por nivel de dependencia
                const indentPx = v.depth > 0 ? (v.depth * 16) : 0;

                // Indicador de dependencia
                const depIcon = v.depth > 0
                    ? `<i class="fas fa-caret-right text-gray-300 text-xs" title="Depende de: ${v.depends_on_variable || 'pai'}"></i>`
                    : '';

                // Indicadores de uso separados: JSON e Prompts
                const emUsoJson = v.em_uso_json === true;
                const emUsoPrompts = (v.uso_count_prompts || v.uso_count || 0) > 0;
                const promptsUsando = v.prompts_usando || [];

                // Icone JSON
                let jsonIcon;
                if (emUsoJson) {
                    jsonIcon = `<i class="fas fa-file-code text-blue-500" title="Em uso no JSON da categoria"></i>`;
                } else {
                    jsonIcon = `<i class="fas fa-file-code text-gray-300" title="Nao presente no JSON"></i>`;
                }

                // Icone Prompts
                let promptIcon;
                if (emUsoPrompts) {
                    const promptCount = v.uso_count_prompts || v.uso_count || 0;
                    const promptTitle = promptsUsando.length > 0
                        ? `Em uso por ${promptCount} prompt(s):\n${promptsUsando.join(', ')}`
                        : `Em uso por ${promptCount} prompt(s)`;
                    promptIcon = `<i class="fas fa-puzzle-piece text-purple-500" title="${promptTitle}"></i>`;
                } else {
                    promptIcon = `<i class="fas fa-puzzle-piece text-gray-300" title="Nao usado por prompts"></i>`;
                }

                const usoIcons = `<span class="flex items-center justify-center gap-2">${jsonIcon} ${promptIcon}</span>`;

                // Badge de inativa
                const inativaBadge = !v.ativo
                    ? `<span class="ml-1 px-1.5 py-0.5 text-[10px] rounded bg-red-100 text-red-600">OFF</span>`
                    : '';

                // Slug exibido (sem prefixo quando agrupado)
                const slugExibido = ocultarCategoria
                    ? removerPrefixoSlug(v.slug, v.categoria_nome)
                    : v.slug;
                const slugCompleto = v.slug;
                const mostrarTooltip = slugExibido !== slugCompleto;

                html += `
                    <tr class="hover:bg-gray-50 transition-colors ${!v.ativo ? 'bg-red-50/50' : ''}">
                        <td class="px-4 py-2 col-slug">
                            <div class="flex items-center gap-1" style="padding-left: ${indentPx}px;">
                                ${depIcon}
                                <div class="slug-display">
                                    <span class="slug-text font-mono text-sm bg-gray-100 px-2 py-0.5 rounded cursor-pointer hover:bg-gray-200"
                                          onclick="copiarSlug('${slugCompleto}')"
                                          title="Clique para copiar">${slugExibido}</span>
                                    ${mostrarTooltip ? `<span class="slug-tooltip">${slugCompleto}</span>` : ''}
                                </div>
                                ${inativaBadge}
                            </div>
                        </td>
                        <td class="px-4 py-2 col-label">
                            <span class="label-text text-gray-800 text-sm" title="${v.label}">${v.label}</span>
                        </td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-0.5 text-xs rounded-full ${getTipoBadgeClass(v.tipo)}">${getTipoLabel(v.tipo)}</span>
                        </td>
                        ${!ocultarCategoria ? `<td class="px-4 py-2 text-gray-500 text-xs">${v.categoria_nome || '-'}</td>` : ''}
                        <td class="px-4 py-2 text-center">${usoIcons}</td>
                        <td class="px-4 py-2 text-right">
                            <button onclick="verDetalhes(${v.id})" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Ver detalhes">
                                <i class="fas fa-eye text-sm"></i>
                            </button>
                            ${v.ativo ? `
                                <button onclick="editarVariavel(${v.id})" class="p-1.5 text-yellow-600 hover:bg-yellow-50 rounded transition-colors" title="Editar">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button onclick="excluirVariavel(${v.id})" class="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors" title="Excluir">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            ` : `
                                <button onclick="reativarVariavel(${v.id})" class="p-1.5 text-green-600 hover:bg-green-50 rounded transition-colors" title="Reativar">
                                    <i class="fas fa-undo text-sm"></i>
                                </button>
                                <button onclick="excluirPermanente(${v.id})" class="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors" title="Excluir permanentemente">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        // Toggle de um grupo individual
        function toggleGrupo(catId) {
            const conteudo = document.getElementById(catId);
            const icon = document.getElementById('icon-' + catId);
            const estadoGrupos = carregarEstadoGrupos();

            if (conteudo.style.display === 'none') {
                conteudo.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                estadoGrupos[catId] = true;
            } else {
                conteudo.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
                estadoGrupos[catId] = false;
            }

            salvarEstadoGrupos(estadoGrupos);
        }

        // Expandir todos os grupos
        function expandirTodosGrupos() {
            const estadoGrupos = carregarEstadoGrupos();
            document.querySelectorAll('.categoria-conteudo').forEach(el => {
                el.style.display = 'block';
                estadoGrupos[el.id] = true;
            });
            document.querySelectorAll('.categoria-icon').forEach(el => {
                el.style.transform = 'rotate(0deg)';
            });
            salvarEstadoGrupos(estadoGrupos);
        }

        // Recolher todos os grupos
        function recolherTodosGrupos() {
            const estadoGrupos = carregarEstadoGrupos();
            document.querySelectorAll('.categoria-conteudo').forEach(el => {
                el.style.display = 'none';
                estadoGrupos[el.id] = false;
            });
            document.querySelectorAll('.categoria-icon').forEach(el => {
                el.style.transform = 'rotate(-90deg)';
            });
            salvarEstadoGrupos(estadoGrupos);
        }

        function getTipoBadgeClass(tipo) {
            const classes = {
                'text': 'bg-blue-100 text-blue-700',
                'number': 'bg-green-100 text-green-700',
                'date': 'bg-purple-100 text-purple-700',
                'boolean': 'bg-yellow-100 text-yellow-700',
                'choice': 'bg-indigo-100 text-indigo-700',
                'list': 'bg-pink-100 text-pink-700',
                'currency': 'bg-emerald-100 text-emerald-700'
            };
            return classes[tipo] || 'bg-gray-100 text-gray-700';
        }

        function getTipoLabel(tipo) {
            const labels = {
                'text': 'Texto',
                'number': 'Numero',
                'date': 'Data',
                'boolean': 'Sim/Nao',
                'choice': 'Escolha',
                'list': 'Lista',
                'currency': 'Monetario'
            };
            return labels[tipo] || tipo;
        }

        // Paginacao
        function atualizarPaginacao() {
            const inicio = paginaAtual * itensPorPagina + 1;
            const fim = inicio + variaveis.length - 1;

            document.getElementById('pag-inicio').textContent = variaveis.length > 0 ? inicio : 0;
            document.getElementById('pag-fim').textContent = fim;
            document.getElementById('pag-total').textContent = totalVariaveis || variaveis.length;

            document.getElementById('btn-anterior').disabled = paginaAtual === 0;
            document.getElementById('btn-proxima').disabled = variaveis.length < itensPorPagina;
        }

        function paginaAnterior() {
            if (paginaAtual > 0) {
                paginaAtual--;
                carregarVariaveis();
            }
        }

        function proximaPagina() {
            paginaAtual++;
            carregarVariaveis();
        }

        // Ver detalhes
        async function verDetalhes(id) {
            try {
                const response = await fetch(`/admin/api/extraction/variaveis/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar detalhes');
                const v = await response.json();

                document.getElementById('modal-detalhe-titulo').textContent = v.label;
                document.getElementById('detalhe-slug').textContent = v.slug;
                document.getElementById('detalhe-label').textContent = v.label;
                document.getElementById('detalhe-tipo').innerHTML = `<span class="px-2 py-1 text-xs rounded-full ${getTipoBadgeClass(v.tipo)}">${getTipoLabel(v.tipo)}</span>`;
                document.getElementById('detalhe-descricao').textContent = v.descricao || 'Sem descricao';
                document.getElementById('detalhe-categoria').textContent = v.categoria_nome || '-';
                document.getElementById('detalhe-criado-em').textContent = new Date(v.criado_em).toLocaleDateString('pt-BR');

                // Opcoes
                const opcoesContainer = document.getElementById('detalhe-opcoes-container');
                const opcoesDiv = document.getElementById('detalhe-opcoes');
                if (v.opcoes && v.opcoes.length > 0) {
                    opcoesContainer.classList.remove('hidden');
                    opcoesDiv.innerHTML = v.opcoes.map(o => `<span class="px-2 py-1 bg-gray-100 rounded text-sm">${o}</span>`).join('');
                } else {
                    opcoesContainer.classList.add('hidden');
                }

                // Prompts
                const promptsDiv = document.getElementById('detalhe-prompts');
                if (v.prompt_usages && v.prompt_usages.length > 0) {
                    promptsDiv.innerHTML = v.prompt_usages.map(p => `
                        <a href="/admin/prompts-modulos?id=${p.prompt_id}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-800">${p.prompt_titulo}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${p.modo_ativacao === 'deterministic' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                    ${p.modo_ativacao === 'deterministic' ? 'Deterministico' : 'LLM'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500">${p.prompt_nome}</p>
                        </a>
                    `).join('');
                } else {
                    promptsDiv.innerHTML = '<p class="text-gray-400 text-sm">Nenhum prompt usa esta variavel.</p>';
                }

                document.getElementById('modal-detalhe').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes da variavel');
            }
        }

        function fecharModal() {
            document.getElementById('modal-detalhe').classList.add('hidden');
        }

        // Criar variavel
        function criarVariavel() {
            document.getElementById('modal-variavel-titulo').textContent = 'Nova Variavel';
            document.getElementById('variavel-id').value = '';
            document.getElementById('variavel-slug').value = '';
            document.getElementById('variavel-label').value = '';
            document.getElementById('variavel-tipo').value = 'text';
            document.getElementById('variavel-descricao').value = '';
            document.getElementById('variavel-opcoes').value = '';
            document.getElementById('variavel-fonte-codigo').value = '';
            document.getElementById('variavel-fonte-tipo').value = '';
            document.getElementById('opcoes-container').classList.add('hidden');
            document.getElementById('variavel-slug').disabled = false;
            document.getElementById('modal-variavel').classList.remove('hidden');
        }

        // Editar variavel
        async function editarVariavel(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            document.getElementById('modal-variavel-titulo').textContent = 'Editar Variavel';
            document.getElementById('variavel-id').value = v.id;
            document.getElementById('variavel-slug').value = v.slug;
            document.getElementById('variavel-label').value = v.label;
            document.getElementById('variavel-tipo').value = v.tipo;
            document.getElementById('variavel-descricao').value = v.descricao || '';
            document.getElementById('variavel-opcoes').value = (v.opcoes || []).join('\n');
            document.getElementById('variavel-fonte-codigo').value = v.fonte_verdade_codigo || '';
            document.getElementById('variavel-fonte-tipo').value = v.fonte_verdade_tipo || '';
            document.getElementById('variavel-slug').disabled = true;

            if (v.tipo === 'choice' || v.tipo === 'list') {
                document.getElementById('opcoes-container').classList.remove('hidden');
            } else {
                document.getElementById('opcoes-container').classList.add('hidden');
            }

            document.getElementById('modal-variavel').classList.remove('hidden');
        }

        function fecharModalVariavel() {
            document.getElementById('modal-variavel').classList.add('hidden');
        }

        // Salvar variavel
        async function salvarVariavel() {
            const id = document.getElementById('variavel-id').value;
            const slug = document.getElementById('variavel-slug').value;
            const label = document.getElementById('variavel-label').value;
            const tipo = document.getElementById('variavel-tipo').value;
            const descricao = document.getElementById('variavel-descricao').value;
            const opcoesText = document.getElementById('variavel-opcoes').value;
            const fonteCodigo = document.getElementById('variavel-fonte-codigo').value.trim();
            const fonteTipo = document.getElementById('variavel-fonte-tipo').value.trim();

            if (!slug || !label || !tipo) {
                alert('Preencha os campos obrigatorios');
                return;
            }

            const opcoes = (tipo === 'choice' || tipo === 'list') && opcoesText
                ? opcoesText.split('\n').map(o => o.trim()).filter(o => o)
                : null;

            const data = {
                slug,
                label,
                tipo,
                descricao,
                opcoes,
                fonte_verdade_codigo: fonteCodigo || null,
                fonte_verdade_tipo: fonteTipo || null
            };

            try {
                let response;
                if (id) {
                    response = await fetch(`/admin/api/extraction/variaveis/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/admin/api/extraction/variaveis', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }

                fecharModalVariavel();
                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao salvar variavel:', error);
                alert('Erro ao salvar variavel: ' + error.message);
            }
        }

        // Excluir variavel (HARD DELETE com limpeza automatica)
        async function excluirVariavel(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            try {
                // Primeiro, busca informacoes sobre dependencias
                const depResponse = await fetch(`/admin/api/extraction/variaveis/${id}/dependentes`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                let avisos = [];

                // Verifica uso em JSON
                if (v.em_uso_json) {
                    avisos.push('- Sera REMOVIDA do JSON da categoria');
                }

                // Verifica uso em Prompts
                const promptCount = v.uso_count_prompts || v.uso_count || 0;
                if (promptCount > 0) {
                    const promptsLista = v.prompts_usando && v.prompts_usando.length > 0
                        ? v.prompts_usando.join(', ')
                        : `${promptCount} prompt(s)`;
                    avisos.push(`- Sera removida como condicao de: ${promptsLista}`);
                }

                // Verifica dependencias
                if (depResponse.ok) {
                    const depData = await depResponse.json();
                    if (depData.variaveis_dependentes && depData.variaveis_dependentes.length > 0) {
                        avisos.push(`- Variaveis dependentes terao a dependencia removida: ${depData.variaveis_dependentes.map(v => v.slug).join(', ')}`);
                    }
                    if (depData.perguntas_dependentes && depData.perguntas_dependentes.length > 0) {
                        avisos.push(`- ${depData.perguntas_dependentes.length} pergunta(s) terao a dependencia removida`);
                    }
                }

                let mensagemConfirmacao = `ATENCAO: Esta acao e IRREVERSIVEL!\n\n`;
                mensagemConfirmacao += `A variavel "${v.label}" sera EXCLUIDA PERMANENTEMENTE.\n\n`;

                if (avisos.length > 0) {
                    mensagemConfirmacao += `Limpeza automatica que sera realizada:\n${avisos.join('\n')}\n\n`;
                }

                mensagemConfirmacao += `Deseja continuar?`;

                if (!confirm(mensagemConfirmacao)) return;

                const response = await fetch(`/admin/api/extraction/variaveis/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }

                const result = await response.json();

                let msgSucesso = 'Variavel excluida com sucesso!';
                const limpezas_info = result.limpezas_realizadas;
                if (limpezas_info) {
                    const limpezas = [];
                    if (limpezas_info.json_atualizado) limpezas.push('removida do JSON');
                    if (limpezas_info.prompts_removidos > 0) limpezas.push(`${limpezas_info.prompts_removidos} prompt(s) atualizados`);
                    if (limpezas_info.dependencias_perguntas_removidas > 0) limpezas.push(`${limpezas_info.dependencias_perguntas_removidas} dependencia(s) de perguntas removidas`);
                    if (limpezas_info.dependencias_variaveis_removidas > 0) limpezas.push(`${limpezas_info.dependencias_variaveis_removidas} dependencia(s) de variaveis removidas`);
                    if (limpezas_info.pergunta_origem_removida) limpezas.push('pergunta de origem removida');

                    if (limpezas.length > 0) {
                        msgSucesso += `\n\nLimpeza realizada: ${limpezas.join(', ')}.`;
                    }
                }

                alert(msgSucesso);
                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao excluir variavel:', error);
                alert('Erro ao excluir variavel: ' + error.message);
            }
        }

        // Toggle opcoes baseado no tipo
        document.getElementById('variavel-tipo').addEventListener('change', function() {
            const opcoes = document.getElementById('opcoes-container');
            if (this.value === 'choice' || this.value === 'list') {
                opcoes.classList.remove('hidden');
            } else {
                opcoes.classList.add('hidden');
            }
        });

        // Reativar variavel
        async function reativarVariavel(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            if (!confirm(`Deseja reativar a variavel "${v.label}"?`)) return;

            try {
                const response = await fetch(`/admin/api/extraction/variaveis/${id}/reativar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao reativar');
                }

                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao reativar variavel:', error);
                alert('Erro ao reativar variavel: ' + error.message);
            }
        }

        // Excluir permanentemente
        async function excluirPermanente(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            try {
                // Primeiro, busca informacoes sobre dependencias
                const depResponse = await fetch(`/admin/api/extraction/variaveis/${id}/dependentes`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                let mensagemConfirmacao = `ATENCAO: Esta acao e IRREVERSIVEL!\n\n`;

                if (depResponse.ok) {
                    const depData = await depResponse.json();
                    if (depData.total_dependentes > 0) {
                        mensagemConfirmacao += `Existem ${depData.total_dependentes} item(ns) que dependem desta variavel:\n`;

                        if (depData.variaveis_dependentes.length > 0) {
                            mensagemConfirmacao += `- Variaveis: ${depData.variaveis_dependentes.map(v => v.slug).join(', ')}\n`;
                        }
                        if (depData.perguntas_dependentes.length > 0) {
                            mensagemConfirmacao += `- Perguntas: ${depData.perguntas_dependentes.length} pergunta(s)\n`;
                        }

                        mensagemConfirmacao += `\nEssas dependencias serao REMOVIDAS.\n\n`;
                    }
                }

                mensagemConfirmacao += `Deseja excluir PERMANENTEMENTE a variavel "${v.label}"?`;

                if (!confirm(mensagemConfirmacao)) return;

                const response = await fetch(`/admin/api/extraction/variaveis/${id}/permanente`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }

                const result = await response.json();

                let msgSucesso = 'Variavel excluida permanentemente!';
                if (result.dependencias_removidas) {
                    const total = result.dependencias_removidas.variaveis + result.dependencias_removidas.perguntas;
                    if (total > 0) {
                        msgSucesso += `\n${total} dependencia(s) foram removidas.`;
                    }
                }

                alert(msgSucesso);
                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao excluir variavel:', error);
                alert('Erro ao excluir variavel: ' + error.message);
            }
        }

        // Listeners de filtros
        document.getElementById('busca-variavel').addEventListener('input', debounce(() => {
            paginaAtual = 0;
            carregarVariaveis();
        }, 300));

        document.getElementById('filtro-tipo').addEventListener('change', () => {
            paginaAtual = 0;
            carregarVariaveis();
        });

        document.getElementById('filtro-categoria').addEventListener('change', () => {
            paginaAtual = 0;
            carregarVariaveis();
        });

        document.getElementById('mostrar-inativas').addEventListener('change', () => {
            paginaAtual = 0;
            carregarCategorias(); // Atualiza dropdown de categorias
            carregarVariaveis();
        });

        // Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Modal de ajuda
        function abrirModalAjuda() {
            document.getElementById('modal-ajuda').classList.remove('hidden');
        }

        function fecharModalAjuda() {
            document.getElementById('modal-ajuda').classList.add('hidden');
        }

        // Modal do Glossario
        let glossarioCarregado = false;
        let glossarioConteudoOriginal = '';

        async function abrirGlossario() {
            document.getElementById('modal-glossario').classList.remove('hidden');

            if (!glossarioCarregado) {
                await carregarGlossario();
            }
        }

        function fecharGlossario() {
            document.getElementById('modal-glossario').classList.add('hidden');
            document.getElementById('glossario-busca').value = '';
            if (glossarioConteudoOriginal) {
                document.getElementById('glossario-conteudo').innerHTML = glossarioConteudoOriginal;
            }
        }

        async function carregarGlossario() {
            try {
                const response = await fetch('/admin/help/glossary', {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar glossário');
                }

                const data = await response.json();

                // Converte markdown para HTML (simplificado)
                const html = converterMarkdownParaHTML(data.content);

                document.getElementById('glossario-conteudo').innerHTML = html;
                glossarioConteudoOriginal = html;
                glossarioCarregado = true;

            } catch (error) {
                console.error('Erro ao carregar glossário:', error);
                document.getElementById('glossario-conteudo').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-red-500">
                            <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                            <p>Erro ao carregar glossário</p>
                            <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function converterMarkdownParaHTML(markdown) {
            // Conversão simplificada de markdown para HTML
            let html = markdown
                // Escapa HTML
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')

                // Blocos de código
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')

                // Código inline
                .replace(/`([^`]+)`/g, '<code>$1</code>')

                // Headers com IDs para navegação
                .replace(/^### (.+)$/gm, (match, text) => {
                    const id = text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h3 id="${id}">${text}</h3>`;
                })
                .replace(/^## (.+)$/gm, (match, text) => {
                    const id = text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h2 id="${id}">${text}</h2>`;
                })
                .replace(/^# (.+)$/gm, (match, text) => {
                    const id = text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h1 id="${id}">${text}</h1>`;
                })

                // Bold e Italic
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')

                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-indigo-600 hover:underline">$1</a>')

                // Tabelas
                .replace(/^\|(.+)\|$/gm, (match, content) => {
                    const cells = content.split('|').map(c => c.trim());
                    if (cells.every(c => /^[-:]+$/.test(c))) {
                        return ''; // linha divisória da tabela, ignora
                    }
                    const isHeader = cells.every(c => c.length > 0);
                    const tag = 'td';
                    return '<tr>' + cells.map(c => `<${tag}>${c}</${tag}>`).join('') + '</tr>';
                })

                // Listas não ordenadas
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')

                // Linhas horizontais
                .replace(/^---+$/gm, '<hr>')

                // Parágrafos
                .replace(/\n\n/g, '</p><p>')

                // Quebras de linha em listas
                .replace(/<\/li>\n<li>/g, '</li><li>');

            // Envolver listas
            html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
            html = html.replace(/<\/ul>\s*<ul>/g, '');

            // Envolver tabelas
            html = html.replace(/(<tr>[\s\S]*?<\/tr>)+/g, '<table>$&</table>');
            html = html.replace(/<\/table>\s*<table>/g, '');

            // Primeiro td vira th na primeira tr de cada tabela
            html = html.replace(/<table>[\s\S]*?<\/table>/g, (table) => {
                return table.replace(/<table><tr>([\s\S]*?)<\/tr>/, (match, content) => {
                    return '<table><tr>' + content.replace(/<td>/g, '<th>').replace(/<\/td>/g, '</th>') + '</tr>';
                });
            });

            return '<p>' + html + '</p>';
        }

        function buscarNoGlossario(termo) {
            if (!termo || termo.length < 2) {
                document.getElementById('glossario-conteudo').innerHTML = glossarioConteudoOriginal;
                return;
            }

            const conteudo = document.getElementById('glossario-conteudo');
            let html = glossarioConteudoOriginal;

            // Destaca o termo buscado
            const regex = new RegExp(`(${termo.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            html = html.replace(regex, '<span class="highlight">$1</span>');

            conteudo.innerHTML = html;

            // Scroll para a primeira ocorrência
            const firstHighlight = conteudo.querySelector('.highlight');
            if (firstHighlight) {
                firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function irParaSecao(secaoId) {
            const elemento = document.getElementById(secaoId);
            if (elemento) {
                elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Inicializacao
        document.addEventListener('DOMContentLoaded', async () => {
            if (await verificarAuth()) {
                carregarResumo();
                carregarCategorias();
                carregarVariaveis();
            }
        });
    </script>
</body>
</html>
