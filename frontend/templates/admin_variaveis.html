<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Variaveis - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10 w-auto">
                    </a>
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="font-semibold text-gray-800">Painel de Variaveis</h1>
                        <p class="text-xs text-gray-500">Variaveis de extracao do sistema</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <a href="/admin/categorias-resumo-json" class="text-gray-500 hover:text-gray-700 transition-colors text-sm">
                        <i class="fas fa-file-code mr-1"></i> Categorias JSON
                    </a>
                    <a href="/admin/prompts-modulos" class="text-gray-500 hover:text-gray-700 transition-colors text-sm">
                        <i class="fas fa-puzzle-piece mr-1"></i> Prompts Modulares
                    </a>
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-hashtag text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total de Variaveis</p>
                        <p id="total-variaveis" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-link text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Em Uso</p>
                        <p id="variaveis-em-uso" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-unlink text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Sem Uso</p>
                        <p id="variaveis-sem-uso" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-layer-group text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tipos</p>
                        <p id="total-tipos" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input
                            type="text"
                            id="busca-variavel"
                            placeholder="Buscar por slug ou label..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                    </div>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="filtro-tipo" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">Todos os tipos</option>
                        <option value="text">Texto</option>
                        <option value="number">Numero</option>
                        <option value="date">Data</option>
                        <option value="boolean">Sim/Nao</option>
                        <option value="choice">Escolha Unica</option>
                        <option value="list">Lista</option>
                        <option value="currency">Valor Monetario</option>
                    </select>
                    <select id="filtro-categoria" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">Todas as categorias</option>
                    </select>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                        <input type="checkbox" id="mostrar-inativas" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <span class="text-sm text-gray-600">Mostrar inativas</span>
                    </label>
                    <button
                        onclick="criarVariavel()"
                        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2"
                    >
                        <i class="fas fa-plus"></i>
                        Nova Variavel
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Variaveis -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Slug</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Label</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uso em Prompts</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acoes</th>
                    </tr>
                </thead>
                <tbody id="variaveis-table" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Carregando variaveis...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginacao -->
        <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-gray-500">
                Mostrando <span id="pag-inicio">0</span> - <span id="pag-fim">0</span> de <span id="pag-total">0</span> variaveis
            </div>
            <div class="flex gap-2">
                <button
                    id="btn-anterior"
                    onclick="paginaAnterior()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button
                    id="btn-proxima"
                    onclick="proximaPagina()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

    </main>

    <!-- Modal de Detalhes da Variavel -->
    <div id="modal-detalhe" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
                <h2 id="modal-detalhe-titulo" class="text-lg font-semibold text-gray-800">Detalhes da Variavel</h2>
                <button onclick="fecharModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Slug</label>
                        <p id="detalhe-slug" class="text-gray-800 font-mono bg-gray-50 px-2 py-1 rounded">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Tipo</label>
                        <p id="detalhe-tipo" class="text-gray-800">-</p>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Label</label>
                        <p id="detalhe-label" class="text-gray-800">-</p>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Descricao</label>
                        <p id="detalhe-descricao" class="text-gray-800">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Categoria</label>
                        <p id="detalhe-categoria" class="text-gray-800">-</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Criado em</label>
                        <p id="detalhe-criado-em" class="text-gray-800">-</p>
                    </div>
                    <div id="detalhe-opcoes-container" class="col-span-2 hidden">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Opcoes</label>
                        <div id="detalhe-opcoes" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Prompts que usam esta variavel -->
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="font-medium text-gray-800 mb-3">
                        <i class="fas fa-puzzle-piece text-indigo-500 mr-2"></i>
                        Prompts que usam esta variavel
                    </h3>
                    <div id="detalhe-prompts" class="space-y-2">
                        <p class="text-gray-400 text-sm">Nenhum prompt usa esta variavel.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Criar/Editar Variavel -->
    <div id="modal-variavel" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-primary-50 to-blue-50">
                <h2 id="modal-variavel-titulo" class="text-lg font-semibold text-gray-800">Nova Variavel</h2>
                <button onclick="fecharModalVariavel()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="form-variavel" class="p-6 space-y-4 overflow-y-auto flex-1">
                <input type="hidden" id="variavel-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Slug *</label>
                    <input
                        type="text"
                        id="variavel-slug"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="nome_da_variavel"
                        required
                    >
                    <p class="text-xs text-gray-400 mt-1">Identificador unico em snake_case</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label *</label>
                    <input
                        type="text"
                        id="variavel-label"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Nome de exibicao"
                        required
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                    <select
                        id="variavel-tipo"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        required
                    >
                        <option value="text">Texto</option>
                        <option value="number">Numero</option>
                        <option value="date">Data</option>
                        <option value="boolean">Sim/Nao</option>
                        <option value="choice">Escolha Unica</option>
                        <option value="list">Lista</option>
                        <option value="currency">Valor Monetario</option>
                    </select>
                </div>

                <div id="opcoes-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Opcoes</label>
                    <textarea
                        id="variavel-opcoes"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Uma opcao por linha"
                        rows="3"
                    ></textarea>
                    <p class="text-xs text-gray-400 mt-1">Uma opcao por linha</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descricao</label>
                    <textarea
                        id="variavel-descricao"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Descricao opcional"
                        rows="2"
                    ></textarea>
                </div>
            </form>

            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button
                    type="button"
                    onclick="fecharModalVariavel()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                >
                    Cancelar
                </button>
                <button
                    type="button"
                    onclick="salvarVariavel()"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                >
                    <i class="fas fa-save mr-1"></i>
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let variaveis = [];
        let categorias = [];
        let paginaAtual = 0;
        const itensPorPagina = 20;
        let totalVariaveis = 0;

        // Funcao auxiliar para obter o token
        function getToken() {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'access_token') {
                    return value;
                }
            }
            return null;
        }

        // Verificar autenticacao
        async function verificarAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // Carregar resumo
        async function carregarResumo() {
            try {
                const response = await fetch('/admin/api/extraction/variaveis/resumo', {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar resumo');
                const data = await response.json();

                document.getElementById('total-variaveis').textContent = data.total || 0;
                document.getElementById('variaveis-em-uso').textContent = data.variaveis_com_uso || 0;
                document.getElementById('variaveis-sem-uso').textContent = data.variaveis_sem_uso || 0;
                document.getElementById('total-tipos').textContent = Object.keys(data.distribuicao_tipos || {}).length;
            } catch (error) {
                console.error('Erro ao carregar resumo:', error);
            }
        }

        // Carregar categorias para filtro
        async function carregarCategorias() {
            try {
                const response = await fetch('/admin/api/categorias-resumo-json', {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) return;
                categorias = await response.json();

                const select = document.getElementById('filtro-categoria');
                select.innerHTML = '<option value="">Todas as categorias</option>';
                categorias.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.nome}</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carregar variaveis
        async function carregarVariaveis() {
            try {
                const busca = document.getElementById('busca-variavel').value;
                const tipo = document.getElementById('filtro-tipo').value;
                const categoriaId = document.getElementById('filtro-categoria').value;
                const mostrarInativas = document.getElementById('mostrar-inativas').checked;

                let url = `/admin/api/extraction/variaveis?limit=${itensPorPagina}&offset=${paginaAtual * itensPorPagina}`;
                if (busca) url += `&busca=${encodeURIComponent(busca)}`;
                if (tipo) url += `&tipo=${tipo}`;
                if (categoriaId) url += `&categoria_id=${categoriaId}`;
                if (mostrarInativas) url += `&apenas_ativos=false`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar variaveis');
                variaveis = await response.json();

                renderizarTabela();
                atualizarPaginacao();
            } catch (error) {
                console.error('Erro ao carregar variaveis:', error);
                document.getElementById('variaveis-table').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-red-400">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Erro ao carregar variaveis</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Renderizar tabela
        function renderizarTabela() {
            const tbody = document.getElementById('variaveis-table');

            if (variaveis.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-400">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p>Nenhuma variavel encontrada</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = variaveis.map(v => `
                <tr class="hover:bg-gray-50 transition-colors ${!v.ativo ? 'bg-red-50 opacity-75' : ''}">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${v.slug}</span>
                            ${!v.ativo ? '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">Inativa</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-800">${v.label}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getTipoBadgeClass(v.tipo)}">${getTipoLabel(v.tipo)}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-500 text-sm">${v.categoria_nome || '-'}</td>
                    <td class="px-6 py-4">
                        ${v.uso_count > 0
                            ? `<span class="text-green-600"><i class="fas fa-link mr-1"></i>${v.uso_count} prompt(s)</span>`
                            : '<span class="text-gray-400">Nenhum</span>'
                        }
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button
                            onclick="verDetalhes(${v.id})"
                            class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Ver detalhes"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        ${v.ativo ? `
                            <button
                                onclick="editarVariavel(${v.id})"
                                class="p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition-colors"
                                title="Editar"
                            >
                                <i class="fas fa-edit"></i>
                            </button>
                            <button
                                onclick="excluirVariavel(${v.id})"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Desativar"
                                ${v.uso_count > 0 ? 'disabled' : ''}
                            >
                                <i class="fas fa-ban"></i>
                            </button>
                        ` : `
                            <button
                                onclick="reativarVariavel(${v.id})"
                                class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                title="Reativar"
                            >
                                <i class="fas fa-undo"></i>
                            </button>
                            <button
                                onclick="excluirPermanente(${v.id})"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Excluir permanentemente"
                            >
                                <i class="fas fa-trash"></i>
                            </button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function getTipoBadgeClass(tipo) {
            const classes = {
                'text': 'bg-blue-100 text-blue-700',
                'number': 'bg-green-100 text-green-700',
                'date': 'bg-purple-100 text-purple-700',
                'boolean': 'bg-yellow-100 text-yellow-700',
                'choice': 'bg-indigo-100 text-indigo-700',
                'list': 'bg-pink-100 text-pink-700',
                'currency': 'bg-emerald-100 text-emerald-700'
            };
            return classes[tipo] || 'bg-gray-100 text-gray-700';
        }

        function getTipoLabel(tipo) {
            const labels = {
                'text': 'Texto',
                'number': 'Numero',
                'date': 'Data',
                'boolean': 'Sim/Nao',
                'choice': 'Escolha',
                'list': 'Lista',
                'currency': 'Monetario'
            };
            return labels[tipo] || tipo;
        }

        // Paginacao
        function atualizarPaginacao() {
            const inicio = paginaAtual * itensPorPagina + 1;
            const fim = inicio + variaveis.length - 1;

            document.getElementById('pag-inicio').textContent = variaveis.length > 0 ? inicio : 0;
            document.getElementById('pag-fim').textContent = fim;
            document.getElementById('pag-total').textContent = totalVariaveis || variaveis.length;

            document.getElementById('btn-anterior').disabled = paginaAtual === 0;
            document.getElementById('btn-proxima').disabled = variaveis.length < itensPorPagina;
        }

        function paginaAnterior() {
            if (paginaAtual > 0) {
                paginaAtual--;
                carregarVariaveis();
            }
        }

        function proximaPagina() {
            paginaAtual++;
            carregarVariaveis();
        }

        // Ver detalhes
        async function verDetalhes(id) {
            try {
                const response = await fetch(`/admin/api/extraction/variaveis/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) throw new Error('Erro ao carregar detalhes');
                const v = await response.json();

                document.getElementById('modal-detalhe-titulo').textContent = v.label;
                document.getElementById('detalhe-slug').textContent = v.slug;
                document.getElementById('detalhe-label').textContent = v.label;
                document.getElementById('detalhe-tipo').innerHTML = `<span class="px-2 py-1 text-xs rounded-full ${getTipoBadgeClass(v.tipo)}">${getTipoLabel(v.tipo)}</span>`;
                document.getElementById('detalhe-descricao').textContent = v.descricao || 'Sem descricao';
                document.getElementById('detalhe-categoria').textContent = v.categoria_nome || '-';
                document.getElementById('detalhe-criado-em').textContent = new Date(v.criado_em).toLocaleDateString('pt-BR');

                // Opcoes
                const opcoesContainer = document.getElementById('detalhe-opcoes-container');
                const opcoesDiv = document.getElementById('detalhe-opcoes');
                if (v.opcoes && v.opcoes.length > 0) {
                    opcoesContainer.classList.remove('hidden');
                    opcoesDiv.innerHTML = v.opcoes.map(o => `<span class="px-2 py-1 bg-gray-100 rounded text-sm">${o}</span>`).join('');
                } else {
                    opcoesContainer.classList.add('hidden');
                }

                // Prompts
                const promptsDiv = document.getElementById('detalhe-prompts');
                if (v.prompt_usages && v.prompt_usages.length > 0) {
                    promptsDiv.innerHTML = v.prompt_usages.map(p => `
                        <a href="/admin/prompts-modulos?id=${p.prompt_id}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-800">${p.prompt_titulo}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${p.modo_ativacao === 'deterministic' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                    ${p.modo_ativacao === 'deterministic' ? 'Deterministico' : 'LLM'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500">${p.prompt_nome}</p>
                        </a>
                    `).join('');
                } else {
                    promptsDiv.innerHTML = '<p class="text-gray-400 text-sm">Nenhum prompt usa esta variavel.</p>';
                }

                document.getElementById('modal-detalhe').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes da variavel');
            }
        }

        function fecharModal() {
            document.getElementById('modal-detalhe').classList.add('hidden');
        }

        // Criar variavel
        function criarVariavel() {
            document.getElementById('modal-variavel-titulo').textContent = 'Nova Variavel';
            document.getElementById('variavel-id').value = '';
            document.getElementById('variavel-slug').value = '';
            document.getElementById('variavel-label').value = '';
            document.getElementById('variavel-tipo').value = 'text';
            document.getElementById('variavel-descricao').value = '';
            document.getElementById('variavel-opcoes').value = '';
            document.getElementById('opcoes-container').classList.add('hidden');
            document.getElementById('variavel-slug').disabled = false;
            document.getElementById('modal-variavel').classList.remove('hidden');
        }

        // Editar variavel
        async function editarVariavel(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            document.getElementById('modal-variavel-titulo').textContent = 'Editar Variavel';
            document.getElementById('variavel-id').value = v.id;
            document.getElementById('variavel-slug').value = v.slug;
            document.getElementById('variavel-label').value = v.label;
            document.getElementById('variavel-tipo').value = v.tipo;
            document.getElementById('variavel-descricao').value = v.descricao || '';
            document.getElementById('variavel-opcoes').value = (v.opcoes || []).join('\n');
            document.getElementById('variavel-slug').disabled = true;

            if (v.tipo === 'choice' || v.tipo === 'list') {
                document.getElementById('opcoes-container').classList.remove('hidden');
            } else {
                document.getElementById('opcoes-container').classList.add('hidden');
            }

            document.getElementById('modal-variavel').classList.remove('hidden');
        }

        function fecharModalVariavel() {
            document.getElementById('modal-variavel').classList.add('hidden');
        }

        // Salvar variavel
        async function salvarVariavel() {
            const id = document.getElementById('variavel-id').value;
            const slug = document.getElementById('variavel-slug').value;
            const label = document.getElementById('variavel-label').value;
            const tipo = document.getElementById('variavel-tipo').value;
            const descricao = document.getElementById('variavel-descricao').value;
            const opcoesText = document.getElementById('variavel-opcoes').value;

            if (!slug || !label || !tipo) {
                alert('Preencha os campos obrigatorios');
                return;
            }

            const opcoes = (tipo === 'choice' || tipo === 'list') && opcoesText
                ? opcoesText.split('\n').map(o => o.trim()).filter(o => o)
                : null;

            const data = { slug, label, tipo, descricao, opcoes };

            try {
                let response;
                if (id) {
                    response = await fetch(`/admin/api/extraction/variaveis/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/admin/api/extraction/variaveis', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }

                fecharModalVariavel();
                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao salvar variavel:', error);
                alert('Erro ao salvar variavel: ' + error.message);
            }
        }

        // Excluir variavel
        async function excluirVariavel(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            if (v.uso_count > 0) {
                alert('Nao e possivel excluir uma variavel que esta em uso por prompts.');
                return;
            }

            if (!confirm(`Deseja excluir a variavel "${v.label}"?`)) return;

            try {
                const response = await fetch(`/admin/api/extraction/variaveis/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }

                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao excluir variavel:', error);
                alert('Erro ao excluir variavel: ' + error.message);
            }
        }

        // Toggle opcoes baseado no tipo
        document.getElementById('variavel-tipo').addEventListener('change', function() {
            const opcoes = document.getElementById('opcoes-container');
            if (this.value === 'choice' || this.value === 'list') {
                opcoes.classList.remove('hidden');
            } else {
                opcoes.classList.add('hidden');
            }
        });

        // Reativar variavel
        async function reativarVariavel(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            if (!confirm(`Deseja reativar a variavel "${v.label}"?`)) return;

            try {
                const response = await fetch(`/admin/api/extraction/variaveis/${id}/reativar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao reativar');
                }

                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao reativar variavel:', error);
                alert('Erro ao reativar variavel: ' + error.message);
            }
        }

        // Excluir permanentemente
        async function excluirPermanente(id) {
            const v = variaveis.find(v => v.id === id);
            if (!v) return;

            if (!confirm(`ATENCAO: Esta acao e IRREVERSIVEL!\n\nDeseja excluir PERMANENTEMENTE a variavel "${v.label}"?`)) return;

            try {
                const response = await fetch(`/admin/api/extraction/variaveis/${id}/permanente`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }

                carregarVariaveis();
                carregarResumo();
            } catch (error) {
                console.error('Erro ao excluir variavel:', error);
                alert('Erro ao excluir variavel: ' + error.message);
            }
        }

        // Listeners de filtros
        document.getElementById('busca-variavel').addEventListener('input', debounce(() => {
            paginaAtual = 0;
            carregarVariaveis();
        }, 300));

        document.getElementById('filtro-tipo').addEventListener('change', () => {
            paginaAtual = 0;
            carregarVariaveis();
        });

        document.getElementById('filtro-categoria').addEventListener('change', () => {
            paginaAtual = 0;
            carregarVariaveis();
        });

        document.getElementById('mostrar-inativas').addEventListener('change', () => {
            paginaAtual = 0;
            carregarVariaveis();
        });

        // Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Inicializacao
        document.addEventListener('DOMContentLoaded', async () => {
            if (await verificarAuth()) {
                carregarResumo();
                carregarCategorias();
                carregarVariaveis();
            }
        });
    </script>
</body>
</html>
