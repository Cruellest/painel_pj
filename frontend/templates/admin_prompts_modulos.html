<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Prompts - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd',
                            300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9',
                            600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .editor-container { font-family: 'Fira Code', 'Monaco', 'Consolas', monospace; }
        .tag-pill { @apply px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700; }
        .keyword-pill { @apply px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-700; }
        
        /* Animações para categorias colapsáveis */
        .categoria-icon {
            transition: transform 0.2s ease-in-out;
        }
        .categoria-conteudo {
            transition: all 0.2s ease-in-out;
        }
        .categoria-grupo:hover > div:first-child {
            filter: brightness(0.97);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="/admin/prompts-config" class="text-gray-500 hover:text-primary-600">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Gerenciamento de Prompts Modulares</h1>
                    <p class="text-sm text-gray-500">Edite e versione prompts do sistema</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="/admin/modulos-tipo-peca" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <i class="fas fa-layer-group"></i> Módulos por Tipo de Peça
                </a>
                <button onclick="abrirModalGrupos()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                    <i class="fas fa-layer-group"></i> Grupos
                </button>
                <button onclick="criarModulo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Criar Módulo
                </button>
                <button onclick="abrirModalImportar()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i class="fas fa-upload"></i> Importar JSON
                </button>
                <button onclick="abrirModalExportar()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="busca" placeholder="Buscar por título ou conteúdo..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                        oninput="filtrarModulos()">
                </div>
                <select id="filtro-tipo" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filtrarModulos()">
                    <option value="">Todos os tipos</option>
                    <option value="base">Base (Sistema)</option>
                    <option value="peca">Peça</option>
                    <option value="conteudo">Conteúdo</option>
                </select>
                <select id="filtro-grupo" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filtrarModulos()">
                    <option value="">Todos os grupos</option>
                </select>
                <select id="filtro-categoria" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filtrarModulos()">
                    <option value="">Todas as categorias</option>
                </select>
                <label class="flex items-center gap-2 text-sm text-gray-600">
                    <input type="checkbox" id="apenas-ativos" checked onchange="filtrarModulos()">
                    Apenas ativos
                </label>
            </div>
        </div>

        <!-- Lista de Módulos -->
        <div id="lista-modulos" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando módulos...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Grupos -->
    <div id="modal-grupos" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">Grupos e Subgrupos de Conteudo</h2>
                    <p class="text-sm text-gray-500">Gerencie os grupos usados nos prompts de conteudo</p>
                </div>
                <button onclick="fecharModalGrupos()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Grupos</h3>
                        <form id="form-grupo" class="space-y-3">
                            <input type="hidden" id="grupo-id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                <input type="text" id="grupo-nome" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                                <input type="text" id="grupo-slug" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                                    <input type="number" id="grupo-ordem" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="0" min="0">
                                </div>
                                <label class="flex items-center gap-2 mt-6 text-sm text-gray-700">
                                    <input type="checkbox" id="grupo-ativo" checked>
                                    Ativo
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" onclick="salvarGrupo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                                    <i class="fas fa-save mr-1"></i> Salvar Grupo
                                </button>
                                <button type="button" onclick="limparGrupoForm()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    Limpar
                                </button>
                            </div>
                        </form>
                        <div id="lista-grupos" class="space-y-2"></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Subgrupos</h3>
                        <div id="subgrupo-grupo-info" class="text-sm text-gray-500">Selecione um grupo para editar subgrupos.</div>
                        <form id="form-subgrupo" class="space-y-3">
                            <input type="hidden" id="subgrupo-id">
                            <input type="hidden" id="subgrupo-grupo-id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                <input type="text" id="subgrupo-nome" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                                <input type="text" id="subgrupo-slug" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                                    <input type="number" id="subgrupo-ordem" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="0" min="0">
                                </div>
                                <label class="flex items-center gap-2 mt-6 text-sm text-gray-700">
                                    <input type="checkbox" id="subgrupo-ativo" checked>
                                    Ativo
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" onclick="salvarSubgrupo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                                    <i class="fas fa-save mr-1"></i> Salvar Subgrupo
                                </button>
                                <button type="button" onclick="limparSubgrupoForm()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    Limpar
                                </button>
                            </div>
                        </form>
                        <div id="lista-subgrupos" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="modal-editor" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col m-4">
            <!-- Header do Modal -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-primary-50 to-blue-50">
                <div>
                    <h2 id="modal-titulo" class="text-lg font-semibold text-gray-800">Editar Módulo</h2>
                    <p id="modal-subtitulo" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="fecharEditor()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Corpo do Modal -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="form-modulo" class="space-y-6">
                    <input type="hidden" id="modulo-id">
                    
                    <!-- Informações Básicas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                            <select id="modulo-tipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                <option value="base">Base (Sistema)</option>
                                <option value="peca">Peça</option>
                                <option value="conteudo">Conteúdo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                            <input type="text" id="modulo-categoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                placeholder="Ex: medicamento">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subcategoria</label>
                            <input type="text" id="modulo-subcategoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                placeholder="Ex: nao_incorporado_sus">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome (único)</label>
                            <input type="text" id="modulo-nome" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required
                                placeholder="identificador_unico">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="modulo-titulo" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required
                            placeholder="Título legível do módulo">
                    </div>
                    
                    <div id="grupo-conteudo-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Grupo (Conteudo)</label>
                            <select id="modulo-grupo" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Selecione o grupo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subgrupo (Opcional)</label>
                            <select id="modulo-subgrupo" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Sem subgrupo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Condição de Ativação (apenas para tipo conteudo) -->
                    <div id="condicao-ativacao-container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-bolt text-yellow-500 mr-1"></i>
                            Condição de Ativação
                            <span class="text-xs text-gray-400 ml-2">(Quando este prompt deve ser acionado? - usado pelo Agente Detector)</span>
                        </label>
                        <textarea id="modulo-condicao-ativacao" rows="4" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm resize-y"
                            placeholder="Descreva a situação em que este prompt deve ser ativado. Ex: 'Quando o processo envolve pedido de medicamento não incorporado ao SUS' ou 'Quando há alegação de dano moral'"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Esta descrição é usada APENAS pelo Agente Detector para decidir se ativa este módulo. Não é enviada ao gerador de peça.</p>
                    </div>
                    
                    <!-- Editor de Conteúdo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-file-alt text-blue-500 mr-1"></i>
                            Conteúdo do Prompt (Markdown)
                            <span class="text-xs text-gray-400 ml-2">(Enviado ao Agente Gerador de Peça)</span>
                            <button type="button" onclick="toggleFullscreen()" class="ml-2 text-primary-600 hover:text-primary-700">
                                <i class="fas fa-expand"></i> Tela cheia
                            </button>
                        </label>
                        <textarea id="modulo-conteudo" rows="15" 
                            class="editor-container w-full px-4 py-3 border border-gray-300 rounded-lg font-mono text-sm resize-y"
                            placeholder="Digite o conteúdo do prompt aqui... Este é o texto que será incluído no prompt enviado à IA para gerar a peça."></textarea>
                    </div>
                    
                    <!-- Palavras-chave -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-tags text-purple-500 mr-1"></i>
                            Palavras-chave (para detecção automática)
                        </label>
                        <div id="keywords-container" class="flex flex-wrap gap-2 p-3 border border-gray-300 rounded-lg min-h-[44px]">
                            <!-- Keywords renderizadas aqui -->
                        </div>
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="nova-keyword" placeholder="Adicionar palavra-chave" 
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                onkeypress="if(event.key==='Enter'){event.preventDefault();adicionarKeyword()}">
                            <button type="button" onclick="adicionarKeyword()" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tags -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-folder text-blue-500 mr-1"></i>
                            Tags (organização)
                        </label>
                        <div id="tags-container" class="flex flex-wrap gap-2 p-3 border border-gray-300 rounded-lg min-h-[44px]">
                            <!-- Tags renderizadas aqui -->
                        </div>
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="nova-tag" placeholder="Adicionar tag"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                onkeypress="if(event.key==='Enter'){event.preventDefault();adicionarTag()}">
                            <button type="button" onclick="adicionarTag()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="modulo-ativo" checked class="w-4 h-4 text-primary-600 rounded">
                            <span class="text-sm text-gray-700">Módulo ativo</span>
                        </label>
                        <div>
                            <label class="text-sm text-gray-700 mr-2">Ordem:</label>
                            <input type="number" id="modulo-ordem" value="0" min="0" 
                                class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <!-- Motivo da alteração (apenas para edição) -->
                    <div id="motivo-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-comment text-orange-500 mr-1"></i>
                            Motivo da alteração <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="modulo-motivo" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Ex: Atualização de jurisprudência - Tema 106 STJ">
                    </div>
                </form>
            </div>
            
            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
                <div id="versao-info" class="text-sm text-gray-500"></div>
                <div class="flex gap-3">
                    <button type="button" onclick="fecharEditor()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        Cancelar
                    </button>
                    <button type="button" onclick="verHistorico()" id="btn-historico" class="hidden px-4 py-2 text-purple-600 bg-purple-50 hover:bg-purple-100 rounded-lg">
                        <i class="fas fa-history mr-1"></i> Histórico
                    </button>
                    <button type="button" onclick="salvarModulo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <i class="fas fa-save mr-1"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico -->
    <div id="modal-historico" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Histórico de Versões</h2>
                <button onclick="fecharHistorico()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="historico-lista" class="space-y-4">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Importação -->
    <div id="modal-importar" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-green-50 to-emerald-50">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-upload text-green-600 mr-2"></i>
                        Importar Módulos de Prompts
                    </h2>
                    <p class="text-sm text-gray-500">Importe módulos a partir de um arquivo JSON</p>
                </div>
                <button onclick="fecharModalImportar()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Área de Upload -->
                <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-500 transition-colors cursor-pointer"
                    onclick="document.getElementById('arquivo-json').click()"
                    ondrop="handleDrop(event)"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)">
                    <input type="file" id="arquivo-json" accept=".json" class="hidden" onchange="carregarArquivoJson(event)">
                    <i class="fas fa-file-upload text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">Arraste um arquivo JSON aqui ou clique para selecionar</p>
                    <p class="text-sm text-gray-400">Formato: arquivo JSON com array "modulos"</p>
                </div>
                
                <!-- Preview do arquivo carregado -->
                <div id="preview-importacao" class="hidden mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">
                            <i class="fas fa-file-code text-green-600 mr-2"></i>
                            <span id="nome-arquivo">arquivo.json</span>
                        </h3>
                        <button onclick="limparArquivo()" class="text-sm text-red-600 hover:text-red-700">
                            <i class="fas fa-trash mr-1"></i> Remover
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <span class="text-2xl font-bold text-green-600" id="total-modulos">0</span>
                                <p class="text-sm text-gray-500">Módulos encontrados</p>
                            </div>
                            <div>
                                <span class="text-2xl font-bold text-blue-600" id="novos-modulos">0</span>
                                <p class="text-sm text-gray-500">Novos</p>
                            </div>
                            <div>
                                <span class="text-2xl font-bold text-orange-600" id="existentes-modulos">0</span>
                                <p class="text-sm text-gray-500">Já existem</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de módulos a importar -->
                    <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">Nome</th>
                                    <th class="px-3 py-2 text-left">Categoria</th>
                                    <th class="px-3 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="lista-modulos-importar" class="divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Opção de sobrescrever -->
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="sobrescrever-existentes" class="mt-1 w-4 h-4 text-yellow-600 rounded">
                            <div>
                                <span class="font-medium text-yellow-800">Sobrescrever módulos existentes</span>
                                <p class="text-sm text-yellow-600">Se marcado, os módulos que já existem serão atualizados com os novos valores. Uma nova versão será criada no histórico.</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Resultado da importação -->
                <div id="resultado-importacao" class="hidden mt-6">
                    <div id="resultado-sucesso" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            Importação concluída!
                        </h4>
                        <div class="mt-3 grid grid-cols-4 gap-4 text-center">
                            <div>
                                <span class="text-xl font-bold text-gray-700" id="res-total">0</span>
                                <p class="text-xs text-gray-500">Recebidos</p>
                            </div>
                            <div>
                                <span class="text-xl font-bold text-green-600" id="res-criados">0</span>
                                <p class="text-xs text-gray-500">Criados</p>
                            </div>
                            <div>
                                <span class="text-xl font-bold text-blue-600" id="res-atualizados">0</span>
                                <p class="text-xs text-gray-500">Atualizados</p>
                            </div>
                            <div>
                                <span class="text-xl font-bold text-gray-400" id="res-ignorados">0</span>
                                <p class="text-xs text-gray-500">Ignorados</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="resultado-erros" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erros encontrados
                        </h4>
                        <ul id="lista-erros" class="mt-2 text-sm text-red-700 list-disc list-inside">
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-end gap-3">
                <button type="button" onclick="fecharModalImportar()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    Fechar
                </button>
                <button type="button" onclick="executarImportacao()" id="btn-importar" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-upload mr-1"></i> Importar Módulos
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Exportação -->
    <div id="modal-exportar" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-download text-blue-600 mr-2"></i>
                        Exportar Módulos de Prompts
                    </h2>
                    <p class="text-sm text-gray-500">Selecione os módulos para exportar em JSON</p>
                </div>
                <button onclick="fecharModalExportar()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Filtros de Exportação -->
                <div class="flex flex-wrap gap-4 items-center mb-4 pb-4 border-b border-gray-200">
                    <select id="export-filtro-tipo" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filtrarModulosExport()">
                        <option value="">Todos os tipos</option>
                        <option value="base">Base (Sistema)</option>
                        <option value="peca">Peça</option>
                        <option value="conteudo">Conteúdo</option>
                    </select>
                    <select id="export-filtro-categoria" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filtrarModulosExport()">
                        <option value="">Todas as categorias</option>
                    </select>
                    <div class="flex-1"></div>
                    <span id="export-contador" class="text-sm text-gray-500">0 selecionados</span>
                </div>
                
                <!-- Ações em Lote -->
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="selecionarTodosExport(true)" class="px-3 py-1.5 text-sm bg-green-50 text-green-700 rounded-lg hover:bg-green-100">
                        <i class="fas fa-check-double mr-1"></i> Selecionar Todos
                    </button>
                    <button onclick="selecionarTodosExport(false)" class="px-3 py-1.5 text-sm bg-red-50 text-red-700 rounded-lg hover:bg-red-100">
                        <i class="fas fa-times mr-1"></i> Desmarcar Todos
                    </button>
                    <button onclick="selecionarPorTipo('conteudo')" class="px-3 py-1.5 text-sm bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100">
                        <i class="fas fa-puzzle-piece mr-1"></i> Só Conteúdo
                    </button>
                    <button onclick="selecionarPorTipo('peca')" class="px-3 py-1.5 text-sm bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100">
                        <i class="fas fa-file-alt mr-1"></i> Só Peça
                    </button>
                    <button onclick="inverterSelecaoExport()" class="px-3 py-1.5 text-sm bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-exchange-alt mr-1"></i> Inverter
                    </button>
                </div>
                
                <!-- Lista de Módulos para Exportar -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left w-10">
                                        <input type="checkbox" id="export-select-all" onchange="selecionarTodosExport(this.checked)" class="w-4 h-4 text-blue-600 rounded">
                                    </th>
                                    <th class="px-3 py-2 text-left">Título</th>
                                    <th class="px-3 py-2 text-left">Tipo</th>
                                    <th class="px-3 py-2 text-left">Categoria</th>
                                    <th class="px-3 py-2 text-left">Subcategoria</th>
                                </tr>
                            </thead>
                            <tbody id="lista-modulos-exportar" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="px-3 py-8 text-center text-gray-400">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
                <span id="export-info" class="text-sm text-gray-500"></span>
                <div class="flex items-center gap-3">
                    <button type="button" onclick="fecharModalExportar()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        Cancelar
                    </button>
                    <button type="button" onclick="executarExportacao()" id="btn-exportar" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-download mr-1"></i> Exportar JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/prompts-modulos';
        let modulosCache = [];
        let modulosExportCache = [];
        let keywordsAtuais = [];
        let tagsAtuais = [];
        let moduloAtualId = null;
        let gruposCache = [];
        let subgruposCache = [];
        let grupoSelecionadoId = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            carregarModulos();
            carregarCategorias();
            carregarGrupos();
        });

        async function carregarModulos() {
            try {
                const params = new URLSearchParams();
                const tipo = document.getElementById('filtro-tipo').value;
                const grupoId = document.getElementById('filtro-grupo').value;
                const categoria = document.getElementById('filtro-categoria').value;
                const busca = document.getElementById('busca').value;
                const apenasAtivos = document.getElementById('apenas-ativos').checked;

                if (tipo) params.append('tipo', tipo);
                if (grupoId && (!tipo || tipo === 'conteudo')) params.append('group_id', grupoId);
                if (categoria) params.append('categoria', categoria);
                if (busca) params.append('busca', busca);
                params.append('apenas_ativos', apenasAtivos);

                const response = await fetch(`${API_BASE}?${params}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar módulos');

                modulosCache = await response.json();
                renderizarModulos();
            } catch (error) {
                console.error(error);
                document.getElementById('lista-modulos').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar módulos</p>
                    </div>`;
            }
        }

        async function carregarCategorias() {
            try {
                const params = new URLSearchParams();
                const grupoId = document.getElementById('filtro-grupo').value;
                if (grupoId) params.append('group_id', grupoId);

                const response = await fetch(`${API_BASE}/categorias?${params}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                const categorias = await response.json();
                const select = document.getElementById('filtro-categoria');
                select.innerHTML = '<option value="">Todas as categorias</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }


        async function carregarGrupos() {
            try {
                const response = await fetch(`${API_BASE}/grupos?apenas_ativos=false`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar grupos');

                gruposCache = await response.json();
                atualizarSelectGrupos();
                renderizarGruposModal();

                if (grupoSelecionadoId) {
                    await carregarSubgruposGrupo(grupoSelecionadoId);
                }
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
            }
        }

        function atualizarSelectGrupos() {
            const filtro = document.getElementById('filtro-grupo');
            if (filtro) {
                const valorAtual = filtro.value;
                filtro.innerHTML = '<option value="">Todos os grupos</option>';
                gruposCache.forEach((grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo.id;
                    option.textContent = grupo.name || grupo.nome;
                    filtro.appendChild(option);
                });
                if (valorAtual) {
                    filtro.value = valorAtual;
                }
            }

            const selectModulo = document.getElementById('modulo-grupo');
            if (selectModulo) {
                const valorAtual = selectModulo.value;
                selectModulo.innerHTML = '<option value="">Selecione o grupo</option>';
                gruposCache.forEach((grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo.id;
                    option.textContent = grupo.name || grupo.nome;
                    selectModulo.appendChild(option);
                });
                if (valorAtual) {
                    selectModulo.value = valorAtual;
                }
            }
        }

        function abrirModalGrupos() {
            document.getElementById('modal-grupos').classList.remove('hidden');
            carregarGrupos();
        }

        function fecharModalGrupos() {
            document.getElementById('modal-grupos').classList.add('hidden');
        }

        function limparGrupoForm() {
            document.getElementById('grupo-id').value = '';
            document.getElementById('grupo-nome').value = '';
            document.getElementById('grupo-slug').value = '';
            document.getElementById('grupo-ordem').value = 0;
            document.getElementById('grupo-ativo').checked = true;
        }

        function renderizarGruposModal() {
            const container = document.getElementById('lista-grupos');
            if (!container) return;

            if (!gruposCache.length) {
                container.innerHTML = '<p class="text-sm text-gray-400">Nenhum grupo cadastrado.</p>';
                return;
            }

            container.innerHTML = gruposCache.map((grupo) => {
                const ativo = grupo.active ? 'Ativo' : 'Inativo';
                const ativoClass = grupo.active ? 'text-green-600' : 'text-gray-400';
                return `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${grupo.name}</p>
                            <p class="text-xs text-gray-500">${grupo.slug} - <span class="${ativoClass}">${ativo}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editarGrupo(${grupo.id})" class="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded">Editar</button>
                            <button onclick="selecionarGrupoSubgrupos(${grupo.id})" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Subgrupos</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editarGrupo(id) {
            const grupo = gruposCache.find((g) => g.id === id);
            if (!grupo) return;

            document.getElementById('grupo-id').value = grupo.id;
            document.getElementById('grupo-nome').value = grupo.name || '';
            document.getElementById('grupo-slug').value = grupo.slug || '';
            document.getElementById('grupo-ordem').value = grupo.order || 0;
            document.getElementById('grupo-ativo').checked = grupo.active !== false;
        }

        async function salvarGrupo() {
            const id = document.getElementById('grupo-id').value;
            const payload = {
                name: document.getElementById('grupo-nome').value,
                slug: document.getElementById('grupo-slug').value,
                active: document.getElementById('grupo-ativo').checked,
                order: parseInt(document.getElementById('grupo-ordem').value) || 0
            };

            if (!payload.name || !payload.slug) {
                alert('Informe nome e slug do grupo');
                return;
            }

            try {
                const response = await fetch(id ? `${API_BASE}/grupos/${id}` : `${API_BASE}/grupos`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar grupo');
                }

                limparGrupoForm();
                carregarGrupos();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function selecionarGrupoSubgrupos(id) {
            grupoSelecionadoId = id;
            document.getElementById('subgrupo-grupo-id').value = id;
            const grupo = gruposCache.find((g) => g.id === id);
            const info = document.getElementById('subgrupo-grupo-info');
            if (info) {
                info.textContent = grupo ? `Subgrupos de ${grupo.name}` : 'Subgrupos do grupo selecionado';
            }
            limparSubgrupoForm();
            await carregarSubgruposGrupo(id);
        }

        async function carregarSubgruposGrupo(groupId) {
            if (!groupId) return;

            try {
                const response = await fetch(`${API_BASE}/grupos/${groupId}/subgrupos`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar subgrupos');

                subgruposCache = await response.json();
                renderizarSubgruposModal();
            } catch (error) {
                console.error('Erro ao carregar subgrupos:', error);
            }
        }

        function renderizarSubgruposModal() {
            const container = document.getElementById('lista-subgrupos');
            if (!container) return;

            if (!grupoSelecionadoId) {
                container.innerHTML = '<p class="text-sm text-gray-400">Selecione um grupo.</p>';
                return;
            }

            if (!subgruposCache.length) {
                container.innerHTML = '<p class="text-sm text-gray-400">Nenhum subgrupo cadastrado.</p>';
                return;
            }

            container.innerHTML = subgruposCache.map((subgrupo) => {
                const ativo = subgrupo.active ? 'Ativo' : 'Inativo';
                const ativoClass = subgrupo.active ? 'text-green-600' : 'text-gray-400';
                return `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${subgrupo.name}</p>
                            <p class="text-xs text-gray-500">${subgrupo.slug} - <span class="${ativoClass}">${ativo}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editarSubgrupo(${subgrupo.id})" class="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded">Editar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editarSubgrupo(id) {
            const subgrupo = subgruposCache.find((s) => s.id === id);
            if (!subgrupo) return;

            document.getElementById('subgrupo-id').value = subgrupo.id;
            document.getElementById('subgrupo-nome').value = subgrupo.name || '';
            document.getElementById('subgrupo-slug').value = subgrupo.slug || '';
            document.getElementById('subgrupo-ordem').value = subgrupo.order || 0;
            document.getElementById('subgrupo-ativo').checked = subgrupo.active !== false;
        }

        async function salvarSubgrupo() {
            const groupId = document.getElementById('subgrupo-grupo-id').value;
            if (!groupId) {
                alert('Selecione um grupo antes de salvar subgrupo');
                return;
            }

            const id = document.getElementById('subgrupo-id').value;
            const payload = {
                name: document.getElementById('subgrupo-nome').value,
                slug: document.getElementById('subgrupo-slug').value,
                active: document.getElementById('subgrupo-ativo').checked,
                order: parseInt(document.getElementById('subgrupo-ordem').value) || 0
            };

            if (!payload.name || !payload.slug) {
                alert('Informe nome e slug do subgrupo');
                return;
            }

            try {
                const response = await fetch(id ? `${API_BASE}/subgrupos/${id}` : `${API_BASE}/grupos/${groupId}/subgrupos`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar subgrupo');
                }

                limparSubgrupoForm();
                await carregarSubgruposGrupo(groupId);
                carregarGrupos();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        function limparSubgrupoForm() {
            document.getElementById('subgrupo-id').value = '';
            document.getElementById('subgrupo-nome').value = '';
            document.getElementById('subgrupo-slug').value = '';
            document.getElementById('subgrupo-ordem').value = 0;
            document.getElementById('subgrupo-ativo').checked = true;
        }

        async function carregarSubgruposModulo(groupId, selectedId = null) {
            const select = document.getElementById('modulo-subgrupo');
            if (!select) return;

            select.innerHTML = '<option value="">Sem subgrupo</option>';

            if (!groupId) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/grupos/${groupId}/subgrupos`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) return;

                const subgrupos = await response.json();
                subgrupos.forEach((subgrupo) => {
                    const option = document.createElement('option');
                    option.value = subgrupo.id;
                    option.textContent = subgrupo.name;
                    select.appendChild(option);
                });

                if (selectedId) {
                    select.value = selectedId;
                }
            } catch (error) {
                console.error('Erro ao carregar subgrupos:', error);
            }
        }

        function renderizarModulos() {
            const container = document.getElementById('lista-modulos');
            
            if (modulosCache.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Nenhum módulo encontrado</p>
                        <button onclick="criarModulo()" class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg">
                            Criar primeiro módulo
                        </button>
                    </div>`;
                return;
            }

            // Agrupa por tipo
            const grupos = { base: [], peca: [], conteudo: [] };
            modulosCache.forEach(m => {
                if (grupos[m.tipo]) grupos[m.tipo].push(m);
            });

            const tipoLabels = {
                base: { icon: 'fa-cog', label: 'Base (Prompt do Sistema)', color: 'indigo' },
                peca: { icon: 'fa-file-alt', label: 'Peças (Estrutura/Template)', color: 'green' },
                conteudo: { icon: 'fa-lightbulb', label: 'Conteúdo (Teses e Argumentos)', color: 'orange' }
            };

            let html = '';
            for (const [tipo, modulos] of Object.entries(grupos)) {
                if (modulos.length === 0) continue;
                
                const info = tipoLabels[tipo];
                
                // Para tipo 'conteudo', agrupa por categoria
                if (tipo === 'conteudo') {
                    html += renderizarConteudoPorCategoria(modulos, info);
                } else {
                    html += renderizarGrupoSimples(tipo, modulos, info);
                }
            }

            container.innerHTML = html;
        }
        
        function renderizarGrupoSimples(tipo, modulos, info) {
            let html = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-${info.color}-50 border-b border-${info.color}-100">
                        <h3 class="font-semibold text-${info.color}-800 flex items-center gap-2">
                            <i class="fas ${info.icon}"></i>
                            ${info.label} (${modulos.length})
                        </h3>
                    </div>
                    <div class="divide-y divide-gray-100">
            `;

            modulos.forEach(m => {
                html += renderizarItemModulo(m);
            });

            html += '</div></div>';
            return html;
        }
        
        function renderizarConteudoPorCategoria(modulos, info) {
            // Agrupa módulos de conteúdo por categoria
            const categorias = {};
            modulos.forEach(m => {
                const cat = m.categoria || 'Sem Categoria';
                if (!categorias[cat]) {
                    categorias[cat] = [];
                }
                categorias[cat].push(m);
            });
            
            // Ordena categorias alfabeticamente
            const categoriasOrdenadas = Object.keys(categorias).sort((a, b) => {
                if (a === 'Sem Categoria') return 1;
                if (b === 'Sem Categoria') return -1;
                return a.localeCompare(b, 'pt-BR');
            });
            
            let html = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-${info.color}-50 border-b border-${info.color}-100 flex items-center justify-between">
                        <h3 class="font-semibold text-${info.color}-800 flex items-center gap-2">
                            <i class="fas ${info.icon}"></i>
                            ${info.label} (${modulos.length})
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="expandirTodasCategorias()" class="px-2 py-1 text-xs text-${info.color}-700 hover:bg-${info.color}-100 rounded">
                                <i class="fas fa-expand-alt mr-1"></i> Expandir todas
                            </button>
                            <button onclick="recolherTodasCategorias()" class="px-2 py-1 text-xs text-${info.color}-700 hover:bg-${info.color}-100 rounded">
                                <i class="fas fa-compress-alt mr-1"></i> Recolher todas
                            </button>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-100">
            `;
            
            // Cores para subcategorias
            const coresCategoria = [
                'blue', 'purple', 'teal', 'pink', 'cyan', 'amber', 'lime', 'rose', 'indigo', 'emerald'
            ];
            
            categoriasOrdenadas.forEach((cat, idx) => {
                const modulosCat = categorias[cat];
                const corCategoria = coresCategoria[idx % coresCategoria.length];
                const catId = `cat-${cat.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // Agrupa por subcategoria dentro da categoria
                const subcategorias = {};
                modulosCat.forEach(m => {
                    const subcat = m.subcategoria || 'Geral';
                    if (!subcategorias[subcat]) {
                        subcategorias[subcat] = [];
                    }
                    subcategorias[subcat].push(m);
                });
                
                const subcategoriasOrdenadas = Object.keys(subcategorias).sort((a, b) => {
                    if (a === 'Geral') return -1;
                    if (b === 'Geral') return 1;
                    return a.localeCompare(b, 'pt-BR');
                });
                
                html += `
                    <div class="categoria-grupo" data-categoria="${cat}">
                        <div class="px-4 py-3 bg-${corCategoria}-50 border-b border-${corCategoria}-100 cursor-pointer hover:bg-${corCategoria}-100 transition-colors flex items-center justify-between"
                            onclick="toggleCategoria('${catId}')">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-chevron-down text-${corCategoria}-500 transition-transform categoria-icon" id="icon-${catId}"></i>
                                <span class="font-medium text-${corCategoria}-800">${cat}</span>
                                <span class="px-2 py-0.5 text-xs bg-${corCategoria}-200 text-${corCategoria}-800 rounded-full">${modulosCat.length} módulos</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-${corCategoria}-600">
                                ${subcategoriasOrdenadas.map(s => `<span class="px-1.5 py-0.5 bg-white/50 rounded">${s}</span>`).join('')}
                            </div>
                        </div>
                        <div class="categoria-conteudo" id="${catId}">
                `;
                
                // Renderiza por subcategoria
                subcategoriasOrdenadas.forEach(subcat => {
                    const modulosSubcat = subcategorias[subcat];
                    
                    if (subcategoriasOrdenadas.length > 1 || subcat !== 'Geral') {
                        html += `
                            <div class="px-4 py-2 bg-gray-50 border-b border-gray-100">
                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">
                                    <i class="fas fa-folder-open mr-1"></i>${subcat}
                                </span>
                            </div>
                        `;
                    }
                    
                    html += `<div class="divide-y divide-gray-100">`;
                    modulosSubcat.forEach(m => {
                        html += renderizarItemModulo(m, false); // Não mostra categoria no badge
                    });
                    html += `</div>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            return html;
        }
        
        function renderizarItemModulo(m, mostrarCategoria = true) {
            const statusBadge = m.ativo 
                ? '<span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">Ativo</span>'
                : '<span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-500 rounded-full">Inativo</span>';
            
            const keywords = (m.palavras_chave || []).slice(0, 3).map(k => 
                `<span class="keyword-pill">${k}</span>`
            ).join('');
            
            const categoriaBadge = mostrarCategoria && m.categoria 
                ? `<span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded">${m.categoria}${m.subcategoria ? '/' + m.subcategoria : ''}</span>` 
                : '';

            return `
                <div class="px-4 py-3 hover:bg-gray-50 flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-gray-800">${m.titulo}</span>
                            ${statusBadge}
                            ${categoriaBadge}
                            <span class="text-xs text-gray-400">v${m.versao}</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <span class="font-mono text-xs bg-gray-100 px-1 rounded">${m.nome}</span>
                            ${keywords ? `<span class="text-gray-300">|</span> ${keywords}` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="editarModulo(${m.id})" class="px-3 py-1.5 text-sm text-primary-600 hover:bg-primary-50 rounded-lg">
                            <i class="fas fa-edit mr-1"></i> Editar
                        </button>
                        <button onclick="verModulo(${m.id})" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-eye mr-1"></i> Ver
                        </button>
                        <button onclick="excluirModulo(${m.id}, '${m.titulo.replace(/'/g, "\\'")}')" class="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg">
                            <i class="fas fa-trash mr-1"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function toggleCategoria(catId) {
            const conteudo = document.getElementById(catId);
            const icon = document.getElementById('icon-' + catId);
            
            if (conteudo.style.display === 'none') {
                conteudo.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                conteudo.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }
        
        function expandirTodasCategorias() {
            document.querySelectorAll('.categoria-conteudo').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.categoria-icon').forEach(el => {
                el.style.transform = 'rotate(0deg)';
            });
        }
        
        function recolherTodasCategorias() {
            document.querySelectorAll('.categoria-conteudo').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.categoria-icon').forEach(el => {
                el.style.transform = 'rotate(-90deg)';
            });
        }

        function filtrarModulos() {
            carregarCategorias();
            carregarModulos();
        }

        function criarModulo() {
            moduloAtualId = null;
            keywordsAtuais = [];
            tagsAtuais = [];
            
            document.getElementById('modulo-id').value = '';
            document.getElementById('modulo-tipo').value = 'conteudo';
            document.getElementById('modulo-categoria').value = '';
            document.getElementById('modulo-subcategoria').value = '';
            document.getElementById('modulo-nome').value = '';
            document.getElementById('modulo-titulo').value = '';
            document.getElementById('modulo-condicao-ativacao').value = '';
            document.getElementById('modulo-conteudo').value = '';
            document.getElementById('modulo-ativo').checked = true;
            document.getElementById('modulo-ordem').value = 0;
            const grupoSelect = document.getElementById('modulo-grupo');
            const subgrupoSelect = document.getElementById('modulo-subgrupo');
            const grupoPadrao = gruposCache.length === 1 ? gruposCache[0].id : ''; 
            if (grupoSelect) grupoSelect.value = grupoPadrao;
            if (subgrupoSelect) subgrupoSelect.value = ''; 
            if (grupoPadrao) { 
                carregarSubgruposModulo(grupoPadrao);
            } else {
                carregarSubgruposModulo(null);
            }
            
            document.getElementById('modal-titulo').textContent = 'Criar Novo Módulo';
            document.getElementById('modal-subtitulo').textContent = '';
            document.getElementById('motivo-container').classList.add('hidden');
            document.getElementById('btn-historico').classList.add('hidden');
            document.getElementById('versao-info').textContent = '';
            
            // Mostra/esconde campo de condição baseado no tipo
            toggleCondicaoAtivacao();
            
            renderizarKeywords();
            renderizarTags();
            
            document.getElementById('modal-editor').classList.remove('hidden');
        }
        
        function toggleCondicaoAtivacao() {
            const tipo = document.getElementById('modulo-tipo').value;
            const container = document.getElementById('condicao-ativacao-container');
            const grupoContainer = document.getElementById('grupo-conteudo-container');

            // Condio de ativao s faz sentido para tipo 'conteudo'
            if (tipo === 'conteudo') {
                container.classList.remove('hidden');
                if (grupoContainer) {
                    grupoContainer.classList.remove('hidden');
                }
            } else {
                container.classList.add('hidden');
                if (grupoContainer) {
                    grupoContainer.classList.add('hidden');
                }
                const grupoSelect = document.getElementById('modulo-grupo');
                const subgrupoSelect = document.getElementById('modulo-subgrupo');
                if (grupoSelect) grupoSelect.value = '';
                if (subgrupoSelect) subgrupoSelect.value = '';
            }
        }
        
        // Adiciona listener para mudança de tipo
        document.getElementById('modulo-tipo').addEventListener('change', toggleCondicaoAtivacao);

        const moduloGrupoSelect = document.getElementById('modulo-grupo');
        if (moduloGrupoSelect) {
            moduloGrupoSelect.addEventListener('change', (e) => {
                carregarSubgruposModulo(e.target.value);
            });
        }


        async function editarModulo(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Módulo não encontrado');
                
                const modulo = await response.json();
                moduloAtualId = modulo.id;
                keywordsAtuais = modulo.palavras_chave || [];
                tagsAtuais = modulo.tags || [];
                
                document.getElementById('modulo-id').value = modulo.id;
                document.getElementById('modulo-tipo').value = modulo.tipo;
                document.getElementById('modulo-categoria').value = modulo.categoria || '';
                document.getElementById('modulo-subcategoria').value = modulo.subcategoria || '';
                document.getElementById('modulo-nome').value = modulo.nome;
                document.getElementById('modulo-titulo').value = modulo.titulo;
                document.getElementById('modulo-condicao-ativacao').value = modulo.condicao_ativacao || '';
                document.getElementById('modulo-conteudo').value = modulo.conteudo;
                document.getElementById('modulo-ativo').checked = modulo.ativo;
                document.getElementById('modulo-ordem').value = modulo.ordem || 0;
                document.getElementById('modulo-motivo').value = '';
                const grupoSelect = document.getElementById('modulo-grupo');
                const subgrupoSelect = document.getElementById('modulo-subgrupo');
                if (grupoSelect) grupoSelect.value = modulo.group_id || ''; 
                if (subgrupoSelect) subgrupoSelect.value = ''; 
                await carregarSubgruposModulo(modulo.group_id, modulo.subgroup_id);
                
                document.getElementById('modal-titulo').textContent = 'Editar Módulo';
                document.getElementById('modal-subtitulo').textContent = modulo.titulo;
                document.getElementById('motivo-container').classList.remove('hidden');
                document.getElementById('btn-historico').classList.remove('hidden');
                document.getElementById('versao-info').textContent = `Versão ${modulo.versao} • Atualizado em ${new Date(modulo.atualizado_em).toLocaleString('pt-BR')}`;
                
                // Mostra/esconde campo de condição baseado no tipo
                toggleCondicaoAtivacao();
                
                renderizarKeywords();
                renderizarTags();
                
                document.getElementById('modal-editor').classList.remove('hidden');
            } catch (error) {
                alert('Erro ao carregar módulo: ' + error.message);
            }
        }

        function verModulo(id) {
            editarModulo(id); // Abre o editor (depois pode criar view somente leitura)
        }

        async function salvarModulo() {
            const id = document.getElementById('modulo-id').value;
            const isNovo = !id;
            const tipo = document.getElementById('modulo-tipo').value;
            const grupoId = document.getElementById('modulo-grupo').value;
            const subgrupoId = document.getElementById('modulo-subgrupo').value;
            
            const dados = {
                tipo: tipo,
                categoria: document.getElementById('modulo-categoria').value || null,
                subcategoria: document.getElementById('modulo-subcategoria').value || null,
                nome: document.getElementById('modulo-nome').value,
                titulo: document.getElementById('modulo-titulo').value,
                condicao_ativacao: tipo === 'conteudo' ? (document.getElementById('modulo-condicao-ativacao').value || null) : null,
                conteudo: document.getElementById('modulo-conteudo').value,
                palavras_chave: keywordsAtuais,
                tags: tagsAtuais,
                ativo: document.getElementById('modulo-ativo').checked,
                ordem: parseInt(document.getElementById('modulo-ordem').value) || 0,
                group_id: tipo === 'conteudo' ? (grupoId ? parseInt(grupoId) : null) : null,
                subgroup_id: tipo === 'conteudo' ? (subgrupoId ? parseInt(subgrupoId) : null) : null
            };
            
            if (tipo === 'conteudo' && !grupoId) {
                alert('Selecione o grupo do mdulo de contedo');
                document.getElementById('modulo-grupo').focus();
                return;
            }

            if (!isNovo) {
                dados.motivo = document.getElementById('modulo-motivo').value;
                if (!dados.motivo) {
                    alert('Por favor, informe o motivo da alteração');
                    document.getElementById('modulo-motivo').focus();
                    return;
                }
            }
            
            try {
                const response = await fetch(isNovo ? API_BASE : `${API_BASE}/${id}`, {
                    method: isNovo ? 'POST' : 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }
                
                fecharEditor();
                carregarModulos();
                alert(isNovo ? 'Módulo criado com sucesso!' : 'Módulo atualizado com sucesso!');
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function excluirModulo(id, titulo) {
            const opcao = confirm(`Excluir "${titulo}"?\n\nEscolha:\n- OK para DESATIVAR (pode reativar depois)\n- Cancele e use Shift+Clique para EXCLUIR PERMANENTEMENTE`);
            
            if (!opcao) return;
            
            // Se Shift estiver pressionado, exclusão permanente
            const permanente = event?.shiftKey;
            
            try {
                const url = permanente ? `${API_BASE}/${id}/permanente` : `${API_BASE}/${id}`;
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }
                
                const result = await response.json();
                carregarModulos();
                alert(result.message);
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        function fecharEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
        }

        // Keywords
        function renderizarKeywords() {
            const container = document.getElementById('keywords-container');
            container.innerHTML = keywordsAtuais.map((kw, i) => `
                <span class="keyword-pill flex items-center gap-1">
                    ${kw}
                    <button type="button" onclick="removerKeyword(${i})" class="text-purple-500 hover:text-purple-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }

        function adicionarKeyword() {
            const input = document.getElementById('nova-keyword');
            const valor = input.value.trim().toLowerCase();
            if (valor && !keywordsAtuais.includes(valor)) {
                keywordsAtuais.push(valor);
                renderizarKeywords();
            }
            input.value = '';
        }

        function removerKeyword(index) {
            keywordsAtuais.splice(index, 1);
            renderizarKeywords();
        }

        // Tags
        function renderizarTags() {
            const container = document.getElementById('tags-container');
            container.innerHTML = tagsAtuais.map((tag, i) => `
                <span class="tag-pill flex items-center gap-1">
                    ${tag}
                    <button type="button" onclick="removerTag(${i})" class="text-blue-500 hover:text-blue-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }

        function adicionarTag() {
            const input = document.getElementById('nova-tag');
            const valor = input.value.trim().toLowerCase();
            if (valor && !tagsAtuais.includes(valor)) {
                tagsAtuais.push(valor);
                renderizarTags();
            }
            input.value = '';
        }

        function removerTag(index) {
            tagsAtuais.splice(index, 1);
            renderizarTags();
        }

        // Histórico
        async function verHistorico() {
            if (!moduloAtualId) return;
            
            document.getElementById('modal-historico').classList.remove('hidden');
            document.getElementById('historico-lista').innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/${moduloAtualId}/historico`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                const historico = await response.json();
                
                if (historico.length === 0) {
                    document.getElementById('historico-lista').innerHTML = '<div class="text-center py-8 text-gray-400">Nenhuma versão anterior</div>';
                    return;
                }
                
                document.getElementById('historico-lista').innerHTML = historico.map(h => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-800">Versão ${h.versao}</span>
                            <span class="text-sm text-gray-500">${new Date(h.alterado_em).toLocaleString('pt-BR')}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${h.motivo || 'Sem descrição'}</p>
                        <div class="text-xs text-gray-400">${h.diff_resumo || ''}</div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="restaurarVersao(${h.versao})" class="px-3 py-1 text-sm text-orange-600 bg-orange-50 rounded hover:bg-orange-100">
                                <i class="fas fa-undo mr-1"></i> Restaurar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('historico-lista').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar histórico</div>';
            }
        }

        function fecharHistorico() {
            document.getElementById('modal-historico').classList.add('hidden');
        }

        async function restaurarVersao(versao) {
            const motivo = prompt('Motivo da restauração:');
            if (!motivo) return;
            
            try {
                const response = await fetch(`${API_BASE}/${moduloAtualId}/restaurar/${versao}?motivo=${encodeURIComponent(motivo)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Erro ao restaurar');
                
                alert('Versão restaurada com sucesso!');
                fecharHistorico();
                fecharEditor();
                carregarModulos();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function exportarTodos() {
            try {
                const response = await fetch(`${API_BASE}/exportar/todos`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompts_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            } catch (error) {
                alert('Erro ao exportar: ' + error.message);
            }
        }

        // ==========================================
        // Funções de Importação
        // ==========================================
        
        let modulosParaImportar = [];
        
        function abrirModalImportar() {
            // Reset do modal
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('preview-importacao').classList.add('hidden');
            document.getElementById('resultado-importacao').classList.add('hidden');
            document.getElementById('btn-importar').classList.add('hidden');
            document.getElementById('arquivo-json').value = '';
            document.getElementById('sobrescrever-existentes').checked = false;
            modulosParaImportar = [];
            
            document.getElementById('modal-importar').classList.remove('hidden');
        }
        
        function fecharModalImportar() {
            document.getElementById('modal-importar').classList.add('hidden');
            // Se houve importação, recarrega a lista
            const resultadoSucesso = document.getElementById('resultado-sucesso');
            if (!resultadoSucesso.classList.contains('hidden')) {
                carregarModulos();
            }
        }
        
        // ==========================================
        // Funções de Exportação
        // ==========================================
        
        async function abrirModalExportar() {
            document.getElementById('modal-exportar').classList.remove('hidden');
            await carregarModulosParaExport();
            atualizarContadorExport();
        }
        
        function fecharModalExportar() {
            document.getElementById('modal-exportar').classList.add('hidden');
        }
        
        async function carregarModulosParaExport() {
            try {
                const response = await fetch(`${API_BASE}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar módulos');
                
                modulosExportCache = await response.json();
                
                // Popula categorias no filtro
                const categorias = [...new Set(modulosExportCache.map(m => m.categoria).filter(c => c))];
                const selectCategoria = document.getElementById('export-filtro-categoria');
                selectCategoria.innerHTML = '<option value="">Todas as categorias</option>' +
                    categorias.map(c => `<option value="${c}">${c}</option>`).join('');
                
                renderizarModulosExport(modulosExportCache);
                
            } catch (error) {
                console.error('Erro ao carregar módulos para exportação:', error);
            }
        }
        
        function filtrarModulosExport() {
            const tipo = document.getElementById('export-filtro-tipo').value;
            const categoria = document.getElementById('export-filtro-categoria').value;
            
            let filtrados = modulosExportCache;
            
            if (tipo) {
                filtrados = filtrados.filter(m => m.tipo === tipo);
            }
            if (categoria) {
                filtrados = filtrados.filter(m => m.categoria === categoria);
            }
            
            renderizarModulosExport(filtrados);
        }
        
        function renderizarModulosExport(modulos) {
            const tbody = document.getElementById('lista-modulos-exportar');
            
            if (modulos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-8 text-center text-gray-400">Nenhum módulo encontrado</td></tr>';
                return;
            }
            
            const tipoLabels = {
                'base': '<span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-700">Base</span>',
                'peca': '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">Peça</span>',
                'conteudo': '<span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">Conteúdo</span>'
            };
            
            tbody.innerHTML = modulos.map(m => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2">
                        <input type="checkbox" class="export-checkbox w-4 h-4 text-blue-600 rounded" 
                            data-id="${m.id}" data-tipo="${m.tipo}" onchange="atualizarContadorExport()">
                    </td>
                    <td class="px-3 py-2">
                        <p class="font-medium text-gray-800">${m.titulo}</p>
                        <p class="text-xs text-gray-500">${m.nome}</p>
                    </td>
                    <td class="px-3 py-2">${tipoLabels[m.tipo] || m.tipo}</td>
                    <td class="px-3 py-2">${m.categoria || '-'}</td>
                    <td class="px-3 py-2">${m.subcategoria || '-'}</td>
                </tr>
            `).join('');
        }
        
        function selecionarTodosExport(selecionar) {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => cb.checked = selecionar);
            document.getElementById('export-select-all').checked = selecionar;
            atualizarContadorExport();
        }
        
        function selecionarPorTipo(tipo) {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = cb.dataset.tipo === tipo;
            });
            atualizarContadorExport();
        }
        
        function inverterSelecaoExport() {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => cb.checked = !cb.checked);
            atualizarContadorExport();
        }
        
        function atualizarContadorExport() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const total = checkboxes.length;
            document.getElementById('export-contador').textContent = `${total} selecionado${total !== 1 ? 's' : ''}`;
            document.getElementById('btn-exportar').disabled = total === 0;
            
            // Atualiza info
            if (total > 0) {
                document.getElementById('export-info').textContent = `${total} módulo${total !== 1 ? 's' : ''} será${total !== 1 ? 'ão' : ''} exportado${total !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('export-info').textContent = 'Selecione ao menos um módulo';
            }
        }
        
        async function executarExportacao() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('Selecione ao menos um módulo para exportar');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/exportar/selecionados`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ ids })
                });
                
                if (!response.ok) throw new Error('Erro ao exportar');
                
                const data = await response.json();
                
                // Cria e baixa o arquivo
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompts_modulos_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                fecharModalExportar();
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar módulos');
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-green-500', 'bg-green-50');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-green-500', 'bg-green-50');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-green-500', 'bg-green-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.json')) {
                processarArquivoJson(files[0]);
            } else {
                alert('Por favor, selecione um arquivo .json');
            }
        }
        
        function carregarArquivoJson(event) {
            const file = event.target.files[0];
            if (file) {
                processarArquivoJson(file);
            }
        }
        
        async function processarArquivoJson(file) {
            try {
                const texto = await file.text();
                const dados = JSON.parse(texto);
                
                // Aceita tanto { modulos: [...] } quanto diretamente [...]
                let modulos = dados.modulos || dados;
                if (!Array.isArray(modulos)) {
                    throw new Error('Formato inválido: esperado um array de módulos');
                }
                
                modulosParaImportar = modulos;
                
                // Atualiza nome do arquivo
                document.getElementById('nome-arquivo').textContent = file.name;
                
                // Verifica quais já existem
                await verificarModulosExistentes();
                
                // Mostra preview
                document.getElementById('upload-area').classList.add('hidden');
                document.getElementById('preview-importacao').classList.remove('hidden');
                document.getElementById('btn-importar').classList.remove('hidden');
                
            } catch (error) {
                alert('Erro ao processar arquivo: ' + error.message);
            }
        }
        
        async function verificarModulosExistentes() {
            // Carrega módulos existentes para comparar
            const response = await fetch(`${API_BASE}?apenas_ativos=false`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
            });
            const existentes = await response.json();
            
            // Cria um mapa de módulos existentes por chave única
            const mapaExistentes = new Map();
            existentes.forEach(m => {
                const chave = `${m.tipo}|${m.categoria || ''}|${m.subcategoria || ''}|${m.nome}`;
                mapaExistentes.set(chave, m);
            });
            
            let novos = 0;
            let existentesCount = 0;
            
            const tbody = document.getElementById('lista-modulos-importar');
            tbody.innerHTML = '';
            
            modulosParaImportar.forEach((item, i) => {
                // Normalizar campos
                const tipo_raw = item.tipo || 'conteudo';
                const tipo = tipo_raw.toLowerCase().replace('ú', 'u');
                const nome = item.nome_unico || item.nome || `modulo_${i+1}`;
                const categoria = item.categoria || '';
                const subcategoria = item.subcategoria || '';
                const titulo = item.titulo || nome;
                
                const chave = `${tipo}|${categoria}|${subcategoria}|${nome}`;
                const jaExiste = mapaExistentes.has(chave);
                
                if (jaExiste) {
                    existentesCount++;
                } else {
                    novos++;
                }
                
                tbody.innerHTML += `
                    <tr class="${jaExiste ? 'bg-orange-50' : 'bg-green-50'}">
                        <td class="px-3 py-2">
                            <span class="font-medium">${titulo}</span>
                            <span class="text-xs text-gray-400 block font-mono">${nome}</span>
                        </td>
                        <td class="px-3 py-2 text-gray-600">
                            ${categoria}${subcategoria ? '/' + subcategoria : ''}
                        </td>
                        <td class="px-3 py-2">
                            ${jaExiste 
                                ? '<span class="px-2 py-0.5 text-xs bg-orange-100 text-orange-700 rounded-full">Já existe</span>'
                                : '<span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">Novo</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('total-modulos').textContent = modulosParaImportar.length;
            document.getElementById('novos-modulos').textContent = novos;
            document.getElementById('existentes-modulos').textContent = existentesCount;
        }
        
        function limparArquivo() {
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('preview-importacao').classList.add('hidden');
            document.getElementById('btn-importar').classList.add('hidden');
            document.getElementById('arquivo-json').value = '';
            modulosParaImportar = [];
        }
        
        async function executarImportacao() {
            if (modulosParaImportar.length === 0) {
                alert('Nenhum módulo para importar');
                return;
            }
            
            const sobrescrever = document.getElementById('sobrescrever-existentes').checked;
            
            const btn = document.getElementById('btn-importar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Importando...';
            
            try {
                const response = await fetch(`${API_BASE}/importar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        modulos: modulosParaImportar,
                        sobrescrever_existentes: sobrescrever
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro na importação');
                }
                
                const resultado = await response.json();
                
                // Mostra resultado
                document.getElementById('preview-importacao').classList.add('hidden');
                document.getElementById('btn-importar').classList.add('hidden');
                document.getElementById('resultado-importacao').classList.remove('hidden');
                document.getElementById('resultado-sucesso').classList.remove('hidden');
                
                document.getElementById('res-total').textContent = resultado.total_recebidos;
                document.getElementById('res-criados').textContent = resultado.criados;
                document.getElementById('res-atualizados').textContent = resultado.atualizados;
                document.getElementById('res-ignorados').textContent = resultado.ignorados;
                
                // Mostra erros se houver
                if (resultado.erros && resultado.erros.length > 0) {
                    document.getElementById('resultado-erros').classList.remove('hidden');
                    document.getElementById('lista-erros').innerHTML = resultado.erros
                        .map(e => `<li>${e}</li>`).join('');
                } else {
                    document.getElementById('resultado-erros').classList.add('hidden');
                }
                
            } catch (error) {
                alert('Erro na importação: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload mr-1"></i> Importar Módulos';
            }
        }

        function toggleFullscreen() {
            const textarea = document.getElementById('modulo-conteudo');
            if (textarea.style.position === 'fixed') {
                textarea.style.position = '';
                textarea.style.top = '';
                textarea.style.left = '';
                textarea.style.width = '';
                textarea.style.height = '';
                textarea.style.zIndex = '';
                textarea.rows = 15;
            } else {
                textarea.style.position = 'fixed';
                textarea.style.top = '0';
                textarea.style.left = '0';
                textarea.style.width = '100vw';
                textarea.style.height = '100vh';
                textarea.style.zIndex = '9999';
                textarea.rows = 50;
            }
        }
    </script>
</body>
</html>
