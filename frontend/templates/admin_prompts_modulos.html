<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Prompts - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SortableJS para drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd',
                            300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9',
                            600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .editor-container { font-family: 'Fira Code', 'Monaco', 'Consolas', monospace; }
        .tag-pill { @apply px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700; }

        /* Animações para categorias colapsáveis */
        .categoria-icon {
            transition: transform 0.2s ease-in-out;
        }
        .categoria-conteudo {
            transition: all 0.2s ease-in-out;
        }
        .categoria-grupo:hover > div:first-child {
            filter: brightness(0.97);
        }
        
        /* Estilos para drag & drop */
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebfb;
        }
        .sortable-chosen {
            background: #e3f2fd;
        }
        .sortable-drag {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        /* Combobox pesquisável de variáveis */
        .variable-combobox {
            position: relative;
            flex: 1;
        }
        .variable-combobox-input {
            width: 100%;
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
        }
        .variable-combobox-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .variable-combobox-input.has-value {
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
        }
        .variable-combobox-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 280px;
            overflow-y: auto;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
            display: none;
        }
        .variable-combobox-dropdown.open {
            display: block;
        }
        .variable-combobox-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #f3f4f6;
        }
        .variable-combobox-item:hover, .variable-combobox-item.highlighted {
            background: #eff6ff;
        }
        .variable-combobox-item .slug {
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #1f2937;
        }
        .variable-combobox-item .tipo {
            font-size: 0.65rem;
            color: #6b7280;
            margin-left: 0.5rem;
        }
        .variable-combobox-item .label {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 2px;
        }
        .variable-combobox-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
        }
        .variable-combobox-clear:hover {
            color: #ef4444;
        }
        .variable-combobox-no-results {
            padding: 0.75rem;
            color: #9ca3af;
            font-size: 0.8rem;
            text-align: center;
        }
        .variable-combobox-hint {
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
            color: #6b7280;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6">
            <!-- Linha principal -->
            <div class="flex items-center justify-between h-14">
                <!-- Identidade (esquerda) -->
                <div class="flex items-center gap-3">
                    <a href="/dashboard" class="text-gray-400 hover:text-gray-600 p-1.5 hover:bg-gray-100 rounded transition-colors" title="Voltar">
                        <i class="fas fa-arrow-left text-sm"></i>
                    </a>
                    <div class="h-5 w-px bg-gray-200"></div>
                    <div>
                        <h1 class="text-base font-medium text-gray-800">Prompts</h1>
                    </div>
                </div>

                <!-- Ações (direita) -->
                <div class="flex items-center gap-2">
                    <button onclick="abrirGlossario()" class="px-3 py-1.5 text-xs text-indigo-600 hover:bg-indigo-50 rounded transition-colors" title="Glossário de Conceitos">
                        <i class="fas fa-book mr-1"></i><span class="hidden sm:inline">Glossário</span>
                    </button>
                    <button onclick="abrirModalImportar()" class="px-3 py-1.5 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors" title="Importar">
                        <i class="fas fa-upload mr-1"></i><span class="hidden sm:inline">Importar</span>
                    </button>
                    <button onclick="abrirModalExportar()" class="px-3 py-1.5 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors" title="Exportar">
                        <i class="fas fa-download mr-1"></i><span class="hidden sm:inline">Exportar</span>
                    </button>
                    <button onclick="criarModulo()" class="px-3 py-1.5 text-xs bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors">
                        <i class="fas fa-plus mr-1"></i>Novo Módulo
                    </button>
                </div>
            </div>

            <!-- Navegação secundária -->
            <nav class="flex items-center gap-1 -mb-px">
                <a href="/admin/prompts-modulos" class="px-3 py-2 text-xs font-medium text-primary-600 border-b-2 border-primary-600">
                    Módulos
                </a>
                <a href="/admin/categorias-resumo-json" class="px-3 py-2 text-xs text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors">
                    Categorias
                </a>
                <a href="/admin/variaveis" class="px-3 py-2 text-xs text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors">
                    Variáveis
                </a>
                <a href="/admin/modulos-tipo-peca" class="px-3 py-2 text-xs text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors">
                    Tipos de Peça
                </a>
                <button onclick="abrirModalGrupos()" class="px-3 py-2 text-xs text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors">
                    Grupos
                </button>
                <button onclick="abrirGerenciarSubcategoriasPrincipal()" class="px-3 py-2 text-xs text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors">
                    Assuntos
                </button>
                <button onclick="abrirModalOrdemCategorias()" class="px-3 py-2 text-xs text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 transition-colors">
                    Ordem
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex flex-wrap gap-3 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="busca" placeholder="Buscar por titulo ou conteudo..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        oninput="filtrarModulos()">
                </div>
                <select id="filtro-tipo" class="flex-shrink-0 w-[140px] px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="filtrarModulos()">
                    <option value="">Todos os tipos</option>
                    <option value="base">Base (Sistema)</option>
                    <option value="peca">Peca</option>
                    <option value="conteudo">Conteudo</option>
                </select>
                <select id="filtro-grupo" class="flex-shrink-0 w-[150px] px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="onGrupoChange()">
                    <option value="">Todos os grupos</option>
                </select>
                <select id="filtro-subgrupo" class="flex-shrink-0 w-[160px] px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="filtrarModulos()">
                    <option value="">Todos os subgrupos</option>
                </select>
                <select id="filtro-categoria" class="flex-shrink-0 w-[160px] px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="carregarModulos()">
                    <option value="">Todas as categorias</option>
                </select>
                <!-- Filtro de Assunto com combobox pesquisável (multi-select) -->
                <div class="relative flex-shrink-0 w-[180px]" id="filtro-assunto-container">
                    <div class="relative">
                        <input type="text" id="filtro-assunto-input"
                            placeholder="Todos os assuntos"
                            class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg text-sm bg-white cursor-pointer"
                            onclick="abrirAssuntoDropdown(event)"
                            onkeydown="onAssuntoInputKeydown(event)"
                            readonly
                            autocomplete="off">
                        <button type="button" id="limpar-assunto" onclick="limparFiltroAssunto(event)"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 hidden z-10"
                            title="Limpar filtro">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        <i id="filtro-assunto-chevron" class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                    </div>
                    <div id="filtro-assunto-dropdown"
                        class="absolute top-full left-0 mt-1 w-[280px] bg-white border border-gray-300 rounded-lg shadow-lg z-50 hidden"
                        onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-gray-200 p-2 z-10">
                            <input type="text" id="filtro-assunto-busca"
                                placeholder="Buscar assunto..."
                                class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-primary-500 focus:border-primary-500"
                                oninput="filtrarAssuntosDropdownBusca()"
                                onclick="event.stopPropagation()">
                        </div>
                        <div id="filtro-assunto-lista" class="max-h-[250px] overflow-y-auto py-1">
                            <!-- Items serão inseridos via JS -->
                        </div>
                        <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-2 flex justify-between items-center z-10">
                            <span id="filtro-assunto-count" class="text-xs text-gray-500">0 selecionados</span>
                            <button type="button" onclick="fecharAssuntoDropdown()"
                                class="px-3 py-1 text-xs bg-primary-600 text-white rounded hover:bg-primary-700">
                                Aplicar
                            </button>
                        </div>
                    </div>
                </div>
                <label class="flex-shrink-0 flex items-center gap-2 text-sm text-gray-600 whitespace-nowrap">
                    <input type="checkbox" id="apenas-ativos" checked onchange="filtrarModulos()" class="rounded text-primary-600">
                    Apenas ativos
                </label>
            </div>
        </div>

        <!-- Lista de Módulos -->
        <div id="lista-modulos" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando módulos...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Grupos -->
    <div id="modal-grupos" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">Grupos e Subgrupos de Conteudo</h2>
                    <p class="text-sm text-gray-500">Gerencie os grupos usados nos prompts de conteudo</p>
                </div>
                <button onclick="fecharModalGrupos()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Grupos</h3>
                        <form id="form-grupo" class="space-y-3">
                            <input type="hidden" id="grupo-id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                <input type="text" id="grupo-nome" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                                <input type="text" id="grupo-slug" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                                    <input type="number" id="grupo-ordem" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="0" min="0">
                                </div>
                                <label class="flex items-center gap-2 mt-6 text-sm text-gray-700">
                                    <input type="checkbox" id="grupo-ativo" checked>
                                    Ativo
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" onclick="salvarGrupo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                                    <i class="fas fa-save mr-1"></i> Salvar Grupo
                                </button>
                                <button type="button" onclick="limparGrupoForm()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    Limpar
                                </button>
                            </div>
                        </form>
                        <div id="lista-grupos" class="space-y-2"></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Subgrupos</h3>
                        <div id="subgrupo-grupo-info" class="text-sm text-gray-500">Selecione um grupo para editar subgrupos.</div>
                        <form id="form-subgrupo" class="space-y-3">
                            <input type="hidden" id="subgrupo-id">
                            <input type="hidden" id="subgrupo-grupo-id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                <input type="text" id="subgrupo-nome" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                                <input type="text" id="subgrupo-slug" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                                    <input type="number" id="subgrupo-ordem" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="0" min="0">
                                </div>
                                <label class="flex items-center gap-2 mt-6 text-sm text-gray-700">
                                    <input type="checkbox" id="subgrupo-ativo" checked>
                                    Ativo
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" onclick="salvarSubgrupo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                                    <i class="fas fa-save mr-1"></i> Salvar Subgrupo
                                </button>
                                <button type="button" onclick="limparSubgrupoForm()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    Limpar
                                </button>
                            </div>
                        </form>
                        <div id="lista-subgrupos" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="modal-editor" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col m-4">
            <!-- Header do Modal -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-primary-50 to-blue-50">
                <div>
                    <h2 id="modal-titulo" class="text-lg font-semibold text-gray-800">Editar Módulo</h2>
                    <p id="modal-subtitulo" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="fecharEditor()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Corpo do Modal -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="form-modulo" class="space-y-4">
                    <input type="hidden" id="modulo-id">

                    <!-- Linha 1: Tipo, Categoria, Subcategoria, Assuntos -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                            <select id="modulo-tipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                                <option value="base">Base (Sistema)</option>
                                <option value="peca">Peça</option>
                                <option value="conteudo">Conteúdo</option>
                            </select>
                        </div>
                        <div id="categoria-field-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Categoria
                                <span class="text-xs text-gray-400 ml-1">(agrupa)</span>
                            </label>
                            <input type="text" id="modulo-categoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="Ex: Eventualidade">
                        </div>
                        <div id="subcategoria-field-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Subcategoria
                                <span class="text-xs text-gray-400 ml-1">(organiza)</span>
                            </label>
                            <input type="text" id="modulo-subcategoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="Ex: Cirurgia">
                        </div>
                        <div id="subcategorias-field-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Assuntos
                                <button type="button" onclick="abrirGerenciarSubcategorias()" class="ml-1 text-xs text-primary-600 hover:text-primary-700">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </label>
                            <div id="modulo-subcategorias-container" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg min-h-[38px] max-h-[80px] overflow-y-auto">
                                <div id="modulo-subcategorias-opcoes" class="flex flex-wrap gap-1">
                                    <span class="text-gray-400 text-xs">Selecione um grupo</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha 2: Nome e Título -->
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome (único)</label>
                            <input type="text" id="modulo-nome" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required
                                placeholder="identificador_unico">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                            <input type="text" id="modulo-titulo" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required
                                placeholder="Título legível do módulo">
                        </div>
                    </div>

                    <!-- Linha 3: Grupo e Subgrupo -->
                    <div id="grupo-conteudo-container" class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Grupo</label>
                            <select id="modulo-grupo" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Selecione o grupo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subgrupo</label>
                            <select id="modulo-subgrupo" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Sem subgrupo</option>
                            </select>
                        </div>
                    </div>

                    <!-- SEÇÃO: CONTEÚDO DO MÓDULO -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-file-alt text-blue-600 text-sm"></i>
                                <span class="font-medium text-blue-800 text-sm">Conteúdo do Módulo</span>
                                <span class="text-xs text-blue-500">(único, independente do modo de ativação)</span>
                            </div>
                            <button type="button" onclick="toggleFullscreen()" class="text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1">
                                <i class="fas fa-expand"></i> Expandir
                            </button>
                        </div>
                        <textarea id="modulo-conteudo" rows="12"
                            class="editor-container w-full px-3 py-2 border border-blue-300 rounded-lg font-mono text-sm resize-y bg-white"
                            placeholder="Digite o conteúdo do prompt aqui..."></textarea>
                    </div>

                    <!-- SEÇÃO: FORMA DE ATIVAÇÃO (APENAS TIPO CONTEUDO) -->
                    <div id="condicao-ativacao-container" class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-bolt text-amber-500 text-sm"></i>
                            <span class="font-medium text-gray-800 text-sm">Forma de Ativação</span>
                            <span class="text-xs text-gray-500">(define quando este módulo é ativado)</span>
                        </div>

                        <!-- Toggle Modo LLM/Determinístico -->
                        <div class="flex items-center gap-3 mb-3 p-2 bg-white rounded-lg border border-gray-200">
                            <span class="text-xs font-medium text-gray-600">Modo:</span>
                            <div class="flex items-center gap-1 bg-gray-100 rounded-md p-0.5">
                                <button type="button" onclick="selecionarModoAtivacao('llm')" id="btn-modo-llm"
                                    class="px-2.5 py-1 text-xs rounded bg-primary-100 text-primary-700 font-medium">
                                    <i class="fas fa-brain mr-1"></i>LLM
                                </button>
                                <button type="button" onclick="selecionarModoAtivacao('deterministic')" id="btn-modo-deterministic"
                                    class="px-2.5 py-1 text-xs rounded text-gray-500 hover:bg-gray-200">
                                    <i class="fas fa-code-branch mr-1"></i>Determinístico
                                </button>
                            </div>
                            <span id="modo-info" class="text-xs text-gray-500">IA avalia a descrição</span>
                        </div>

                        <!-- Modo LLM: Descrição em linguagem natural -->
                        <div id="modo-llm-content">
                            <label class="block text-xs font-medium text-gray-700 mb-1">
                                Condição de Ativação <span class="text-gray-400">(quando este módulo deve ser acionado?)</span>
                            </label>
                            <textarea id="modulo-condicao-ativacao" rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y"
                                placeholder="Ex: 'Quando há medicamento não incorporado ao SUS' ou 'Quando há alegação de dano moral'"></textarea>
                        </div>

                        <!-- Modo Determinístico: Editor de Regras -->
                        <div id="modo-deterministic-content" class="hidden">
                            <!-- Gerar Regra via IA -->
                            <div class="mb-3 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                                <label class="block text-xs font-medium text-blue-700 mb-1.5">
                                    <i class="fas fa-magic mr-1"></i>Gerar Regra via IA
                                </label>
                                <div class="flex gap-2">
                                    <textarea id="regra-linguagem-natural" rows="2"
                                        class="flex-1 px-2 py-1.5 border border-blue-300 rounded text-xs resize-none"
                                        placeholder="Ex: 'O medicamento não está na lista RENAME' ou 'O autor é idoso'"></textarea>
                                    <button type="button" onclick="gerarRegraIA()"
                                        id="btn-gerar-regra-ia"
                                        class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-1 text-xs whitespace-nowrap">
                                        <i class="fas fa-wand-magic-sparkles"></i>Gerar
                                    </button>
                                </div>

                                <!-- Preview da regra gerada -->
                                <div id="preview-regra-gerada" class="hidden mt-2">
                                    <div class="bg-white p-2 rounded border border-blue-200">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-xs font-medium text-gray-700">Regra:</span>
                                            <span id="preview-status" class="text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700">OK</span>
                                        </div>
                                        <div id="preview-regra-conteudo" class="text-xs text-gray-600 mb-2"></div>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="aplicarRegraGerada()"
                                                class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                                <i class="fas fa-check mr-1"></i>Aplicar
                                            </button>
                                            <button type="button" onclick="descartarRegraGerada()"
                                                class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300">
                                                <i class="fas fa-times mr-1"></i>Descartar
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Erros -->
                                <div id="erro-regra-gerada" class="hidden mt-2 p-2 bg-red-50 border border-red-200 rounded">
                                    <div class="flex items-start gap-1.5">
                                        <i class="fas fa-exclamation-circle text-red-500 text-xs mt-0.5"></i>
                                        <div class="flex-1">
                                            <p id="erro-regra-msg" class="text-xs text-red-700"></p>
                                            <div id="variaveis-faltantes" class="mt-1 hidden">
                                                <p class="text-xs text-red-600 font-medium">Variáveis não encontradas:</p>
                                                <div id="lista-variaveis-faltantes" class="space-y-0.5"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-xs text-gray-400 text-center mb-2">— ou configure manualmente —</div>

                            <!-- REGRA PRIMÁRIA -->
                            <div class="mb-4 p-3 border border-indigo-200 rounded-lg bg-indigo-50/30">
                                <label class="block text-xs font-medium text-indigo-700 mb-2">
                                    <i class="fas fa-1 text-indigo-500 mr-1"></i>Regra Primária (Principal)
                                    <span class="font-normal text-gray-500 ml-1">- Baseada no documento fonte (ex: petição inicial)</span>
                                </label>

                                <!-- Visualizador Humanizado Primária -->
                                <div id="regra-humanizada" class="mb-2 p-2 bg-white border border-gray-200 rounded text-xs">
                                    <span class="text-gray-400 italic">Nenhuma regra configurada</span>
                                </div>

                                <!-- Editor de Condições Primária -->
                                <div id="editor-regras" class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs text-gray-600">Operador:</label>
                                        <select id="regra-operador" class="px-2 py-1 border border-gray-300 rounded text-xs"
                                            onchange="atualizarVisualizadorRegra()">
                                            <option value="and">E (AND)</option>
                                            <option value="or">OU (OR)</option>
                                        </select>
                                    </div>

                                    <div id="lista-condicoes" class="space-y-1.5">
                                        <!-- Condições e grupos serão adicionados aqui -->
                                    </div>

                                    <div class="flex gap-2">
                                        <button type="button" onclick="adicionarCondicao()"
                                            class="px-2.5 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-xs">
                                            <i class="fas fa-plus mr-1"></i>Condição
                                        </button>
                                        <button type="button" onclick="adicionarGrupo()"
                                            class="px-2.5 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs"
                                            title="Adicionar grupo de condições">
                                            <i class="fas fa-object-group mr-1"></i>Grupo
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- REGRA SECUNDÁRIA (FALLBACK) -->
                            <div class="mb-3 p-3 border border-amber-200 rounded-lg bg-amber-50/30">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-xs font-medium text-amber-700">
                                        <i class="fas fa-2 text-amber-500 mr-1"></i>Regra Secundária (Fallback)
                                    </label>
                                    <label class="flex items-center gap-1.5 text-xs">
                                        <input type="checkbox" id="fallback-habilitado"
                                            class="w-3.5 h-3.5 text-amber-600 rounded"
                                            onchange="toggleFallback()">
                                        <span class="text-gray-700">Usar Fallback</span>
                                    </label>
                                </div>

                                <!-- Aviso explicativo -->
                                <div class="mb-2 p-2 bg-amber-100/50 border border-amber-200 rounded text-xs text-amber-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>Importante:</strong> A regra secundária só é avaliada se a variável da primária
                                    <strong>NÃO EXISTIR</strong> (documento não identificado). Se a primária existir,
                                    seu valor prevalece mesmo que seja <code class="bg-amber-200 px-1 rounded">false</code> ou <code class="bg-amber-200 px-1 rounded">null</code>.
                                </div>

                                <!-- Conteúdo da regra secundária (colapsável) -->
                                <div id="fallback-content" class="hidden">
                                    <!-- Gerar Regra Secundária via IA -->
                                    <div class="mb-2 p-2 bg-amber-100/50 border border-amber-200 rounded">
                                        <div class="flex gap-2">
                                            <textarea id="regra-secundaria-linguagem-natural" rows="2"
                                                class="flex-1 px-2 py-1.5 border border-amber-300 rounded text-xs resize-none"
                                                placeholder="Ex: 'A contestação menciona competência do juizado'"></textarea>
                                            <button type="button" onclick="gerarRegraSecundariaIA()"
                                                id="btn-gerar-regra-secundaria-ia"
                                                class="px-3 py-1.5 bg-amber-600 text-white rounded hover:bg-amber-700 flex items-center gap-1 text-xs whitespace-nowrap">
                                                <i class="fas fa-wand-magic-sparkles"></i>Gerar
                                            </button>
                                        </div>

                                        <!-- Preview da regra secundária gerada -->
                                        <div id="preview-regra-secundaria-gerada" class="hidden mt-2">
                                            <div class="bg-white p-2 rounded border border-amber-200">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="text-xs font-medium text-gray-700">Regra Secundária:</span>
                                                    <span id="preview-secundaria-status" class="text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700">OK</span>
                                                </div>
                                                <div id="preview-regra-secundaria-conteudo" class="text-xs text-gray-600 mb-2"></div>
                                                <div class="flex gap-2">
                                                    <button type="button" onclick="aplicarRegraSecundariaGerada()"
                                                        class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                                        <i class="fas fa-check mr-1"></i>Aplicar
                                                    </button>
                                                    <button type="button" onclick="descartarRegraSecundariaGerada()"
                                                        class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300">
                                                        <i class="fas fa-times mr-1"></i>Descartar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Visualizador Humanizado Secundária -->
                                    <div id="regra-secundaria-humanizada" class="mb-2 p-2 bg-white border border-gray-200 rounded text-xs">
                                        <span class="text-gray-400 italic">Nenhuma regra secundária configurada</span>
                                    </div>

                                    <!-- Editor de Condições Secundária -->
                                    <div id="editor-regras-secundaria" class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <label class="text-xs text-gray-600">Operador:</label>
                                            <select id="regra-secundaria-operador" class="px-2 py-1 border border-gray-300 rounded text-xs"
                                                onchange="atualizarVisualizadorRegraSecundaria()">
                                                <option value="and">E (AND)</option>
                                                <option value="or">OU (OR)</option>
                                            </select>
                                        </div>

                                        <div id="lista-condicoes-secundaria" class="space-y-1.5">
                                            <!-- Condições secundárias serão adicionadas aqui -->
                                        </div>

                                        <div class="flex gap-2">
                                            <button type="button" onclick="adicionarCondicaoSecundaria()"
                                                class="px-2.5 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200 text-xs">
                                                <i class="fas fa-plus mr-1"></i>Condição
                                            </button>
                                            <button type="button" onclick="adicionarGrupoSecundaria()"
                                                class="px-2.5 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 text-xs"
                                                title="Adicionar grupo de condições">
                                                <i class="fas fa-object-group mr-1"></i>Grupo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- JSON das regras (hidden para backend) -->
                            <input type="hidden" id="modulo-regra-json">
                            <input type="hidden" id="modulo-regra-secundaria-json">
                            <input type="hidden" id="modulo-regra-secundaria-texto-original">
                        </div>
                    </div>

                    <!-- Tags e Status na mesma linha -->
                    <div class="grid grid-cols-3 gap-3 items-end">
                        <!-- Tags -->
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-700 mb-1">
                                <i class="fas fa-tags text-gray-400 mr-1"></i>Tags
                            </label>
                            <div class="flex gap-2">
                                <div id="tags-container" class="flex-1 flex flex-wrap gap-1 px-2 py-1.5 border border-gray-300 rounded-lg min-h-[36px] max-h-[60px] overflow-y-auto">
                                    <!-- Tags renderizadas aqui -->
                                </div>
                                <input type="text" id="nova-tag" placeholder="Nova tag"
                                    class="w-24 px-2 py-1.5 border border-gray-300 rounded-lg text-xs"
                                    onkeypress="if(event.key==='Enter'){event.preventDefault();adicionarTag()}">
                                <button type="button" onclick="adicionarTag()" class="px-2 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-xs">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Status e Ordem -->
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-1.5 text-xs">
                                <input type="checkbox" id="modulo-ativo" checked class="w-3.5 h-3.5 text-primary-600 rounded">
                                <span class="text-gray-700">Ativo</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <label class="text-xs text-gray-600">Ordem:</label>
                                <input type="number" id="modulo-ordem" value="0" min="0"
                                    class="w-14 px-2 py-1 border border-gray-300 rounded text-xs">
                            </div>
                        </div>
                    </div>

                    <!-- Motivo da alteração (apenas para edição) -->
                    <div id="motivo-container" class="hidden">
                        <label class="block text-xs font-medium text-gray-700 mb-1">
                            <i class="fas fa-comment text-orange-400 mr-1"></i>Motivo da alteração <span class="text-gray-400">(opcional)</span>
                        </label>
                        <input type="text" id="modulo-motivo"
                            class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                            placeholder="Ex: Atualização de jurisprudência - Tema 106 STJ">
                    </div>
                </form>
            </div>
            
            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
                <div id="versao-info" class="text-sm text-gray-500"></div>
                <div class="flex gap-3">
                    <button type="button" onclick="fecharEditor()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        Cancelar
                    </button>
                    <button type="button" onclick="verHistorico()" id="btn-historico" class="hidden px-4 py-2 text-purple-600 bg-purple-50 hover:bg-purple-100 rounded-lg">
                        <i class="fas fa-history mr-1"></i> Histórico
                    </button>
                    <button type="button" onclick="salvarModulo()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <i class="fas fa-save mr-1"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico -->
    <div id="modal-historico" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Histórico de Versões</h2>
                <button onclick="fecharHistorico()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="historico-lista" class="space-y-4">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Importação -->
    <div id="modal-importar" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-green-50 to-emerald-50">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-upload text-green-600 mr-2"></i>
                        Importar Módulos de Prompts
                    </h2>
                    <p class="text-sm text-gray-500">Importe módulos a partir de um arquivo JSON</p>
                </div>
                <button onclick="fecharModalImportar()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Área de Upload -->
                <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-500 transition-colors cursor-pointer"
                    onclick="document.getElementById('arquivo-json').click()"
                    ondrop="handleDrop(event)"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)">
                    <input type="file" id="arquivo-json" accept=".json" class="hidden" onchange="carregarArquivoJson(event)">
                    <i class="fas fa-file-upload text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">Arraste um arquivo JSON aqui ou clique para selecionar</p>
                    <p class="text-sm text-gray-400">Formato: arquivo JSON com array "modulos"</p>
                </div>
                
                <!-- Preview do arquivo carregado -->
                <div id="preview-importacao" class="hidden mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">
                            <i class="fas fa-file-code text-green-600 mr-2"></i>
                            <span id="nome-arquivo">arquivo.json</span>
                        </h3>
                        <button onclick="limparArquivo()" class="text-sm text-red-600 hover:text-red-700">
                            <i class="fas fa-trash mr-1"></i> Remover
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <span class="text-2xl font-bold text-green-600" id="total-modulos">0</span>
                                <p class="text-sm text-gray-500">Módulos encontrados</p>
                            </div>
                            <div>
                                <span class="text-2xl font-bold text-blue-600" id="novos-modulos">0</span>
                                <p class="text-sm text-gray-500">Novos</p>
                            </div>
                            <div>
                                <span class="text-2xl font-bold text-orange-600" id="existentes-modulos">0</span>
                                <p class="text-sm text-gray-500">Já existem</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de módulos a importar -->
                    <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">Nome</th>
                                    <th class="px-3 py-2 text-left">Categoria</th>
                                    <th class="px-3 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="lista-modulos-importar" class="divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Opção de sobrescrever -->
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="sobrescrever-existentes" class="mt-1 w-4 h-4 text-yellow-600 rounded">
                            <div>
                                <span class="font-medium text-yellow-800">Sobrescrever módulos existentes</span>
                                <p class="text-sm text-yellow-600">Se marcado, os módulos que já existem serão atualizados com os novos valores. Uma nova versão será criada no histórico.</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Resultado da importação -->
                <div id="resultado-importacao" class="hidden mt-6">
                    <div id="resultado-sucesso" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            Importação concluída!
                        </h4>
                        <div class="mt-3 grid grid-cols-4 gap-4 text-center">
                            <div>
                                <span class="text-xl font-bold text-gray-700" id="res-total">0</span>
                                <p class="text-xs text-gray-500">Recebidos</p>
                            </div>
                            <div>
                                <span class="text-xl font-bold text-green-600" id="res-criados">0</span>
                                <p class="text-xs text-gray-500">Criados</p>
                            </div>
                            <div>
                                <span class="text-xl font-bold text-blue-600" id="res-atualizados">0</span>
                                <p class="text-xs text-gray-500">Atualizados</p>
                            </div>
                            <div>
                                <span class="text-xl font-bold text-gray-400" id="res-ignorados">0</span>
                                <p class="text-xs text-gray-500">Ignorados</p>
                            </div>
                        </div>
                        <!-- Itens criados automaticamente -->
                        <div id="itens-criados-auto" class="hidden mt-4 pt-3 border-t border-green-200">
                            <p class="text-xs text-green-700 font-medium mb-2">
                                <i class="fas fa-magic mr-1"></i> Criados automaticamente:
                            </p>
                            <div class="flex flex-wrap gap-3 text-xs">
                                <span id="res-grupos-criados" class="hidden px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                    <i class="fas fa-folder mr-1"></i> <span class="num">0</span> grupo(s)
                                </span>
                                <span id="res-subgrupos-criados" class="hidden px-2 py-1 bg-indigo-100 text-indigo-700 rounded">
                                    <i class="fas fa-folder-open mr-1"></i> <span class="num">0</span> subgrupo(s)
                                </span>
                                <span id="res-subcategorias-criadas" class="hidden px-2 py-1 bg-amber-100 text-amber-700 rounded">
                                    <i class="fas fa-tags mr-1"></i> <span class="num">0</span> assunto(s)
                                </span>
                            </div>
                        </div>
                    </div>

                    <div id="resultado-erros" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erros encontrados
                        </h4>
                        <ul id="lista-erros" class="mt-2 text-sm text-red-700 list-disc list-inside">
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-end gap-3">
                <button type="button" onclick="fecharModalImportar()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    Fechar
                </button>
                <button type="button" onclick="executarImportacao()" id="btn-importar" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-upload mr-1"></i> Importar Módulos
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Exportação -->
    <div id="modal-exportar" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-download text-blue-600 mr-2"></i>
                        Exportar Módulos de Prompts
                    </h2>
                    <p class="text-sm text-gray-500">Selecione os módulos para exportar em JSON</p>
                </div>
                <button onclick="fecharModalExportar()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Filtros de Exportação -->
                <div class="flex flex-wrap gap-4 items-center mb-4 pb-4 border-b border-gray-200">
                    <select id="export-filtro-tipo" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filtrarModulosExport()">
                        <option value="">Todos os tipos</option>
                        <option value="base">Base (Sistema)</option>
                        <option value="peca">Peça</option>
                        <option value="conteudo">Conteúdo</option>
                    </select>
                    <select id="export-filtro-categoria" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filtrarModulosExport()">
                        <option value="">Todas as categorias</option>
                    </select>
                    <div class="flex-1"></div>
                    <span id="export-contador" class="text-sm text-gray-500">0 selecionados</span>
                </div>
                
                <!-- Ações em Lote -->
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="selecionarTodosExport(true)" class="px-3 py-1.5 text-sm bg-green-50 text-green-700 rounded-lg hover:bg-green-100">
                        <i class="fas fa-check-double mr-1"></i> Selecionar Todos
                    </button>
                    <button onclick="selecionarTodosExport(false)" class="px-3 py-1.5 text-sm bg-red-50 text-red-700 rounded-lg hover:bg-red-100">
                        <i class="fas fa-times mr-1"></i> Desmarcar Todos
                    </button>
                    <button onclick="selecionarPorTipo('conteudo')" class="px-3 py-1.5 text-sm bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100">
                        <i class="fas fa-puzzle-piece mr-1"></i> Só Conteúdo
                    </button>
                    <button onclick="selecionarPorTipo('peca')" class="px-3 py-1.5 text-sm bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100">
                        <i class="fas fa-file-alt mr-1"></i> Só Peça
                    </button>
                    <button onclick="inverterSelecaoExport()" class="px-3 py-1.5 text-sm bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-exchange-alt mr-1"></i> Inverter
                    </button>
                </div>
                
                <!-- Lista de Módulos para Exportar -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left w-10">
                                        <input type="checkbox" id="export-select-all" onchange="selecionarTodosExport(this.checked)" class="w-4 h-4 text-blue-600 rounded">
                                    </th>
                                    <th class="px-3 py-2 text-left">Título</th>
                                    <th class="px-3 py-2 text-left">Tipo</th>
                                    <th class="px-3 py-2 text-left">Categoria</th>
                                    <th class="px-3 py-2 text-left">Assunto</th>
                                </tr>
                            </thead>
                            <tbody id="lista-modulos-exportar" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="px-3 py-8 text-center text-gray-400">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
                <span id="export-info" class="text-sm text-gray-500"></span>
                <div class="flex items-center gap-3">
                    <button type="button" onclick="fecharModalExportar()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        Cancelar
                    </button>
                    <button type="button" onclick="executarExportacao()" id="btn-exportar" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-download mr-1"></i> Exportar JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ordem das Categorias -->
    <div id="modal-ordem-categorias" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-amber-50">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-sort-amount-down text-amber-500 mr-2"></i>
                    Ordem das Categorias
                </h3>
                <button onclick="fecharModalOrdemCategorias()" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- Seletor de Grupo -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-folder text-gray-400 mr-1"></i>
                        Selecione o Grupo
                    </label>
                    <select id="ordem-grupo-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="carregarOrdemCategorias()">
                        <option value="">Selecione um grupo...</option>
                    </select>
                </div>

                <!-- Info -->
                <div class="mb-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                    <i class="fas fa-info-circle mr-1"></i>
                    Defina a ordem em que as categorias aparecerao no prompt enviado ao gerador de pecas.
                    <br>Menor numero = aparece primeiro.
                </div>

                <!-- Lista de Categorias para ordenar -->
                <div id="ordem-categorias-lista" class="space-y-2 max-h-80 overflow-y-auto">
                    <p class="text-gray-400 text-sm text-center py-4">Selecione um grupo para ver as categorias</p>
                </div>

                <!-- Botoes -->
                <div class="mt-4 flex justify-end gap-2">
                    <button onclick="fecharModalOrdemCategorias()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">
                        Cancelar
                    </button>
                    <button onclick="salvarOrdemCategorias()" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm font-medium">
                        <i class="fas fa-save mr-1"></i> Salvar Ordem
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciar Subcategorias -->
    <div id="modal-subcategorias" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-purple-50">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-tags text-purple-500 mr-2"></i>
                    Gerenciar Assuntos
                </h3>
                <button onclick="fecharGerenciarSubcategorias()" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <!-- Seletor de Grupo -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-folder text-gray-400 mr-1"></i>
                        Selecione o Grupo
                    </label>
                    <select id="subcategorias-grupo-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" onchange="onSubcategoriaGrupoChange()">
                        <option value="">Selecione um grupo...</option>
                    </select>
                </div>

                <!-- Conteudo (aparece quando grupo selecionado) -->
                <div id="subcategorias-conteudo" class="hidden">
                    <!-- Form para criar nova subcategoria -->
                    <form id="form-nova-subcategoria" onsubmit="criarSubcategoria(event)" class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-plus-circle text-green-500 mr-1"></i>
                            Novo Assunto
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <input type="text" id="nova-subcategoria-nome" required placeholder="Nome (ex: Servidor Publico)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" oninput="autoGerarSlugSubcategoria()">
                            </div>
                            <div>
                                <input type="text" id="nova-subcategoria-slug" required placeholder="Slug (ex: servidor_publico)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono">
                            </div>
                            <div>
                                <input type="text" id="nova-subcategoria-descricao" placeholder="Descricao (opcional)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-1"></i> Criar Assunto
                            </button>
                        </div>
                    </form>

                    <!-- Lista de subcategorias existentes -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-list text-gray-400 mr-1"></i>
                            Assuntos Existentes
                            <span id="subcategorias-count" class="text-xs text-gray-400 ml-1"></span>
                        </h4>
                        <div id="lista-subcategorias-gerenciar" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-400 text-sm text-center py-4">Carregando...</p>
                        </div>
                    </div>
                </div>

                <!-- Placeholder quando nenhum grupo selecionado -->
                <div id="subcategorias-placeholder" class="text-center py-8 text-gray-400">
                    <i class="fas fa-hand-pointer text-3xl mb-2"></i>
                    <p>Selecione um grupo acima para gerenciar seus assuntos</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/prompts-modulos';
        let modulosCache = [];
        let modulosExportCache = [];
        let tagsAtuais = [];
        let moduloAtualId = null;
        let gruposCache = [];
        let subgruposCache = [];
        let subcategoriasCache = [];
        let subcategoriasSelecionadas = [];
        let grupoSelecionadoId = null;
        let ordemCategoriasConfig = {}; // Cache da ordem das categorias por grupo
        let salvarOrdemTimeout = null; // Timeout para debounce do salvamento automático
        // Estado do modo de ativação
        let modoAtivacaoAtual = 'llm'; // 'llm' ou 'deterministic'
        let condicoesRegra = []; // Array de condições/grupos para modo determinístico (PRIMÁRIA)
        let condicoesRegraSecundaria = []; // Array de condições/grupos para regra SECUNDÁRIA (fallback)
        let variaveisDisponiveis = []; // Cache de variáveis para autocomplete
        let contadorIdCondicao = 0; // Contador para IDs únicos
        let regraSecundariaGerada = null; // Cache da regra secundária gerada pela IA
        // Estado dos comboboxes de variáveis
        let comboboxAberto = null;
        let comboboxHighlightIndex = -1;
        let comboboxDebounceTimer = null;
        // Estado do filtro de assuntos
        let assuntosFiltroCache = []; // Cache de todos os assuntos para o filtro
        let assuntosSelecionadosFiltro = []; // IDs dos assuntos selecionados no filtro
        let assuntoDropdownAberto = false; // Estado do dropdown de assuntos
        let comboboxSecAberto = null;
        let comboboxSecHighlightIndex = -1;

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            // Carrega dados em paralelo para melhor performance
            await Promise.all([
                carregarVariaveisDisponiveis(),
                carregarModulos(),
                carregarCategorias(),
                carregarGrupos(),
                carregarAssuntosFiltro()
            ]);

            // Fecha dropdown de assuntos ao clicar fora
            document.addEventListener('click', (e) => {
                if (!assuntoDropdownAberto) return;
                const container = document.getElementById('filtro-assunto-container');
                if (container && !container.contains(e.target)) {
                    fecharAssuntoDropdown();
                }
            });

            // Fecha com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && assuntoDropdownAberto) {
                    fecharAssuntoDropdown();
                }
            });
        });

        async function carregarModulos() {
            try {
                const params = new URLSearchParams();
                const tipo = document.getElementById('filtro-tipo').value;
                const grupoId = document.getElementById('filtro-grupo').value;
                const subgrupoId = document.getElementById('filtro-subgrupo').value;
                const categoria = document.getElementById('filtro-categoria').value;
                const busca = document.getElementById('busca').value;
                const apenasAtivos = document.getElementById('apenas-ativos').checked;

                if (tipo) params.append('tipo', tipo);
                if (grupoId) params.append('group_id', grupoId);
                if (subgrupoId) params.append('subgroup_id', subgrupoId);
                if (categoria) params.append('categoria', categoria);
                if (busca) params.append('busca', busca);
                params.append('apenas_ativos', apenasAtivos);

                // Filtro por assuntos (subcategorias)
                if (assuntosSelecionadosFiltro.length > 0) {
                    assuntosSelecionadosFiltro.forEach(id => {
                        params.append('subcategoria_ids', id);
                    });
                }

                const response = await fetch(`${API_BASE}?${params}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar módulos');

                modulosCache = await response.json();

                // Busca ordem das categorias usando grupo selecionado ou inferido
                let grupoOrdemId = null;
                if (grupoId) {
                    grupoOrdemId = parseInt(grupoId, 10);
                    if (Number.isNaN(grupoOrdemId)) {
                        grupoOrdemId = null;
                    }
                }
                if (!grupoOrdemId) {
                    grupoOrdemId = obterGrupoIdParaSalvar();
                }
                if (grupoOrdemId) {
                    await carregarOrdemCategoriasGrupo(grupoOrdemId);
                } else {
                    ordemCategoriasConfig = {};
                }

                renderizarModulos();
            } catch (error) {
                console.error(error);
                document.getElementById('lista-modulos').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar módulos</p>
                    </div>`;
            }
        }

        // Carrega a ordem configurada das categorias para um grupo
        async function carregarOrdemCategoriasGrupo(grupoId) {
            try {
                const response = await fetch(`${API_BASE}/grupos/${grupoId}/categorias-ordem`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    ordemCategoriasConfig = {};
                    (data.categorias || []).forEach(cat => {
                        ordemCategoriasConfig[cat.nome] = cat.ordem;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar ordem das categorias:', error);
            }
        }

        async function carregarCategorias(preservarSelecao = true) {
            try {
                const params = new URLSearchParams();
                const grupoId = document.getElementById('filtro-grupo').value;
                if (grupoId) params.append('group_id', grupoId);

                const response = await fetch(`${API_BASE}/categorias?${params}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                const categorias = await response.json();
                const select = document.getElementById('filtro-categoria');
                const valorAnterior = preservarSelecao ? select.value : '';
                select.innerHTML = '<option value="">Todas as categorias</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
                // Restaura seleção anterior se ainda existir nas opções
                if (valorAnterior && categorias.includes(valorAnterior)) {
                    select.value = valorAnterior;
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }


        async function carregarGrupos() {
            try {
                const response = await fetch(`${API_BASE}/grupos?apenas_ativos=false`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar grupos');

                gruposCache = await response.json();
                atualizarSelectGrupos();
                renderizarGruposModal();

                if (grupoSelecionadoId) {
                    await carregarSubgruposGrupo(grupoSelecionadoId);
                }
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
            }
        }

        function atualizarSelectGrupos() {
            const filtro = document.getElementById('filtro-grupo');
            if (filtro) {
                const valorAtual = filtro.value;
                filtro.innerHTML = '<option value="">Todos os grupos</option>';
                gruposCache.forEach((grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo.id;
                    option.textContent = grupo.name || grupo.nome;
                    filtro.appendChild(option);
                });
                if (valorAtual) {
                    filtro.value = valorAtual;
                }
            }

            const selectModulo = document.getElementById('modulo-grupo');
            if (selectModulo) {
                const valorAtual = selectModulo.value;
                selectModulo.innerHTML = '<option value="">Selecione o grupo</option>';
                gruposCache.forEach((grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo.id;
                    option.textContent = grupo.name || grupo.nome;
                    selectModulo.appendChild(option);
                });
                if (valorAtual) {
                    selectModulo.value = valorAtual;
                }
            }
        }

        function abrirModalGrupos() {
            document.getElementById('modal-grupos').classList.remove('hidden');
            carregarGrupos();
        }

        function fecharModalGrupos() {
            document.getElementById('modal-grupos').classList.add('hidden');
        }

        function limparGrupoForm() {
            document.getElementById('grupo-id').value = '';
            document.getElementById('grupo-nome').value = '';
            document.getElementById('grupo-slug').value = '';
            document.getElementById('grupo-ordem').value = 0;
            document.getElementById('grupo-ativo').checked = true;
        }

        function renderizarGruposModal() {
            const container = document.getElementById('lista-grupos');
            if (!container) return;

            if (!gruposCache.length) {
                container.innerHTML = '<p class="text-sm text-gray-400">Nenhum grupo cadastrado.</p>';
                return;
            }

            container.innerHTML = gruposCache.map((grupo) => {
                const ativo = grupo.active ? 'Ativo' : 'Inativo';
                const ativoClass = grupo.active ? 'text-green-600' : 'text-gray-400';
                return `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${grupo.name}</p>
                            <p class="text-xs text-gray-500">${grupo.slug} - <span class="${ativoClass}">${ativo}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editarGrupo(${grupo.id})" class="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded">Editar</button>
                            <button onclick="selecionarGrupoSubgrupos(${grupo.id})" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Subgrupos</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editarGrupo(id) {
            const grupo = gruposCache.find((g) => g.id === id);
            if (!grupo) return;

            document.getElementById('grupo-id').value = grupo.id;
            document.getElementById('grupo-nome').value = grupo.name || '';
            document.getElementById('grupo-slug').value = grupo.slug || '';
            document.getElementById('grupo-ordem').value = grupo.order || 0;
            document.getElementById('grupo-ativo').checked = grupo.active !== false;
        }

        async function salvarGrupo() {
            const id = document.getElementById('grupo-id').value;
            const payload = {
                name: document.getElementById('grupo-nome').value,
                slug: document.getElementById('grupo-slug').value,
                active: document.getElementById('grupo-ativo').checked,
                order: parseInt(document.getElementById('grupo-ordem').value) || 0
            };

            if (!payload.name || !payload.slug) {
                alert('Informe nome e slug do grupo');
                return;
            }

            try {
                const response = await fetch(id ? `${API_BASE}/grupos/${id}` : `${API_BASE}/grupos`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar grupo');
                }

                limparGrupoForm();
                carregarGrupos();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function selecionarGrupoSubgrupos(id) {
            grupoSelecionadoId = id;
            document.getElementById('subgrupo-grupo-id').value = id;
            const grupo = gruposCache.find((g) => g.id === id);
            const info = document.getElementById('subgrupo-grupo-info');
            if (info) {
                info.textContent = grupo ? `Subgrupos de ${grupo.name}` : 'Subgrupos do grupo selecionado';
            }
            limparSubgrupoForm();
            await carregarSubgruposGrupo(id);
        }

        async function carregarSubgruposGrupo(groupId) {
            if (!groupId) return;

            try {
                const response = await fetch(`${API_BASE}/grupos/${groupId}/subgrupos`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar subgrupos');

                subgruposCache = await response.json();
                renderizarSubgruposModal();
            } catch (error) {
                console.error('Erro ao carregar subgrupos:', error);
            }
        }

        function renderizarSubgruposModal() {
            const container = document.getElementById('lista-subgrupos');
            if (!container) return;

            if (!grupoSelecionadoId) {
                container.innerHTML = '<p class="text-sm text-gray-400">Selecione um grupo.</p>';
                return;
            }

            if (!subgruposCache.length) {
                container.innerHTML = '<p class="text-sm text-gray-400">Nenhum subgrupo cadastrado.</p>';
                return;
            }

            container.innerHTML = subgruposCache.map((subgrupo) => {
                const ativo = subgrupo.active ? 'Ativo' : 'Inativo';
                const ativoClass = subgrupo.active ? 'text-green-600' : 'text-gray-400';
                return `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${subgrupo.name}</p>
                            <p class="text-xs text-gray-500">${subgrupo.slug} - <span class="${ativoClass}">${ativo}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editarSubgrupo(${subgrupo.id})" class="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded">Editar</button>
                            <button onclick="deletarSubgrupo(${subgrupo.id}, '${subgrupo.name.replace(/'/g, "\\'")}')" class="px-2 py-1 text-xs bg-red-50 text-red-600 rounded hover:bg-red-100">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editarSubgrupo(id) {
            const subgrupo = subgruposCache.find((s) => s.id === id);
            if (!subgrupo) return;

            document.getElementById('subgrupo-id').value = subgrupo.id;
            document.getElementById('subgrupo-nome').value = subgrupo.name || '';
            document.getElementById('subgrupo-slug').value = subgrupo.slug || '';
            document.getElementById('subgrupo-ordem').value = subgrupo.order || 0;
            document.getElementById('subgrupo-ativo').checked = subgrupo.active !== false;
        }

        async function deletarSubgrupo(id, nome) {
            // Primeira confirmação
            if (!confirm(`Deseja deletar o subgrupo "${nome}"?`)) {
                return;
            }

            try {
                // Primeiro tenta deletar sem force
                let response = await fetch(`${API_BASE}/subgrupos/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                // Status 409 = Conflito (há módulos usando)
                if (response.status === 409) {
                    const error = await response.json();
                    const detail = error.detail || '';
                    const match = detail.match(/(\d+)/);
                    const numModulos = match ? match[1] : 'alguns';

                    // Pergunta se quer deletar mesmo assim
                    if (!confirm(`ATENÇÃO: ${numModulos} módulo(s) estão usando este subgrupo.\n\nDeseja deletar mesmo assim?\n\nOs módulos serão desvinculados (não excluídos).`)) {
                        return;
                    }

                    // Tenta novamente com force=true
                    response = await fetch(`${API_BASE}/subgrupos/${id}?force=true`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });

                    if (!response.ok) {
                        const forceError = await response.json();
                        throw new Error(forceError.detail || 'Erro ao deletar subgrupo');
                    }
                } else if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao deletar subgrupo');
                }

                const result = await response.json();
                alert(result.message);
                await carregarSubgruposGrupo(grupoSelecionadoId);
                renderizarSubgruposModal();
                limparSubgrupoForm();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function salvarSubgrupo() {
            const groupId = document.getElementById('subgrupo-grupo-id').value;
            if (!groupId) {
                alert('Selecione um grupo antes de salvar subgrupo');
                return;
            }

            const id = document.getElementById('subgrupo-id').value;
            const payload = {
                name: document.getElementById('subgrupo-nome').value,
                slug: document.getElementById('subgrupo-slug').value,
                active: document.getElementById('subgrupo-ativo').checked,
                order: parseInt(document.getElementById('subgrupo-ordem').value) || 0
            };

            if (!payload.name || !payload.slug) {
                alert('Informe nome e slug do subgrupo');
                return;
            }

            try {
                const response = await fetch(id ? `${API_BASE}/subgrupos/${id}` : `${API_BASE}/grupos/${groupId}/subgrupos`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar subgrupo');
                }

                limparSubgrupoForm();
                await carregarSubgruposGrupo(groupId);
                carregarGrupos();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        function limparSubgrupoForm() {
            document.getElementById('subgrupo-id').value = '';
            document.getElementById('subgrupo-nome').value = '';
            document.getElementById('subgrupo-slug').value = '';
            document.getElementById('subgrupo-ordem').value = 0;
            document.getElementById('subgrupo-ativo').checked = true;
        }

        async function carregarSubgruposModulo(groupId, selectedId = null) {
            const select = document.getElementById('modulo-subgrupo');
            if (!select) return;

            select.innerHTML = '<option value="">Sem subgrupo</option>';

            if (!groupId) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/grupos/${groupId}/subgrupos`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) return;

                const subgrupos = await response.json();
                subgrupos.forEach((subgrupo) => {
                    const option = document.createElement('option');
                    option.value = subgrupo.id;
                    option.textContent = subgrupo.name;
                    select.appendChild(option);
                });

                if (selectedId) {
                    select.value = selectedId;
                }
            } catch (error) {
                console.error('Erro ao carregar subgrupos:', error);
            }
        }

        async function carregarSubcategoriasModulo(groupId, selectedIds = []) {
            const container = document.getElementById('modulo-subcategorias-opcoes');
            if (!container) return;

            subcategoriasSelecionadas = selectedIds || [];

            if (!groupId) {
                container.innerHTML = '<span class="text-gray-400 text-sm">Selecione um grupo primeiro</span>';
                subcategoriasCache = [];
                return;
            }

            try {
                const response = await fetch(`/admin/api/prompts-modulos/grupos/${groupId}/subcategorias`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (!response.ok) {
                    container.innerHTML = '<span class="text-gray-400 text-sm">Erro ao carregar</span>';
                    return;
                }

                subcategoriasCache = await response.json();
                renderizarSubcategoriasCheckboxes();
            } catch (error) {
                console.error('Erro ao carregar subcategorias:', error);
                container.innerHTML = '<span class="text-red-400 text-sm">Erro ao carregar assuntos</span>';
            }
        }

        function renderizarSubcategoriasCheckboxes() {
            const container = document.getElementById('modulo-subcategorias-opcoes');
            if (!container) return;

            if (subcategoriasCache.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum assunto cadastrado. <button type="button" onclick="abrirGerenciarSubcategorias()" class="text-primary-600 hover:underline">Criar um</button></span>';
                return;
            }

            container.innerHTML = subcategoriasCache.map(sub => {
                const checked = subcategoriasSelecionadas.includes(sub.id) ? 'checked' : '';
                return `
                    <label class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full border ${checked ? 'border-primary-500 bg-primary-50' : 'border-gray-200 bg-white'} text-sm cursor-pointer hover:border-primary-300 transition-colors">
                        <input type="checkbox" value="${sub.id}" ${checked} onchange="toggleSubcategoria(${sub.id})" class="h-3.5 w-3.5 text-primary-600 rounded border-gray-300">
                        <span class="${checked ? 'text-primary-700' : 'text-gray-700'}">${sub.nome}</span>
                    </label>
                `;
            }).join('');
        }

        function toggleSubcategoria(id) {
            const index = subcategoriasSelecionadas.indexOf(id);
            if (index === -1) {
                subcategoriasSelecionadas.push(id);
            } else {
                subcategoriasSelecionadas.splice(index, 1);
            }
            renderizarSubcategoriasCheckboxes();
        }

        // Funções para gerenciar subcategorias
        let grupoIdParaSubcategorias = null;

        function abrirGerenciarSubcategorias() {
            const grupoId = document.getElementById('modulo-grupo').value;
            if (!grupoId) {
                alert('Selecione um grupo primeiro');
                return;
            }
            grupoIdParaSubcategorias = grupoId;
            abrirModalSubcategorias(grupoId);
        }

        function abrirGerenciarSubcategoriasPrincipal() {
            // Abre o modal e popula o seletor de grupos
            const select = document.getElementById('subcategorias-grupo-select');
            select.innerHTML = '<option value="">Selecione um grupo...</option>';
            gruposCache.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                select.appendChild(option);
            });

            // Pre-seleciona o grupo do filtro se houver
            const grupoFiltro = document.getElementById('filtro-grupo').value;
            if (grupoFiltro) {
                select.value = grupoFiltro;
                onSubcategoriaGrupoChange();
            } else {
                // Esconde conteudo e mostra placeholder
                document.getElementById('subcategorias-conteudo').classList.add('hidden');
                document.getElementById('subcategorias-placeholder').classList.remove('hidden');
            }

            document.getElementById('modal-subcategorias').classList.remove('hidden');
        }

        async function onSubcategoriaGrupoChange() {
            const grupoId = document.getElementById('subcategorias-grupo-select').value;

            if (!grupoId) {
                document.getElementById('subcategorias-conteudo').classList.add('hidden');
                document.getElementById('subcategorias-placeholder').classList.remove('hidden');
                return;
            }

            grupoIdParaSubcategorias = grupoId;

            // Mostra conteudo e esconde placeholder
            document.getElementById('subcategorias-conteudo').classList.remove('hidden');
            document.getElementById('subcategorias-placeholder').classList.add('hidden');

            // Carrega subcategorias do grupo
            await carregarSubcategoriasParaGerenciar(grupoId);
        }

        async function carregarSubcategoriasParaGerenciar(grupoId) {
            try {
                const response = await fetch(`/admin/api/prompts-modulos/grupos/${grupoId}/subcategorias?apenas_ativas=false`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    subcategoriasCache = await response.json();
                }
            } catch (error) {
                console.error('Erro ao carregar subcategorias:', error);
            }
            document.getElementById('nova-subcategoria-nome').value = '';
            document.getElementById('nova-subcategoria-slug').value = '';
            document.getElementById('nova-subcategoria-descricao').value = '';
            renderizarListaSubcategoriasGerenciar();
        }

        function abrirModalSubcategorias(grupoId) {
            grupoIdParaSubcategorias = grupoId;

            // Popula e seleciona o grupo no seletor
            const select = document.getElementById('subcategorias-grupo-select');
            select.innerHTML = '<option value="">Selecione um grupo...</option>';
            gruposCache.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                select.appendChild(option);
            });
            select.value = grupoId;

            // Mostra conteudo
            document.getElementById('subcategorias-conteudo').classList.remove('hidden');
            document.getElementById('subcategorias-placeholder').classList.add('hidden');

            document.getElementById('modal-subcategorias').classList.remove('hidden');
            document.getElementById('nova-subcategoria-nome').value = '';
            document.getElementById('nova-subcategoria-slug').value = '';
            document.getElementById('nova-subcategoria-descricao').value = '';
            renderizarListaSubcategoriasGerenciar();
        }

        function fecharGerenciarSubcategorias() {
            document.getElementById('modal-subcategorias').classList.add('hidden');
        }

        function autoGerarSlugSubcategoria() {
            const nome = document.getElementById('nova-subcategoria-nome').value;
            const slug = nome
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '');
            document.getElementById('nova-subcategoria-slug').value = slug;
        }

        async function criarSubcategoria(event) {
            event.preventDefault();
            const grupoId = grupoIdParaSubcategorias;
            if (!grupoId) {
                alert('Nenhum grupo selecionado');
                return;
            }
            const nome = document.getElementById('nova-subcategoria-nome').value.trim();
            const slug = document.getElementById('nova-subcategoria-slug').value.trim();
            const descricao = document.getElementById('nova-subcategoria-descricao').value.trim();

            if (!nome || !slug) {
                alert('Nome e slug sao obrigatorios');
                return;
            }

            try {
                const response = await fetch(`/admin/api/prompts-modulos/grupos/${grupoId}/subcategorias`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome, slug, descricao: descricao || null })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao criar assunto');
                }

                document.getElementById('nova-subcategoria-nome').value = '';
                document.getElementById('nova-subcategoria-slug').value = '';
                document.getElementById('nova-subcategoria-descricao').value = '';

                // Recarrega subcategorias
                await carregarSubcategoriasParaGerenciar(grupoId);

                // Se o modal de módulo estiver aberto, atualiza também
                const moduloGrupoId = document.getElementById('modulo-grupo')?.value;
                if (moduloGrupoId === grupoId) {
                    await carregarSubcategoriasModulo(grupoId, subcategoriasSelecionadas);
                }
            } catch (error) {
                alert(error.message);
            }
        }

        async function excluirSubcategoria(id) {
            if (!confirm('Deseja realmente excluir este assunto?')) return;

            const grupoId = grupoIdParaSubcategorias;

            try {
                const response = await fetch(`/admin/api/prompts-modulos/subcategorias/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir assunto');
                }

                // Remove da seleção se estava selecionada
                subcategoriasSelecionadas = subcategoriasSelecionadas.filter(s => s !== id);

                // Recarrega subcategorias
                await carregarSubcategoriasParaGerenciar(grupoId);

                // Se o modal de módulo estiver aberto, atualiza também
                const moduloGrupoId = document.getElementById('modulo-grupo')?.value;
                if (moduloGrupoId === grupoId) {
                    await carregarSubcategoriasModulo(grupoId, subcategoriasSelecionadas);
                }
            } catch (error) {
                alert(error.message);
            }
        }

        function renderizarListaSubcategoriasGerenciar() {
            const container = document.getElementById('lista-subcategorias-gerenciar');
            const countEl = document.getElementById('subcategorias-count');
            if (!container) return;

            // Atualiza contador
            if (countEl) {
                countEl.textContent = `(${subcategoriasCache.length})`;
            }

            if (subcategoriasCache.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Nenhum assunto cadastrado</p>';
                return;
            }

            container.innerHTML = subcategoriasCache.map(sub => {
                const ativoClass = sub.active !== false ? 'bg-gray-50' : 'bg-red-50 opacity-60';
                const ativoLabel = sub.active !== false ? '' : '<span class="text-xs text-red-500 ml-1">(inativo)</span>';
                return `
                <div class="flex items-center justify-between p-2 ${ativoClass} rounded-lg">
                    <div>
                        <span class="text-sm font-medium text-gray-700">${sub.nome}</span>${ativoLabel}
                        <span class="text-xs text-gray-400 ml-2 font-mono">${sub.slug}</span>
                    </div>
                    <button type="button" onclick="excluirSubcategoria(${sub.id})" class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded" title="Excluir">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
            `}).join('');
        }

        function renderizarModulos() {
            const container = document.getElementById('lista-modulos');
            
            if (modulosCache.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Nenhum módulo encontrado</p>
                        <button onclick="criarModulo()" class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg">
                            Criar primeiro módulo
                        </button>
                    </div>`;
                return;
            }

            // Agrupa por tipo
            const grupos = { base: [], peca: [], conteudo: [] };
            modulosCache.forEach(m => {
                if (grupos[m.tipo]) grupos[m.tipo].push(m);
            });

            const tipoLabels = {
                base: { icon: 'fa-cog', label: 'Base (Prompt do Sistema)', color: 'indigo' },
                peca: { icon: 'fa-file-alt', label: 'Peças (Estrutura/Template)', color: 'green' },
                conteudo: { icon: 'fa-lightbulb', label: 'Conteúdo (Teses e Argumentos)', color: 'orange' }
            };

            let html = '';
            for (const [tipo, modulos] of Object.entries(grupos)) {
                if (modulos.length === 0) continue;
                
                const info = tipoLabels[tipo];
                
                // Para tipo 'conteudo', agrupa por categoria
                if (tipo === 'conteudo') {
                    html += renderizarConteudoPorCategoria(modulos, info);
                } else {
                    html += renderizarGrupoSimples(tipo, modulos, info);
                }
            }

            container.innerHTML = html;
        }
        
        function renderizarGrupoSimples(tipo, modulos, info) {
            let html = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-${info.color}-50 border-b border-${info.color}-100">
                        <h3 class="font-semibold text-${info.color}-800 flex items-center gap-2">
                            <i class="fas ${info.icon}"></i>
                            ${info.label} (${modulos.length})
                        </h3>
                    </div>
                    <div class="divide-y divide-gray-100">
            `;

            modulos.forEach(m => {
                html += renderizarItemModulo(m);
            });

            html += '</div></div>';
            return html;
        }
        
        function renderizarConteudoPorCategoria(modulos, info) {
            // Agrupa módulos de conteúdo por categoria
            const categorias = {};
            modulos.forEach(m => {
                const cat = m.categoria || 'Sem Categoria';
                if (!categorias[cat]) {
                    categorias[cat] = [];
                }
                categorias[cat].push(m);
            });
            
            // Ordena categorias pela ordem configurada, ou alfabeticamente se não houver ordem
            const categoriasOrdenadas = Object.keys(categorias).sort((a, b) => {
                if (a === 'Sem Categoria') return 1;
                if (b === 'Sem Categoria') return -1;

                // Usa ordem configurada se disponível
                const ordemA = ordemCategoriasConfig[a];
                const ordemB = ordemCategoriasConfig[b];

                // Se ambas têm ordem configurada, ordena por ordem
                if (ordemA !== undefined && ordemB !== undefined) {
                    return ordemA - ordemB;
                }
                // Se apenas uma tem ordem, ela vem primeiro
                if (ordemA !== undefined) return -1;
                if (ordemB !== undefined) return 1;

                // Fallback: ordem alfabética
                return a.localeCompare(b, 'pt-BR');
            });
            
            let html = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-${info.color}-50 border-b border-${info.color}-100 flex items-center justify-between">
                        <h3 class="font-semibold text-${info.color}-800 flex items-center gap-2">
                            <i class="fas ${info.icon}"></i>
                            ${info.label} (${modulos.length})
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="expandirTodasCategorias()" class="px-2 py-1 text-xs text-${info.color}-700 hover:bg-${info.color}-100 rounded">
                                <i class="fas fa-expand-alt mr-1"></i> Expandir todas
                            </button>
                            <button onclick="recolherTodasCategorias()" class="px-2 py-1 text-xs text-${info.color}-700 hover:bg-${info.color}-100 rounded">
                                <i class="fas fa-compress-alt mr-1"></i> Recolher todas
                            </button>
                        </div>
                    </div>
                    <div id="categorias-container" class="divide-y divide-gray-100">
            `;
            
            // Cores para subcategorias
            const coresCategoria = [
                'blue', 'purple', 'teal', 'pink', 'cyan', 'amber', 'lime', 'rose', 'indigo', 'emerald'
            ];
            
            categoriasOrdenadas.forEach((cat, idx) => {
                const modulosCat = categorias[cat];
                const corCategoria = coresCategoria[idx % coresCategoria.length];
                const catId = `cat-${cat.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // Ordena por campo ordem
                modulosCat.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
                
                // Agrupa por subcategoria dentro da categoria
                const subcategorias = {};
                modulosCat.forEach(m => {
                    const subcat = m.subcategoria || 'Geral';
                    if (!subcategorias[subcat]) {
                        subcategorias[subcat] = [];
                    }
                    subcategorias[subcat].push(m);
                });
                
                const subcategoriasOrdenadas = Object.keys(subcategorias).sort((a, b) => {
                    if (a === 'Geral') return -1;
                    if (b === 'Geral') return 1;
                    return a.localeCompare(b, 'pt-BR');
                });
                
                html += `
                    <div class="categoria-grupo categoria-draggable" data-categoria="${cat}">
                        <div class="px-4 py-3 bg-${corCategoria}-50 border-b border-${corCategoria}-100 cursor-pointer hover:bg-${corCategoria}-100 transition-colors flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="drag-handle-categoria text-${corCategoria}-300 hover:text-${corCategoria}-500 cursor-grab" title="Arraste para reordenar categoria">
                                    <i class="fas fa-grip-vertical"></i>
                                </span>
                                <i class="fas fa-chevron-down text-${corCategoria}-500 transition-transform categoria-icon" id="icon-${catId}" onclick="toggleCategoria('${catId}')"></i>
                                <span class="font-medium text-${corCategoria}-800" onclick="toggleCategoria('${catId}')">${cat}</span>
                                <span class="px-2 py-0.5 text-xs bg-${corCategoria}-200 text-${corCategoria}-800 rounded-full">${modulosCat.length} módulos</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-${corCategoria}-600">
                                ${subcategoriasOrdenadas.map(s => `<span class="px-1.5 py-0.5 bg-white/50 rounded">${s}</span>`).join('')}
                            </div>
                        </div>
                        <div class="categoria-conteudo" id="${catId}">
                `;
                
                // Renderiza por subcategoria
                subcategoriasOrdenadas.forEach(subcat => {
                    const modulosSubcat = subcategorias[subcat];
                    const subcatId = `${catId}-${subcat.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    
                    if (subcategoriasOrdenadas.length > 1 || subcat !== 'Geral') {
                        html += `
                            <div class="px-4 py-2 bg-gray-50 border-b border-gray-100">
                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">
                                    <i class="fas fa-folder-open mr-1"></i>${subcat}
                                </span>
                            </div>
                        `;
                    }
                    
                    html += `<div class="prompts-sortable divide-y divide-gray-100" id="${subcatId}" data-categoria="${cat}" data-subcategoria="${subcat}">`;
                    modulosSubcat.forEach(m => {
                        html += renderizarItemModulo(m, false); // Não mostra categoria no badge
                    });
                    html += `</div>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            return html;
        }
        
        function renderizarItemModulo(m, mostrarCategoria = true) {
            const statusBadge = m.ativo
                ? '<span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">Ativo</span>'
                : '<span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-500 rounded-full">Inativo</span>';

            const categoriaBadge = mostrarCategoria && m.categoria
                ? `<span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded">${m.categoria}</span>`
                : '';

            // Badge de modo de ativação (apenas para prompts de conteúdo)
            const modoAtivacaoBadge = m.tipo === 'conteudo'
                ? (m.modo_ativacao === 'deterministic'
                    ? '<span class="px-2 py-0.5 text-xs bg-amber-100 text-amber-700 rounded-full" title="Ativação por regra determinística"><i class="fas fa-cog mr-1"></i>Regra</span>'
                    : '<span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full" title="Ativação por LLM"><i class="fas fa-brain mr-1"></i>LLM</span>')
                : '';

            // Subcategorias associadas (tags minimalistas em roxo)
            const subcatsBadges = (m.subcategorias_nomes && m.subcategorias_nomes.length > 0)
                ? m.subcategorias_nomes.map(n => `<span class="px-1.5 py-0.5 text-[10px] bg-purple-50 text-purple-600 rounded">${n}</span>`).join('')
                : '';

            return `
                <div class="prompt-item px-4 py-3 hover:bg-gray-50 flex items-center justify-between" data-id="${m.id}" data-categoria="${m.categoria || ''}">
                    <div class="drag-handle text-gray-300 hover:text-gray-500 mr-3 cursor-grab" title="Arraste para reordenar">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-gray-800">${m.titulo}</span>
                            ${statusBadge}
                            ${modoAtivacaoBadge}
                            ${categoriaBadge}
                            <span class="text-xs text-gray-400">v${m.versao}</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <span class="font-mono text-xs bg-gray-100 px-1 rounded">${m.nome}</span>
                            ${subcatsBadges}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="editarModulo(${m.id})" class="px-3 py-1.5 text-sm text-primary-600 hover:bg-primary-50 rounded-lg">
                            <i class="fas fa-edit mr-1"></i> Editar
                        </button>
                        <button onclick="verModulo(${m.id})" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-eye mr-1"></i> Ver
                        </button>
                        <button onclick="excluirModulo(${m.id}, '${m.titulo.replace(/'/g, "\\'")}')" class="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg">
                            <i class="fas fa-trash mr-1"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function toggleCategoria(catId) {
            const conteudo = document.getElementById(catId);
            const icon = document.getElementById('icon-' + catId);
            
            if (conteudo.style.display === 'none') {
                conteudo.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                conteudo.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }
        
        function expandirTodasCategorias() {
            document.querySelectorAll('.categoria-conteudo').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.categoria-icon').forEach(el => {
                el.style.transform = 'rotate(0deg)';
            });
        }
        
        function recolherTodasCategorias() {
            document.querySelectorAll('.categoria-conteudo').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.categoria-icon').forEach(el => {
                el.style.transform = 'rotate(-90deg)';
            });
        }

        // ==========================================
        // Drag & Drop - Reordenação de Prompts
        // ==========================================

        let sortableInstances = [];
        let ordemModificada = false;

        function obterGrupoIdParaSalvar() {
            const filtroGrupo = document.getElementById('filtro-grupo');
            const grupoIdRaw = filtroGrupo ? filtroGrupo.value : '';
            const grupoId = parseInt(grupoIdRaw, 10);
            if (!Number.isNaN(grupoId)) {
                return grupoId;
            }

            const gruposConteudo = new Set(
                (modulosCache || [])
                    .filter(modulo => modulo.tipo === 'conteudo' && modulo.group_id)
                    .map(modulo => modulo.group_id)
            );
            if (gruposConteudo.size === 1) {
                return [...gruposConteudo][0];
            }

            return null;
        }
        
        function inicializarSortable() {
            // Limpa instâncias anteriores
            sortableInstances.forEach(instance => instance.destroy());
            sortableInstances = [];
            
            // Inicializa sortable para cada container de prompts
            document.querySelectorAll('.prompts-sortable').forEach(container => {
                const sortable = new Sortable(container, {
                    group: 'prompts',
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: function(evt) {
                        marcarOrdemModificada();
                    }
                });
                sortableInstances.push(sortable);
            });
            
            // Inicializa sortable para categorias
            const categoriasContainer = document.getElementById('categorias-container');
            if (categoriasContainer) {
                const sortableCategorias = new Sortable(categoriasContainer, {
                    group: 'categorias',
                    animation: 150,
                    handle: '.drag-handle-categoria',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: function(evt) {
                        marcarOrdemModificada();
                    }
                });
                sortableInstances.push(sortableCategorias);
            }
        }
        
        function marcarOrdemModificada() {
            ordemModificada = true;
            if (salvarOrdemTimeout) {
                clearTimeout(salvarOrdemTimeout);
            }
            salvarOrdemTimeout = setTimeout(() => {
                salvarOrdemPrompts(true);
            }, 500);
        }
        
        async function salvarOrdemPrompts(silencioso = false) {
            const btnSalvar = document.getElementById('btn-salvar-ordem');
            if (btnSalvar) {
                btnSalvar.disabled = true;
                btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Salvando...';
            }
            
            try {
                const grupoId = obterGrupoIdParaSalvar();
                if (!grupoId) {
                    return;
                }
                
                // Coleta ordem das categorias e prompts
                const categoriasContainer = document.getElementById('categorias-container');
                const categorias = [];
                
                let ordemCategoria = 0;
                categoriasContainer.querySelectorAll('.categoria-draggable').forEach(catEl => {
                    const nomeCategoria = catEl.dataset.categoria;
                    const prompts = [];
                    
                    let ordemPrompt = 0;
                    catEl.querySelectorAll('.prompt-item').forEach(promptEl => {
                        prompts.push({
                            id: parseInt(promptEl.dataset.id),
                            ordem: ordemPrompt++
                        });
                    });
                    
                    categorias.push({
                        nome: nomeCategoria,
                        ordem: ordemCategoria++,
                        prompts: prompts
                    });
                });
                
                const response = await fetch(`${API_BASE}/prompts/reordenar-completo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        group_id: grupoId,
                        categorias: categorias
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao salvar ordem');
                }
                
                const result = await response.json();
                
                ordemModificada = false;
                if (btnSalvar) {
                    btnSalvar.style.display = 'none';
                    btnSalvar.classList.remove('animate-pulse');
                }
                
                if (!silencioso) {
                    mostrarNotificacao(`Ordem salva! ${result.categorias_atualizadas} categorias e ${result.prompts_atualizados} prompts atualizados.`, 'success');
                }
                
            } catch (error) {
                console.error('Erro ao salvar ordem:', error);
                mostrarNotificacao('Erro ao salvar ordem. Tente novamente.', 'error');
            } finally {
                if (btnSalvar) {
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = '<i class="fas fa-save mr-1"></i> Salvar Ordem';
                }
            }
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const cores = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const notif = document.createElement('div');
            notif.className = `fixed bottom-4 right-4 ${cores[tipo]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity`;
            notif.textContent = mensagem;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        
        // Reinicializa sortable após carregar módulos
        const originalRenderizarModulos = renderizarModulos;
        renderizarModulos = function() {
            originalRenderizarModulos();
            setTimeout(inicializarSortable, 100);
        };

        function filtrarModulos() {
            carregarModulos();
        }

        async function onGrupoChange() {
            // Quando o grupo muda, recarrega categorias e subgrupos
            const grupoId = document.getElementById('filtro-grupo').value;
            await carregarCategorias(false);
            await carregarSubgruposFiltro(grupoId);
            carregarModulos();
        }

        async function carregarSubgruposFiltro(grupoId) {
            const select = document.getElementById('filtro-subgrupo');
            select.innerHTML = '<option value="">Todos os subgrupos</option>';

            if (!grupoId) return;

            try {
                const response = await fetch(`${API_BASE}/grupos/${grupoId}/subgrupos?apenas_ativos=true`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const subgrupos = await response.json();
                    subgrupos.forEach(sg => {
                        const option = document.createElement('option');
                        option.value = sg.id;
                        option.textContent = sg.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar subgrupos para filtro:', error);
            }
        }

        // ==========================================
        // Funções do Filtro de Assuntos (Subcategorias)
        // ==========================================

        // Carrega todos os assuntos para o filtro
        async function carregarAssuntosFiltro() {
            try {
                const response = await fetch(`${API_BASE}/subcategorias?apenas_ativas=true`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    assuntosFiltroCache = await response.json();
                }
            } catch (error) {
                console.error('Erro ao carregar assuntos para filtro:', error);
            }
        }

        // Renderiza lista de assuntos no dropdown
        function renderizarAssuntosFiltro(filtro = '') {
            const lista = document.getElementById('filtro-assunto-lista');
            if (!lista) return;

            const filtroLower = filtro.toLowerCase().trim();
            const assuntosFiltrados = filtroLower
                ? assuntosFiltroCache.filter(a =>
                    a.nome.toLowerCase().includes(filtroLower) ||
                    (a.group_name && a.group_name.toLowerCase().includes(filtroLower))
                )
                : assuntosFiltroCache;

            if (assuntosFiltrados.length === 0) {
                lista.innerHTML = '<div class="px-3 py-4 text-sm text-gray-500 text-center">Nenhum assunto encontrado</div>';
                return;
            }

            // Agrupa por grupo
            const porGrupo = {};
            assuntosFiltrados.forEach(a => {
                const grupo = a.group_name || 'Sem grupo';
                if (!porGrupo[grupo]) porGrupo[grupo] = [];
                porGrupo[grupo].push(a);
            });

            let html = '';
            Object.keys(porGrupo).sort().forEach(grupo => {
                html += `<div class="px-3 py-1.5 text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-100 sticky top-0">${grupo}</div>`;
                porGrupo[grupo].forEach(a => {
                    const isSelected = assuntosSelecionadosFiltro.includes(a.id);
                    html += `
                        <label class="px-3 py-2 text-sm cursor-pointer hover:bg-primary-50 flex items-center gap-2 ${isSelected ? 'bg-primary-100' : ''}"
                               onclick="event.stopPropagation()">
                            <input type="checkbox" ${isSelected ? 'checked' : ''}
                                class="rounded border-gray-300 text-primary-600 focus:ring-primary-500 cursor-pointer"
                                onchange="toggleAssuntoFiltro(${a.id}, event)">
                            <span class="select-none">${a.nome}</span>
                        </label>
                    `;
                });
            });

            lista.innerHTML = html;
            atualizarContadorAssuntos();
        }

        // Atualiza contador de assuntos selecionados
        function atualizarContadorAssuntos() {
            const count = document.getElementById('filtro-assunto-count');
            if (count) {
                const n = assuntosSelecionadosFiltro.length;
                count.textContent = n === 0 ? 'Nenhum selecionado' : `${n} selecionado${n > 1 ? 's' : ''}`;
            }
        }

        // Abre dropdown de assuntos
        function abrirAssuntoDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('filtro-assunto-dropdown');
            const chevron = document.getElementById('filtro-assunto-chevron');
            const btnLimpar = document.getElementById('limpar-assunto');

            if (!assuntoDropdownAberto) {
                dropdown.classList.remove('hidden');
                chevron.classList.add('hidden');
                assuntoDropdownAberto = true;

                // Limpa busca e renderiza
                const buscaInput = document.getElementById('filtro-assunto-busca');
                if (buscaInput) {
                    buscaInput.value = '';
                    buscaInput.focus();
                }
                renderizarAssuntosFiltro();
            }
        }

        // Fecha dropdown de assuntos e aplica filtro
        function fecharAssuntoDropdown() {
            const dropdown = document.getElementById('filtro-assunto-dropdown');
            const chevron = document.getElementById('filtro-assunto-chevron');
            const btnLimpar = document.getElementById('limpar-assunto');

            if (dropdown) {
                dropdown.classList.add('hidden');
                assuntoDropdownAberto = false;

                // Mostra chevron ou botão limpar
                if (assuntosSelecionadosFiltro.length > 0) {
                    chevron.classList.add('hidden');
                    btnLimpar.classList.remove('hidden');
                } else {
                    chevron.classList.remove('hidden');
                    btnLimpar.classList.add('hidden');
                }

                // Aplica filtro ao fechar
                carregarModulos();
            }
        }

        // Filtra assuntos no dropdown via input principal (legado)
        function filtrarAssuntosDropdown() {
            // Não faz nada - usamos o campo de busca dentro do dropdown
        }

        // Filtra assuntos no dropdown via campo de busca interno
        function filtrarAssuntosDropdownBusca() {
            const busca = document.getElementById('filtro-assunto-busca');
            renderizarAssuntosFiltro(busca ? busca.value : '');
        }

        // Trata teclas no input principal
        function onAssuntoInputKeydown(event) {
            if (event.key === 'Escape') {
                fecharAssuntoDropdown();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (!assuntoDropdownAberto) {
                    abrirAssuntoDropdown(event);
                }
            }
        }

        // Seleciona/deseleciona um assunto no filtro (SEM fechar dropdown)
        function toggleAssuntoFiltro(id, event) {
            if (event) event.stopPropagation();

            const idx = assuntosSelecionadosFiltro.indexOf(id);
            if (idx >= 0) {
                assuntosSelecionadosFiltro.splice(idx, 1);
            } else {
                assuntosSelecionadosFiltro.push(id);
            }

            // Atualiza visual
            atualizarInputAssuntoFiltro();
            atualizarContadorAssuntos();

            // Re-renderiza para atualizar checkboxes
            const busca = document.getElementById('filtro-assunto-busca');
            renderizarAssuntosFiltro(busca ? busca.value : '');
        }

        // Atualiza o texto do input com assuntos selecionados
        function atualizarInputAssuntoFiltro() {
            const input = document.getElementById('filtro-assunto-input');
            const btnLimpar = document.getElementById('limpar-assunto');
            const chevron = document.getElementById('filtro-assunto-chevron');

            if (assuntosSelecionadosFiltro.length === 0) {
                input.value = '';
                input.placeholder = 'Todos os assuntos';
                if (!assuntoDropdownAberto) {
                    btnLimpar.classList.add('hidden');
                    chevron.classList.remove('hidden');
                }
            } else {
                const nomes = assuntosSelecionadosFiltro.map(id => {
                    const assunto = assuntosFiltroCache.find(a => a.id === id);
                    return assunto ? assunto.nome : '';
                }).filter(n => n);

                if (nomes.length === 1) {
                    input.value = nomes[0];
                } else if (nomes.length > 0) {
                    input.value = `${nomes[0]} +${nomes.length - 1}`;
                }
                input.placeholder = '';
                if (!assuntoDropdownAberto) {
                    btnLimpar.classList.remove('hidden');
                    chevron.classList.add('hidden');
                }
            }
        }

        // Limpa o filtro de assuntos
        function limparFiltroAssunto(event) {
            if (event) event.stopPropagation();
            assuntosSelecionadosFiltro = [];
            atualizarInputAssuntoFiltro();
            atualizarContadorAssuntos();
            carregarModulos();
        }

        // ==========================================
        // Funções do Modo de Ativação (LLM/Determinístico)
        // ==========================================

        // Carrega variáveis disponíveis para autocomplete
        async function carregarVariaveisDisponiveis() {
            try {
                // Carrega TODAS as variáveis ativas (limit=2000 para garantir)
                const response = await fetch('/admin/api/extraction/variaveis?apenas_ativos=true&limit=2000', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    variaveisDisponiveis = await response.json();
                    console.log(`Carregadas ${variaveisDisponiveis.length} variáveis disponíveis`);
                }
            } catch (error) {
                console.error('Erro ao carregar variáveis:', error);
            }
        }

        // ==========================================
        // Funções do Combobox de Variáveis
        // ==========================================

        // Abre o dropdown do combobox
        function abrirCombobox(condId) {
            // Fecha qualquer combobox aberto antes
            if (comboboxAberto !== null && comboboxAberto !== condId) {
                fecharCombobox(comboboxAberto);
            }
            
            const dropdown = document.getElementById(`combobox-dropdown-${condId}`);
            const input = document.getElementById(`combobox-input-${condId}`);
            
            if (dropdown && input) {
                dropdown.classList.add('open');
                comboboxAberto = condId;
                comboboxHighlightIndex = -1;
                
                // Limpa o input para facilitar a busca (guarda o valor original)
                const selectedSlug = input.dataset.selectedSlug || '';
                if (selectedSlug) {
                    input.dataset.originalValue = input.value;
                    input.value = '';
                    input.classList.remove('has-value');
                }
                
                // Renderiza as primeiras variáveis
                renderizarItensCombobox(condId, '');
            }
        }

        // Fecha o dropdown do combobox
        function fecharCombobox(condId) {
            const dropdown = document.getElementById(`combobox-dropdown-${condId}`);
            const input = document.getElementById(`combobox-input-${condId}`);
            
            if (dropdown) {
                dropdown.classList.remove('open');
            }
            
            // Restaura o valor original se nenhum foi selecionado
            if (input) {
                const selectedSlug = input.dataset.selectedSlug || '';
                if (selectedSlug) {
                    const varInfo = variaveisDisponiveis.find(v => v.slug === selectedSlug);
                    input.value = `${selectedSlug} (${varInfo?.tipo || 'text'})`;
                    input.classList.add('has-value');
                } else if (input.dataset.originalValue) {
                    input.value = '';
                }
            }
            
            if (comboboxAberto === condId) {
                comboboxAberto = null;
            }
        }

        // Filtra as opções do combobox com debounce
        function filtrarCombobox(condId, termo) {
            clearTimeout(comboboxDebounceTimer);
            comboboxDebounceTimer = setTimeout(() => {
                renderizarItensCombobox(condId, termo);
            }, 150);
        }

        // Renderiza os itens filtrados no dropdown
        function renderizarItensCombobox(condId, termo) {
            const container = document.getElementById(`combobox-items-${condId}`);
            if (!container) return;
            
            const termoLower = termo.toLowerCase().trim();
            
            // Filtra variáveis por slug ou label
            let filtradas = variaveisDisponiveis;
            if (termoLower) {
                filtradas = variaveisDisponiveis.filter(v => {
                    const slugMatch = v.slug.toLowerCase().includes(termoLower);
                    const labelMatch = v.label && v.label.toLowerCase().includes(termoLower);
                    return slugMatch || labelMatch;
                });
            }
            
            // Limita a 50 para performance
            const limite = 50;
            const mostradas = filtradas.slice(0, limite);
            
            if (mostradas.length === 0) {
                container.innerHTML = `
                    <div class="variable-combobox-no-results">
                        <i class="fas fa-search mr-1"></i>
                        Nenhuma variável encontrada para "${termo}"
                    </div>`;
                return;
            }
            
            container.innerHTML = mostradas.map((v, idx) => `
                <div class="variable-combobox-item ${idx === comboboxHighlightIndex ? 'highlighted' : ''}"
                    data-slug="${v.slug}"
                    onclick="selecionarVariavelCombobox(${condId}, '${v.slug}')"
                    onmouseenter="comboboxHighlightIndex = ${idx}">
                    <div>
                        <span class="slug">${destacarTermo(v.slug, termoLower)}</span>
                        <span class="tipo">${v.tipo}</span>
                    </div>
                    ${v.label ? `<div class="label">${destacarTermo(v.label, termoLower)}</div>` : ''}
                </div>
            `).join('');
            
            if (filtradas.length > limite) {
                container.innerHTML += `
                    <div class="variable-combobox-hint">
                        <i class="fas fa-ellipsis-h mr-1"></i>
                        +${filtradas.length - limite} variáveis (refine sua busca)
                    </div>`;
            }
        }

        // Destaca o termo buscado no texto
        function destacarTermo(texto, termo) {
            if (!termo) return texto;
            const regex = new RegExp(`(${termo.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return texto.replace(regex, '<mark style="background:#fef08a;padding:0 2px;border-radius:2px;">$1</mark>');
        }

        // Seleciona uma variável do combobox
        function selecionarVariavelCombobox(condId, slug) {
            const input = document.getElementById(`combobox-input-${condId}`);
            const varInfo = variaveisDisponiveis.find(v => v.slug === slug);
            
            if (input && varInfo) {
                input.value = `${slug} (${varInfo.tipo})`;
                input.dataset.selectedSlug = slug;
                input.classList.add('has-value');
            }
            
            // Atualiza a condição
            onVariavelChange(condId, slug);
            
            // Fecha o dropdown
            fecharCombobox(condId);
        }

        // Limpa a seleção do combobox
        function limparCombobox(condId) {
            const input = document.getElementById(`combobox-input-${condId}`);
            if (input) {
                input.value = '';
                input.dataset.selectedSlug = '';
                input.classList.remove('has-value');
            }
            
            // Atualiza a condição
            onVariavelChange(condId, '');
            
            // Re-renderiza a condição
            renderizarCondicoes();
        }

        // Navegação por teclado no combobox
        function navegarCombobox(event, condId) {
            const container = document.getElementById(`combobox-items-${condId}`);
            if (!container) return;
            
            const items = container.querySelectorAll('.variable-combobox-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    comboboxHighlightIndex = Math.min(comboboxHighlightIndex + 1, items.length - 1);
                    atualizarHighlight(items);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    comboboxHighlightIndex = Math.max(comboboxHighlightIndex - 1, 0);
                    atualizarHighlight(items);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (comboboxHighlightIndex >= 0 && items[comboboxHighlightIndex]) {
                        const slug = items[comboboxHighlightIndex].dataset.slug;
                        selecionarVariavelCombobox(condId, slug);
                    }
                    break;
                case 'Escape':
                    fecharCombobox(condId);
                    break;
            }
        }

        // Atualiza a classe de destaque nos itens
        function atualizarHighlight(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('highlighted', idx === comboboxHighlightIndex);
                if (idx === comboboxHighlightIndex) {
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }

        // Fecha combobox ao clicar fora
        document.addEventListener('click', (e) => {
            // Fecha combobox primário
            if (comboboxAberto !== null) {
                const combobox = document.getElementById(`combobox-${comboboxAberto}`);
                if (combobox && !combobox.contains(e.target)) {
                    fecharCombobox(comboboxAberto);
                }
            }
            // Fecha combobox secundário
            if (comboboxSecAberto !== null) {
                const comboboxSec = document.getElementById(`combobox-sec-${comboboxSecAberto}`);
                if (comboboxSec && !comboboxSec.contains(e.target)) {
                    fecharComboboxSecundaria(comboboxSecAberto);
                }
            }
        });

        // Seleciona modo de ativação (LLM ou Determinístico)
        function selecionarModoAtivacao(modo) {
            modoAtivacaoAtual = modo;

            const btnLLM = document.getElementById('btn-modo-llm');
            const btnDet = document.getElementById('btn-modo-deterministic');
            const modoInfo = document.getElementById('modo-info');
            const conteudoLLM = document.getElementById('modo-llm-content');
            const conteudoDet = document.getElementById('modo-deterministic-content');

            if (modo === 'llm') {
                btnLLM.className = 'px-3 py-1.5 text-sm rounded-md bg-primary-100 text-primary-700 font-medium';
                btnDet.className = 'px-3 py-1.5 text-sm rounded-md text-gray-500 hover:bg-gray-100';
                modoInfo.textContent = 'A IA avalia a descrição para decidir se ativa este módulo';
                conteudoLLM.classList.remove('hidden');
                conteudoDet.classList.add('hidden');
            } else {
                btnLLM.className = 'px-3 py-1.5 text-sm rounded-md text-gray-500 hover:bg-gray-100';
                btnDet.className = 'px-3 py-1.5 text-sm rounded-md bg-indigo-100 text-indigo-700 font-medium';
                modoInfo.textContent = 'Regras baseadas em variáveis extraídas determinam a ativação';
                conteudoLLM.classList.add('hidden');
                conteudoDet.classList.remove('hidden');
                renderizarCondicoes();
            }
        }

        // Gera ID único para condições/grupos
        function gerarIdUnico() {
            return ++contadorIdCondicao;
        }

        // Adiciona uma nova condição ao editor de regras (no nível raiz ou dentro de um grupo)
        function adicionarCondicao(grupoId = null) {
            const novaCondicao = {
                type: 'condition',
                id: gerarIdUnico(),
                variavel: '',
                operador: 'equals',
                valor: ''
            };
            
            if (grupoId !== null) {
                // Adiciona dentro de um grupo
                const grupo = encontrarItemPorId(condicoesRegra, grupoId);
                if (grupo && grupo.type === 'group') {
                    grupo.conditions.push(novaCondicao);
                }
            } else {
                // Adiciona no nível raiz
                condicoesRegra.push(novaCondicao);
            }
            renderizarCondicoes();
        }

        // Adiciona um novo grupo de condições
        function adicionarGrupo(grupoId = null) {
            const novoGrupo = {
                type: 'group',
                id: gerarIdUnico(),
                operador: 'or', // Por padrão o grupo interno é OR (para A AND (B OR C))
                conditions: []
            };
            
            if (grupoId !== null) {
                // Adiciona dentro de outro grupo (subgrupo)
                const grupoPai = encontrarItemPorId(condicoesRegra, grupoId);
                if (grupoPai && grupoPai.type === 'group') {
                    grupoPai.conditions.push(novoGrupo);
                }
            } else {
                // Adiciona no nível raiz
                condicoesRegra.push(novoGrupo);
            }
            renderizarCondicoes();
        }

        // Encontra um item (condição ou grupo) por ID, recursivamente
        function encontrarItemPorId(items, id) {
            for (const item of items) {
                if (item.id === id) return item;
                if (item.type === 'group' && item.conditions) {
                    const found = encontrarItemPorId(item.conditions, id);
                    if (found) return found;
                }
            }
            return null;
        }

        // Remove uma condição ou grupo (recursivamente)
        function removerCondicao(id, parentArray = null) {
            const array = parentArray || condicoesRegra;
            const idx = array.findIndex(c => c.id === id);
            if (idx !== -1) {
                array.splice(idx, 1);
                renderizarCondicoes();
                atualizarVisualizadorRegra();
                return true;
            }
            // Busca em grupos aninhados
            for (const item of array) {
                if (item.type === 'group' && item.conditions) {
                    if (removerCondicao(id, item.conditions)) return true;
                }
            }
            return false;
        }

        // Atualiza uma condição (busca recursivamente)
        function atualizarCondicao(id, campo, valor) {
            const condicao = encontrarItemPorId(condicoesRegra, id);
            if (condicao) {
                condicao[campo] = valor;
                atualizarVisualizadorRegra();
            }
        }

        // Atualiza o operador de um grupo
        function atualizarOperadorGrupo(id, novoOperador) {
            const grupo = encontrarItemPorId(condicoesRegra, id);
            if (grupo && grupo.type === 'group') {
                grupo.operador = novoOperador;
                atualizarVisualizadorRegra();
            }
        }

        // Renderiza as condições e grupos no editor
        function renderizarCondicoes() {
            const container = document.getElementById('lista-condicoes');
            if (!container) return;

            if (condicoesRegra.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-sm italic p-3 bg-gray-50 rounded-lg">
                        Nenhuma condição adicionada. Clique em "Adicionar Condição" ou "Adicionar Grupo" para começar.
                    </div>`;
                atualizarVisualizadorRegra();
                return;
            }

            container.innerHTML = renderizarItens(condicoesRegra, 0);
            atualizarVisualizadorRegra();
        }

        // Renderiza itens recursivamente (condições e grupos)
        function renderizarItens(items, nivel) {
            const operadores = [
                { value: 'equals', label: 'é igual a' },
                { value: 'not_equals', label: 'é diferente de' },
                { value: 'contains', label: 'contém' },
                { value: 'not_contains', label: 'não contém' },
                { value: 'exists', label: 'existe (tem valor)' },
                { value: 'not_exists', label: 'não existe (vazio)' },
                { value: 'greater_than', label: 'é maior que' },
                { value: 'less_than', label: 'é menor que' },
                { value: 'in_list', label: 'está na lista' },
                { value: 'not_in_list', label: 'não está na lista' }
            ];

            return items.map(item => {
                if (item.type === 'group') {
                    return renderizarGrupo(item, nivel, operadores);
                } else {
                    return renderizarCondicaoItem(item, nivel, operadores);
                }
            }).join('');
        }

        // Renderiza um grupo
        function renderizarGrupo(grupo, nivel, operadores) {
            const bgColor = nivel === 0 ? 'bg-purple-50' : 'bg-indigo-50';
            const borderColor = nivel === 0 ? 'border-purple-300' : 'border-indigo-300';
            
            return `
            <div class="p-3 ${bgColor} rounded-lg border-2 ${borderColor} border-dashed" data-id="${grupo.id}" data-type="group">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-object-group text-purple-500"></i>
                        <span class="text-sm font-medium text-purple-700">Grupo</span>
                        <select class="px-2 py-1 text-xs border border-purple-300 rounded bg-white"
                            onchange="atualizarOperadorGrupo(${grupo.id}, this.value)">
                            <option value="and" ${grupo.operador === 'and' ? 'selected' : ''}>AND</option>
                            <option value="or" ${grupo.operador === 'or' ? 'selected' : ''}>OR</option>
                        </select>
                    </div>
                    <button type="button" onclick="removerCondicao(${grupo.id})"
                        class="p-1 text-red-400 hover:text-red-600 hover:bg-red-100 rounded">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
                <div class="space-y-2 ml-4 border-l-2 border-purple-200 pl-3">
                    ${grupo.conditions.length === 0 
                        ? '<p class="text-xs text-gray-400 italic py-2">Grupo vazio - adicione condições</p>'
                        : renderizarItens(grupo.conditions, nivel + 1)
                    }
                </div>
                <div class="mt-2 ml-4 flex gap-2">
                    <button type="button" onclick="adicionarCondicao(${grupo.id})"
                        class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200">
                        <i class="fas fa-plus mr-1"></i> Condição
                    </button>
                    <button type="button" onclick="adicionarGrupo(${grupo.id})"
                        class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs hover:bg-indigo-200">
                        <i class="fas fa-object-group mr-1"></i> Subgrupo
                    </button>
                </div>
            </div>
            `;
        }

        // Renderiza uma condição individual
        function renderizarCondicaoItem(c, nivel, operadores) {
            const varInfo = variaveisDisponiveis.find(v => v.slug === c.variavel);
            const esconderValor = ['exists', 'not_exists'].includes(c.operador);
            const marginLeft = nivel > 0 ? '' : '';
            const displayValue = c.variavel ? `${c.variavel} (${varInfo?.tipo || 'text'})` : '';

            return `
            <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200 ${marginLeft}" data-id="${c.id}" data-type="condition">
                <div class="variable-combobox" id="combobox-${c.id}">
                    <input type="text"
                        class="variable-combobox-input ${c.variavel ? 'has-value' : ''}"
                        id="combobox-input-${c.id}"
                        placeholder="Digite para buscar variável..."
                        value="${displayValue}"
                        data-selected-slug="${c.variavel || ''}"
                        onfocus="abrirCombobox(${c.id})"
                        oninput="filtrarCombobox(${c.id}, this.value)"
                        onkeydown="navegarCombobox(event, ${c.id})"
                        autocomplete="off">
                    ${c.variavel ? `<span class="variable-combobox-clear" onclick="limparCombobox(${c.id})"><i class="fas fa-times text-xs"></i></span>` : ''}
                    <div class="variable-combobox-dropdown" id="combobox-dropdown-${c.id}">
                        <div class="variable-combobox-hint">
                            <i class="fas fa-search mr-1"></i> Digite para filtrar (${variaveisDisponiveis.length} variáveis)
                        </div>
                        <div id="combobox-items-${c.id}"></div>
                    </div>
                </div>
                <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                    onchange="atualizarCondicao(${c.id}, 'operador', this.value); toggleValorCondicao(${c.id}, this.value)">
                    ${operadores.map(op => `
                        <option value="${op.value}" ${c.operador === op.value ? 'selected' : ''}>
                            ${op.label}
                        </option>
                    `).join('')}
                </select>
                <div id="valor-container-${c.id}" class="${esconderValor ? 'hidden' : ''}">
                    ${renderizarCampoValor(c, varInfo)}
                </div>
                <button type="button" onclick="removerCondicao(${c.id})"
                    class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
            `;
        }

        // Renderiza campo de valor baseado no tipo da variavel
        function renderizarCampoValor(condicao, varInfo) {
            const tipo = varInfo?.tipo || 'text';
            const opcoes = varInfo?.opcoes || [];
            const valor = condicao.valor || '';
            const id = condicao.id;

            switch (tipo) {
                case 'boolean':
                    return `
                        <select id="valor-${id}"
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm min-w-[120px]"
                            onchange="atualizarCondicao(${id}, 'valor', this.value)">
                            <option value="">Selecione...</option>
                            <option value="true" ${valor === 'true' || valor === true ? 'selected' : ''}>Sim (true)</option>
                            <option value="false" ${valor === 'false' || valor === false ? 'selected' : ''}>Nao (false)</option>
                        </select>
                    `;

                case 'choice':
                    if (opcoes && opcoes.length > 0) {
                        return `
                            <select id="valor-${id}"
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm min-w-[150px]"
                                onchange="atualizarCondicao(${id}, 'valor', this.value)">
                                <option value="">Selecione...</option>
                                ${opcoes.map(op => `
                                    <option value="${op}" ${valor === op ? 'selected' : ''}>${op}</option>
                                `).join('')}
                            </select>
                        `;
                    }
                    return renderizarInputTexto(id, valor);

                case 'number':
                case 'currency':
                    return `
                        <input type="number"
                            id="valor-${id}"
                            class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            placeholder="${tipo === 'currency' ? 'R$ 0,00' : '0'}"
                            value="${valor}"
                            step="${tipo === 'currency' ? '0.01' : '1'}"
                            onchange="atualizarCondicao(${id}, 'valor', this.value)">
                    `;

                case 'date':
                    return `
                        <input type="date"
                            id="valor-${id}"
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            value="${valor}"
                            onchange="atualizarCondicao(${id}, 'valor', this.value)">
                    `;

                case 'list':
                    if (opcoes && opcoes.length > 0) {
                        const valoresArray = Array.isArray(valor) ? valor : (valor ? valor.split(',') : []);
                        return `
                            <select id="valor-${id}"
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm min-w-[150px]"
                                multiple size="3"
                                onchange="atualizarCondicaoLista(${id}, this)">
                                ${opcoes.map(op => {
                                    const selected = valoresArray.includes(op);
                                    return `<option value="${op}" ${selected ? 'selected' : ''}>${op}</option>`;
                                }).join('')}
                            </select>
                        `;
                    }
                    return renderizarInputTexto(id, valor, 'Valores (virgula)');

                default:
                    return renderizarInputTexto(id, valor);
            }
        }

        // Input texto padrao
        function renderizarInputTexto(id, valor, placeholder = 'Valor') {
            return `
                <input type="text"
                    id="valor-${id}"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm min-w-[150px]"
                    placeholder="${placeholder}"
                    value="${valor}"
                    onchange="atualizarCondicao(${id}, 'valor', this.value)">
            `;
        }

        // Handler para mudanca de variavel (re-renderiza campo de valor)
        function onVariavelChange(id, slug) {
            atualizarCondicao(id, 'variavel', slug);
            // Re-renderiza para atualizar o tipo do campo de valor
            renderizarCondicoes();
        }

        // Handler para lista multi-select
        function atualizarCondicaoLista(id, selectEl) {
            const valores = Array.from(selectEl.selectedOptions).map(opt => opt.value);
            atualizarCondicao(id, 'valor', valores.join(','));
        }

        // Toggle visibilidade do campo de valor (para operadores exists/not_exists)
        function toggleValorCondicao(id, operador) {
            const valorContainer = document.getElementById(`valor-container-${id}`);
            if (valorContainer) {
                if (['exists', 'not_exists'].includes(operador)) {
                    valorContainer.classList.add('hidden');
                    atualizarCondicao(id, 'valor', '');
                } else {
                    valorContainer.classList.remove('hidden');
                }
            }
        }

        // Atualiza o visualizador humanizado da regra
        function atualizarVisualizadorRegra() {
            const container = document.getElementById('regra-humanizada');
            if (!container) return;

            if (condicoesRegra.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm italic">Nenhuma regra configurada</p>';
                document.getElementById('modulo-regra-json').value = '';
                return;
            }

            const operadorPrincipal = document.getElementById('regra-operador')?.value || 'and';

            // Gera visualização humanizada recursiva
            const htmlRegra = gerarVisualizacaoHumanizada(condicoesRegra, operadorPrincipal);
            container.innerHTML = `
                <div class="text-sm">
                    <span class="text-gray-500 mr-2">Ativar quando:</span>
                    ${htmlRegra}
                </div>`;

            // Gera o AST JSON para o backend
            const regraAST = gerarRegraAST(condicoesRegra, operadorPrincipal);
            document.getElementById('modulo-regra-json').value = JSON.stringify(regraAST);
        }

        // Gera visualização humanizada recursiva
        function gerarVisualizacaoHumanizada(items, operador) {
            const operadorTexto = operador === 'and' ? 'E' : 'OU';

            const getOperadorTexto = (op) => {
                const map = {
                    'equals': '=', 'not_equals': '≠', 'contains': 'contém',
                    'not_contains': 'não contém', 'exists': 'existe', 'not_exists': 'não existe',
                    'greater_than': '>', 'less_than': '<', 'in_list': 'em', 'not_in_list': 'não em'
                };
                return map[op] || op;
            };

            const partes = items.map((item, index) => {
                let html = '';
                
                if (item.type === 'group') {
                    const grupoOperadorTexto = item.operador === 'and' ? 'E' : 'OU';
                    const subHtml = gerarVisualizacaoHumanizada(item.conditions || [], item.operador);
                    html = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 rounded border border-purple-300">
                        <span class="text-purple-600 text-xs font-bold">(</span>
                        ${subHtml}
                        <span class="text-purple-600 text-xs font-bold">)</span>
                    </span>`;
                } else {
                    const varInfo = variaveisDisponiveis.find(v => v.slug === item.variavel);
                    const varLabel = varInfo ? `<span class="font-mono text-indigo-600">${item.variavel}</span>` :
                        (item.variavel ? `<span class="font-mono text-gray-600">${item.variavel}</span>` : '<span class="text-red-400">[?]</span>');

                    let valorHtml = '';
                    if (!['exists', 'not_exists'].includes(item.operador)) {
                        valorHtml = item.valor !== undefined && item.valor !== '' 
                            ? `<span class="font-semibold text-green-600">"${item.valor}"</span>` 
                            : '<span class="text-red-400">[?]</span>';
                    }

                    const opTexto = getOperadorTexto(item.operador);
                    html = `<span class="inline-flex items-center gap-1">
                        ${varLabel} <span class="text-gray-500">${opTexto}</span> ${valorHtml}
                    </span>`;
                }

                const conectivo = index < items.length - 1 
                    ? `<span class="mx-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded text-xs font-bold">${operadorTexto}</span>` 
                    : '';

                return html + conectivo;
            });

            return partes.join('');
        }

        // Gera AST JSON para o backend (formato compatível com DeterministicRuleEvaluator)
        function gerarRegraAST(items, operador) {
            if (items.length === 0) return null;

            // Se só tem um item, retorna ele diretamente
            if (items.length === 1) {
                return converterParaAST(items[0]);
            }

            // Múltiplos itens: agrupa com o operador
            return {
                type: operador,
                conditions: items.map(item => converterParaAST(item))
            };
        }

        // Converte um item (condição ou grupo) para formato AST
        function converterParaAST(item) {
            if (item.type === 'group') {
                return gerarRegraAST(item.conditions || [], item.operador);
            } else {
                // Condição simples
                let valor = item.valor;
                // Converte string 'true'/'false' para boolean
                if (valor === 'true') valor = true;
                else if (valor === 'false') valor = false;
                // Tenta converter para número se parecer número
                else if (!isNaN(valor) && valor !== '') valor = Number(valor);

                return {
                    type: 'condition',
                    variable: item.variavel,
                    operator: item.operador,
                    value: valor
                };
            }
        }

        // Reseta o editor de regras
        function resetarEditorRegras() {
            modoAtivacaoAtual = 'llm';
            condicoesRegra = [];
            contadorIdCondicao = 0;
            selecionarModoAtivacao('llm');
        }

        // Carrega regra existente do módulo (suporta formato antigo e novo)
        function carregarRegraModulo(regraJson) {
            if (!regraJson) {
                resetarEditorRegras();
                return;
            }

            try {
                const regra = typeof regraJson === 'string' ? JSON.parse(regraJson) : regraJson;
                
                // Formato antigo: { logic: 'and', conditions: [...] }
                if (regra.logic && regra.conditions) {
                    modoAtivacaoAtual = 'deterministic';
                    document.getElementById('regra-operador').value = regra.logic || 'and';

                    condicoesRegra = regra.conditions.map(c => ({
                        type: 'condition',
                        id: gerarIdUnico(),
                        variavel: c.variable || '',
                        operador: c.operator || 'equals',
                        valor: c.value !== undefined ? c.value : ''
                    }));

                    selecionarModoAtivacao('deterministic');
                }
                // Formato novo (AST): { type: 'and', conditions: [...] }
                else if (regra.type && regra.type !== 'condition') {
                    modoAtivacaoAtual = 'deterministic';
                    document.getElementById('regra-operador').value = regra.type || 'and';
                    
                    condicoesRegra = carregarASTRecursivo(regra.conditions || []);

                    selecionarModoAtivacao('deterministic');
                }
                // Condição única
                else if (regra.type === 'condition') {
                    modoAtivacaoAtual = 'deterministic';
                    document.getElementById('regra-operador').value = 'and';
                    
                    condicoesRegra = [{
                        type: 'condition',
                        id: gerarIdUnico(),
                        variavel: regra.variable || '',
                        operador: regra.operator || 'equals',
                        valor: regra.value !== undefined ? regra.value : ''
                    }];

                    selecionarModoAtivacao('deterministic');
                } else {
                    resetarEditorRegras();
                }
            } catch (e) {
                console.error('Erro ao carregar regra:', e);
                resetarEditorRegras();
            }
        }

        // Carrega AST recursivamente (converte formato backend para frontend)
        function carregarASTRecursivo(conditions) {
            return conditions.map(c => {
                if (c.type === 'condition') {
                    return {
                        type: 'condition',
                        id: gerarIdUnico(),
                        variavel: c.variable || '',
                        operador: c.operator || 'equals',
                        valor: c.value !== undefined ? c.value : ''
                    };
                } else if (c.type === 'and' || c.type === 'or') {
                    return {
                        type: 'group',
                        id: gerarIdUnico(),
                        operador: c.type,
                        conditions: carregarASTRecursivo(c.conditions || [])
                    };
                } else if (c.type === 'not') {
                    // NOT com condição única ou múltiplas
                    const innerConditions = c.condition ? [c.condition] : (c.conditions || []);
                    return {
                        type: 'group',
                        id: gerarIdUnico(),
                        operador: 'not',
                        conditions: carregarASTRecursivo(innerConditions)
                    };
                }
                return c;
            });
        }

        // ============================================================================
        // GERACAO VIA LINGUAGEM NATURAL (IA)
        // ============================================================================

        // Cache da ultima regra gerada pela IA
        let ultimaRegraGerada = null;

        // Gera regra via IA a partir de linguagem natural
        async function gerarRegraIA() {
            const texto = document.getElementById('regra-linguagem-natural').value.trim();
            if (!texto) {
                alert('Digite uma condicao em linguagem natural');
                return;
            }

            const btn = document.getElementById('btn-gerar-regra-ia');
            const btnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            btn.disabled = true;

            // Esconde estados anteriores
            document.getElementById('preview-regra-gerada').classList.add('hidden');
            document.getElementById('erro-regra-gerada').classList.add('hidden');

            try {
                const grupoId = document.getElementById('modulo-grupo')?.value || '';
                const response = await fetch('/admin/api/extraction/regras-deterministicas/gerar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        condicao_texto: texto,
                        contexto: `Grupo: ${grupoId || 'N/A'}`
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Mostra preview
                    ultimaRegraGerada = {
                        regra: data.regra,
                        variaveis_usadas: data.variaveis_usadas,
                        texto_original: texto
                    };
                    mostrarPreviewRegra(data);
                } else {
                    // Mostra erro
                    mostrarErroRegra(data);
                }

            } catch (error) {
                console.error('Erro ao gerar regra:', error);
                document.getElementById('erro-regra-gerada').classList.remove('hidden');
                document.getElementById('erro-regra-msg').textContent = 'Erro de conexao com o servidor: ' + error.message;
            } finally {
                btn.innerHTML = btnHtml;
                btn.disabled = false;
            }
        }

        // Mostra preview da regra gerada
        function mostrarPreviewRegra(data) {
            document.getElementById('preview-regra-gerada').classList.remove('hidden');

            const statusEl = document.getElementById('preview-status');
            statusEl.textContent = 'Valida';
            statusEl.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';

            // Renderiza regra humanizada
            const conteudo = document.getElementById('preview-regra-conteudo');
            conteudo.innerHTML = renderizarRegraHumanizadaIA(data.regra);
        }

        // Mostra erro de geracao
        function mostrarErroRegra(data) {
            document.getElementById('erro-regra-gerada').classList.remove('hidden');
            
            // Erro especial: variáveis insuficientes
            if (data.erro === 'variaveis_insuficientes') {
                document.getElementById('erro-regra-msg').textContent = data.mensagem || 'Não há variáveis suficientes para esta condição';
                
                if (data.variaveis_necessarias && data.variaveis_necessarias.length > 0) {
                    document.getElementById('variaveis-faltantes').classList.remove('hidden');
                    const lista = document.getElementById('lista-variaveis-faltantes');
                    
                    lista.innerHTML = `
                        <p class="text-xs text-amber-700 mb-2 font-medium">
                            <i class="fas fa-lightbulb mr-1"></i>
                            A IA sugere criar as seguintes variáveis:
                        </p>
                        ${data.variaveis_necessarias.map(v => `
                            <div class="flex items-center gap-2 text-sm bg-amber-50 p-2 rounded border border-amber-200 mb-1">
                                <span class="font-mono bg-amber-100 px-1.5 py-0.5 rounded text-amber-800">${v.slug_sugerido}</span>
                                <span class="text-gray-600 flex-1">${v.descricao || ''}</span>
                                <span class="text-xs text-gray-500">(${v.tipo_sugerido || 'text'})</span>
                                <button type="button"
                                    onclick="criarVariavelFaltante('${v.slug_sugerido}', '${v.tipo_sugerido || 'text'}', '${v.descricao || ''}')"
                                    class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                    <i class="fas fa-plus mr-1"></i>Criar
                                </button>
                            </div>
                        `).join('')}
                    `;
                } else {
                    document.getElementById('variaveis-faltantes').classList.add('hidden');
                }
                return;
            }

            // Erro padrão
            document.getElementById('erro-regra-msg').textContent = data.erro || 'Erro ao gerar regra';

            // Mostra variaveis faltantes com sugestao de criacao
            if (data.variaveis_faltantes && data.variaveis_faltantes.length > 0) {
                document.getElementById('variaveis-faltantes').classList.remove('hidden');
                const lista = document.getElementById('lista-variaveis-faltantes');

                lista.innerHTML = data.variaveis_faltantes.map((v, i) => {
                    const sugestao = data.sugestoes_variaveis?.[i] || { slug: v, tipo_sugerido: 'text' };
                    return `
                        <div class="flex items-center gap-2 text-sm">
                            <span class="font-mono bg-red-100 px-1.5 py-0.5 rounded">${v}</span>
                            <span class="text-gray-500">-</span>
                            <span class="text-xs text-gray-600">Tipo sugerido: ${sugestao.tipo_sugerido}</span>
                            <button type="button"
                                onclick="criarVariavelFaltante('${v}', '${sugestao.tipo_sugerido}', '${sugestao.label_sugerido || ''}')"
                                class="text-xs text-blue-600 hover:underline ml-2">
                                <i class="fas fa-plus-circle mr-1"></i>Criar variavel
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('variaveis-faltantes').classList.add('hidden');
            }
        }

        // Aplica regra gerada ao builder manual
        function aplicarRegraGerada() {
            if (!ultimaRegraGerada) return;

            const regra = ultimaRegraGerada.regra;

            // Determina operador principal
            const operadorLogico = (regra.type === 'or') ? 'or' : 'and';
            document.getElementById('regra-operador').value = operadorLogico;

            // Converte AST para formato do builder (mantendo estrutura aninhada)
            if (regra.type === 'condition') {
                // Condição única
                condicoesRegra = [{
                    type: 'condition',
                    id: gerarIdUnico(),
                    variavel: regra.variable,
                    operador: regra.operator,
                    valor: regra.value !== undefined ? String(regra.value) : ''
                }];
            } else if (regra.conditions) {
                // Múltiplas condições (possivelmente aninhadas)
                condicoesRegra = carregarASTRecursivo(regra.conditions);
            } else {
                condicoesRegra = [];
            }

            renderizarCondicoes();

            // Limpa preview
            document.getElementById('preview-regra-gerada').classList.add('hidden');
            document.getElementById('regra-linguagem-natural').value = '';
            ultimaRegraGerada = null;

            // Feedback visual
            const btn = document.querySelector('#modo-deterministic-content button[onclick="adicionarCondicao()"]');
            if (btn) {
                const originalClass = btn.className;
                btn.className = btn.className.replace('bg-indigo-100', 'bg-green-100').replace('text-indigo-700', 'text-green-700');
                setTimeout(() => { btn.className = originalClass; }, 1000);
            }
        }

        // Descarta regra gerada
        function descartarRegraGerada() {
            document.getElementById('preview-regra-gerada').classList.add('hidden');
            ultimaRegraGerada = null;
        }

        // ============================================================================
        // REGRA SECUNDARIA (FALLBACK)
        // ============================================================================

        // Toggle para mostrar/esconder conteúdo da regra secundária
        function toggleFallback() {
            const habilitado = document.getElementById('fallback-habilitado').checked;
            const conteudo = document.getElementById('fallback-content');
            if (habilitado) {
                conteudo.classList.remove('hidden');
            } else {
                conteudo.classList.add('hidden');
            }
        }

        // Reseta o editor de regras secundárias
        function resetarEditorRegrasSecundaria() {
            condicoesRegraSecundaria = [];
            const regraSecundariaOperador = document.getElementById('regra-secundaria-operador');
            if (regraSecundariaOperador) {
                regraSecundariaOperador.value = 'and';
            }
            const textareaSecundaria = document.getElementById('regra-secundaria-linguagem-natural');
            if (textareaSecundaria) {
                textareaSecundaria.value = '';
            }
            const jsonHidden = document.getElementById('modulo-regra-secundaria-json');
            if (jsonHidden) {
                jsonHidden.value = '';
            }
            const textoHidden = document.getElementById('modulo-regra-secundaria-texto-original');
            if (textoHidden) {
                textoHidden.value = '';
            }
            renderizarCondicoesSecundaria();
            atualizarVisualizadorRegraSecundaria();
            document.getElementById('preview-regra-secundaria-gerada')?.classList.add('hidden');
        }

        // Carrega regra secundária existente do módulo
        function carregarRegraSecundariaModulo(regraJson) {
            if (!regraJson) {
                resetarEditorRegrasSecundaria();
                return;
            }

            try {
                const regra = typeof regraJson === 'string' ? JSON.parse(regraJson) : regraJson;

                // Formato AST: { type: 'and'/'or', conditions: [...] }
                if (regra.type && regra.type !== 'condition') {
                    document.getElementById('regra-secundaria-operador').value = regra.type || 'and';
                    condicoesRegraSecundaria = carregarASTRecursivo(regra.conditions || []);
                }
                // Condição única: { type: 'condition', variable, operator, value }
                else if (regra.type === 'condition') {
                    document.getElementById('regra-secundaria-operador').value = 'and';
                    condicoesRegraSecundaria = [{
                        type: 'condition',
                        id: gerarIdUnico(),
                        variavel: regra.variable || '',
                        operador: regra.operator || 'equals',
                        valor: regra.value !== undefined ? regra.value : ''
                    }];
                }
                // Formato antigo: { logic: 'and', conditions: [...] }
                else if (regra.logic && regra.conditions) {
                    document.getElementById('regra-secundaria-operador').value = regra.logic || 'and';
                    condicoesRegraSecundaria = regra.conditions.map(c => ({
                        type: 'condition',
                        id: gerarIdUnico(),
                        variavel: c.variable || '',
                        operador: c.operator || 'equals',
                        valor: c.value !== undefined ? c.value : ''
                    }));
                }
                else {
                    resetarEditorRegrasSecundaria();
                    return;
                }

                renderizarCondicoesSecundaria();
                atualizarVisualizadorRegraSecundaria();

                // Atualiza JSON hidden
                const ast = construirASTSecundaria();
                document.getElementById('modulo-regra-secundaria-json').value = ast ? JSON.stringify(ast) : '';

            } catch (e) {
                console.error('Erro ao carregar regra secundária:', e);
                resetarEditorRegrasSecundaria();
            }
        }

        // Gera regra secundária via IA
        async function gerarRegraSecundariaIA() {
            const texto = document.getElementById('regra-secundaria-linguagem-natural').value.trim();
            if (!texto) {
                alert('Digite uma condição em linguagem natural para a regra secundária');
                return;
            }

            const btn = document.getElementById('btn-gerar-regra-secundaria-ia');
            const btnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            btn.disabled = true;

            document.getElementById('preview-regra-secundaria-gerada').classList.add('hidden');

            try {
                const grupoId = document.getElementById('modulo-grupo')?.value || '';
                const response = await fetch('/admin/api/extraction/regras-deterministicas/gerar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        condicao_texto: texto,
                        contexto: `Regra SECUNDÁRIA (fallback) - Grupo: ${grupoId || 'N/A'}`
                    })
                });

                const data = await response.json();

                if (data.success) {
                    regraSecundariaGerada = {
                        regra: data.regra,
                        variaveis_usadas: data.variaveis_usadas,
                        texto_original: texto
                    };
                    // Mostra preview
                    document.getElementById('preview-regra-secundaria-gerada').classList.remove('hidden');
                    document.getElementById('preview-secundaria-status').textContent = 'Válida';
                    document.getElementById('preview-secundaria-status').className = 'text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700';
                    document.getElementById('preview-regra-secundaria-conteudo').innerHTML = renderizarRegraHumanizadaIA(data.regra);
                } else {
                    alert(data.erro || 'Erro ao gerar regra secundária');
                }
            } catch (error) {
                console.error('Erro ao gerar regra secundária:', error);
                alert('Erro de conexão: ' + error.message);
            } finally {
                btn.innerHTML = btnHtml;
                btn.disabled = false;
            }
        }

        // Aplica regra secundária gerada ao builder
        function aplicarRegraSecundariaGerada() {
            if (!regraSecundariaGerada) return;

            const regra = regraSecundariaGerada.regra;

            // Determina operador principal
            const operadorLogico = (regra.type === 'or') ? 'or' : 'and';
            document.getElementById('regra-secundaria-operador').value = operadorLogico;

            // Converte AST para formato do builder
            if (regra.type === 'condition') {
                condicoesRegraSecundaria = [{
                    type: 'condition',
                    id: gerarIdUnico(),
                    variavel: regra.variable,
                    operador: regra.operator,
                    valor: regra.value !== undefined ? String(regra.value) : ''
                }];
            } else if (regra.conditions) {
                condicoesRegraSecundaria = carregarASTRecursivo(regra.conditions);
            } else {
                condicoesRegraSecundaria = [];
            }

            renderizarCondicoesSecundaria();

            // Preserva o texto original antes de limpar o textarea
            const textoOriginal = regraSecundariaGerada.texto_original ||
                                  document.getElementById('regra-secundaria-linguagem-natural')?.value || '';
            const textoHidden = document.getElementById('modulo-regra-secundaria-texto-original');
            if (textoHidden) {
                textoHidden.value = textoOriginal;
            }

            // Limpa preview e textarea (mas o texto está preservado no hidden)
            document.getElementById('preview-regra-secundaria-gerada').classList.add('hidden');
            document.getElementById('regra-secundaria-linguagem-natural').value = '';
            regraSecundariaGerada = null;
        }

        // Descarta regra secundária gerada
        function descartarRegraSecundariaGerada() {
            document.getElementById('preview-regra-secundaria-gerada').classList.add('hidden');
            regraSecundariaGerada = null;
        }

        // Adiciona condição à regra secundária
        function adicionarCondicaoSecundaria() {
            condicoesRegraSecundaria.push({
                type: 'condition',
                id: gerarIdUnico(),
                variavel: '',
                operador: 'equals',
                valor: ''
            });
            renderizarCondicoesSecundaria();
        }

        // Adiciona grupo à regra secundária
        function adicionarGrupoSecundaria() {
            condicoesRegraSecundaria.push({
                type: 'group',
                id: gerarIdUnico(),
                operador: 'and',
                conditions: []
            });
            renderizarCondicoesSecundaria();
        }

        // Remove item da regra secundária
        function removerItemSecundaria(id) {
            condicoesRegraSecundaria = condicoesRegraSecundaria.filter(c => c.id !== id);
            renderizarCondicoesSecundaria();
        }

        // Renderiza condições da regra secundária
        function renderizarCondicoesSecundaria() {
            const container = document.getElementById('lista-condicoes-secundaria');
            container.innerHTML = condicoesRegraSecundaria.map(cond => renderizarItemCondicaoSecundaria(cond)).join('');
            atualizarVisualizadorRegraSecundaria();
        }

        // Renderiza item de condição secundária (reutiliza lógica da primária)
        function renderizarItemCondicaoSecundaria(item) {
            if (item.type === 'condition') {
                const varInfo = variaveisDisponiveis.find(v => v.slug === item.variavel);
                const displayValue = item.variavel ? `${item.variavel} (${varInfo?.tipo || 'text'})` : '';
                const esconderValor = ['exists', 'not_exists'].includes(item.operador);
                
                return `
                    <div class="flex items-center gap-1.5 p-2 bg-amber-50 rounded border border-amber-200" data-id-sec="${item.id}">
                        <div class="variable-combobox flex-1 min-w-[150px]" id="combobox-sec-${item.id}">
                            <input type="text"
                                class="variable-combobox-input text-xs ${item.variavel ? 'has-value' : ''}"
                                id="combobox-sec-input-${item.id}"
                                placeholder="Buscar variável..."
                                value="${displayValue}"
                                data-selected-slug="${item.variavel || ''}"
                                onfocus="abrirComboboxSecundaria('${item.id}')"
                                oninput="filtrarComboboxSecundaria('${item.id}', this.value)"
                                onkeydown="navegarComboboxSecundaria(event, '${item.id}')"
                                autocomplete="off">
                            ${item.variavel ? `<span class="variable-combobox-clear" onclick="limparComboboxSecundaria('${item.id}')"><i class="fas fa-times text-xs"></i></span>` : ''}
                            <div class="variable-combobox-dropdown" id="combobox-sec-dropdown-${item.id}">
                                <div class="variable-combobox-hint">
                                    <i class="fas fa-search mr-1"></i> Digite para filtrar
                                </div>
                                <div id="combobox-sec-items-${item.id}"></div>
                            </div>
                        </div>
                        <select class="px-1.5 py-1 border border-gray-300 rounded text-xs"
                            onchange="atualizarCondicaoSecundaria('${item.id}', 'operador', this.value)">
                            <option value="equals" ${item.operador === 'equals' ? 'selected' : ''}>=</option>
                            <option value="not_equals" ${item.operador === 'not_equals' ? 'selected' : ''}>!=</option>
                            <option value="contains" ${item.operador === 'contains' ? 'selected' : ''}>contém</option>
                            <option value="exists" ${item.operador === 'exists' ? 'selected' : ''}>existe</option>
                            <option value="not_exists" ${item.operador === 'not_exists' ? 'selected' : ''}>não existe</option>
                        </select>
                        <div id="valor-sec-container-${item.id}" class="${esconderValor ? 'hidden' : ''}">
                            <input type="text" value="${item.valor || ''}" placeholder="valor"
                                class="px-1.5 py-1 border border-gray-300 rounded text-xs w-20"
                                onchange="atualizarCondicaoSecundaria('${item.id}', 'valor', this.value)">
                        </div>
                        <button type="button" onclick="removerItemSecundaria('${item.id}')"
                            class="p-1 text-red-500 hover:bg-red-100 rounded">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `;
            }
            return '';
        }

        // Funções do combobox para regra secundária
        function abrirComboboxSecundaria(condId) {
            if (comboboxSecAberto !== null && comboboxSecAberto !== condId) {
                fecharComboboxSecundaria(comboboxSecAberto);
            }
            
            const dropdown = document.getElementById(`combobox-sec-dropdown-${condId}`);
            const input = document.getElementById(`combobox-sec-input-${condId}`);
            
            if (dropdown && input) {
                dropdown.classList.add('open');
                comboboxSecAberto = condId;
                comboboxSecHighlightIndex = -1;
                
                const selectedSlug = input.dataset.selectedSlug || '';
                if (selectedSlug) {
                    input.dataset.originalValue = input.value;
                    input.value = '';
                    input.classList.remove('has-value');
                }
                
                renderizarItensComboboxSecundaria(condId, '');
            }
        }

        function fecharComboboxSecundaria(condId) {
            const dropdown = document.getElementById(`combobox-sec-dropdown-${condId}`);
            const input = document.getElementById(`combobox-sec-input-${condId}`);
            
            if (dropdown) {
                dropdown.classList.remove('open');
            }
            
            if (input) {
                const selectedSlug = input.dataset.selectedSlug || '';
                if (selectedSlug) {
                    const varInfo = variaveisDisponiveis.find(v => v.slug === selectedSlug);
                    input.value = `${selectedSlug} (${varInfo?.tipo || 'text'})`;
                    input.classList.add('has-value');
                }
            }
            
            if (comboboxSecAberto === condId) {
                comboboxSecAberto = null;
            }
        }

        function filtrarComboboxSecundaria(condId, termo) {
            clearTimeout(comboboxDebounceTimer);
            comboboxDebounceTimer = setTimeout(() => {
                renderizarItensComboboxSecundaria(condId, termo);
            }, 150);
        }

        function renderizarItensComboboxSecundaria(condId, termo) {
            const container = document.getElementById(`combobox-sec-items-${condId}`);
            if (!container) return;
            
            const termoLower = termo.toLowerCase().trim();
            let filtradas = variaveisDisponiveis;
            if (termoLower) {
                filtradas = variaveisDisponiveis.filter(v => {
                    const slugMatch = v.slug.toLowerCase().includes(termoLower);
                    const labelMatch = v.label && v.label.toLowerCase().includes(termoLower);
                    return slugMatch || labelMatch;
                });
            }
            
            const limite = 50;
            const mostradas = filtradas.slice(0, limite);
            
            if (mostradas.length === 0) {
                container.innerHTML = `<div class="variable-combobox-no-results">Nenhuma variável encontrada</div>`;
                return;
            }
            
            container.innerHTML = mostradas.map((v, idx) => `
                <div class="variable-combobox-item ${idx === comboboxSecHighlightIndex ? 'highlighted' : ''}"
                    data-slug="${v.slug}"
                    onclick="selecionarVariavelComboboxSecundaria('${condId}', '${v.slug}')">
                    <div>
                        <span class="slug">${destacarTermo(v.slug, termoLower)}</span>
                        <span class="tipo">${v.tipo}</span>
                    </div>
                    ${v.label ? `<div class="label">${destacarTermo(v.label, termoLower)}</div>` : ''}
                </div>
            `).join('');
        }

        function selecionarVariavelComboboxSecundaria(condId, slug) {
            const input = document.getElementById(`combobox-sec-input-${condId}`);
            const varInfo = variaveisDisponiveis.find(v => v.slug === slug);
            
            if (input && varInfo) {
                input.value = `${slug} (${varInfo.tipo})`;
                input.dataset.selectedSlug = slug;
                input.classList.add('has-value');
            }
            
            atualizarCondicaoSecundaria(condId, 'variavel', slug);
            fecharComboboxSecundaria(condId);
        }

        function limparComboboxSecundaria(condId) {
            const input = document.getElementById(`combobox-sec-input-${condId}`);
            if (input) {
                input.value = '';
                input.dataset.selectedSlug = '';
                input.classList.remove('has-value');
            }
            atualizarCondicaoSecundaria(condId, 'variavel', '');
            renderizarCondicoesSecundaria();
        }

        function navegarComboboxSecundaria(event, condId) {
            const container = document.getElementById(`combobox-sec-items-${condId}`);
            if (!container) return;
            
            const items = container.querySelectorAll('.variable-combobox-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    comboboxSecHighlightIndex = Math.min(comboboxSecHighlightIndex + 1, items.length - 1);
                    atualizarHighlightSec(items);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    comboboxSecHighlightIndex = Math.max(comboboxSecHighlightIndex - 1, 0);
                    atualizarHighlightSec(items);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (comboboxSecHighlightIndex >= 0 && items[comboboxSecHighlightIndex]) {
                        const slug = items[comboboxSecHighlightIndex].dataset.slug;
                        selecionarVariavelComboboxSecundaria(condId, slug);
                    }
                    break;
                case 'Escape':
                    fecharComboboxSecundaria(condId);
                    break;
            }
        }

        function atualizarHighlightSec(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('highlighted', idx === comboboxSecHighlightIndex);
                if (idx === comboboxSecHighlightIndex) {
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }

        // Atualiza campo de condição secundária
        function atualizarCondicaoSecundaria(id, campo, valor) {
            const cond = condicoesRegraSecundaria.find(c => c.id === id);
            if (cond) {
                cond[campo] = valor;
                atualizarVisualizadorRegraSecundaria();
            }
        }

        // Atualiza visualizador humanizado da regra secundária
        function atualizarVisualizadorRegraSecundaria() {
            const container = document.getElementById('regra-secundaria-humanizada');
            const regra = construirASTSecundaria();

            // Atualiza o JSON hidden
            const jsonHidden = document.getElementById('modulo-regra-secundaria-json');
            if (jsonHidden) {
                jsonHidden.value = regra ? JSON.stringify(regra) : '';
            }

            if (!regra || (regra.conditions && regra.conditions.length === 0)) {
                container.innerHTML = '<span class="text-gray-400 italic">Nenhuma regra secundária configurada</span>';
                return;
            }

            container.innerHTML = renderizarRegraHumanizadaIA(regra);
        }

        // Constrói AST da regra secundária (usando a mesma lógica recursiva da regra primária)
        function construirASTSecundaria() {
            const operadorPrincipal = document.getElementById('regra-secundaria-operador')?.value || 'and';

            if (condicoesRegraSecundaria.length === 0) {
                return null;
            }

            // Usa a função gerarRegraAST que lida corretamente com grupos aninhados
            return gerarRegraAST(condicoesRegraSecundaria, operadorPrincipal);
        }

        // Renderiza regra em formato humanizado (para preview IA)
        function renderizarRegraHumanizadaIA(regra) {
            if (!regra) return '<span class="text-gray-400">Nenhuma regra</span>';

            const getOperadorTexto = (op) => {
                const map = {
                    'equals': '=',
                    'not_equals': '!=',
                    'contains': 'contem',
                    'not_contains': 'nao contem',
                    'exists': 'existe',
                    'not_exists': 'nao existe',
                    'greater_than': '>',
                    'less_than': '<',
                    'greater_or_equal': '>=',
                    'less_or_equal': '<=',
                    'in_list': 'em',
                    'not_in_list': 'nao em'
                };
                return map[op] || op;
            };

            function renderNode(node) {
                if (node.type === 'condition') {
                    const varHtml = `<span class="font-mono text-indigo-600">${node.variable}</span>`;
                    const opHtml = `<span class="text-gray-500">${getOperadorTexto(node.operator)}</span>`;
                    const valHtml = node.value !== undefined ?
                        `<span class="font-semibold text-green-600">"${node.value}"</span>` : '';
                    return `${varHtml} ${opHtml} ${valHtml}`;
                }

                if (node.type === 'and' || node.type === 'or') {
                    const sep = node.type === 'and' ?
                        '<span class="mx-1 px-1 bg-gray-200 text-gray-600 rounded text-xs">E</span>' :
                        '<span class="mx-1 px-1 bg-yellow-200 text-yellow-700 rounded text-xs">OU</span>';
                    return node.conditions.map(c => renderNode(c)).join(sep);
                }

                if (node.type === 'not') {
                    return '<span class="text-red-600">NAO</span> (' +
                        node.conditions.map(c => renderNode(c)).join(', ') + ')';
                }

                return JSON.stringify(node);
            }

            return `<div class="text-sm"><span class="text-gray-500 mr-2">Ativar quando:</span>${renderNode(regra)}</div>`;
        }

        // Abre tela para criar variavel faltante
        function criarVariavelFaltante(slug, tipoSugerido, labelSugerido) {
            const url = `/admin/variaveis?criar=1&slug=${encodeURIComponent(slug)}&tipo=${encodeURIComponent(tipoSugerido)}&label=${encodeURIComponent(labelSugerido || slug.replace(/_/g, ' '))}`;
            if (confirm(`Deseja criar a variavel "${slug}"?\n\nTipo sugerido: ${tipoSugerido}\n\nVoce sera redirecionado para a pagina de variaveis.`)) {
                window.open(url, '_blank');
            }
        }

        function criarModulo() {
            moduloAtualId = null;
            tagsAtuais = [];
            
            document.getElementById('modulo-id').value = '';
            document.getElementById('modulo-tipo').value = 'conteudo';
            document.getElementById('modulo-categoria').value = '';
            document.getElementById('modulo-subcategoria').value = '';
            document.getElementById('modulo-nome').value = '';
            document.getElementById('modulo-titulo').value = '';
            document.getElementById('modulo-condicao-ativacao').value = '';
            document.getElementById('modulo-conteudo').value = '';
            document.getElementById('modulo-ativo').checked = true;
            document.getElementById('modulo-ordem').value = 0;
            const grupoSelect = document.getElementById('modulo-grupo');
            const subgrupoSelect = document.getElementById('modulo-subgrupo');
            const grupoPadrao = gruposCache.length === 1 ? gruposCache[0].id : ''; 
            if (grupoSelect) grupoSelect.value = grupoPadrao;
            if (subgrupoSelect) subgrupoSelect.value = ''; 
            if (grupoPadrao) {
                carregarSubgruposModulo(grupoPadrao);
                carregarSubcategoriasModulo(grupoPadrao, []);
            } else {
                carregarSubgruposModulo(null);
                carregarSubcategoriasModulo(null, []);
            }

            document.getElementById('modal-titulo').textContent = 'Criar Novo Módulo';
            document.getElementById('modal-subtitulo').textContent = '';
            document.getElementById('motivo-container').classList.add('hidden');
            document.getElementById('btn-historico').classList.add('hidden');
            document.getElementById('versao-info').textContent = '';
            
            // Mostra/esconde campo de condição baseado no tipo
            toggleCondicaoAtivacao();

            // Reseta o editor de regras para modo LLM
            resetarEditorRegras();

            // Reseta o editor de regras secundárias (fallback)
            const fallbackCheckbox = document.getElementById('fallback-habilitado');
            const fallbackContent = document.getElementById('fallback-content');
            if (fallbackCheckbox) fallbackCheckbox.checked = false;
            if (fallbackContent) fallbackContent.classList.add('hidden');
            resetarEditorRegrasSecundaria();

            renderizarTags();

            document.getElementById('modal-editor').classList.remove('hidden');
        }

        function toggleCondicaoAtivacao() {
            const tipo = document.getElementById('modulo-tipo').value;
            const container = document.getElementById('condicao-ativacao-container');
            const grupoContainer = document.getElementById('grupo-conteudo-container');
            const subcategoriasContainer = document.getElementById('subcategorias-field-container');
            const subcategoriaContainer = document.getElementById('subcategoria-field-container');
            const categoriaContainer = document.getElementById('categoria-field-container');

            // Condição de ativação, grupo, subcategoria e assuntos só fazem sentido para tipo 'conteudo'
            if (tipo === 'conteudo') {
                container.classList.remove('hidden');
                if (grupoContainer) grupoContainer.classList.remove('hidden');
                if (subcategoriasContainer) subcategoriasContainer.classList.remove('hidden');
                if (subcategoriaContainer) subcategoriaContainer.classList.remove('hidden');
                if (categoriaContainer) categoriaContainer.classList.remove('hidden');
            } else if (tipo === 'peca') {
                // Peça não tem categoria, subcategoria, grupo, condição
                container.classList.add('hidden');
                if (grupoContainer) grupoContainer.classList.add('hidden');
                if (subcategoriasContainer) subcategoriasContainer.classList.add('hidden');
                if (subcategoriaContainer) subcategoriaContainer.classList.add('hidden');
                if (categoriaContainer) categoriaContainer.classList.add('hidden');
                // Limpa os valores
                document.getElementById('modulo-categoria').value = '';
                document.getElementById('modulo-subcategoria').value = '';
            } else {
                // Base: mostra categoria mas esconde grupo/subcategoria/condição
                container.classList.add('hidden');
                if (grupoContainer) grupoContainer.classList.add('hidden');
                if (subcategoriasContainer) subcategoriasContainer.classList.add('hidden');
                if (subcategoriaContainer) subcategoriaContainer.classList.add('hidden');
                if (categoriaContainer) categoriaContainer.classList.remove('hidden');
                const grupoSelect = document.getElementById('modulo-grupo');
                const subgrupoSelect = document.getElementById('modulo-subgrupo');
                if (grupoSelect) grupoSelect.value = '';
                if (subgrupoSelect) subgrupoSelect.value = '';
                // Limpa subcategoria e assuntos selecionados
                document.getElementById('modulo-subcategoria').value = '';
                subcategoriasSelecionadas = [];
            }
        }
        
        // Adiciona listener para mudança de tipo
        document.getElementById('modulo-tipo').addEventListener('change', toggleCondicaoAtivacao);

        const moduloGrupoSelect = document.getElementById('modulo-grupo');
        if (moduloGrupoSelect) {
            moduloGrupoSelect.addEventListener('change', (e) => {
                carregarSubgruposModulo(e.target.value);
                carregarSubcategoriasModulo(e.target.value, []);
            });
        }


        async function editarModulo(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Módulo não encontrado');
                
                const modulo = await response.json();
                moduloAtualId = modulo.id;
                tagsAtuais = modulo.tags || [];
                
                document.getElementById('modulo-id').value = modulo.id;
                document.getElementById('modulo-tipo').value = modulo.tipo;
                document.getElementById('modulo-categoria').value = modulo.categoria || '';
                document.getElementById('modulo-subcategoria').value = modulo.subcategoria || '';
                document.getElementById('modulo-nome').value = modulo.nome;
                document.getElementById('modulo-titulo').value = modulo.titulo;
                document.getElementById('modulo-condicao-ativacao').value = modulo.condicao_ativacao || '';
                document.getElementById('modulo-conteudo').value = modulo.conteudo;
                document.getElementById('modulo-ativo').checked = modulo.ativo;
                document.getElementById('modulo-ordem').value = modulo.ordem || 0;
                document.getElementById('modulo-motivo').value = '';
                const grupoSelect = document.getElementById('modulo-grupo');
                const subgrupoSelect = document.getElementById('modulo-subgrupo');
                if (grupoSelect) grupoSelect.value = modulo.group_id || '';
                if (subgrupoSelect) subgrupoSelect.value = '';
                await carregarSubgruposModulo(modulo.group_id, modulo.subgroup_id);
                await carregarSubcategoriasModulo(modulo.group_id, modulo.subcategoria_ids || []);

                document.getElementById('modal-titulo').textContent = 'Editar Módulo';
                document.getElementById('modal-subtitulo').textContent = modulo.titulo;
                document.getElementById('motivo-container').classList.remove('hidden');
                document.getElementById('btn-historico').classList.remove('hidden');
                document.getElementById('versao-info').textContent = `Versão ${modulo.versao} - Atualizado em ${new Date(modulo.atualizado_em).toLocaleString('pt-BR')}`;
                
                // Mostra/esconde campo de condição baseado no tipo
                toggleCondicaoAtivacao();

                // Carrega regra determinística se existir
                if (modulo.modo_ativacao === 'deterministic' && modulo.regra_deterministica) {
                    carregarRegraModulo(modulo.regra_deterministica);
                } else {
                    resetarEditorRegras();
                }

                // Carrega regra secundária (fallback) se existir
                const fallbackCheckbox = document.getElementById('fallback-habilitado');
                const fallbackContent = document.getElementById('fallback-content');
                if (fallbackCheckbox) {
                    fallbackCheckbox.checked = modulo.fallback_habilitado || false;
                }
                if (fallbackContent) {
                    fallbackContent.classList.toggle('hidden', !modulo.fallback_habilitado);
                }
                if (modulo.regra_secundaria_texto_original) {
                    const textareaSecundaria = document.getElementById('regra-secundaria-linguagem-natural');
                    if (textareaSecundaria) {
                        textareaSecundaria.value = modulo.regra_secundaria_texto_original;
                    }
                    // Também preenche o campo hidden para garantir persistência
                    const textoHidden = document.getElementById('modulo-regra-secundaria-texto-original');
                    if (textoHidden) {
                        textoHidden.value = modulo.regra_secundaria_texto_original;
                    }
                }
                if (modulo.regra_deterministica_secundaria) {
                    carregarRegraSecundariaModulo(modulo.regra_deterministica_secundaria);
                } else {
                    resetarEditorRegrasSecundaria();
                }

                renderizarTags();

                document.getElementById('modal-editor').classList.remove('hidden');
            } catch (error) {
                alert('Erro ao carregar módulo: ' + error.message);
            }
        }

        function verModulo(id) {
            editarModulo(id); // Abre o editor (depois pode criar view somente leitura)
        }

        async function salvarModulo() {
            const id = document.getElementById('modulo-id').value;
            const isNovo = !id;
            const tipo = document.getElementById('modulo-tipo').value;
            const grupoId = document.getElementById('modulo-grupo').value;
            const subgrupoId = document.getElementById('modulo-subgrupo').value;
            
            // Obtém modo de ativação e regra primária
            const regraJson = document.getElementById('modulo-regra-json')?.value || '';
            let regraAtivacao = null;
            if (modoAtivacaoAtual === 'deterministic' && regraJson) {
                try {
                    regraAtivacao = JSON.parse(regraJson);
                } catch (e) {
                    console.error('Erro ao parsear regra primária:', e);
                }
            }

            // Obtém regra secundária (fallback)
            const regraSecundariaJson = document.getElementById('modulo-regra-secundaria-json')?.value || '';
            let regraSecundaria = null;
            const fallbackHabilitado = document.getElementById('fallback-habilitado')?.checked || false;
            if (modoAtivacaoAtual === 'deterministic' && fallbackHabilitado && regraSecundariaJson) {
                try {
                    regraSecundaria = JSON.parse(regraSecundariaJson);
                } catch (e) {
                    console.error('Erro ao parsear regra secundária:', e);
                }
            }
            // Texto original: prioriza o campo hidden (preservado ao aplicar), depois o textarea
            const regraSecundariaTextoOriginal = fallbackHabilitado
                ? (document.getElementById('modulo-regra-secundaria-texto-original')?.value ||
                   document.getElementById('regra-secundaria-linguagem-natural')?.value || null)
                : null;

            const dados = {
                tipo: tipo,
                categoria: document.getElementById('modulo-categoria').value || null,
                subcategoria: document.getElementById('modulo-subcategoria').value || null,
                subcategoria_ids: tipo === 'conteudo' ? subcategoriasSelecionadas : [],
                nome: document.getElementById('modulo-nome').value,
                titulo: document.getElementById('modulo-titulo').value,
                condicao_ativacao: tipo === 'conteudo' ? (document.getElementById('modulo-condicao-ativacao').value || null) : null,
                modo_ativacao: tipo === 'conteudo' ? modoAtivacaoAtual : null,
                regra_deterministica: tipo === 'conteudo' && modoAtivacaoAtual === 'deterministic' ? regraAtivacao : null,
                regra_deterministica_secundaria: tipo === 'conteudo' && modoAtivacaoAtual === 'deterministic' ? regraSecundaria : null,
                regra_secundaria_texto_original: tipo === 'conteudo' && modoAtivacaoAtual === 'deterministic' ? regraSecundariaTextoOriginal : null,
                fallback_habilitado: tipo === 'conteudo' ? fallbackHabilitado : false,
                conteudo: document.getElementById('modulo-conteudo').value,
                tags: tagsAtuais,
                ativo: document.getElementById('modulo-ativo').checked,
                ordem: parseInt(document.getElementById('modulo-ordem').value) || 0,
                group_id: tipo === 'conteudo' ? (grupoId ? parseInt(grupoId) : null) : null,
                subgroup_id: tipo === 'conteudo' ? (subgrupoId ? parseInt(subgrupoId) : null) : null
            };

            if (tipo === 'conteudo' && !grupoId) {
                alert('Selecione o grupo do módulo de conteúdo');
                document.getElementById('modulo-grupo').focus();
                return;
            }

            if (!isNovo) {
                dados.motivo = document.getElementById('modulo-motivo').value || null;
            }
            
            try {
                const response = await fetch(isNovo ? API_BASE : `${API_BASE}/${id}`, {
                    method: isNovo ? 'POST' : 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }
                
                fecharEditor();
                carregarModulos();
                alert(isNovo ? 'Módulo criado com sucesso!' : 'Módulo atualizado com sucesso!');
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function excluirModulo(id, titulo) {
            const opcao = confirm(`Excluir "${titulo}"?\n\nEscolha:\n- OK para DESATIVAR (pode reativar depois)\n- Cancele e use Shift+Clique para EXCLUIR PERMANENTEMENTE`);
            
            if (!opcao) return;
            
            // Se Shift estiver pressionado, exclusão permanente
            const permanente = event?.shiftKey;
            
            try {
                const url = permanente ? `${API_BASE}/${id}/permanente` : `${API_BASE}/${id}`;
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }
                
                const result = await response.json();
                carregarModulos();
                alert(result.message);
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        function fecharEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
        }

        // Tags
        function renderizarTags() {
            const container = document.getElementById('tags-container');
            container.innerHTML = tagsAtuais.map((tag, i) => `
                <span class="tag-pill flex items-center gap-1">
                    ${tag}
                    <button type="button" onclick="removerTag(${i})" class="text-blue-500 hover:text-blue-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }

        function adicionarTag() {
            const input = document.getElementById('nova-tag');
            const valor = input.value.trim().toLowerCase();
            if (valor && !tagsAtuais.includes(valor)) {
                tagsAtuais.push(valor);
                renderizarTags();
            }
            input.value = '';
        }

        function removerTag(index) {
            tagsAtuais.splice(index, 1);
            renderizarTags();
        }

        // Histórico
        async function verHistorico() {
            if (!moduloAtualId) return;
            
            document.getElementById('modal-historico').classList.remove('hidden');
            document.getElementById('historico-lista').innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/${moduloAtualId}/historico`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                const historico = await response.json();
                
                if (historico.length === 0) {
                    document.getElementById('historico-lista').innerHTML = '<div class="text-center py-8 text-gray-400">Nenhuma versão anterior</div>';
                    return;
                }
                
                document.getElementById('historico-lista').innerHTML = historico.map(h => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-800">Versão ${h.versao}</span>
                            <span class="text-sm text-gray-500">${new Date(h.alterado_em).toLocaleString('pt-BR')}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${h.motivo || 'Sem descrição'}</p>
                        <div class="text-xs text-gray-400">${h.diff_resumo || ''}</div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="restaurarVersao(${h.versao})" class="px-3 py-1 text-sm text-orange-600 bg-orange-50 rounded hover:bg-orange-100">
                                <i class="fas fa-undo mr-1"></i> Restaurar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('historico-lista').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar histórico</div>';
            }
        }

        function fecharHistorico() {
            document.getElementById('modal-historico').classList.add('hidden');
        }

        async function restaurarVersao(versao) {
            const motivo = prompt('Motivo da restauração:');
            if (!motivo) return;
            
            try {
                const response = await fetch(`${API_BASE}/${moduloAtualId}/restaurar/${versao}?motivo=${encodeURIComponent(motivo)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Erro ao restaurar');
                
                alert('Versão restaurada com sucesso!');
                fecharHistorico();
                fecharEditor();
                carregarModulos();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function exportarTodos() {
            try {
                const response = await fetch(`${API_BASE}/exportar/todos`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompts_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            } catch (error) {
                alert('Erro ao exportar: ' + error.message);
            }
        }

        // ==========================================
        // Funções de Importação
        // ==========================================
        
        let modulosParaImportar = [];
        
        function abrirModalImportar() {
            // Reset do modal
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('preview-importacao').classList.add('hidden');
            document.getElementById('resultado-importacao').classList.add('hidden');
            document.getElementById('btn-importar').classList.add('hidden');
            document.getElementById('arquivo-json').value = '';
            document.getElementById('sobrescrever-existentes').checked = false;
            modulosParaImportar = [];
            
            document.getElementById('modal-importar').classList.remove('hidden');
        }
        
        function fecharModalImportar() {
            document.getElementById('modal-importar').classList.add('hidden');
            // Se houve importação, recarrega a lista
            const resultadoSucesso = document.getElementById('resultado-sucesso');
            if (!resultadoSucesso.classList.contains('hidden')) {
                carregarModulos();
            }
        }
        
        // ==========================================
        // Funções de Exportação
        // ==========================================
        
        async function abrirModalExportar() {
            document.getElementById('modal-exportar').classList.remove('hidden');
            await carregarModulosParaExport();
            atualizarContadorExport();
        }
        
        function fecharModalExportar() {
            document.getElementById('modal-exportar').classList.add('hidden');
        }
        
        async function carregarModulosParaExport() {
            try {
                const response = await fetch(`${API_BASE}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar módulos');
                
                modulosExportCache = await response.json();
                
                // Popula categorias no filtro
                const categorias = [...new Set(modulosExportCache.map(m => m.categoria).filter(c => c))];
                const selectCategoria = document.getElementById('export-filtro-categoria');
                selectCategoria.innerHTML = '<option value="">Todas as categorias</option>' +
                    categorias.map(c => `<option value="${c}">${c}</option>`).join('');
                
                renderizarModulosExport(modulosExportCache);
                
            } catch (error) {
                console.error('Erro ao carregar módulos para exportação:', error);
            }
        }
        
        function filtrarModulosExport() {
            const tipo = document.getElementById('export-filtro-tipo').value;
            const categoria = document.getElementById('export-filtro-categoria').value;
            
            let filtrados = modulosExportCache;
            
            if (tipo) {
                filtrados = filtrados.filter(m => m.tipo === tipo);
            }
            if (categoria) {
                filtrados = filtrados.filter(m => m.categoria === categoria);
            }
            
            renderizarModulosExport(filtrados);
        }
        
        function renderizarModulosExport(modulos) {
            const tbody = document.getElementById('lista-modulos-exportar');
            
            if (modulos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-8 text-center text-gray-400">Nenhum módulo encontrado</td></tr>';
                return;
            }
            
            const tipoLabels = {
                'base': '<span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-700">Base</span>',
                'peca': '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">Peça</span>',
                'conteudo': '<span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">Conteúdo</span>'
            };
            
            tbody.innerHTML = modulos.map(m => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2">
                        <input type="checkbox" class="export-checkbox w-4 h-4 text-blue-600 rounded" 
                            data-id="${m.id}" data-tipo="${m.tipo}" onchange="atualizarContadorExport()">
                    </td>
                    <td class="px-3 py-2">
                        <p class="font-medium text-gray-800">${m.titulo}</p>
                        <p class="text-xs text-gray-500">${m.nome}</p>
                    </td>
                    <td class="px-3 py-2">${tipoLabels[m.tipo] || m.tipo}</td>
                    <td class="px-3 py-2">${m.categoria || '-'}</td>
                    <td class="px-3 py-2">${m.subcategoria || '-'}</td>
                </tr>
            `).join('');
        }
        
        function selecionarTodosExport(selecionar) {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => cb.checked = selecionar);
            document.getElementById('export-select-all').checked = selecionar;
            atualizarContadorExport();
        }
        
        function selecionarPorTipo(tipo) {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = cb.dataset.tipo === tipo;
            });
            atualizarContadorExport();
        }
        
        function inverterSelecaoExport() {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => cb.checked = !cb.checked);
            atualizarContadorExport();
        }
        
        function atualizarContadorExport() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const total = checkboxes.length;
            document.getElementById('export-contador').textContent = `${total} selecionado${total !== 1 ? 's' : ''}`;
            document.getElementById('btn-exportar').disabled = total === 0;
            
            // Atualiza info
            if (total > 0) {
                document.getElementById('export-info').textContent = `${total} módulo${total !== 1 ? 's' : ''} será${total !== 1 ? 'ão' : ''} exportado${total !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('export-info').textContent = 'Selecione ao menos um módulo';
            }
        }
        
        async function executarExportacao() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('Selecione ao menos um módulo para exportar');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/exportar/selecionados`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ ids })
                });
                
                if (!response.ok) throw new Error('Erro ao exportar');
                
                const data = await response.json();
                
                // Cria e baixa o arquivo
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompts_modulos_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                fecharModalExportar();
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar módulos');
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-green-500', 'bg-green-50');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-green-500', 'bg-green-50');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-green-500', 'bg-green-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.json')) {
                processarArquivoJson(files[0]);
            } else {
                alert('Por favor, selecione um arquivo .json');
            }
        }
        
        function carregarArquivoJson(event) {
            const file = event.target.files[0];
            if (file) {
                processarArquivoJson(file);
            }
        }
        
        async function processarArquivoJson(file) {
            try {
                const texto = await file.text();
                const dados = JSON.parse(texto);
                
                // Aceita tanto { modulos: [...] } quanto diretamente [...]
                let modulos = dados.modulos || dados;
                if (!Array.isArray(modulos)) {
                    throw new Error('Formato inválido: esperado um array de módulos');
                }
                
                modulosParaImportar = modulos;
                
                // Atualiza nome do arquivo
                document.getElementById('nome-arquivo').textContent = file.name;
                
                // Verifica quais já existem
                await verificarModulosExistentes();
                
                // Mostra preview
                document.getElementById('upload-area').classList.add('hidden');
                document.getElementById('preview-importacao').classList.remove('hidden');
                document.getElementById('btn-importar').classList.remove('hidden');
                
            } catch (error) {
                alert('Erro ao processar arquivo: ' + error.message);
            }
        }
        
        async function verificarModulosExistentes() {
            // Carrega módulos existentes para comparar
            const response = await fetch(`${API_BASE}?apenas_ativos=false`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
            });
            const existentes = await response.json();
            
            // Cria um mapa de módulos existentes por chave única
            const mapaExistentes = new Map();
            existentes.forEach(m => {
                const chave = `${m.tipo}|${m.categoria || ''}|${m.subcategoria || ''}|${m.nome}`;
                mapaExistentes.set(chave, m);
            });
            
            let novos = 0;
            let existentesCount = 0;
            
            const tbody = document.getElementById('lista-modulos-importar');
            tbody.innerHTML = '';
            
            modulosParaImportar.forEach((item, i) => {
                // Normalizar campos
                const tipo_raw = item.tipo || 'conteudo';
                const tipo = tipo_raw.toLowerCase().replace('ú', 'u');
                const nome = item.nome_unico || item.nome || `modulo_${i+1}`;
                const categoria = item.categoria || '';
                const subcategoria = item.subcategoria || '';
                const titulo = item.titulo || nome;
                
                const chave = `${tipo}|${categoria}|${subcategoria}|${nome}`;
                const jaExiste = mapaExistentes.has(chave);
                
                if (jaExiste) {
                    existentesCount++;
                } else {
                    novos++;
                }
                
                tbody.innerHTML += `
                    <tr class="${jaExiste ? 'bg-orange-50' : 'bg-green-50'}">
                        <td class="px-3 py-2">
                            <span class="font-medium">${titulo}</span>
                            <span class="text-xs text-gray-400 block font-mono">${nome}</span>
                        </td>
                        <td class="px-3 py-2 text-gray-600">
                            ${categoria}${subcategoria ? '/' + subcategoria : ''}
                        </td>
                        <td class="px-3 py-2">
                            ${jaExiste 
                                ? '<span class="px-2 py-0.5 text-xs bg-orange-100 text-orange-700 rounded-full">Já existe</span>'
                                : '<span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">Novo</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('total-modulos').textContent = modulosParaImportar.length;
            document.getElementById('novos-modulos').textContent = novos;
            document.getElementById('existentes-modulos').textContent = existentesCount;
        }
        
        function limparArquivo() {
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('preview-importacao').classList.add('hidden');
            document.getElementById('btn-importar').classList.add('hidden');
            document.getElementById('arquivo-json').value = '';
            modulosParaImportar = [];
        }
        
        async function executarImportacao() {
            if (modulosParaImportar.length === 0) {
                alert('Nenhum módulo para importar');
                return;
            }
            
            const sobrescrever = document.getElementById('sobrescrever-existentes').checked;
            
            const btn = document.getElementById('btn-importar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Importando...';
            
            try {
                const response = await fetch(`${API_BASE}/importar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        modulos: modulosParaImportar,
                        sobrescrever_existentes: sobrescrever
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro na importação');
                }
                
                const resultado = await response.json();
                
                // Mostra resultado
                document.getElementById('preview-importacao').classList.add('hidden');
                document.getElementById('btn-importar').classList.add('hidden');
                document.getElementById('resultado-importacao').classList.remove('hidden');
                document.getElementById('resultado-sucesso').classList.remove('hidden');
                
                document.getElementById('res-total').textContent = resultado.total_recebidos;
                document.getElementById('res-criados').textContent = resultado.criados;
                document.getElementById('res-atualizados').textContent = resultado.atualizados;
                document.getElementById('res-ignorados').textContent = resultado.ignorados;

                // Mostra itens criados automaticamente (grupos, subgrupos, subcategorias)
                const gruposCriados = resultado.grupos_criados || 0;
                const subgruposCriados = resultado.subgrupos_criados || 0;
                const subcategoriasCriadas = resultado.subcategorias_criadas || 0;

                if (gruposCriados > 0 || subgruposCriados > 0 || subcategoriasCriadas > 0) {
                    document.getElementById('itens-criados-auto').classList.remove('hidden');

                    const gruposEl = document.getElementById('res-grupos-criados');
                    const subgruposEl = document.getElementById('res-subgrupos-criados');
                    const subcatsEl = document.getElementById('res-subcategorias-criadas');

                    if (gruposCriados > 0) {
                        gruposEl.classList.remove('hidden');
                        gruposEl.querySelector('.num').textContent = gruposCriados;
                    } else {
                        gruposEl.classList.add('hidden');
                    }

                    if (subgruposCriados > 0) {
                        subgruposEl.classList.remove('hidden');
                        subgruposEl.querySelector('.num').textContent = subgruposCriados;
                    } else {
                        subgruposEl.classList.add('hidden');
                    }

                    if (subcategoriasCriadas > 0) {
                        subcatsEl.classList.remove('hidden');
                        subcatsEl.querySelector('.num').textContent = subcategoriasCriadas;
                    } else {
                        subcatsEl.classList.add('hidden');
                    }
                } else {
                    document.getElementById('itens-criados-auto').classList.add('hidden');
                }

                // Mostra erros se houver
                if (resultado.erros && resultado.erros.length > 0) {
                    document.getElementById('resultado-erros').classList.remove('hidden');
                    document.getElementById('lista-erros').innerHTML = resultado.erros
                        .map(e => `<li>${e}</li>`).join('');
                } else {
                    document.getElementById('resultado-erros').classList.add('hidden');
                }
                
            } catch (error) {
                alert('Erro na importação: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload mr-1"></i> Importar Módulos';
            }
        }

        // ==========================================
        // Funções de Ordem das Categorias
        // ==========================================

        let ordemCategoriasCache = [];

        function abrirModalOrdemCategorias() {
            const modal = document.getElementById('modal-ordem-categorias');
            const select = document.getElementById('ordem-grupo-select');

            // Popula o seletor de grupos
            select.innerHTML = '<option value="">Selecione um grupo...</option>';
            gruposCache.forEach(grupo => {
                const option = document.createElement('option');
                option.value = grupo.id;
                option.textContent = grupo.name || grupo.nome;
                select.appendChild(option);
            });

            // Limpa a lista
            document.getElementById('ordem-categorias-lista').innerHTML =
                '<p class="text-gray-400 text-sm text-center py-4">Selecione um grupo para ver as categorias</p>';

            modal.classList.remove('hidden');
        }

        function fecharModalOrdemCategorias() {
            document.getElementById('modal-ordem-categorias').classList.add('hidden');
        }

        async function carregarOrdemCategorias() {
            const grupoId = document.getElementById('ordem-grupo-select').value;
            const container = document.getElementById('ordem-categorias-lista');

            if (!grupoId) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Selecione um grupo para ver as categorias</p>';
                return;
            }

            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4"><i class="fas fa-spinner fa-spin mr-1"></i> Carregando...</p>';

            try {
                // Busca categorias existentes nos módulos e a ordem configurada
                const [modulosRes, ordemRes] = await Promise.all([
                    fetch(`${API_BASE}?group_id=${grupoId}&tipo=conteudo&apenas_ativos=true`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                    }),
                    fetch(`${API_BASE}/grupos/${grupoId}/categorias-ordem`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                    })
                ]);

                if (!modulosRes.ok) throw new Error('Erro ao carregar módulos');

                const modulos = await modulosRes.json();
                const ordemResponse = ordemRes.ok ? await ordemRes.json() : { categorias: [] };
                const ordemConfig = ordemResponse.categorias || [];

                // Extrai categorias únicas dos módulos
                const categoriasSet = new Set();
                modulos.forEach(m => {
                    if (m.categoria) categoriasSet.add(m.categoria);
                });

                // Cria mapa de ordem existente
                const ordemMap = {};
                ordemConfig.forEach(c => {
                    ordemMap[c.nome] = c.ordem;
                });

                // Prepara lista com ordem (existente ou default)
                ordemCategoriasCache = Array.from(categoriasSet).map((cat, idx) => ({
                    nome: cat,
                    ordem: ordemMap[cat] !== undefined ? ordemMap[cat] : (idx + 1) * 10
                }));

                // Ordena por ordem
                ordemCategoriasCache.sort((a, b) => a.ordem - b.ordem);

                renderizarOrdemCategorias();

            } catch (error) {
                console.error('Erro ao carregar ordem das categorias:', error);
                container.innerHTML = `<p class="text-red-500 text-sm text-center py-4"><i class="fas fa-exclamation-triangle mr-1"></i> Erro: ${error.message}</p>`;
            }
        }

        function renderizarOrdemCategorias() {
            const container = document.getElementById('ordem-categorias-lista');

            if (ordemCategoriasCache.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Nenhuma categoria encontrada nos módulos deste grupo</p>';
                return;
            }

            container.innerHTML = ordemCategoriasCache.map((cat, idx) => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-amber-300 transition-colors" data-categoria="${cat.nome}">
                    <div class="flex-shrink-0">
                        <input type="number"
                            class="w-16 px-2 py-1 text-center border border-gray-300 rounded text-sm font-medium ordem-input"
                            value="${cat.ordem}"
                            min="0"
                            step="1"
                            data-categoria="${cat.nome}"
                            onchange="atualizarOrdemCategoria('${cat.nome.replace(/'/g, "\\'")}', this.value)">
                    </div>
                    <div class="flex-grow">
                        <span class="font-medium text-gray-800">${cat.nome}</span>
                    </div>
                    <div class="flex-shrink-0 text-gray-400">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                </div>
            `).join('');
        }

        function atualizarOrdemCategoria(nome, valor) {
            const cat = ordemCategoriasCache.find(c => c.nome === nome);
            if (cat) {
                cat.ordem = parseInt(valor) || 0;
            }
        }

        async function salvarOrdemCategorias() {
            const grupoId = document.getElementById('ordem-grupo-select').value;

            if (!grupoId) {
                alert('Selecione um grupo');
                return;
            }

            // Atualiza valores dos inputs
            document.querySelectorAll('.ordem-input').forEach(input => {
                const cat = ordemCategoriasCache.find(c => c.nome === input.dataset.categoria);
                if (cat) {
                    cat.ordem = parseInt(input.value) || 0;
                }
            });

            try {
                const response = await fetch(`${API_BASE}/grupos/${grupoId}/categorias-ordem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(
                        ordemCategoriasCache.map(c => ({
                            nome: c.nome,
                            ordem: c.ordem,
                            ativo: true
                        }))
                    )
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }

                alert('Ordem das categorias salva com sucesso!');
                fecharModalOrdemCategorias();

            } catch (error) {
                console.error('Erro ao salvar ordem:', error);
                alert('Erro ao salvar: ' + error.message);
            }
        }

        function toggleFullscreen() {
            const textarea = document.getElementById('modulo-conteudo');
            if (textarea.style.position === 'fixed') {
                textarea.style.position = '';
                textarea.style.top = '';
                textarea.style.left = '';
                textarea.style.width = '';
                textarea.style.height = '';
                textarea.style.zIndex = '';
                textarea.rows = 15;
            } else {
                textarea.style.position = 'fixed';
                textarea.style.top = '0';
                textarea.style.left = '0';
                textarea.style.width = '100vw';
                textarea.style.height = '100vh';
                textarea.style.zIndex = '9999';
                textarea.rows = 50;
            }
        }

        // ============================================
        // Glossário de Conceitos
        // ============================================
        let glossarioCarregado = false;
        let glossarioConteudoOriginal = '';

        async function abrirGlossario() {
            document.getElementById('modal-glossario').classList.remove('hidden');
            if (!glossarioCarregado) {
                await carregarGlossario();
            }
        }

        function fecharGlossario() {
            document.getElementById('modal-glossario').classList.add('hidden');
            document.getElementById('glossario-busca').value = '';
            if (glossarioConteudoOriginal) {
                document.getElementById('glossario-conteudo').innerHTML = glossarioConteudoOriginal;
            }
        }

        async function carregarGlossario() {
            try {
                const response = await fetch('/admin/help/glossary', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar');
                const data = await response.json();
                const html = converterMarkdownParaHTML(data.content);
                document.getElementById('glossario-conteudo').innerHTML = html;
                glossarioConteudoOriginal = html;
                glossarioCarregado = true;
            } catch (error) {
                document.getElementById('glossario-conteudo').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-red-500">
                            <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                            <p>Erro ao carregar glossário</p>
                        </div>
                    </div>`;
            }
        }

        function converterMarkdownParaHTML(md) {
            return '<p>' + md
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/^### (.+)$/gm, (m, t) => `<h3 id="${t.toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-')}">${t}</h3>`)
                .replace(/^## (.+)$/gm, (m, t) => `<h2 id="${t.toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-')}">${t}</h2>`)
                .replace(/^# (.+)$/gm, (m, t) => `<h1 id="${t.toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-')}">${t}</h1>`)
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^\|(.+)\|$/gm, (m, c) => {
                    const cells = c.split('|').map(x => x.trim());
                    if (cells.every(x => /^[-:]+$/.test(x))) return '';
                    return '<tr>' + cells.map(x => `<td>${x}</td>`).join('') + '</tr>';
                })
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^---+$/gm, '<hr>')
                .replace(/\n\n/g, '</p><p>') + '</p>';
        }

        function buscarNoGlossario(termo) {
            if (!termo || termo.length < 2) {
                document.getElementById('glossario-conteudo').innerHTML = glossarioConteudoOriginal;
                return;
            }
            const regex = new RegExp(`(${termo.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            document.getElementById('glossario-conteudo').innerHTML = glossarioConteudoOriginal.replace(regex, '<span class="bg-yellow-200">$1</span>');
        }

        function irParaSecao(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>

    <!-- Modal do Glossário -->
    <div id="modal-glossario" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden m-4 h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-purple-50">
                <div class="flex items-center gap-3">
                    <i class="fas fa-book text-indigo-600 text-xl"></i>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">Glossário de Conceitos</h2>
                        <p class="text-xs text-gray-500">Documentação completa do sistema</p>
                    </div>
                </div>
                <button onclick="fecharGlossario()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="px-6 py-3 border-b bg-gray-50">
                <div class="flex items-center gap-4">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="glossario-busca" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2 border rounded-lg" onkeyup="buscarNoGlossario(this.value)">
                    </div>
                    <div class="flex gap-2 text-xs">
                        <button onclick="irParaSecao('documentos-e-extração')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Documentos</button>
                        <button onclick="irParaSecao('prompts-e-ativação')" class="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">Prompts</button>
                        <button onclick="irParaSecao('termos-ambíguos---como-diferenciar')" class="px-2 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200">Ambiguidades</button>
                    </div>
                </div>
            </div>
            <div id="glossario-conteudo" class="flex-1 overflow-y-auto p-6 prose prose-sm max-w-none">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>
            <div class="px-6 py-3 border-t bg-gray-50 flex justify-end">
                <button onclick="fecharGlossario()" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Fechar</button>
            </div>
        </div>
    </div>

    <style>
        #glossario-conteudo h1 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        #glossario-conteudo h2 { font-size: 1.25rem; font-weight: 600; color: #374151; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        #glossario-conteudo h3 { font-size: 1rem; font-weight: 600; color: #4b5563; margin-top: 1rem; margin-bottom: 0.5rem; }
        #glossario-conteudo code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875em; color: #7c3aed; }
        #glossario-conteudo pre { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        #glossario-conteudo pre code { background: transparent; color: inherit; }
        #glossario-conteudo table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.875rem; }
        #glossario-conteudo th, #glossario-conteudo td { padding: 0.5rem; border: 1px solid #e5e7eb; }
        #glossario-conteudo th { background: #f9fafb; font-weight: 600; }
        #glossario-conteudo ul { padding-left: 1.5rem; }
        #glossario-conteudo li { margin-bottom: 0.25rem; }
        #glossario-conteudo hr { border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }
    </style>
</body>
</html>
