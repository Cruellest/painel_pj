<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorias de Resumo JSON - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd',
                            300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9',
                            600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .json-editor { font-family: 'Fira Code', 'Monaco', 'Consolas', monospace; }
        .codigo-pill { @apply px-2 py-1 text-xs rounded-full bg-green-100 text-green-700 font-mono; }
        .codigo-pill-usado { @apply px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700 font-mono; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="/admin/prompts-config" class="text-gray-500 hover:text-primary-600">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Categorias de Formato de Resumo JSON</h1>
                    <p class="text-sm text-gray-500">Defina formatos JSON para resumos de documentos por categoria</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="criarCategoria()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Nova Categoria
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <!-- Info Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex gap-3">
                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                <div class="text-sm text-blue-700">
                    <p class="font-medium mb-1">Como funciona:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Cada categoria define um formato JSON específico para resumos de documentos</li>
                        <li>Associe códigos de documento TJ-MS a cada categoria</li>
                        <li>A categoria <span class="font-mono bg-blue-100 px-1 rounded">residual</span> é usada para documentos sem categoria específica</li>
                        <li>A IA extrairá informações seguindo a estrutura JSON definida</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Lista de Categorias -->
        <div id="lista-categorias" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando categorias...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Edição -->
    <div id="modal-editor" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col m-4">
            <!-- Header do Modal -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-primary-50 to-green-50">
                <div>
                    <h2 id="modal-titulo" class="text-lg font-semibold text-gray-800">Editar Categoria</h2>
                    <p id="modal-subtitulo" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="fecharEditor()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="flex-1 overflow-auto p-6">
                <form id="form-categoria" class="space-y-6">
                    <input type="hidden" id="categoria-id">
                    
                    <!-- Dados básicos -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome (identificador)</label>
                            <input type="text" id="categoria-nome" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                placeholder="ex: peticoes, decisoes, recursos">
                            <p class="text-xs text-gray-500 mt-1">Identificador único (sem espaços ou acentos)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título (exibição)</label>
                            <input type="text" id="categoria-titulo" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                placeholder="ex: Petições, Decisões Judiciais">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <textarea id="categoria-descricao" rows="2"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Descreva o propósito desta categoria..."></textarea>
                    </div>

                    <!-- Códigos de documento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Códigos de Documento TJ-MS
                            <button type="button" onclick="abrirSeletorCodigos()" class="ml-2 text-primary-600 hover:text-primary-700 text-xs">
                                <i class="fas fa-list"></i> Ver lista de códigos
                            </button>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="novo-codigo" placeholder="Digite o código (ex: 500)"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                onkeypress="if(event.key==='Enter'){event.preventDefault();adicionarCodigo();}">
                            <button type="button" onclick="adicionarCodigo()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                        <div id="lista-codigos" class="flex flex-wrap gap-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                            <span class="text-gray-400 text-sm">Nenhum código adicionado</span>
                        </div>
                    </div>

                    <!-- Formato JSON -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Formato JSON Esperado
                            <button type="button" onclick="validarJSON()" class="ml-2 text-primary-600 hover:text-primary-700 text-xs">
                                <i class="fas fa-check-circle"></i> Validar JSON
                            </button>
                            <button type="button" onclick="formatarJSON()" class="ml-2 text-primary-600 hover:text-primary-700 text-xs">
                                <i class="fas fa-indent"></i> Formatar
                            </button>
                        </label>
                        <textarea id="categoria-formato-json" rows="15" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 json-editor text-sm"
                            placeholder='{"tipo_documento": "string", "partes": {"autor": "string", "reu": "string"}, ...}'></textarea>
                        <p id="json-status" class="text-xs mt-1"></p>
                    </div>

                    <!-- Instruções de extração -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Instruções de Extração (opcional)</label>
                        <textarea id="categoria-instrucoes" rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Instruções adicionais para a IA sobre como preencher os campos..."></textarea>
                    </div>

                    <!-- Opções -->
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="categoria-residual" class="rounded">
                            <span class="text-sm text-gray-700">Categoria Residual (fallback para documentos sem categoria)</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="categoria-ativo" checked class="rounded">
                            <span class="text-sm text-gray-700">Ativo</span>
                        </label>
                    </div>

                    <!-- Motivo (para edição) -->
                    <div id="campo-motivo" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Motivo da Alteração</label>
                        <input type="text" id="categoria-motivo"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Descreva o motivo da alteração...">
                    </div>
                </form>
            </div>

            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                <button type="button" onclick="fecharEditor()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancelar
                </button>
                <button type="button" onclick="salvarCategoria()" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    <i class="fas fa-save mr-2"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Códigos -->
    <div id="modal-codigos" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Códigos de Documento TJ-MS</h2>
                <button onclick="fecharSeletorCodigos()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 border-b border-gray-200">
                <input type="text" id="busca-codigo" placeholder="Buscar código ou descrição..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg" oninput="filtrarCodigos()">
            </div>
            <div id="lista-codigos-disponiveis" class="flex-1 overflow-auto p-4">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin"></i> Carregando...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/categorias-resumo-json';
        let categorias = [];
        let codigosDisponiveis = [];
        let codigosSelecionados = [];
        let categoriaAtual = null;

        // Autenticação
        function getToken() {
            return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            };
        }

        // Carrega categorias
        async function carregarCategorias() {
            try {
                const response = await fetch(`${API_BASE}?apenas_ativos=false`, {
                    headers: getHeaders()
                });
                
                if (response.status === 401) {
                    window.location.href = '/login?redirect=/admin/categorias-resumo-json';
                    return;
                }
                
                categorias = await response.json();
                renderizarCategorias();
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                document.getElementById('lista-categorias').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar categorias</p>
                    </div>
                `;
            }
        }

        // Renderiza lista de categorias
        function renderizarCategorias() {
            const container = document.getElementById('lista-categorias');
            
            if (categorias.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Nenhuma categoria cadastrada</p>
                        <p class="text-sm">Clique em "Nova Categoria" para começar</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = categorias.map(cat => `
                <div class="bg-white rounded-xl border ${cat.ativo ? 'border-gray-200' : 'border-red-200 bg-red-50'} shadow-sm p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-semibold ${cat.ativo ? 'text-gray-800' : 'text-gray-500'}">${cat.titulo}</h3>
                                ${cat.is_residual ? '<span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">RESIDUAL</span>' : ''}
                                ${!cat.ativo ? '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">INATIVO</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-500 font-mono mb-2">${cat.nome}</p>
                            ${cat.descricao ? `<p class="text-sm text-gray-600 mb-3">${cat.descricao}</p>` : ''}
                            
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${(cat.codigos_documento || []).slice(0, 10).map(cod => 
                                    `<span class="codigo-pill">${cod}</span>`
                                ).join('')}
                                ${(cat.codigos_documento || []).length > 10 ? 
                                    `<span class="text-xs text-gray-500">+${cat.codigos_documento.length - 10} mais</span>` : ''}
                                ${(cat.codigos_documento || []).length === 0 && !cat.is_residual ? 
                                    '<span class="text-xs text-gray-400 italic">Nenhum código associado</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <button onclick="editarCategoria(${cat.id})" 
                                class="px-3 py-1.5 text-primary-600 hover:bg-primary-50 rounded-lg text-sm">
                                <i class="fas fa-edit mr-1"></i> Editar
                            </button>
                            ${!cat.is_residual ? `
                                <button onclick="confirmarExclusao(${cat.id}, '${cat.titulo}')" 
                                    class="px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-lg text-sm">
                                    <i class="fas fa-trash mr-1"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Preview do formato JSON -->
                    <details class="mt-3">
                        <summary class="text-sm text-primary-600 cursor-pointer hover:text-primary-700">
                            <i class="fas fa-code mr-1"></i> Ver formato JSON
                        </summary>
                        <pre class="mt-2 p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-48 border">${escapeHtml(cat.formato_json)}</pre>
                    </details>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Criar nova categoria
        function criarCategoria() {
            categoriaAtual = null;
            codigosSelecionados = [];
            
            document.getElementById('modal-titulo').textContent = 'Nova Categoria';
            document.getElementById('modal-subtitulo').textContent = '';
            document.getElementById('categoria-id').value = '';
            document.getElementById('categoria-nome').value = '';
            document.getElementById('categoria-titulo').value = '';
            document.getElementById('categoria-descricao').value = '';
            document.getElementById('categoria-formato-json').value = `{
  "tipo_documento": "string - tipo identificado do documento",
  "partes": {
    "autor": "string ou null",
    "reu": "string ou null"
  },
  "pedido_objeto": "string - o que está sendo requerido",
  "argumentos_principais": ["string - lista de argumentos"],
  "decisao_dispositivo": "string ou null",
  "pontos_relevantes": ["string"],
  "irrelevante": false
}`;
            document.getElementById('categoria-instrucoes').value = '';
            document.getElementById('categoria-residual').checked = false;
            document.getElementById('categoria-ativo').checked = true;
            document.getElementById('campo-motivo').classList.add('hidden');
            
            atualizarListaCodigos();
            document.getElementById('modal-editor').classList.remove('hidden');
        }

        // Editar categoria existente
        async function editarCategoria(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`, { headers: getHeaders() });
                const categoria = await response.json();
                
                categoriaAtual = categoria;
                codigosSelecionados = categoria.codigos_documento || [];
                
                document.getElementById('modal-titulo').textContent = 'Editar Categoria';
                document.getElementById('modal-subtitulo').textContent = `ID: ${categoria.id}`;
                document.getElementById('categoria-id').value = categoria.id;
                document.getElementById('categoria-nome').value = categoria.nome;
                document.getElementById('categoria-titulo').value = categoria.titulo;
                document.getElementById('categoria-descricao').value = categoria.descricao || '';
                document.getElementById('categoria-formato-json').value = categoria.formato_json;
                document.getElementById('categoria-instrucoes').value = categoria.instrucoes_extracao || '';
                document.getElementById('categoria-residual').checked = categoria.is_residual;
                document.getElementById('categoria-ativo').checked = categoria.ativo;
                document.getElementById('campo-motivo').classList.remove('hidden');
                document.getElementById('categoria-motivo').value = '';
                
                atualizarListaCodigos();
                document.getElementById('modal-editor').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar categoria:', error);
                alert('Erro ao carregar categoria');
            }
        }

        // Fechar editor
        function fecharEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
            categoriaAtual = null;
        }

        // Adicionar código
        function adicionarCodigo() {
            const input = document.getElementById('novo-codigo');
            const codigo = parseInt(input.value.trim());
            
            if (isNaN(codigo) || codigo <= 0) {
                alert('Digite um código numérico válido');
                return;
            }
            
            if (codigosSelecionados.includes(codigo)) {
                alert('Este código já foi adicionado');
                return;
            }
            
            codigosSelecionados.push(codigo);
            input.value = '';
            atualizarListaCodigos();
        }

        // Remover código
        function removerCodigo(codigo) {
            codigosSelecionados = codigosSelecionados.filter(c => c !== codigo);
            atualizarListaCodigos();
        }

        // Atualizar lista visual de códigos
        function atualizarListaCodigos() {
            const container = document.getElementById('lista-codigos');
            
            if (codigosSelecionados.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum código adicionado</span>';
                return;
            }
            
            container.innerHTML = codigosSelecionados.map(cod => `
                <span class="codigo-pill flex items-center gap-1">
                    ${cod}
                    <button type="button" onclick="removerCodigo(${cod})" class="text-green-500 hover:text-green-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }

        // Validar JSON
        function validarJSON() {
            const textarea = document.getElementById('categoria-formato-json');
            const status = document.getElementById('json-status');
            
            try {
                JSON.parse(textarea.value);
                status.textContent = '✓ JSON válido';
                status.className = 'text-xs mt-1 text-green-600';
            } catch (e) {
                status.textContent = `✗ Erro: ${e.message}`;
                status.className = 'text-xs mt-1 text-red-600';
            }
        }

        // Formatar JSON
        function formatarJSON() {
            const textarea = document.getElementById('categoria-formato-json');
            try {
                const json = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(json, null, 2);
                validarJSON();
            } catch (e) {
                alert('JSON inválido - corrija os erros antes de formatar');
            }
        }

        // Salvar categoria
        async function salvarCategoria() {
            const id = document.getElementById('categoria-id').value;
            const isEdit = !!id;
            
            // Valida JSON antes de salvar
            const formatoJson = document.getElementById('categoria-formato-json').value;
            try {
                JSON.parse(formatoJson);
            } catch (e) {
                alert('O formato JSON é inválido. Corrija antes de salvar.');
                return;
            }
            
            const dados = {
                nome: document.getElementById('categoria-nome').value.trim(),
                titulo: document.getElementById('categoria-titulo').value.trim(),
                descricao: document.getElementById('categoria-descricao').value.trim() || null,
                codigos_documento: codigosSelecionados,
                formato_json: formatoJson,
                instrucoes_extracao: document.getElementById('categoria-instrucoes').value.trim() || null,
                is_residual: document.getElementById('categoria-residual').checked,
                ativo: document.getElementById('categoria-ativo').checked
            };
            
            if (isEdit) {
                dados.motivo = document.getElementById('categoria-motivo').value.trim() || 'Atualização via interface';
            }
            
            if (!dados.nome || !dados.titulo) {
                alert('Nome e título são obrigatórios');
                return;
            }
            
            try {
                const url = isEdit ? `${API_BASE}/${id}` : API_BASE;
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: getHeaders(),
                    body: JSON.stringify(dados)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }
                
                fecharEditor();
                carregarCategorias();
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert(`Erro ao salvar: ${error.message}`);
            }
        }

        // Confirmar exclusão
        function confirmarExclusao(id, titulo) {
            if (confirm(`Deseja desativar a categoria "${titulo}"?`)) {
                excluirCategoria(id);
            }
        }

        // Excluir (desativar) categoria
        async function excluirCategoria(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }
                
                carregarCategorias();
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert(`Erro ao excluir: ${error.message}`);
            }
        }

        // Abrir seletor de códigos
        async function abrirSeletorCodigos() {
            document.getElementById('modal-codigos').classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/codigos-disponiveis`, {
                    headers: getHeaders()
                });
                codigosDisponiveis = await response.json();
                renderizarCodigosDisponiveis();
            } catch (error) {
                console.error('Erro ao carregar códigos:', error);
            }
        }

        // Fechar seletor de códigos
        function fecharSeletorCodigos() {
            document.getElementById('modal-codigos').classList.add('hidden');
        }

        // Renderizar códigos disponíveis
        function renderizarCodigosDisponiveis() {
            const busca = document.getElementById('busca-codigo').value.toLowerCase();
            const container = document.getElementById('lista-codigos-disponiveis');
            
            const filtrados = codigosDisponiveis.filter(c => 
                String(c.codigo).includes(busca) || 
                c.descricao.toLowerCase().includes(busca)
            );
            
            container.innerHTML = filtrados.map(c => {
                const jaAdicionado = codigosSelecionados.includes(c.codigo);
                const emOutraCategoria = c.categoria && (!categoriaAtual || c.categoria.categoria_id !== categoriaAtual.id);
                
                return `
                    <div class="flex items-center justify-between py-2 px-3 hover:bg-gray-50 rounded border-b border-gray-100">
                        <div>
                            <span class="font-mono font-semibold">${c.codigo}</span>
                            <span class="text-gray-600 ml-2">${c.descricao}</span>
                            ${emOutraCategoria ? `<span class="ml-2 text-xs text-yellow-600"><i class="fas fa-exclamation-triangle"></i> Em: ${c.categoria.categoria_titulo}</span>` : ''}
                        </div>
                        <button onclick="adicionarCodigoLista(${c.codigo})" 
                            class="px-3 py-1 ${jaAdicionado ? 'bg-gray-100 text-gray-400' : 'bg-green-100 text-green-700 hover:bg-green-200'} rounded text-sm"
                            ${jaAdicionado ? 'disabled' : ''}>
                            ${jaAdicionado ? '<i class="fas fa-check"></i>' : '<i class="fas fa-plus"></i>'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Filtrar códigos
        function filtrarCodigos() {
            renderizarCodigosDisponiveis();
        }

        // Adicionar código da lista
        function adicionarCodigoLista(codigo) {
            if (!codigosSelecionados.includes(codigo)) {
                codigosSelecionados.push(codigo);
                atualizarListaCodigos();
                renderizarCodigosDisponiveis();
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            if (!getToken()) {
                window.location.href = '/login?redirect=/admin/categorias-resumo-json';
                return;
            }
            carregarCategorias();
        });
    </script>
</body>
</html>
