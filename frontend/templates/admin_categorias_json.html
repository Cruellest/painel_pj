<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorias de Resumo JSON - Portal PGE-MS</title>
    <!-- VERSAO: 2026-01-19-v5 - botao Aplicar JSON nas Perguntas (JSON como fonte de verdade) -->
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SortableJS para drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd',
                            300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9',
                            600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .json-editor { font-family: 'Fira Code', 'Monaco', 'Consolas', monospace; }
        .codigo-pill { @apply px-2 py-1 text-xs rounded-full bg-green-100 text-green-700 font-mono; }
        .codigo-pill-usado { @apply px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700 font-mono; }
        /* Estilos para drag & drop */
        .sortable-ghost { opacity: 0.4; background-color: #dbeafe; }
        .sortable-chosen { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .sortable-drag { opacity: 0.9; }
        .drag-handle { cursor: grab; opacity: 0.5; transition: opacity 0.2s; }
        .drag-handle:hover { opacity: 1; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-500 hover:text-primary-600">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Categorias de Formato de Resumo JSON</h1>
                    <p class="text-sm text-gray-500">Defina formatos JSON para resumos de documentos por categoria</p>
                </div>
            </div>
            <!-- REFATORADO: Botões simplificados, cores neutras, menos destaque visual -->
            <div class="flex items-center gap-2">
                <a href="/admin/variaveis" class="px-3 py-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2 text-sm">
                    <i class="fas fa-hashtag"></i> Variáveis
                </a>
                <a href="/admin/prompts-modulos" class="px-3 py-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2 text-sm">
                    <i class="fas fa-puzzle-piece"></i> Prompts
                </a>
                <button onclick="abrirModalAjudaGeral()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg" title="Como funciona">
                    <i class="fas fa-question-circle"></i>
                </button>
                <span class="w-px h-6 bg-gray-200"></span>
                <a href="/admin/categorias-resumo-json/teste" class="px-3 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2 text-sm">
                    <i class="fas fa-flask"></i> Testar
                </a>
                <button onclick="criarCategoria()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center gap-2 text-sm">
                    <i class="fas fa-plus"></i> Nova Categoria
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <!-- REFATORADO: Bloco "Como funciona" removido - conteúdo movido para modal de ajuda (ícone no header) -->

        <!-- Lista de Categorias -->
        <div id="lista-categorias" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Carregando categorias...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Edição (não fecha ao clicar fora) -->
    <div id="modal-editor" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col m-4" onclick="event.stopPropagation()">
            <!-- REFATORADO: Header sem gradiente, mais limpo -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h2 id="modal-titulo" class="text-lg font-semibold text-gray-800">Editar Categoria</h2>
                    <p id="modal-subtitulo" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="fecharEditor()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="flex-1 overflow-auto p-6">
                <form id="form-categoria" class="space-y-6">
                    <input type="hidden" id="categoria-id">

                    <!-- Dados básicos -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome (identificador)</label>
                            <input type="text" id="categoria-nome" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                placeholder="ex: peticoes, decisoes, recursos">
                            <p class="text-xs text-gray-500 mt-1">Identificador único (sem espaços ou acentos)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título (exibição)</label>
                            <input type="text" id="categoria-titulo" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                placeholder="ex: Petições, Decisões Judiciais">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <textarea id="categoria-descricao" rows="2"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Descreva o propósito desta categoria..."></textarea>
                    </div>

                    <!-- REFATORADO: Fonte dos Documentos - cores neutras -->
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-filter text-gray-500"></i>
                            <h4 class="text-sm font-semibold text-gray-700">Fonte dos Documentos</h4>
                        </div>

                        <div class="flex gap-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="source_type" value="code" checked
                                    class="text-primary-600 focus:ring-primary-500"
                                    onchange="alterarTipoFonte('code')">
                                <span class="text-sm text-gray-700">Por código de documento</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="source_type" value="special"
                                    class="text-primary-600 focus:ring-primary-500"
                                    onchange="alterarTipoFonte('special')">
                                <span class="text-sm text-gray-700">Fonte especial (regra lógica)</span>
                            </label>
                        </div>

                        <!-- REFATORADO: Fonte especial - info discreta -->
                        <div id="secao-fonte-especial" class="hidden">
                            <p class="text-xs text-gray-500 mb-3">
                                <i class="fas fa-info-circle mr-1"></i>
                                Fontes especiais identificam documentos por regras lógicas em vez de códigos.
                            </p>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Selecione a fonte especial</label>
                                <select id="categoria-fonte-especial"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    <option value="">-- Selecione --</option>
                                </select>
                                <p id="descricao-fonte-especial" class="text-xs text-gray-500 mt-2 hidden"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Códigos de documento (somente se tipo = code) -->
                    <div id="secao-codigos-documento">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Códigos de Documento TJ-MS
                            <button type="button" onclick="abrirSeletorCodigos()" class="ml-2 text-primary-600 hover:text-primary-700 text-xs">
                                <i class="fas fa-list"></i> Ver lista de códigos
                            </button>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="novo-codigo" placeholder="Digite o código (ex: 500)"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                onkeypress="if(event.key==='Enter'){event.preventDefault();adicionarCodigo();}">
                            <button type="button" onclick="adicionarCodigo()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                        <div id="lista-codigos" class="flex flex-wrap gap-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                            <span class="text-gray-400 text-sm">Nenhum código adicionado</span>
                        </div>
                    </div>

                    <!-- Campos ocultos para fonte de verdade (legacy, mantido para compatibilidade) -->
                    <input type="hidden" id="categoria-fonte-codigo" value="">
                    <input type="hidden" id="categoria-fonte-tipo-llm" value="">

                    <!-- ABAS: Ferramenta IA para gerar JSON -->
                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-code text-gray-400"></i>
                                <h3 class="text-md font-semibold text-gray-700">Formato JSON</h3>
                                <!-- REFATORADO: Ícone de ajuda discreto -->
                                <button type="button" onclick="abrirModalAjudaJSON()" class="text-gray-400 hover:text-gray-600" title="Como funciona o formato JSON">
                                    <i class="fas fa-question-circle text-sm"></i>
                                </button>
                            </div>
                            <!-- REFATORADO: Badge discreto ao invés de gradiente chamativo -->
                            <div id="badge-json-ia" class="hidden">
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded flex items-center gap-1">
                                    <i class="fas fa-robot"></i>
                                    Gerado por IA
                                </span>
                            </div>
                        </div>

                        <!-- Seletor de Abas -->
                        <div class="flex border-b border-gray-200 mb-4">
                            <button type="button" onclick="selecionarModo('legado')" id="tab-modo-legado"
                                class="px-4 py-2 text-sm font-medium border-b-2 border-primary-500 text-primary-600 bg-primary-50 rounded-t-lg">
                                <i class="fas fa-code mr-2"></i>JSON Manual
                            </button>
                            <button type="button" onclick="selecionarModo('ia')" id="tab-modo-ia"
                                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-magic mr-2"></i>Gerar com IA
                            </button>
                        </div>

                        <!-- REFATORADO: Conteúdo Modo IA - sem bloco explicativo grande -->
                        <div id="conteudo-modo-ia" class="hidden space-y-4">

                            <!-- REFATORADO: Lista de Perguntas - botões neutros e compactos -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-700">
                                        Perguntas de Extração
                                        <span class="text-xs text-gray-400 ml-1" id="contador-perguntas">(0 perguntas)</span>
                                    </label>
                                    <div class="flex gap-1">
                                        <!-- Botões secundários: estilo outline/neutro -->
                                        <button type="button" onclick="reordenarComIA()" id="btn-reordenar-ia" class="px-2 py-1 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 text-xs flex items-center gap-1" title="Usar IA para reordenar as perguntas logicamente">
                                            <i class="fas fa-sort"></i> Reordenar
                                        </button>
                                        <button type="button" onclick="agruparPorDependencias()" id="btn-agrupar-dependencias" class="px-2 py-1 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 text-xs flex items-center gap-1" title="Agrupar filhos abaixo das perguntas mães (sem IA)">
                                            <i class="fas fa-sitemap"></i> Agrupar
                                        </button>
                                        <button type="button" onclick="criarDependenciasComIA()" id="btn-dependencias-ia" class="px-2 py-1 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 text-xs flex items-center gap-1" title="Usar IA para criar/recriar dependências entre perguntas">
                                            <i class="fas fa-code-branch"></i> Dependências
                                        </button>
                                        <span class="w-px h-5 bg-gray-200 mx-1"></span>
                                        <button type="button" onclick="abrirModalPerguntasLote()" class="px-2 py-1 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 text-xs flex items-center gap-1">
                                            <i class="fas fa-list-ul"></i> Várias
                                        </button>
                                        <!-- Único botão primário: adicionar -->
                                        <button type="button" onclick="abrirModalPergunta()" class="px-3 py-1 bg-primary-600 text-white rounded hover:bg-primary-700 text-xs flex items-center gap-1">
                                            <i class="fas fa-plus"></i> Nova
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mb-2"><i class="fas fa-grip-vertical mr-1"></i>Arraste para reordenar</p>

                                <!-- Aviso de inconsistência JSON vs Perguntas -->
                                <div id="aviso-inconsistencia" class="hidden mb-3 p-3 bg-amber-50 border border-amber-300 rounded-lg">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5"></i>
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-amber-800" id="aviso-inconsistencia-texto">
                                                Existem variáveis no JSON sem perguntas correspondentes
                                            </p>
                                            <p class="text-xs text-amber-600 mt-1" id="aviso-inconsistencia-detalhes"></p>
                                            <button type="button" onclick="sincronizarPerguntasComJson()"
                                                class="mt-2 px-3 py-1.5 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-sm flex items-center gap-1">
                                                <i class="fas fa-sync-alt"></i> Sincronizar Perguntas com JSON
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div id="lista-perguntas" class="space-y-3 max-h-96 overflow-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                                    <p class="text-gray-400 text-sm text-center py-8">
                                        <i class="fas fa-question-circle text-2xl mb-2 block"></i>
                                        Nenhuma pergunta adicionada ainda.<br>
                                        <span class="text-xs">Clique em "Nova Pergunta" ou "Várias Perguntas" para começar.</span>
                                    </p>
                                </div>
                            </div>

                            <!-- REFATORADO: Botões Gerar JSON - apenas um primário -->
                            <div class="flex items-center gap-3 flex-wrap">
                                <button type="button" onclick="gerarJSONcomIA()" id="btn-gerar-ia"
                                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 text-sm">
                                    <i class="fas fa-robot mr-2"></i>Gerar JSON com IA
                                </button>
                                <button type="button" onclick="atualizarJSON()" id="btn-atualizar-json"
                                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm"
                                    title="Sincroniza o JSON com as perguntas cadastradas, sem usar IA.">
                                    <i class="fas fa-sync-alt mr-2"></i>Atualizar JSON
                                </button>
                                <span id="status-geracao" class="text-sm text-gray-500"></span>
                            </div>

                            <!-- Preview do JSON Gerado -->
                            <div id="preview-json-gerado" class="hidden">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-700">
                                        <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                        JSON Gerado pela IA
                                    </label>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="aceitarJSONGerado()" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200">
                                            <i class="fas fa-check mr-1"></i>Aceitar e Usar
                                        </button>
                                        <button type="button" onclick="editarJSONGerado()" class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded text-sm hover:bg-yellow-200">
                                            <i class="fas fa-edit mr-1"></i>Editar
                                        </button>
                                        <button type="button" onclick="descartarJSONGerado()" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                            <i class="fas fa-times mr-1"></i>Descartar
                                        </button>
                                    </div>
                                </div>
                                <pre id="json-gerado-preview" class="p-4 bg-gray-800 text-green-400 rounded-lg text-sm overflow-auto max-h-64 font-mono"></pre>
                            </div>

                            <!-- Variáveis Criadas -->
                            <div id="variaveis-criadas" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-tags text-blue-500 mr-1"></i>
                                    Variáveis Criadas
                                </label>
                                <div id="lista-variaveis-criadas" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>

                        <!-- REFATORADO: Conteúdo Modo Legado - sem bloco explicativo -->
                        <div id="conteudo-modo-legado" class="space-y-4">

                            <!-- Formato JSON Manual -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Formato JSON Esperado
                                    <button type="button" onclick="validarJSON()" class="ml-2 text-primary-600 hover:text-primary-700 text-xs">
                                        <i class="fas fa-check-circle"></i> Validar JSON
                                    </button>
                                    <button type="button" onclick="formatarJSON()" class="ml-2 text-primary-600 hover:text-primary-700 text-xs">
                                        <i class="fas fa-indent"></i> Formatar
                                    </button>
                                </label>
                                <textarea id="categoria-formato-json" rows="12"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 json-editor text-sm"
                                    placeholder='{"tipo_documento": "string", "partes": {"autor": "string", "reu": "string"}, ...}'></textarea>
                                <p id="json-status" class="text-xs mt-1"></p>

                                <!-- Botão Aplicar JSON nas Perguntas -->
                                <div class="mt-3 flex items-center gap-3">
                                    <button type="button" onclick="aplicarJsonNasPerguntas()" id="btn-aplicar-json"
                                        class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm flex items-center gap-2">
                                        <i class="fas fa-arrow-right"></i>
                                        Aplicar JSON nas Perguntas
                                    </button>
                                    <span class="text-xs text-gray-500">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Sincroniza perguntas e variáveis com o JSON (cria, atualiza e remove)
                                    </span>
                                    <span id="status-aplicar-json" class="text-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instruções de extração (comum aos dois modos) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Instruções de Extração (opcional)</label>
                        <textarea id="categoria-instrucoes" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Instruções adicionais para a IA sobre como preencher os campos..."></textarea>
                    </div>

                    <!-- Opções -->
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="categoria-residual" class="rounded">
                            <span class="text-sm text-gray-700">Categoria Residual (fallback para documentos sem categoria)</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="categoria-ativo" checked class="rounded">
                            <span class="text-sm text-gray-700">Ativo</span>
                        </label>
                    </div>

                    <!-- Motivo (para edição) -->
                    <div id="campo-motivo" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Motivo da Alteração</label>
                        <input type="text" id="categoria-motivo"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Descreva o motivo da alteração...">
                    </div>
                </form>
            </div>

            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                <div class="flex items-center gap-3">
                    <button type="button" onclick="fecharEditor()" id="btn-cancelar-categoria" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Fechar
                    </button>
                    <!-- Feedback de erro inline -->
                    <span id="save-error-msg" class="text-sm text-red-600 hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="save-error-text"></span>
                    </span>
                </div>
                <button type="button" onclick="salvarCategoria()" id="btn-salvar-categoria" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px] transition-all">
                    <i class="fas fa-save mr-2"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Códigos -->
    <div id="modal-codigos" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Códigos de Documento TJ-MS</h2>
                <button onclick="fecharSeletorCodigos()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 border-b border-gray-200">
                <input type="text" id="busca-codigo" placeholder="Buscar código ou descrição..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg" oninput="filtrarCodigos()">
            </div>
            <div id="lista-codigos-disponiveis" class="flex-1 overflow-auto p-4">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin"></i> Carregando...
                </div>
            </div>
        </div>
    </div>

    <!-- REFATORADO: Modal de Nova/Editar Pergunta - header neutro -->
    <div id="modal-pergunta" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 id="modal-pergunta-titulo" class="text-lg font-semibold text-gray-800">Nova Pergunta de Extração</h2>
                <button onclick="fecharModalPergunta()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-auto p-6 space-y-4">
                <input type="hidden" id="pergunta-index" value="-1">

                <!-- Pergunta em linguagem natural -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pergunta em linguagem natural *</label>
                    <textarea id="pergunta-texto" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                        placeholder="Ex: Qual é o medicamento solicitado na petição?"></textarea>
                    <p class="text-xs text-gray-400 mt-1">Escreva como se estivesse perguntando a um assistente humano.</p>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <p class="text-sm text-gray-500 mb-3">
                        <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                        Sugestões opcionais (a IA decide se não preencher)
                    </p>

                    <!-- Nome da variável sugerido -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome base da variável</label>
                        <div class="flex items-stretch">
                            <!-- Prefixo fixo da categoria (não editável) -->
                            <span id="pergunta-prefixo-variavel"
                                class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 bg-gray-100 text-gray-600 text-sm rounded-l-lg font-mono"
                                title="Prefixo automático da categoria">
                                <!-- Preenchido via JS -->
                            </span>
                            <!-- Input para o nome base (sem prefixo) -->
                            <input type="text" id="pergunta-nome-variavel"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-primary-500 font-mono"
                                placeholder="ex: medicamento_solicitado">
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Apenas letras minúsculas, números e underscores. Prefixo aplicado automaticamente.</p>
                    </div>

                    <!-- Tipo de dado -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de dado sugerido</label>
                            <select id="pergunta-tipo"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                onchange="toggleOpcoesPergunta()">
                                <option value="">Deixar IA decidir</option>
                                <option value="text">Texto livre</option>
                                <option value="number">Número inteiro</option>
                                <option value="currency">Valor monetário</option>
                                <option value="boolean">Sim/Não</option>
                                <option value="date">Data</option>
                                <option value="choice">Lista de opções</option>
                                <option value="list">Lista de textos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="pergunta-ordem" value="0" min="0"
                                    class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                                <button type="button" id="btn-ordem-ia" onclick="toggleOrdemIABtn()"
                                    class="px-2.5 py-2 border-2 border-amber-300 bg-amber-50 text-amber-700 rounded-lg hover:bg-amber-100 hover:border-amber-400 transition-all flex items-center gap-1.5"
                                    title="Deixar a IA decidir a melhor posição para esta pergunta">
                                    <i class="fas fa-robot"></i>
                                    <span class="text-sm">IA decide</span>
                                </button>
                                <input type="checkbox" id="pergunta-ordem-ia" class="hidden">
                            </div>
                            <p id="ordem-ia-info" class="text-xs text-amber-600 mt-1 hidden flex items-center gap-1">
                                <i class="fas fa-robot"></i> A IA sugere a melhor posição ao salvar
                            </p>
                        </div>
                    </div>

                    <!-- Opções (para choice) -->
                    <div id="opcoes-pergunta-container" class="hidden mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Opções (uma por linha)</label>
                        <textarea id="pergunta-opcoes" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            placeholder="Deferido&#10;Indeferido&#10;Parcialmente deferido"></textarea>
                    </div>
                </div>

                <!-- Dependência Condicional -->
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="pergunta-tem-dependencia" class="rounded"
                            onchange="toggleDependenciaPergunta()">
                        <label for="pergunta-tem-dependencia" class="text-sm font-medium text-gray-700">
                            <i class="fas fa-code-branch text-gray-500 mr-1"></i>
                            Esta pergunta depende de outra
                        </label>
                    </div>

                    <!-- REFATORADO: Dependência com cores neutras -->
                    <div id="dependencia-pergunta-container" class="hidden space-y-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <p class="text-xs text-gray-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            A pergunta só será feita se a condição for satisfeita.
                        </p>

                        <!-- Seleção de variável -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Variável de dependência</label>
                            <select id="pergunta-depends-on"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white"
                                onchange="atualizarOperadoresDependencia()">
                                <option value="">Selecione uma variável ou pergunta anterior...</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">Pode ser uma variável existente ou o slug sugerido de uma pergunta anterior.</p>
                        </div>

                        <!-- Operador -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Condição</label>
                                <select id="pergunta-dependency-operator"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white"
                                    onchange="toggleValorDependencia()">
                                    <option value="equals">é igual a</option>
                                    <option value="not_equals">é diferente de</option>
                                    <option value="exists">existe (tem valor)</option>
                                    <option value="not_exists">não existe (vazio)</option>
                                    <option value="contains">contém</option>
                                    <option value="greater_than">é maior que</option>
                                    <option value="less_than">é menor que</option>
                                </select>
                            </div>

                            <!-- Valor -->
                            <div id="dependencia-valor-container">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor</label>
                                <input type="text" id="pergunta-dependency-value"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                    placeholder="ex: true, sim, medicamento">
                            </div>
                        </div>

                        <!-- Preview humanizado -->
                        <div id="dependencia-preview" class="p-2 bg-white rounded border border-gray-200 text-sm text-gray-600">
                            <span class="text-gray-400 italic">Configure a dependência acima</span>
                        </div>
                    </div>
                </div>

                <!-- Fonte de Verdade (edita a variável vinculada) -->
                <div id="fonte-verdade-container" class="border-t border-gray-200 pt-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-crosshairs text-gray-500"></i>
                        <span class="text-sm font-medium text-gray-700">Fonte de Verdade</span>
                        <span class="text-xs text-gray-400">(salvo na variável)</span>
                    </div>

                    <!-- Info quando não há variável vinculada -->
                    <div id="fonte-verdade-sem-variavel" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <p class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            A fonte de verdade será configurável após gerar a variável (salve a categoria primeiro).
                        </p>
                    </div>

                    <!-- Campos editáveis quando há variável -->
                    <div id="fonte-verdade-campos" class="space-y-3">
                        <input type="hidden" id="variavel-vinculada-id" value="">
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Código específico -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                    Código específico
                                </label>
                                <select id="pergunta-fonte-codigo"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                    <option value="">Todos os códigos</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Filtro por código TJ-MS</p>
                            </div>
                            <!-- Tipo lógico (LLM) -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                    Tipo lógico (LLM)
                                </label>
                                <input type="text" id="pergunta-fonte-tipo"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500"
                                    placeholder="ex: petição inicial">
                                <p class="text-xs text-gray-400 mt-1">Classificação semântica pela IA</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkbox ativo -->
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="pergunta-ativa" class="rounded" checked>
                    <label for="pergunta-ativa" class="text-sm text-gray-700">Pergunta ativa</label>
                </div>
            </div>

            <!-- REFATORADO: Footer com botão primário padrão -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                <button type="button" onclick="fecharModalPergunta()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button type="button" onclick="salvarPerguntaModal()"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    <i class="fas fa-save mr-1"></i> Salvar Pergunta
                </button>
            </div>
        </div>
    </div>

    <!-- REFATORADO: Modal de Perguntas em Lote - header neutro -->
    <div id="modal-perguntas-lote" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">
                        Adicionar Várias Perguntas
                    </h2>
                    <p class="text-sm text-gray-500">Uma pergunta por linha</p>
                </div>
                <button onclick="fecharModalPerguntasLote()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-auto p-6 space-y-4">
                <!-- REFATORADO: Instruções movidas para tooltip/dica discreta -->

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Perguntas (uma por linha)
                    </label>
                    <textarea id="perguntas-lote-texto" rows="10"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                        placeholder="é ação de medicamento? (pergunta mãe)
tem registro anvisa? (só se for medicamento)
é incorporado ao SUS? (depende da anterior)
se não incorporado, qual alternativa tentada?
qual o valor da causa?"></textarea>
                    <p class="text-xs text-gray-400 mt-1">
                        <span id="contador-linhas-lote">0 perguntas</span> detectadas
                    </p>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="analisar-dependencias-lote" class="rounded" checked>
                    <label for="analisar-dependencias-lote" class="text-sm text-gray-700">
                        Processar com IA (normalização + dependências)
                    </label>
                </div>

                <!-- REFATORADO: Info discreta -->
                <p class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    A IA pode reescrever, mas o número de perguntas será mantido.
                </p>
            </div>

            <!-- REFATORADO: Footer com botão primário padrão -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                <span id="status-lote" class="text-sm text-gray-500"></span>
                <div class="flex gap-3">
                    <button type="button" onclick="fecharModalPerguntasLote()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        Cancelar
                    </button>
                    <button type="button" onclick="salvarPerguntasLote()" id="btn-salvar-lote"
                        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <i class="fas fa-plus mr-2"></i>Criar Perguntas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api/categorias-resumo-json';
        const API_EXTRACTION = '/admin/api/extraction';
        let categorias = [];
        let codigosDisponiveis = [];
        let codigosSelecionados = [];
        let perguntasSelecionadas = [];
        let categoriaAtual = null;
        let modoSelecionado = 'legado'; // 'ia' ou 'legado' - LEGADO é o padrão
        let jsonGeradoPorIA = false; // Se o JSON atual foi gerado por IA
        let jsonGerado = null;
        let mapeamentoVariaveis = {}; // Mapeamento pergunta_id -> info da variável
        let variaveisGeradas = [];
        let perguntasExistentes = []; // Perguntas já salvas no banco

        // ==========================================
        // Performance Metrics (Frontend)
        // ==========================================
        const perfMetrics = {
            clickTime: 0,
            loadingShownTime: 0,
            requestStartTime: 0,
            requestEndTime: 0,
            modalOpenTime: 0,
            currentAction: null
        };

        function startPerfMeasure(action) {
            perfMetrics.clickTime = performance.now();
            perfMetrics.currentAction = action;
            perfMetrics.loadingShownTime = 0;
            perfMetrics.requestStartTime = 0;
            perfMetrics.requestEndTime = 0;
            perfMetrics.modalOpenTime = 0;
        }

        function markLoadingShown() {
            perfMetrics.loadingShownTime = performance.now();
        }

        function markRequestStart() {
            perfMetrics.requestStartTime = performance.now();
        }

        function markRequestEnd() {
            perfMetrics.requestEndTime = performance.now();
        }

        function finishPerfMeasure() {
            perfMetrics.modalOpenTime = performance.now();

            const metrics = {
                action: perfMetrics.currentAction,
                click_to_loading_ms: perfMetrics.loadingShownTime - perfMetrics.clickTime,
                click_to_request_ms: perfMetrics.requestStartTime - perfMetrics.clickTime,
                request_duration_ms: perfMetrics.requestEndTime - perfMetrics.requestStartTime,
                click_to_modal_ms: perfMetrics.modalOpenTime - perfMetrics.clickTime,
                timestamp: new Date().toISOString()
            };

            // Log no console para debugging
            console.log('[PERF]', perfMetrics.currentAction, metrics);

            // Envia para o backend (fire-and-forget)
            sendPerfMetrics(metrics);

            return metrics;
        }

        async function sendPerfMetrics(metrics) {
            try {
                await fetch('/admin/api/performance/frontend-metrics', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        route: '/admin/categorias-resumo-json',
                        ...metrics
                    })
                });
            } catch (e) {
                // Silently ignore - metrics are best-effort
            }
        }

        // Loading overlay global para feedback imediato
        function showLoadingOverlay(message = 'Carregando...') {
            let overlay = document.getElementById('loading-overlay-global');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loading-overlay-global';
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                overlay.innerHTML = `
                    <div class="bg-white rounded-lg p-6 shadow-xl flex items-center gap-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"></div>
                        <span class="text-gray-700 font-medium" id="loading-overlay-text">${message}</span>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                document.getElementById('loading-overlay-text').textContent = message;
                overlay.classList.remove('hidden');
            }
            markLoadingShown();
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay-global');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Autenticação
        function getToken() {
            return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            };
        }

        // Fontes especiais disponíveis
        let fontesEspeciais = [];

        // Carrega fontes especiais disponíveis
        async function carregarFontesEspeciais() {
            try {
                const response = await fetch(`${API_BASE}/fontes-especiais`, {
                    headers: getHeaders()
                });
                if (response.ok) {
                    fontesEspeciais = await response.json();
                    popularSelectFontesEspeciais();
                }
            } catch (error) {
                console.error('Erro ao carregar fontes especiais:', error);
            }
        }

        // Popular dropdown de fontes especiais
        function popularSelectFontesEspeciais() {
            const select = document.getElementById('categoria-fonte-especial');
            select.innerHTML = '<option value="">-- Selecione --</option>';
            fontesEspeciais.forEach(fonte => {
                const option = document.createElement('option');
                option.value = fonte.key;
                option.textContent = fonte.nome;
                option.dataset.descricao = fonte.descricao;
                select.appendChild(option);
            });

            // Listener para mostrar descrição
            select.onchange = function() {
                const descEl = document.getElementById('descricao-fonte-especial');
                const selected = this.options[this.selectedIndex];
                if (selected.value && selected.dataset.descricao) {
                    descEl.textContent = selected.dataset.descricao;
                    descEl.classList.remove('hidden');
                } else {
                    descEl.classList.add('hidden');
                }
            };
        }

        // Alternar tipo de fonte (código vs especial)
        function alterarTipoFonte(tipo) {
            const secaoCodigos = document.getElementById('secao-codigos-documento');
            const secaoEspecial = document.getElementById('secao-fonte-especial');

            if (tipo === 'special') {
                secaoCodigos.classList.add('hidden');
                secaoEspecial.classList.remove('hidden');
            } else {
                secaoCodigos.classList.remove('hidden');
                secaoEspecial.classList.add('hidden');
            }
        }

        // Define o tipo de fonte no formulário
        function setTipoFonte(tipo, valorEspecial = '') {
            // Marca o radio correto
            document.querySelectorAll('input[name="source_type"]').forEach(radio => {
                radio.checked = (radio.value === tipo);
            });

            // Atualiza visibilidade
            alterarTipoFonte(tipo);

            // Se especial, seleciona o valor
            if (tipo === 'special' && valorEspecial) {
                document.getElementById('categoria-fonte-especial').value = valorEspecial;
                // Dispara change para mostrar descrição
                document.getElementById('categoria-fonte-especial').dispatchEvent(new Event('change'));
            }
        }

        // Carrega categorias
        async function carregarCategorias() {
            try {
                const response = await fetch(`${API_BASE}?apenas_ativos=false`, {
                    headers: getHeaders()
                });
                
                if (response.status === 401) {
                    window.location.href = '/login?redirect=/admin/categorias-resumo-json';
                    return;
                }
                
                categorias = await response.json();
                renderizarCategorias();
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                document.getElementById('lista-categorias').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Erro ao carregar categorias</p>
                    </div>
                `;
            }
        }

        // Renderiza lista de categorias
        function renderizarCategorias() {
            const container = document.getElementById('lista-categorias');
            
            if (categorias.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Nenhuma categoria cadastrada</p>
                        <p class="text-sm">Clique em "Nova Categoria" para começar</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = categorias.map(cat => `
                <div class="bg-white rounded-xl border ${cat.ativo ? 'border-gray-200' : 'border-red-200 bg-red-50'} shadow-sm p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2 flex-wrap">
                                <h3 class="text-lg font-semibold ${cat.ativo ? 'text-gray-800' : 'text-gray-500'}">${cat.titulo}</h3>
                                ${cat.json_gerado_por_ia ? `
                                    <span class="px-2 py-0.5 text-xs rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold flex items-center gap-1">
                                        <i class="fas fa-magic"></i> GERADO POR IA
                                    </span>
                                ` : ''}
                                ${cat.is_residual ? '<span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">RESIDUAL</span>' : ''}
                                ${!cat.ativo ? '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">INATIVO</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <button onclick="verPerguntas(${cat.id})" class="text-xs text-purple-600 hover:text-purple-800 hover:underline">
                                    <i class="fas fa-brain mr-1"></i>Ver perguntas
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 font-mono mb-2">${cat.nome}</p>
                            ${cat.descricao ? `<p class="text-sm text-gray-600 mb-3">${cat.descricao}</p>` : ''}

                            <div class="flex flex-wrap gap-2 mb-3">
                                ${(cat.codigos_documento || []).slice(0, 10).map(cod =>
                                    `<span class="codigo-pill">${cod}</span>`
                                ).join('')}
                                ${(cat.codigos_documento || []).length > 10 ?
                                    `<span class="text-xs text-gray-500">+${cat.codigos_documento.length - 10} mais</span>` : ''}
                                ${(cat.codigos_documento || []).length === 0 && !cat.is_residual ?
                                    '<span class="text-xs text-gray-400 italic">Nenhum código associado</span>' : ''}
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button onclick="editarCategoria(${cat.id})"
                                class="px-3 py-1.5 text-primary-600 hover:bg-primary-50 rounded-lg text-sm">
                                <i class="fas fa-edit mr-1"></i> Editar
                            </button>
                            ${!cat.is_residual ? `
                                <button onclick="confirmarExclusao(${cat.id}, '${cat.titulo}')"
                                    class="px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-lg text-sm">
                                    <i class="fas fa-trash mr-1"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Preview do formato JSON -->
                    <details class="mt-3">
                        <summary class="text-sm text-primary-600 cursor-pointer hover:text-primary-700">
                            <i class="fas fa-code mr-1"></i> Ver formato JSON
                        </summary>
                        <pre class="mt-2 p-3 bg-gray-50 rounded-lg text-xs overflow-auto max-h-48 border">${escapeHtml(cat.formato_json)}</pre>
                    </details>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Criar nova categoria
        function criarCategoria() {
            categoriaAtual = null;
            codigosSelecionados = [];
            perguntasSelecionadas = [];
            perguntasExistentes = [];
            jsonGerado = null;
            mapeamentoVariaveis = {};
            variaveisGeradas = [];
            jsonGeradoPorIA = false;

            document.getElementById('modal-titulo').textContent = 'Nova Categoria';
            document.getElementById('modal-subtitulo').textContent = '';
            document.getElementById('categoria-id').value = '';
            document.getElementById('categoria-nome').value = '';
            document.getElementById('categoria-titulo').value = '';
            document.getElementById('categoria-descricao').value = '';
            document.getElementById('categoria-formato-json').value = `{
  "tipo_documento": "string - tipo identificado do documento",
  "partes": {
    "autor": "string ou null",
    "reu": "string ou null"
  },
  "pedido_objeto": "string - o que está sendo requerido",
  "argumentos_principais": ["string - lista de argumentos"],
  "decisao_dispositivo": "string ou null",
  "pontos_relevantes": ["string"],
  "irrelevante": false
}`;
            document.getElementById('categoria-instrucoes').value = '';
            document.getElementById('categoria-residual').checked = false;
            document.getElementById('categoria-ativo').checked = true;
            document.getElementById('campo-motivo').classList.add('hidden');

            // Começa no modo legado (padrão)
            selecionarModo('legado');
            atualizarListaPerguntas();
            atualizarBadgeJsonIA();
            document.getElementById('preview-json-gerado').classList.add('hidden');
            document.getElementById('variaveis-criadas').classList.add('hidden');
            document.getElementById('status-geracao').textContent = '';

            atualizarListaCodigos();

            // Reset fonte especial para modo padrão (código)
            setTipoFonte('code', '');
            document.getElementById('categoria-fonte-especial').value = '';
            document.getElementById('descricao-fonte-especial').classList.add('hidden');

            // Limpa campos de fonte de verdade do grupo
            atualizarSelectFonteCodigo();
            document.getElementById('categoria-fonte-codigo').value = '';
            document.getElementById('categoria-fonte-tipo-llm').value = '';

            document.getElementById('modal-editor').classList.remove('hidden');
        }

        // Editar categoria existente
        async function editarCategoria(id) {
            // PERFORMANCE: Feedback imediato - mostrar loading NO MESMO TICK do click
            startPerfMeasure('editar_categoria');
            showLoadingOverlay('Carregando categoria...');

            try {
                // Fetch categoria
                markRequestStart();
                const response = await fetch(`${API_BASE}/${id}`, { headers: getHeaders() });
                const categoria = await response.json();
                markRequestEnd();

                categoriaAtual = categoria;
                codigosSelecionados = categoria.codigos_documento || [];
                jsonGerado = null;
                mapeamentoVariaveis = {};
                variaveisGeradas = [];
                jsonGeradoPorIA = categoria.json_gerado_por_ia || false;

                document.getElementById('modal-titulo').textContent = 'Editar Categoria';
                document.getElementById('modal-subtitulo').textContent = `ID: ${categoria.id}`;
                document.getElementById('categoria-id').value = categoria.id;
                document.getElementById('categoria-nome').value = categoria.nome;
                document.getElementById('categoria-titulo').value = categoria.titulo;
                document.getElementById('categoria-descricao').value = categoria.descricao || '';
                document.getElementById('categoria-formato-json').value = categoria.formato_json;
                document.getElementById('categoria-instrucoes').value = categoria.instrucoes_extracao || '';
                document.getElementById('categoria-residual').checked = categoria.is_residual;
                document.getElementById('categoria-ativo').checked = categoria.ativo;
                document.getElementById('campo-motivo').classList.remove('hidden');
                document.getElementById('categoria-motivo').value = '';

                // Carrega perguntas existentes da categoria
                await carregarPerguntasCategoria(id);

                // Sempre começa no modo legado (que é o padrão)
                // O usuário pode alternar para modo IA se desejar
                selecionarModo('legado');

                // Atualiza badge de JSON gerado por IA
                atualizarBadgeJsonIA();

                // Reset preview
                document.getElementById('preview-json-gerado').classList.add('hidden');
                document.getElementById('variaveis-criadas').classList.add('hidden');
                document.getElementById('status-geracao').textContent = '';

                atualizarListaCodigos();

                // Configura tipo de fonte (código vs especial)
                const sourceType = categoria.source_type || 'code';
                const sourceSpecialType = categoria.source_special_type || '';
                setTipoFonte(sourceType, sourceSpecialType);

                // Carrega campos de fonte de verdade do grupo
                atualizarSelectFonteCodigo();
                document.getElementById('categoria-fonte-codigo').value = categoria.fonte_verdade_codigo || '';
                document.getElementById('categoria-fonte-tipo-llm').value = categoria.fonte_verdade_tipo || '';

                // Esconde loading e abre modal
                hideLoadingOverlay();
                document.getElementById('modal-editor').classList.remove('hidden');

                // Registra métricas de performance
                finishPerfMeasure();
            } catch (error) {
                console.error('Erro ao carregar categoria:', error);
                hideLoadingOverlay();
                alert('Erro ao carregar categoria');
            }
        }

        // Atualiza badge indicando se JSON foi gerado por IA
        function atualizarBadgeJsonIA() {
            const badge = document.getElementById('badge-json-ia');
            if (jsonGeradoPorIA) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Fechar editor
        function fecharEditor() {
            document.getElementById('modal-editor').classList.add('hidden');
            categoriaAtual = null;

            // Reseta estado do botão salvar
            const btnSalvar = document.getElementById('btn-salvar-categoria');
            const btnCancelar = document.getElementById('btn-cancelar-categoria');
            const errorMsg = document.getElementById('save-error-msg');

            if (btnSalvar) {
                btnSalvar.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar';
                btnSalvar.classList.add('bg-primary-600', 'hover:bg-primary-700');
                btnSalvar.classList.remove('bg-green-600');
                btnSalvar.disabled = false;
            }
            if (btnCancelar) {
                btnCancelar.disabled = false;
            }
            if (errorMsg) {
                errorMsg.classList.add('hidden');
            }
        }

        // Adicionar código
        function adicionarCodigo() {
            const input = document.getElementById('novo-codigo');
            const codigo = parseInt(input.value.trim());

            if (isNaN(codigo) || codigo <= 0) {
                alert('Digite um código numérico válido');
                return;
            }

            if (codigosSelecionados.includes(codigo)) {
                alert('Este código já foi adicionado');
                return;
            }

            codigosSelecionados.push(codigo);
            input.value = '';
            atualizarListaCodigos();
        }

        // Remover código
        function removerCodigo(codigo) {
            codigosSelecionados = codigosSelecionados.filter(c => c !== codigo);
            atualizarListaCodigos();
        }

        // Atualizar lista visual de códigos
        function atualizarListaCodigos() {
            const container = document.getElementById('lista-codigos');

            if (codigosSelecionados.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum código adicionado</span>';
                return;
            }

            container.innerHTML = codigosSelecionados.map(cod => `
                <span class="codigo-pill flex items-center gap-1">
                    ${cod}
                    <button type="button" onclick="removerCodigo(${cod})" class="text-green-500 hover:text-green-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');

            // Atualiza tambem o select de fonte de verdade
            atualizarSelectFonteCodigo();
        }

        // Atualizar select de Fonte de Verdade (codigo especifico)
        function atualizarSelectFonteCodigo() {
            const select = document.getElementById('categoria-fonte-codigo');
            if (!select) return;

            const valorAtual = select.value;
            select.innerHTML = '<option value="">Todos os codigos do grupo</option>';

            codigosSelecionados.forEach(cod => {
                select.innerHTML += `<option value="${cod}">${cod}</option>`;
            });

            // Restaura valor se ainda existir na lista
            if (valorAtual && codigosSelecionados.includes(parseInt(valorAtual))) {
                select.value = valorAtual;
            }
        }

        // ==========================================
        // Funções do Modo IA
        // ==========================================

        // Selecionar modo (ia ou legado)
        function selecionarModo(modo) {
            modoSelecionado = modo;

            const tabIA = document.getElementById('tab-modo-ia');
            const tabLegado = document.getElementById('tab-modo-legado');
            const conteudoIA = document.getElementById('conteudo-modo-ia');
            const conteudoLegado = document.getElementById('conteudo-modo-legado');

            if (modo === 'ia') {
                tabIA.className = 'px-4 py-2 text-sm font-medium border-b-2 border-primary-500 text-primary-600 bg-primary-50 rounded-t-lg';
                tabLegado.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                conteudoIA.classList.remove('hidden');
                conteudoLegado.classList.add('hidden');
            } else {
                tabLegado.className = 'px-4 py-2 text-sm font-medium border-b-2 border-primary-500 text-primary-600 bg-primary-50 rounded-t-lg';
                tabIA.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                conteudoLegado.classList.remove('hidden');
                conteudoIA.classList.add('hidden');
            }
        }

        // ==========================================
        // Funções de Perguntas em Lote
        // ==========================================

        function abrirModalPerguntasLote() {
            document.getElementById('perguntas-lote-texto').value = '';
            document.getElementById('status-lote').textContent = '';
            atualizarContadorLinhasLote();
            document.getElementById('modal-perguntas-lote').classList.remove('hidden');

            // Adiciona listener para contar linhas
            document.getElementById('perguntas-lote-texto').addEventListener('input', atualizarContadorLinhasLote);
        }

        function fecharModalPerguntasLote() {
            document.getElementById('modal-perguntas-lote').classList.add('hidden');
        }

        function atualizarContadorLinhasLote() {
            const texto = document.getElementById('perguntas-lote-texto').value;
            const linhas = texto.split('\n').filter(l => l.trim()).length;
            document.getElementById('contador-linhas-lote').textContent = `${linhas} pergunta${linhas !== 1 ? 's' : ''}`;
        }

        async function salvarPerguntasLote() {
            const categoriaId = document.getElementById('categoria-id').value;
            if (!categoriaId) {
                alert('Salve a categoria primeiro');
                return;
            }

            const texto = document.getElementById('perguntas-lote-texto').value;
            const linhas = texto.split('\n').filter(l => l.trim());

            if (linhas.length === 0) {
                alert('Digite pelo menos uma pergunta');
                return;
            }

            const analisarDependencias = document.getElementById('analisar-dependencias-lote').checked;

            const btn = document.getElementById('btn-salvar-lote');
            const status = document.getElementById('status-lote');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';
            status.textContent = analisarDependencias ? 'Normalizando perguntas e analisando dependências com IA...' : 'Criando perguntas...';
            status.className = 'text-sm text-blue-500';

            try {
                const perguntas = linhas.map(l => ({
                    pergunta: l.trim()
                }));

                const response = await fetch(`${API_EXTRACTION}/perguntas/lote`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        categoria_id: parseInt(categoriaId),
                        perguntas: perguntas,
                        analisar_dependencias: analisarDependencias
                    })
                });

                const resultado = await response.json();

                if (!resultado.success) {
                    throw new Error(resultado.erro || 'Erro ao criar perguntas');
                }

                status.textContent = `✓ ${resultado.total_criadas} perguntas criadas (${resultado.total_com_dependencias} com dependências)`;
                status.className = 'text-sm text-green-600';

                // Recarrega perguntas da categoria
                await carregarPerguntasCategoria(categoriaId);

                // Fecha modal após 1.5s
                setTimeout(() => {
                    fecharModalPerguntasLote();
                }, 1500);

            } catch (error) {
                console.error('Erro:', error);
                // Mensagem mais clara para erros de validação 1:1
                const isValidacao11 = error.message.includes('retornou') &&
                    (error.message.includes('perguntas') || error.message.includes('índices'));
                if (isValidacao11) {
                    status.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${error.message}`;
                } else {
                    status.textContent = `Erro: ${error.message}`;
                }
                status.className = 'text-sm text-red-500';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Criar Perguntas';
            }
        }

        // Adicionar pergunta
        function adicionarPergunta() {
            const input = document.getElementById('nova-pergunta');
            const texto = input.value.trim();

            if (!texto) {
                alert('Digite uma pergunta');
                return;
            }

            // Verifica duplicata
            if (perguntasSelecionadas.some(p => p.pergunta.toLowerCase() === texto.toLowerCase())) {
                alert('Esta pergunta já foi adicionada');
                return;
            }

            perguntasSelecionadas.push({
                pergunta: texto,
                ordem: perguntasSelecionadas.length
            });

            input.value = '';
            atualizarListaPerguntas();
        }

        // Remover pergunta
        async function removerPergunta(index) {
            const pergunta = perguntasSelecionadas[index];

            // Se a pergunta ainda não foi salva (sem ID), apenas remove da lista
            if (!pergunta.id) {
                if (!confirm('Tem certeza que deseja remover esta pergunta?')) {
                    return;
                }
                perguntasSelecionadas.splice(index, 1);
                perguntasSelecionadas.forEach((p, i) => p.ordem = i);
                atualizarListaPerguntas();
                return;
            }

            // Pergunta já salva - verifica se tem variáveis vinculadas
            let temVariaveis = false;
            try {
                const response = await fetch(`${API_EXTRACTION}/variaveis?source_question_id=${pergunta.id}&apenas_ativos=false`, {
                    headers: getHeaders()
                });
                if (response.ok) {
                    const variaveis = await response.json();
                    temVariaveis = variaveis.length > 0;
                }
            } catch (e) {
                console.error('Erro ao verificar variáveis:', e);
            }

            // Monta mensagem de confirmação
            let mensagem = `Tem certeza que deseja excluir a pergunta:\n\n"${pergunta.pergunta}"?\n\n`;
            if (temVariaveis) {
                mensagem += '⚠️ ATENÇÃO: Esta pergunta possui variáveis vinculadas.\n';
                mensagem += 'As variáveis continuarão existindo, mas ficarão sem vínculo com a pergunta de origem.\n\n';
            }
            mensagem += 'Esta ação não pode ser desfeita.';

            if (!confirm(mensagem)) {
                return;
            }

            // Exclui do banco via API
            try {
                const response = await fetch(`${API_EXTRACTION}/perguntas/${pergunta.id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir pergunta');
                }

                // Remove da lista local
                perguntasSelecionadas.splice(index, 1);
                perguntasSelecionadas.forEach((p, i) => p.ordem = i);
                atualizarListaPerguntas();

                // Feedback visual
                const statusEl = document.getElementById('status-geracao');
                if (statusEl) {
                    statusEl.textContent = 'Pergunta excluída com sucesso!';
                    statusEl.className = 'text-sm text-green-600';
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Erro ao excluir pergunta:', error);
                alert(`Erro ao excluir pergunta: ${error.message}`);
            }
        }

        // Atualizar lista visual de perguntas
        function atualizarListaPerguntas() {
            const container = document.getElementById('lista-perguntas');
            const contador = document.getElementById('contador-perguntas');

            // Atualiza contador
            if (contador) {
                contador.textContent = `(${perguntasSelecionadas.length} pergunta${perguntasSelecionadas.length !== 1 ? 's' : ''})`;
            }

            if (perguntasSelecionadas.length === 0) {
                container.innerHTML = `
                    <p class="text-gray-400 text-sm text-center py-8">
                        <i class="fas fa-question-circle text-2xl mb-2 block"></i>
                        Nenhuma pergunta adicionada ainda.<br>
                        <span class="text-xs">Clique em "Nova Pergunta" para começar.</span>
                    </p>`;
                return;
            }

            // Helper para badge de tipo
            const getTipoBadge = (tipo) => {
                const tipos = {
                    'text': { bg: 'bg-gray-100', text: 'text-gray-600', label: 'Texto' },
                    'number': { bg: 'bg-blue-100', text: 'text-blue-600', label: 'Número' },
                    'currency': { bg: 'bg-green-100', text: 'text-green-600', label: 'Moeda' },
                    'boolean': { bg: 'bg-purple-100', text: 'text-purple-600', label: 'Sim/Não' },
                    'date': { bg: 'bg-orange-100', text: 'text-orange-600', label: 'Data' },
                    'choice': { bg: 'bg-indigo-100', text: 'text-indigo-600', label: 'Lista' },
                    'list': { bg: 'bg-teal-100', text: 'text-teal-600', label: 'Lista' }
                };
                if (!tipo) return '';
                const t = tipos[tipo] || { bg: 'bg-gray-100', text: 'text-gray-600', label: tipo };
                return `<span class="px-1.5 py-0.5 text-xs rounded ${t.bg} ${t.text}">${t.label}</span>`;
            };

            container.innerHTML = perguntasSelecionadas.map((p, index) => `
                <div class="pergunta-item bg-white rounded-lg border ${p.ativo === false ? 'border-red-200 bg-red-50' : 'border-gray-200'} p-3 hover:border-primary-300 hover:shadow-sm transition-all" data-index="${index}" data-id="${p.id || ''}">
                    <div class="flex items-start gap-3">
                        <!-- Drag handle -->
                        <div class="drag-handle text-gray-300 hover:text-gray-500 mt-1 shrink-0" title="Arraste para reordenar">
                            <i class="fas fa-grip-vertical"></i>
                        </div>

                        <!-- Número da ordem -->
                        <span class="text-gray-400 text-xs font-mono mt-1 w-6 shrink-0">${index + 1}.</span>

                        <!-- Conteúdo principal -->
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-gray-800 mb-1.5 ${p.ativo === false ? 'text-gray-500' : ''}">${escapeHtml(p.pergunta)}</div>

                            <!-- Badges e info -->
                            <div class="flex flex-wrap items-center gap-2">
                                ${p.nome_variavel_sugerido ? `
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-amber-50 text-amber-700 font-mono">
                                        <i class="fas fa-tag text-amber-400 mr-0.5"></i>${escapeHtml(p.nome_variavel_sugerido)}
                                    </span>
                                ` : ''}
                                ${getTipoBadge(p.tipo_sugerido)}
                                ${p.opcoes_sugeridas && p.opcoes_sugeridas.length > 0 ? `
                                    <span class="text-xs text-gray-400">(${p.opcoes_sugeridas.length} opções)</span>
                                ` : ''}
                                ${p.depends_on_variable ? `
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-purple-50 text-purple-600" title="Depende de: ${escapeHtml(p.depends_on_variable)}">
                                        <i class="fas fa-code-branch text-purple-400 mr-0.5"></i>${escapeHtml(p.depends_on_variable)}
                                    </span>
                                ` : ''}
                                ${p.ativo === false ? `
                                    <span class="px-1.5 py-0.5 text-xs rounded bg-red-100 text-red-600">INATIVA</span>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Ações -->
                        <div class="flex items-center gap-1 shrink-0">
                            <button type="button" onclick="abrirModalPergunta(${index})"
                                class="p-1.5 text-gray-400 hover:text-primary-600 hover:bg-primary-50 rounded" title="Editar">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button type="button" onclick="removerPergunta(${index})"
                                class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded" title="Remover">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Inicializa drag-and-drop com Sortable
            inicializarSortablePerguntas();
        }

        // Instância do Sortable para perguntas
        let sortablePerguntasInstance = null;

        // Inicializa o Sortable para drag-and-drop de perguntas
        function inicializarSortablePerguntas() {
            const container = document.getElementById('lista-perguntas');
            if (!container || perguntasSelecionadas.length === 0) return;

            // Destroy instância anterior se existir
            if (sortablePerguntasInstance) {
                sortablePerguntasInstance.destroy();
                sortablePerguntasInstance = null;
            }

            sortablePerguntasInstance = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: async function(evt) {
                    // Reordena o array local
                    const [movedItem] = perguntasSelecionadas.splice(evt.oldIndex, 1);
                    perguntasSelecionadas.splice(evt.newIndex, 0, movedItem);

                    // Atualiza a ordem de cada item no array
                    perguntasSelecionadas.forEach((p, i) => {
                        p.ordem = i;
                    });

                    // PERFORMANCE: Atualiza apenas os números visíveis, sem re-renderizar DOM inteiro
                    // O Sortable já moveu o elemento no DOM, só precisamos atualizar os números
                    atualizarNumerosOrdem();

                    // Reordena o JSON para seguir a nova ordem das perguntas
                    reordenarJSONComPerguntas();

                    // Salva a nova ordem no servidor se a categoria já existe
                    const categoriaId = document.getElementById('categoria-id').value;
                    if (categoriaId) {
                        await salvarOrdemPerguntas(categoriaId);
                    }
                }
            });
        }

        // PERFORMANCE: Atualiza apenas os números de ordem sem re-renderizar a lista inteira
        function atualizarNumerosOrdem() {
            const container = document.getElementById('lista-perguntas');
            const items = container.querySelectorAll('.pergunta-item');

            items.forEach((item, index) => {
                // Atualiza o número de ordem exibido
                const numeroEl = item.querySelector('.text-gray-400.text-xs.font-mono');
                if (numeroEl) {
                    numeroEl.textContent = `${index + 1}.`;
                }

                // Atualiza o data-index para manter consistência com o array
                item.setAttribute('data-index', index);

                // Atualiza os handlers dos botões de ação (editar e remover)
                // Os botões usam onclick com índice, que precisa ser atualizado após reordenação
                const btnEditar = item.querySelector('button[title="Editar"]');
                const btnRemover = item.querySelector('button[title="Remover"]');

                if (btnEditar) {
                    btnEditar.onclick = () => abrirModalPergunta(index);
                }
                if (btnRemover) {
                    btnRemover.onclick = () => removerPergunta(index);
                }
            });

            // Atualiza o contador de perguntas
            const contador = document.getElementById('contador-perguntas');
            if (contador) {
                contador.textContent = `(${perguntasSelecionadas.length} pergunta${perguntasSelecionadas.length !== 1 ? 's' : ''})`;
            }
        }

        // Salva a ordem das perguntas no servidor (OTIMIZADO: usa endpoint batch)
        async function salvarOrdemPerguntas(categoriaId) {
            try {
                // Filtra apenas perguntas que já têm ID (já salvas no banco)
                const perguntasComId = perguntasSelecionadas
                    .map((p, i) => ({ id: p.id, ordem: i }))
                    .filter(p => p.id);

                if (perguntasComId.length === 0) {
                    console.log('Nenhuma pergunta salva para reordenar');
                    return;
                }

                // PERFORMANCE: Uma única requisição em vez de N requisições
                const response = await fetch(`${API_EXTRACTION}/perguntas/ordem-lote`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        categoria_id: parseInt(categoriaId),
                        perguntas: perguntasComId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar ordem');
                }

                const resultado = await response.json();
                console.log(`Ordem salva: ${resultado.atualizadas} perguntas atualizadas`);
            } catch (error) {
                console.error('Erro ao salvar ordem das perguntas:', error);
            }
        }

        // Reordena perguntas usando IA
        async function reordenarComIA() {
            const categoriaId = document.getElementById('categoria-id').value;
            const categoriaNome = document.getElementById('categoria-nome').value || 'categoria';

            if (perguntasSelecionadas.length < 2) {
                alert('Adicione pelo menos 2 perguntas para reordenar');
                return;
            }

            // Se categoria existe, salva perguntas primeiro
            if (categoriaId) {
                await salvarPerguntasNoServidor(categoriaId);
            }

            const btn = document.getElementById('btn-reordenar-ia');
            const statusEl = document.getElementById('status-geracao');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Reordenando...';
            if (statusEl) {
                statusEl.textContent = 'Aguarde, a IA está analisando a melhor ordem...';
                statusEl.className = 'text-sm text-blue-500';
            }

            try {
                const perguntas = perguntasSelecionadas.map(p => ({
                    id: p.id || null,
                    pergunta: p.pergunta,
                    tipo_sugerido: p.tipo_sugerido || null,
                    depends_on_variable: p.depends_on_variable || null
                }));

                const response = await fetch(`${API_EXTRACTION}/perguntas/ordenar-ia`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        categoria_nome: categoriaNome,
                        perguntas: perguntas
                    })
                });

                const resultado = await response.json();

                if (!resultado.success) {
                    throw new Error(resultado.erro || 'Erro ao reordenar');
                }

                // Aplica a nova ordem
                const novaOrdem = resultado.ordem;
                const perguntasMap = new Map(perguntasSelecionadas.map(p => [p.pergunta.toLowerCase().trim(), p]));
                const novasPerguntas = [];

                for (const item of novaOrdem) {
                    const p = perguntasMap.get(item.pergunta.toLowerCase().trim());
                    if (p) {
                        novasPerguntas.push(p);
                    }
                }

                // Adiciona perguntas que não foram incluídas (fallback)
                const incluidas = new Set(novasPerguntas.map(p => p.pergunta.toLowerCase().trim()));
                for (const p of perguntasSelecionadas) {
                    if (!incluidas.has(p.pergunta.toLowerCase().trim())) {
                        novasPerguntas.push(p);
                    }
                }

                // Atualiza ordem
                perguntasSelecionadas = novasPerguntas;
                perguntasSelecionadas.forEach((p, i) => p.ordem = i);

                atualizarListaPerguntas();

                // Reordena o JSON para seguir a ordem das perguntas
                reordenarJSONComPerguntas();

                // Salva no servidor
                if (categoriaId) {
                    await salvarOrdemPerguntas(categoriaId);
                }

                if (statusEl) {
                    statusEl.textContent = 'Perguntas e JSON reordenados com sucesso pela IA!';
                    statusEl.className = 'text-sm text-green-600';
                }

            } catch (error) {
                console.error('Erro ao reordenar com IA:', error);
                if (statusEl) {
                    statusEl.textContent = `Erro: ${error.message}`;
                    statusEl.className = 'text-sm text-red-500';
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot"></i> Reordenar';
            }
        }

        // Agrupa perguntas por dependências (determinístico, sem IA)
        async function agruparPorDependencias() {
            const categoriaId = document.getElementById('categoria-id').value;

            if (!categoriaId) {
                alert('Salve a categoria primeiro para agrupar por dependências');
                return;
            }

            if (perguntasSelecionadas.length < 2) {
                alert('Adicione pelo menos 2 perguntas para agrupar');
                return;
            }

            // Verifica se há dependências definidas
            const temDependencias = perguntasSelecionadas.some(p => p.depends_on_variable);
            if (!temDependencias) {
                alert('Nenhuma pergunta tem dependência definida.\n\nUse "Dependências IA" para criar dependências primeiro, ou defina manualmente em cada pergunta.');
                return;
            }

            // Salva perguntas primeiro
            await salvarPerguntasNoServidor(categoriaId);

            const btn = document.getElementById('btn-agrupar-dependencias');
            const statusEl = document.getElementById('status-geracao');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Agrupando...';
            if (statusEl) {
                statusEl.textContent = 'Organizando hierarquia de dependências...';
                statusEl.className = 'text-sm text-blue-500';
            }

            try {
                const response = await fetch(`${API_EXTRACTION}/perguntas/agrupar-por-dependencias`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        categoria_id: parseInt(categoriaId)
                    })
                });

                const resultado = await response.json();

                if (!resultado.success) {
                    throw new Error(resultado.message || resultado.detail || 'Erro ao agrupar');
                }

                // Aplica nova ordem no frontend (otimista)
                if (resultado.nova_ordem && resultado.nova_ordem.length > 0) {
                    const ordemMap = new Map(resultado.nova_ordem.map(item => [item.id, item.ordem]));

                    // Atualiza ordem local
                    perguntasSelecionadas.forEach(p => {
                        if (p.id && ordemMap.has(p.id)) {
                            p.ordem = ordemMap.get(p.id);
                        }
                    });

                    // Ordena o array
                    perguntasSelecionadas.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

                    // Atualiza UI
                    atualizarListaPerguntas();

                    // Reordena JSON para seguir ordem das perguntas
                    reordenarJSONComPerguntas();
                }

                // Exibe resultado
                if (statusEl) {
                    if (resultado.ciclos_detectados && resultado.ciclos_detectados.length > 0) {
                        statusEl.textContent = `Agrupado com avisos: ${resultado.ciclos_detectados.join('; ')}`;
                        statusEl.className = 'text-sm text-amber-600';
                        console.warn('Ciclos detectados:', resultado.ciclos_detectados);
                    } else {
                        statusEl.textContent = resultado.message || 'Hierarquia organizada com sucesso!';
                        statusEl.className = 'text-sm text-green-600';
                    }
                }

                // Toast de sucesso
                if (typeof showToast === 'function') {
                    showToast(resultado.message || `${resultado.atualizadas} perguntas reorganizadas`, 'success');
                }

            } catch (error) {
                console.error('Erro ao agrupar por dependências:', error);
                if (statusEl) {
                    statusEl.textContent = `Erro: ${error.message}`;
                    statusEl.className = 'text-sm text-red-500';
                }
                alert(`Erro ao agrupar: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sitemap"></i> Agrupar Filhos';
            }
        }

        // Cria/recria dependências entre perguntas usando IA
        async function criarDependenciasComIA() {
            const categoriaId = document.getElementById('categoria-id').value;

            if (!categoriaId) {
                alert('Salve a categoria primeiro para criar dependências com IA');
                return;
            }

            if (perguntasSelecionadas.length < 2) {
                alert('São necessárias pelo menos 2 perguntas para criar dependências');
                return;
            }

            const btn = document.getElementById('btn-dependencias-ia');
            const statusEl = document.getElementById('status-geracao');

            // Confirma com o usuário
            if (!confirm('A IA vai analisar as perguntas e criar/substituir dependências entre elas.\n\nDependências existentes serão substituídas.\n\nDeseja continuar?')) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
            if (statusEl) {
                statusEl.textContent = 'Analisando perguntas para identificar dependências...';
                statusEl.className = 'text-sm text-blue-500';
            }

            try {
                // Primeiro salva as perguntas atuais
                await salvarPerguntasNoServidor(categoriaId);

                // 1. Chama a API para inferir dependências
                const inferResponse = await fetch(`${API_EXTRACTION}/dependencias/inferir`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ categoria_id: parseInt(categoriaId) })
                });

                const inferResult = await inferResponse.json();

                if (!inferResult.success) {
                    throw new Error(inferResult.erro || 'Erro ao inferir dependências');
                }

                const dependenciasInferidas = inferResult.dependencias_inferidas || [];

                if (dependenciasInferidas.length === 0) {
                    if (statusEl) {
                        statusEl.textContent = 'Nenhuma dependência identificada pela IA. As perguntas parecem ser independentes.';
                        statusEl.className = 'text-sm text-yellow-600';
                    }
                    return;
                }

                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
                if (statusEl) {
                    statusEl.textContent = `Aplicando ${dependenciasInferidas.length} dependência(s) identificada(s)...`;
                    statusEl.className = 'text-sm text-blue-500';
                }

                // 2. Aplica as dependências
                const applyResponse = await fetch(`${API_EXTRACTION}/dependencias/aplicar`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        categoria_id: parseInt(categoriaId),
                        dependencias: dependenciasInferidas
                    })
                });

                const applyResult = await applyResponse.json();

                if (!applyResult.success) {
                    throw new Error(applyResult.erro || 'Erro ao aplicar dependências');
                }

                // 3. Recarrega as perguntas para mostrar as dependências
                await carregarPerguntasCategoria(categoriaId);

                // Mostra resumo das dependências criadas
                const resumoDeps = dependenciasInferidas.map(d =>
                    `• Pergunta ${d.pergunta_id} → depende de "${d.depends_on_variable}"`
                ).join('\n');

                if (statusEl) {
                    statusEl.textContent = `✓ ${dependenciasInferidas.length} dependência(s) criada(s) com sucesso!`;
                    statusEl.className = 'text-sm text-green-600';
                }

                console.log('Dependências criadas pela IA:\n' + resumoDeps);

            } catch (error) {
                console.error('Erro ao criar dependências com IA:', error);
                if (statusEl) {
                    statusEl.textContent = `Erro: ${error.message}`;
                    statusEl.className = 'text-sm text-red-500';
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-code-branch"></i> Dependências IA';
            }
        }

        // Reordena o JSON para seguir a ordem das perguntas
        function reordenarJSONComPerguntas() {
            const textarea = document.getElementById('categoria-formato-json');
            if (!textarea || !textarea.value.trim()) return;

            try {
                const jsonAtual = JSON.parse(textarea.value);

                // Se é um objeto simples, reordena as chaves com base nas perguntas
                if (typeof jsonAtual === 'object' && !Array.isArray(jsonAtual)) {
                    // Mapeia variáveis sugeridas para suas posições
                    const ordemVariaveis = new Map();
                    perguntasSelecionadas.forEach((p, index) => {
                        if (p.nome_variavel_sugerido) {
                            ordemVariaveis.set(p.nome_variavel_sugerido.toLowerCase(), index);
                        }
                    });

                    // Separa chaves que têm ordem definida e chaves que não têm
                    const chavesOrdenadas = [];
                    const chavesNaoOrdenadas = [];

                    for (const chave of Object.keys(jsonAtual)) {
                        const chaveNorm = chave.toLowerCase().replace(/_/g, '');
                        let encontrada = false;

                        // Tenta encontrar correspondência com variáveis sugeridas
                        for (const [varNome, ordem] of ordemVariaveis.entries()) {
                            const varNorm = varNome.toLowerCase().replace(/_/g, '');
                            if (chaveNorm === varNorm || chaveNorm.includes(varNorm) || varNorm.includes(chaveNorm)) {
                                chavesOrdenadas.push({ chave, ordem });
                                encontrada = true;
                                break;
                            }
                        }

                        if (!encontrada) {
                            chavesNaoOrdenadas.push(chave);
                        }
                    }

                    // Ordena as chaves que têm ordem
                    chavesOrdenadas.sort((a, b) => a.ordem - b.ordem);

                    // Reconstrói o JSON na nova ordem
                    const novoJson = {};

                    // Primeiro as chaves ordenadas
                    for (const item of chavesOrdenadas) {
                        novoJson[item.chave] = jsonAtual[item.chave];
                    }

                    // Depois as chaves não ordenadas (mantém ordem original)
                    for (const chave of chavesNaoOrdenadas) {
                        novoJson[chave] = jsonAtual[chave];
                    }

                    // Atualiza o textarea
                    textarea.value = JSON.stringify(novoJson, null, 2);
                    validarJSON();

                    console.log('JSON reordenado para seguir ordem das perguntas');
                }
            } catch (error) {
                console.error('Erro ao reordenar JSON:', error);
                // Não interrompe se falhar - JSON pode estar inválido ou em formato diferente
            }
        }

        // Carregar perguntas existentes da categoria
        async function carregarPerguntasCategoria(categoriaId) {
            try {
                const response = await fetch(`${API_EXTRACTION}/categorias/${categoriaId}/perguntas`, {
                    headers: getHeaders()
                });

                if (!response.ok) return;

                perguntasExistentes = await response.json();
                perguntasSelecionadas = perguntasExistentes.map(p => ({
                    id: p.id,
                    pergunta: p.pergunta,
                    nome_variavel_sugerido: p.nome_variavel_sugerido || null,
                    tipo_sugerido: p.tipo_sugerido || null,
                    opcoes_sugeridas: p.opcoes_sugeridas || null,
                    ordem: p.ordem || 0,
                    // Dependência
                    depends_on_variable: p.depends_on_variable || null,
                    dependency_operator: p.dependency_operator || null,
                    dependency_value: p.dependency_value,
                    dependency_inferred: p.dependency_inferred || false,
                    ativo: p.ativo !== false
                }));

                atualizarListaPerguntas();

                // Verifica consistência JSON vs perguntas
                await verificarConsistenciaJsonPerguntas(categoriaId);
            } catch (error) {
                console.error('Erro ao carregar perguntas:', error);
            }
        }

        // Verifica consistência entre JSON e perguntas
        async function verificarConsistenciaJsonPerguntas(categoriaId) {
            const avisoDiv = document.getElementById('aviso-inconsistencia');
            const avisoTexto = document.getElementById('aviso-inconsistencia-texto');
            const avisoDetalhes = document.getElementById('aviso-inconsistencia-detalhes');

            if (!categoriaId) {
                avisoDiv.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_EXTRACTION}/categorias/${categoriaId}/verificar-consistencia`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    avisoDiv.classList.add('hidden');
                    return;
                }

                const resultado = await response.json();

                if (resultado.consistente) {
                    avisoDiv.classList.add('hidden');
                } else {
                    avisoDiv.classList.remove('hidden');
                    avisoTexto.textContent = resultado.mensagem;

                    // Monta detalhes
                    const detalhes = [];
                    if (resultado.variaveis_sem_pergunta && resultado.variaveis_sem_pergunta.length > 0) {
                        const slugs = resultado.variaveis_sem_pergunta.map(v => v.slug).join(', ');
                        detalhes.push(`Variáveis: ${slugs}`);
                    }
                    avisoDetalhes.textContent = detalhes.join(' | ');
                }
            } catch (error) {
                console.error('Erro ao verificar consistência:', error);
                avisoDiv.classList.add('hidden');
            }
        }

        // Sincroniza perguntas com o JSON da categoria
        async function sincronizarPerguntasComJson() {
            const categoriaId = document.getElementById('categoria-id').value;

            if (!categoriaId) {
                alert('Salve a categoria primeiro');
                return;
            }

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

            try {
                const response = await fetch(`${API_EXTRACTION}/categorias/${categoriaId}/sincronizar-perguntas-json`, {
                    method: 'POST',
                    headers: getHeaders()
                });

                const resultado = await response.json();

                if (resultado.success) {
                    // Esconde o aviso
                    document.getElementById('aviso-inconsistencia').classList.add('hidden');

                    // Recarrega as perguntas
                    await carregarPerguntasCategoria(categoriaId);

                    // Mostra mensagem de sucesso
                    alert(resultado.mensagem || 'Sincronização concluída');
                } else {
                    alert(resultado.erro || 'Erro ao sincronizar');
                }
            } catch (error) {
                console.error('Erro ao sincronizar:', error);
                alert('Erro ao sincronizar perguntas com JSON');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Gerar JSON com IA
        async function gerarJSONcomIA() {
            const categoriaId = document.getElementById('categoria-id').value;

            if (perguntasSelecionadas.length === 0) {
                alert('Adicione pelo menos uma pergunta antes de gerar o JSON');
                return;
            }

            // Se a categoria já existe, primeiro salva as perguntas
            if (categoriaId) {
                await salvarPerguntasNoServidor(categoriaId);
            } else {
                alert('Salve a categoria primeiro para poder gerar o JSON com IA');
                return;
            }

            const btn = document.getElementById('btn-gerar-ia');
            const status = document.getElementById('status-geracao');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
            status.textContent = 'Aguarde, a IA está analisando as perguntas...';
            status.className = 'text-sm text-blue-500';

            try {
                const response = await fetch(`${API_EXTRACTION}/categorias/${categoriaId}/gerar-schema`, {
                    method: 'POST',
                    headers: getHeaders()
                });

                const resultado = await response.json();

                if (!resultado.success) {
                    throw new Error(resultado.erro || 'Erro desconhecido');
                }

                // Armazena JSON gerado e mapeamento
                jsonGerado = resultado.schema_json;
                mapeamentoVariaveis = resultado.mapeamento_variaveis || {};
                variaveisGeradas = resultado.variaveis_criadas || [];

                // Mostra preview
                document.getElementById('preview-json-gerado').classList.remove('hidden');
                document.getElementById('json-gerado-preview').textContent = JSON.stringify(jsonGerado, null, 2);

                // Mostra variáveis criadas
                if (variaveisGeradas.length > 0) {
                    document.getElementById('variaveis-criadas').classList.remove('hidden');
                    document.getElementById('lista-variaveis-criadas').innerHTML = variaveisGeradas.map(v => `
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">
                            <i class="fas fa-tag mr-1"></i>${v.slug} <span class="text-blue-400">(${v.tipo})</span>
                        </span>
                    `).join('');
                }

                status.textContent = 'JSON gerado com sucesso! Revise e clique em Aceitar.';
                status.className = 'text-sm text-green-500';

            } catch (error) {
                console.error('Erro ao gerar JSON:', error);
                status.textContent = `Erro: ${error.message}`;
                status.className = 'text-sm text-red-500';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Gerar JSON com IA';
            }
        }

        // Atualizar JSON sem IA - sincroniza perguntas com o JSON
        async function atualizarJSON() {
            const categoriaId = document.getElementById('categoria-id').value;

            // Se a categoria já existe, primeiro salva as perguntas
            if (categoriaId) {
                await salvarPerguntasNoServidor(categoriaId);
            } else {
                alert('Salve a categoria primeiro para poder atualizar o JSON');
                return;
            }

            const btn = document.getElementById('btn-atualizar-json');
            const status = document.getElementById('status-geracao');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
            status.textContent = 'Sincronizando JSON com as perguntas...';
            status.className = 'text-sm text-blue-500';

            try {
                const response = await fetch(`${API_EXTRACTION}/categorias/${categoriaId}/sincronizar-json`, {
                    method: 'POST',
                    headers: getHeaders()
                });

                const resultado = await response.json();

                if (!resultado.success) {
                    // Verifica se há perguntas incompletas
                    if (resultado.perguntas_incompletas && resultado.perguntas_incompletas.length > 0) {
                        let msgErro = 'Perguntas incompletas:\n\n';
                        resultado.perguntas_incompletas.forEach((p, i) => {
                            msgErro += `${i + 1}. ${p.pergunta}\n   → ${p.problema}\n`;
                        });
                        alert(msgErro);
                    }
                    throw new Error(resultado.erro || 'Erro desconhecido');
                }

                // Atualiza o textarea do JSON com o resultado
                const jsonAtualizado = resultado.schema_json;
                document.getElementById('categoria-formato-json').value = JSON.stringify(jsonAtualizado, null, 2);

                // Também mostra no preview se estiver visível
                if (resultado.variaveis_adicionadas > 0) {
                    jsonGerado = jsonAtualizado;

                    // Mostra preview
                    document.getElementById('preview-json-gerado').classList.remove('hidden');
                    document.getElementById('json-gerado-preview').textContent = JSON.stringify(jsonAtualizado, null, 2);

                    // Mostra variáveis adicionadas
                    if (resultado.variaveis_adicionadas_lista && resultado.variaveis_adicionadas_lista.length > 0) {
                        document.getElementById('variaveis-criadas').classList.remove('hidden');
                        document.getElementById('lista-variaveis-criadas').innerHTML = resultado.variaveis_adicionadas_lista.map(slug => `
                            <span class="px-2 py-1 text-xs rounded-full bg-emerald-100 text-emerald-700">
                                <i class="fas fa-plus-circle mr-1"></i>${slug}
                            </span>
                        `).join('');
                    }
                }

                status.textContent = resultado.mensagem || 'JSON atualizado com sucesso!';
                status.className = resultado.variaveis_adicionadas > 0 ? 'text-sm text-green-500' : 'text-sm text-blue-500';

                // Valida o JSON atualizado
                validarJSON();

            } catch (error) {
                console.error('Erro ao atualizar JSON:', error);
                status.textContent = `Erro: ${error.message}`;
                status.className = 'text-sm text-red-500';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Atualizar JSON';
            }
        }

        // Aplicar JSON nas Perguntas (JSON → Perguntas/Variáveis)
        // Esta função faz o inverso de atualizarJSON: o JSON vira a fonte de verdade
        async function aplicarJsonNasPerguntas(confirmarRemocaoVariaveisEmUso = false) {
            const categoriaId = document.getElementById('categoria-id').value;
            if (!categoriaId) {
                alert('Salve a categoria primeiro para poder aplicar o JSON');
                return;
            }

            const jsonContent = document.getElementById('categoria-formato-json').value.trim();
            if (!jsonContent) {
                alert('O JSON está vazio. Adicione o conteúdo JSON antes de aplicar.');
                return;
            }

            // Valida JSON antes de enviar
            try {
                JSON.parse(jsonContent);
            } catch (e) {
                alert(`JSON inválido: ${e.message}\n\nCorrija o JSON antes de aplicar.`);
                return;
            }

            // Confirmação do usuário (apenas na primeira chamada)
            if (!confirmarRemocaoVariaveisEmUso) {
                const confirmar = confirm(
                    'ATENÇÃO: Esta ação irá sincronizar as perguntas e variáveis com o JSON.\n\n' +
                    '• Campos NOVOS no JSON → criarão novas perguntas/variáveis\n' +
                    '• Campos ALTERADOS → atualizarão tipo, opções, dependências\n' +
                    '• Campos REMOVIDOS do JSON → removerão perguntas/variáveis\n\n' +
                    'Deseja continuar?'
                );
                if (!confirmar) return;
            }

            const btn = document.getElementById('btn-aplicar-json');
            const status = document.getElementById('status-aplicar-json');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Aplicando...';
            status.textContent = 'Reconciliando JSON com perguntas e variáveis...';
            status.className = 'text-sm text-blue-500';

            try {
                const response = await fetch(`${API_EXTRACTION}/categorias/${categoriaId}/aplicar-json`, {
                    method: 'POST',
                    headers: {
                        ...getHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        json_content: jsonContent,
                        confirmar_remocao_variaveis_em_uso: confirmarRemocaoVariaveisEmUso
                    })
                });

                const resultado = await response.json();

                // Trata caso de variáveis em uso que precisam de confirmação
                if (!resultado.success && resultado.requer_confirmacao && resultado.variaveis_em_uso_condicoes) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>Aplicar JSON nas Perguntas';
                    status.textContent = '';

                    const confirmarRemocao = await mostrarModalVariaveisEmUsoJson(resultado.variaveis_em_uso_condicoes);
                    if (confirmarRemocao) {
                        // Chama novamente com confirmação de remoção
                        return aplicarJsonNasPerguntas(true);
                    }
                    return;
                }

                if (!resultado.success) {
                    // Mostra erros de validação detalhados
                    if (resultado.erros_validacao && resultado.erros_validacao.length > 0) {
                        let msgErro = 'Erros de validação no JSON:\n\n';
                        resultado.erros_validacao.forEach((e, i) => {
                            msgErro += `${i + 1}. Campo "${e.slug}":\n   → ${e.erro}\n`;
                            if (e.sugestao) {
                                msgErro += `   Sugestão: ${e.sugestao}\n`;
                            }
                        });
                        alert(msgErro);
                    }
                    throw new Error(resultado.erro || 'Erro desconhecido');
                }

                // Monta mensagem de sucesso detalhada
                let msgSucesso = resultado.mensagem || 'Aplicação concluída!';

                if (resultado.criadas.length > 0) {
                    msgSucesso += `\n\n✓ Criadas: ${resultado.criadas.join(', ')}`;
                }
                if (resultado.atualizadas.length > 0) {
                    msgSucesso += `\n\n✓ Atualizadas: ${resultado.atualizadas.join(', ')}`;
                }
                if (resultado.removidas.length > 0) {
                    msgSucesso += `\n\n✗ Removidas: ${resultado.removidas.join(', ')}`;
                }

                if (resultado.tempo_ms) {
                    msgSucesso += `\n\n(Tempo: ${resultado.tempo_ms}ms)`;
                }

                alert(msgSucesso);

                status.textContent = resultado.mensagem;
                status.className = 'text-sm text-green-500';

                // Recarrega as perguntas da categoria para atualizar a UI
                await carregarPerguntasCategoria(categoriaId);

                // Verifica consistência
                await verificarConsistenciaJsonPerguntas(categoriaId);

            } catch (error) {
                console.error('Erro ao aplicar JSON:', error);
                status.textContent = `Erro: ${error.message}`;
                status.className = 'text-sm text-red-500';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>Aplicar JSON nas Perguntas';
            }
        }

        // Modal de confirmação para variáveis em uso como condição de ativação (Aplicar JSON)
        function mostrarModalVariaveisEmUsoJson(variaveisEmUso) {
            return new Promise((resolve) => {
                // Remove modal anterior se existir
                const modalAnterior = document.getElementById('modal-variaveis-em-uso-json');
                if (modalAnterior) modalAnterior.remove();

                // Monta lista de variáveis e prompts afetados
                let variaveisHtml = '';
                variaveisEmUso.forEach(v => {
                    const promptsNomes = v.prompts.map(p => {
                        const tipoUso = p.tipo_uso && p.tipo_uso.length > 0
                            ? ` (${p.tipo_uso.map(t => t === 'regra_primaria' ? 'Primária' : 'Fallback').join(', ')})`
                            : '';
                        return `<span class="text-gray-700">${p.titulo || p.nome}${tipoUso}</span>`;
                    }).join(', ');

                    variaveisHtml += `
                        <div class="py-2 border-b border-gray-100 last:border-0">
                            <div class="font-mono text-amber-700 font-medium">${v.slug}</div>
                            <div class="text-sm text-gray-500 mt-1">
                                <i class="fas fa-link mr-1"></i>Usada em: ${promptsNomes}
                            </div>
                        </div>
                    `;
                });

                const modal = document.createElement('div');
                modal.id = 'modal-variaveis-em-uso-json';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 overflow-hidden">
                        <div class="bg-amber-500 px-6 py-4">
                            <h3 class="text-lg font-bold text-white flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Atenção - Variáveis em Uso Serão Removidas
                            </h3>
                        </div>
                        <div class="px-6 py-4">
                            <p class="text-gray-700 mb-4">
                                As seguintes variáveis seriam <strong>removidas</strong> pelo JSON, mas estão em uso como
                                <strong>condição de ativação</strong> em módulos:
                            </p>
                            <div class="bg-gray-50 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto border border-gray-200">
                                ${variaveisHtml}
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                                <p class="text-red-700 text-sm">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    <strong>Remover estas variáveis pode causar falhas na ativação de regras e módulos.</strong>
                                    <br><br>
                                    Se continuar, as variáveis serão <strong>desativadas</strong> (soft delete) para preservar o histórico.
                                </p>
                            </div>
                            <p class="text-gray-600 text-sm">Deseja continuar com a aplicação do JSON?</p>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                            <button id="btn-cancelar-aplicar" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                Cancelar
                            </button>
                            <button id="btn-confirmar-aplicar" class="px-4 py-2 text-white bg-amber-600 rounded-lg hover:bg-amber-700 transition-colors">
                                <i class="fas fa-check mr-1"></i>
                                Aplicar mesmo assim
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Event listeners
                document.getElementById('btn-cancelar-aplicar').onclick = () => {
                    modal.remove();
                    resolve(false);
                };

                document.getElementById('btn-confirmar-aplicar').onclick = () => {
                    modal.remove();
                    resolve(true);
                };

                // Fechar ao clicar fora
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };

                // Fechar com ESC
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escHandler);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', escHandler);
            });
        }

        // Salvar perguntas no servidor
        async function salvarPerguntasNoServidor(categoriaId) {
            for (const p of perguntasSelecionadas) {
                const perguntaData = {
                    categoria_id: parseInt(categoriaId),
                    pergunta: p.pergunta,
                    nome_variavel_sugerido: p.nome_variavel_sugerido || null,
                    tipo_sugerido: p.tipo_sugerido || null,
                    opcoes_sugeridas: p.opcoes_sugeridas || null,
                    ordem: p.ordem || 0,
                    // Dependência
                    depends_on_variable: p.depends_on_variable || null,
                    dependency_operator: p.dependency_operator || null,
                    dependency_value: p.dependency_value,
                    dependency_inferred: p.dependency_inferred || false,
                    ativo: p.ativo !== false
                };

                try {
                    if (!p.id) {
                        // Criar nova pergunta
                        const response = await fetch(`${API_EXTRACTION}/perguntas`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify(perguntaData)
                        });

                        if (response.ok) {
                            const nova = await response.json();
                            p.id = nova.id;
                        }
                    } else {
                        // Atualizar pergunta existente
                        const response = await fetch(`${API_EXTRACTION}/perguntas/${p.id}`, {
                            method: 'PUT',
                            headers: getHeaders(),
                            body: JSON.stringify(perguntaData)
                        });

                        if (!response.ok) {
                            console.error('Erro ao atualizar pergunta:', p.id);
                        }
                    }
                } catch (error) {
                    console.error('Erro ao salvar pergunta:', error);
                }
            }
        }

        // Aceitar JSON gerado
        async function aceitarJSONGerado() {
            if (!jsonGerado) return;

            // Coloca o JSON no campo de formato
            document.getElementById('categoria-formato-json').value = JSON.stringify(jsonGerado, null, 2);

            // Marca que foi gerado por IA
            jsonGeradoPorIA = true;
            atualizarBadgeJsonIA();

            // Limpa preview
            document.getElementById('preview-json-gerado').classList.add('hidden');
            document.getElementById('status-geracao').textContent = 'Sincronizando perguntas...';
            document.getElementById('status-geracao').className = 'text-sm text-blue-500';

            // Sincroniza tipos e slugs das perguntas com o mapeamento da IA
            await sincronizarTiposPerguntas();

            // Atualiza status
            document.getElementById('status-geracao').textContent = 'JSON aceito e perguntas atualizadas!';
            document.getElementById('status-geracao').className = 'text-sm text-green-500';

            // Muda para modo legado para mostrar o JSON
            selecionarModo('legado');
        }

        // Sincroniza tipos e slugs das perguntas com o mapeamento gerado pela IA
        async function sincronizarTiposPerguntas() {
            const categoriaId = document.getElementById('categoria-id').value;
            if (!categoriaId) return;

            // Se não há mapeamento, apenas recarrega as perguntas do servidor
            // (o backend já atualizou durante a geração)
            if (!mapeamentoVariaveis || Object.keys(mapeamentoVariaveis).length === 0) {
                console.log('Sem mapeamento local, recarregando perguntas do servidor...');
                await carregarPerguntasCategoria(categoriaId);
                return;
            }

            try {
                const response = await fetch('/admin/api/extraction/perguntas/sync-tipos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        categoria_id: parseInt(categoriaId),
                        mapeamento_variaveis: mapeamentoVariaveis
                    })
                });

                const resultado = await response.json();
                if (resultado.success) {
                    console.log(`Sincronização concluída: ${resultado.perguntas_atualizadas} perguntas atualizadas`);
                    if (resultado.detalhes && resultado.detalhes.length > 0) {
                        console.log('Detalhes:', resultado.detalhes);
                    }
                }

                // SEMPRE recarrega perguntas para refletir slugs e tipos atualizados
                await carregarPerguntasCategoria(categoriaId);

            } catch (error) {
                console.error('Erro ao sincronizar tipos:', error);
                // Mesmo com erro, tenta recarregar perguntas
                await carregarPerguntasCategoria(categoriaId);
            }
        }

        // Editar JSON gerado
        function editarJSONGerado() {
            if (!jsonGerado) return;

            // Coloca o JSON no campo de formato para edição
            document.getElementById('categoria-formato-json').value = JSON.stringify(jsonGerado, null, 2);

            // Ao editar manualmente, não é mais "gerado por IA"
            jsonGeradoPorIA = false;
            atualizarBadgeJsonIA();

            // Limpa preview
            document.getElementById('preview-json-gerado').classList.add('hidden');
            document.getElementById('status-geracao').textContent = 'JSON copiado para edição. Ajuste como necessário.';
            document.getElementById('status-geracao').className = 'text-sm text-yellow-600';

            // Muda para modo legado para edição
            selecionarModo('legado');
        }

        // Descartar JSON gerado
        function descartarJSONGerado() {
            jsonGerado = null;
            mapeamentoVariaveis = {};
            variaveisGeradas = [];

            document.getElementById('preview-json-gerado').classList.add('hidden');
            document.getElementById('variaveis-criadas').classList.add('hidden');
            document.getElementById('status-geracao').textContent = 'JSON descartado. Gere novamente se necessário.';
            document.getElementById('status-geracao').className = 'text-sm text-gray-500';
        }

        // Ver perguntas de uma categoria (abre direto no modo IA)
        async function verPerguntas(categoriaId) {
            await editarCategoria(categoriaId);
            selecionarModo('ia');
        }

        // ==========================================
        // Funções do Modal de Pergunta
        // ==========================================

        // Obtém o namespace/prefixo efetivo da categoria atual
        function obterNamespaceCategoria() {
            if (!categoriaAtual) return '';
            // Usa namespace da API (que é o namespace efetivo calculado pelo backend)
            // Fallback: usa namespace_prefix ou nome normalizado
            if (categoriaAtual.namespace) return categoriaAtual.namespace;
            if (categoriaAtual.namespace_prefix) return categoriaAtual.namespace_prefix;
            // Último fallback: normaliza o nome
            const nome = categoriaAtual.nome || '';
            return nome.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '');
        }

        // Remove o prefixo/namespace de um slug para obter o nome base
        function removerPrefixoSlug(slug, namespace) {
            if (!slug || !namespace) return slug || '';
            const prefixo = namespace + '_';
            if (slug.startsWith(prefixo)) {
                return slug.substring(prefixo.length);
            }
            return slug;
        }

        // Abre modal para nova pergunta ou edição
        async function abrirModalPergunta(index = -1) {
            document.getElementById('pergunta-index').value = index;

            // Popula select de códigos do grupo
            atualizarSelectFonteCodigoPergunta();

            // Limpa campos de fonte de verdade
            document.getElementById('variavel-vinculada-id').value = '';
            document.getElementById('pergunta-fonte-codigo').value = '';
            document.getElementById('pergunta-fonte-tipo').value = '';

            // Exibe o prefixo fixo da categoria no campo de nome da variável
            const namespace = obterNamespaceCategoria();
            const prefixoEl = document.getElementById('pergunta-prefixo-variavel');
            if (namespace) {
                prefixoEl.textContent = namespace + '_';
                prefixoEl.classList.remove('hidden');
            } else {
                prefixoEl.textContent = '';
                prefixoEl.classList.add('hidden');
            }

            if (index === -1) {
                // Nova pergunta
                document.getElementById('modal-pergunta-titulo').textContent = 'Nova Pergunta de Extração';
                document.getElementById('pergunta-texto').value = '';
                document.getElementById('pergunta-nome-variavel').value = '';
                document.getElementById('pergunta-tipo').value = '';
                document.getElementById('pergunta-ordem').value = perguntasSelecionadas.length;
                document.getElementById('pergunta-opcoes').value = '';
                // IA decide ordem - desmarca e reseta estado
                document.getElementById('pergunta-ordem-ia').checked = false;
                // Dependência
                document.getElementById('pergunta-tem-dependencia').checked = false;
                document.getElementById('pergunta-depends-on').value = '';
                document.getElementById('pergunta-dependency-operator').value = 'equals';
                document.getElementById('pergunta-dependency-value').value = '';
                document.getElementById('pergunta-ativa').checked = true;

                // Nova pergunta não tem variável ainda
                document.getElementById('fonte-verdade-sem-variavel').classList.remove('hidden');
                document.getElementById('fonte-verdade-campos').classList.add('hidden');
            } else {
                // Edição
                const p = perguntasSelecionadas[index];
                document.getElementById('modal-pergunta-titulo').textContent = 'Editar Pergunta';
                document.getElementById('pergunta-texto').value = p.pergunta || '';
                // Exibe apenas o nome base (sem prefixo) no input
                const nomeCompleto = p.nome_variavel_sugerido || '';
                const nomeBase = removerPrefixoSlug(nomeCompleto, namespace);
                document.getElementById('pergunta-nome-variavel').value = nomeBase;
                document.getElementById('pergunta-tipo').value = p.tipo_sugerido || '';
                document.getElementById('pergunta-ordem').value = p.ordem || 0;
                document.getElementById('pergunta-opcoes').value = (p.opcoes_sugeridas || []).join('\n');
                // IA decide ordem - desmarca em edição
                document.getElementById('pergunta-ordem-ia').checked = false;
                // Dependência - guarda valores para aplicar depois de popular o select
                const temDependencia = !!p.depends_on_variable;
                const dependsOnValue = p.depends_on_variable || '';
                const dependencyOperatorValue = p.dependency_operator || 'equals';
                const dependencyValueValue = p.dependency_value !== undefined && p.dependency_value !== null ? String(p.dependency_value) : '';

                document.getElementById('pergunta-tem-dependencia').checked = temDependencia;
                document.getElementById('pergunta-dependency-operator').value = dependencyOperatorValue;
                document.getElementById('pergunta-dependency-value').value = dependencyValueValue;
                document.getElementById('pergunta-ativa').checked = p.ativo !== false;

                // Popula o select de dependência ANTES de tentar definir o valor
                if (temDependencia) {
                    popularSelectDependencia();
                    // Agora define o valor com fallback depois que o select foi populado
                    definirValorDependenciaComFallback(dependsOnValue);
                }

                // Busca variável vinculada (se a pergunta foi salva)
                if (p.id) {
                    await carregarVariavelVinculada(p.id);
                } else {
                    document.getElementById('fonte-verdade-sem-variavel').classList.remove('hidden');
                    document.getElementById('fonte-verdade-campos').classList.add('hidden');
                }
            }

            // Reset visual do toggle IA decide
            toggleOrdemIA();

            // Toggle visibilidades iniciais
            toggleOpcoesPergunta();
            toggleDependenciaPergunta();
            toggleValorDependencia();
            atualizarPreviewDependencia();

            document.getElementById('modal-pergunta').classList.remove('hidden');
        }

        // Fecha modal de pergunta
        function fecharModalPergunta() {
            document.getElementById('modal-pergunta').classList.add('hidden');
        }

        // Popula select de códigos para fonte de verdade
        function atualizarSelectFonteCodigoPergunta() {
            const select = document.getElementById('pergunta-fonte-codigo');
            const valorAtual = select.value;
            select.innerHTML = '<option value="">Todos os códigos</option>';
            codigosSelecionados.forEach(cod => {
                select.innerHTML += `<option value="${cod}">${cod}</option>`;
            });
            if (valorAtual && codigosSelecionados.map(String).includes(String(valorAtual))) {
                select.value = valorAtual;
            }
        }

        // Busca variável vinculada à pergunta
        async function carregarVariavelVinculada(perguntaId) {
            try {
                const response = await fetch(`${API_EXTRACTION}/variaveis?source_question_id=${perguntaId}&apenas_ativos=false`, {
                    headers: getHeaders()
                });

                if (response.ok) {
                    const variaveis = await response.json();
                    if (variaveis.length > 0) {
                        const v = variaveis[0];
                        document.getElementById('variavel-vinculada-id').value = v.id;
                        document.getElementById('pergunta-fonte-codigo').value = v.fonte_verdade_codigo || '';
                        document.getElementById('pergunta-fonte-tipo').value = v.fonte_verdade_tipo || '';

                        document.getElementById('fonte-verdade-sem-variavel').classList.add('hidden');
                        document.getElementById('fonte-verdade-campos').classList.remove('hidden');
                    } else {
                        // Sem variável vinculada
                        document.getElementById('fonte-verdade-sem-variavel').classList.remove('hidden');
                        document.getElementById('fonte-verdade-campos').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar variável:', error);
            }
        }

        // Salva fonte de verdade na variável
        async function salvarFonteVerdadeVariavel() {
            const variavelId = document.getElementById('variavel-vinculada-id').value;
            if (!variavelId) return;

            const fonteCodigo = document.getElementById('pergunta-fonte-codigo').value || null;
            const fonteTipo = document.getElementById('pergunta-fonte-tipo').value.trim() || null;

            try {
                await fetch(`${API_EXTRACTION}/variaveis/${variavelId}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        fonte_verdade_codigo: fonteCodigo,
                        fonte_verdade_tipo: fonteTipo
                    })
                });
            } catch (error) {
                console.error('Erro ao salvar fonte de verdade:', error);
            }
        }

        // Toggle para opção "IA decide" na ordem (botão clicável)
        function toggleOrdemIABtn() {
            const checkbox = document.getElementById('pergunta-ordem-ia');
            checkbox.checked = !checkbox.checked;
            atualizarEstadoOrdemIA();
        }

        // Atualiza estado visual do botão "IA decide"
        function atualizarEstadoOrdemIA() {
            const checkbox = document.getElementById('pergunta-ordem-ia');
            const inputOrdem = document.getElementById('pergunta-ordem');
            const infoEl = document.getElementById('ordem-ia-info');
            const btn = document.getElementById('btn-ordem-ia');

            if (checkbox.checked) {
                inputOrdem.disabled = true;
                inputOrdem.classList.add('bg-gray-100', 'text-gray-400');
                infoEl.classList.remove('hidden');
                btn.classList.remove('bg-amber-50', 'border-amber-300', 'text-amber-700');
                btn.classList.add('bg-amber-500', 'border-amber-500', 'text-white');
            } else {
                inputOrdem.disabled = false;
                inputOrdem.classList.remove('bg-gray-100', 'text-gray-400');
                infoEl.classList.add('hidden');
                btn.classList.add('bg-amber-50', 'border-amber-300', 'text-amber-700');
                btn.classList.remove('bg-amber-500', 'border-amber-500', 'text-white');
            }
        }

        // Alias para compatibilidade
        function toggleOrdemIA() {
            atualizarEstadoOrdemIA();
        }

        // Salva pergunta do modal
        async function salvarPerguntaModal() {
            const index = parseInt(document.getElementById('pergunta-index').value);
            const texto = document.getElementById('pergunta-texto').value.trim();

            if (!texto) {
                alert('A pergunta é obrigatória');
                return;
            }

            // Verifica duplicata apenas se for nova pergunta OU se o texto foi alterado
            const isNovaPergunta = index === -1;
            const textoOriginal = !isNovaPergunta ? (perguntasSelecionadas[index]?.pergunta || '').trim().toLowerCase() : '';
            const textoAlterado = isNovaPergunta || textoOriginal !== texto.toLowerCase();

            if (textoAlterado) {
                const duplicata = perguntasSelecionadas.findIndex((p, i) => {
                    return i !== index && (p.pergunta || '').trim().toLowerCase() === texto.toLowerCase();
                });
                if (duplicata !== -1) {
                    alert(`Já existe outra pergunta com este texto (posição ${duplicata + 1}). Altere o texto ou remova a duplicata.`);
                    return;
                }
            }

            const tipo = document.getElementById('pergunta-tipo').value;
            const opcoes = document.getElementById('pergunta-opcoes').value
                .split('\n')
                .map(o => o.trim())
                .filter(o => o);

            // Dependência
            const temDependencia = document.getElementById('pergunta-tem-dependencia').checked;
            const dependsOn = temDependencia ? document.getElementById('pergunta-depends-on').value.trim() : null;
            const dependencyOperator = temDependencia ? document.getElementById('pergunta-dependency-operator').value : null;
            let dependencyValue = temDependencia ? document.getElementById('pergunta-dependency-value').value.trim() : null;

            // Converte valor para booleano se for "true" ou "false"
            if (dependencyValue === 'true') dependencyValue = true;
            else if (dependencyValue === 'false') dependencyValue = false;

            // Para operadores exists/not_exists, o valor é null
            if (['exists', 'not_exists'].includes(dependencyOperator)) {
                dependencyValue = null;
            }

            // Verifica se IA deve decidir a ordem
            const iaDecideOrdem = document.getElementById('pergunta-ordem-ia').checked;
            let ordem = parseInt(document.getElementById('pergunta-ordem').value) || 0;

            // Se IA deve decidir e é nova pergunta, chama API para sugerir posição
            if (iaDecideOrdem && isNovaPergunta && perguntasSelecionadas.length > 0) {
                const categoriaNome = document.getElementById('categoria-nome').value || 'categoria';
                const statusEl = document.getElementById('status-geracao');

                if (statusEl) {
                    statusEl.textContent = 'Consultando IA para determinar a melhor posição...';
                    statusEl.className = 'text-sm text-blue-500';
                }

                try {
                    const response = await fetch(`${API_EXTRACTION}/perguntas/posicionar-ia`, {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            categoria_nome: categoriaNome,
                            nova_pergunta: {
                                pergunta: texto,
                                tipo_sugerido: tipo || null
                            },
                            perguntas_existentes: perguntasSelecionadas.map((p, i) => ({
                                ordem: i,
                                pergunta: p.pergunta
                            }))
                        })
                    });

                    const resultado = await response.json();

                    if (resultado.success) {
                        ordem = resultado.posicao;
                        if (statusEl) {
                            statusEl.textContent = `IA sugeriu posição ${ordem + 1}`;
                            statusEl.className = 'text-sm text-green-600';
                        }
                    }
                } catch (error) {
                    console.error('Erro ao consultar IA para posição:', error);
                    ordem = perguntasSelecionadas.length; // fallback: final
                }
            }

            const perguntaData = {
                pergunta: texto,
                nome_variavel_sugerido: document.getElementById('pergunta-nome-variavel').value.trim() || null,
                tipo_sugerido: tipo || null,
                opcoes_sugeridas: (tipo === 'choice' && opcoes.length > 0) ? opcoes : null,
                ordem: ordem,
                // Dependência
                depends_on_variable: dependsOn || null,
                dependency_operator: dependsOn ? dependencyOperator : null,
                dependency_value: dependsOn ? dependencyValue : null,
                dependency_inferred: false,
                ativo: document.getElementById('pergunta-ativa').checked
            };

            if (index === -1) {
                // Nova pergunta - insere na posição sugerida
                if (iaDecideOrdem && perguntasSelecionadas.length > 0) {
                    // Insere na posição sugerida pela IA
                    perguntasSelecionadas.splice(ordem, 0, perguntaData);
                    // Atualiza ordem de todas as perguntas
                    perguntasSelecionadas.forEach((p, i) => p.ordem = i);
                } else {
                    perguntasSelecionadas.push(perguntaData);
                }
            } else {
                // Edição - mantém o id se existir
                perguntaData.id = perguntasSelecionadas[index].id;
                perguntasSelecionadas[index] = perguntaData;

                // Salva fonte de verdade na variável vinculada (se existir)
                salvarFonteVerdadeVariavel();
            }

            // Reordena por ordem (se não usou IA para posicionar)
            if (!iaDecideOrdem || index !== -1) {
                perguntasSelecionadas.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
            }

            atualizarListaPerguntas();
            fecharModalPergunta();
        }

        // Toggle visibilidade do campo de opções (para tipo choice)
        function toggleOpcoesPergunta() {
            const tipo = document.getElementById('pergunta-tipo').value;
            const container = document.getElementById('opcoes-pergunta-container');

            if (tipo === 'choice') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // ==========================================
        // Funções de Dependência entre Perguntas
        // ==========================================

        // Toggle visibilidade do container de dependência
        function toggleDependenciaPergunta() {
            const checked = document.getElementById('pergunta-tem-dependencia').checked;
            const container = document.getElementById('dependencia-pergunta-container');

            if (checked) {
                container.classList.remove('hidden');
                popularSelectDependencia();
            } else {
                container.classList.add('hidden');
            }
        }

        // Popula o select de variáveis de dependência
        function popularSelectDependencia() {
            const select = document.getElementById('pergunta-depends-on');
            const indexAtual = parseInt(document.getElementById('pergunta-index').value);

            // Mantém o valor atual se existir
            const valorAtual = select.value;

            select.innerHTML = '<option value="">Selecione uma variável ou pergunta anterior...</option>';

            // Adiciona perguntas anteriores da mesma categoria (usando nome_variavel_sugerido como slug)
            const perguntasAnteriores = perguntasSelecionadas.filter((p, i) =>
                i !== indexAtual && p.nome_variavel_sugerido
            );

            if (perguntasAnteriores.length > 0) {
                const groupPerguntas = document.createElement('optgroup');
                groupPerguntas.label = 'Perguntas desta categoria';

                perguntasAnteriores.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.nome_variavel_sugerido;
                    option.textContent = `${p.nome_variavel_sugerido} - "${p.pergunta.substring(0, 40)}..."`;
                    groupPerguntas.appendChild(option);
                });

                select.appendChild(groupPerguntas);
            }

            // Adiciona variáveis do sistema (se carregadas)
            if (variaveisDisponiveis && variaveisDisponiveis.length > 0) {
                const groupVars = document.createElement('optgroup');
                groupVars.label = 'Variáveis do sistema';

                variaveisDisponiveis.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.slug;
                    option.textContent = `${v.slug} (${v.tipo})`;
                    groupVars.appendChild(option);
                });

                select.appendChild(groupVars);
            }

            // Restaura valor anterior se existir
            if (valorAtual) {
                definirValorDependenciaComFallback(valorAtual);
            }

            atualizarPreviewDependencia();
        }

        // Define o valor do select de dependência com fallback para match parcial
        function definirValorDependenciaComFallback(valor) {
            if (!valor) return;

            const select = document.getElementById('pergunta-depends-on');
            select.value = valor;

            // Se encontrou match direto, ok
            if (select.value === valor) return;

            // Se não encontrou match direto, tenta fallback sem namespace
            const opcoes = Array.from(select.options);
            const matchParcial = opcoes.find(opt => {
                if (!opt.value) return false;
                // Verifica se o valor salvo é sufixo do slug (ex: "incorporado_sus" match "medicamento_incorporado_sus")
                return opt.value.endsWith('_' + valor) || opt.value === valor;
            });

            if (matchParcial) {
                select.value = matchParcial.value;
                console.log(`Dependência: fallback de "${valor}" para "${matchParcial.value}"`);
            } else {
                // Se ainda não encontrou, adiciona a opção temporariamente para não perder o valor
                const optionTemp = document.createElement('option');
                optionTemp.value = valor;
                optionTemp.textContent = `${valor} (não encontrada)`;
                optionTemp.style.color = '#f97316'; // laranja para indicar problema
                select.insertBefore(optionTemp, select.firstChild.nextSibling);
                select.value = valor;
                console.warn(`Dependência: variável "${valor}" não encontrada no sistema`);
            }
        }

        // Atualiza operadores com base na variável selecionada
        function atualizarOperadoresDependencia() {
            atualizarPreviewDependencia();
        }

        // Toggle visibilidade do campo de valor
        function toggleValorDependencia() {
            const operador = document.getElementById('pergunta-dependency-operator').value;
            const container = document.getElementById('dependencia-valor-container');

            if (['exists', 'not_exists'].includes(operador)) {
                container.classList.add('hidden');
            } else {
                container.classList.remove('hidden');
            }

            atualizarPreviewDependencia();
        }

        // Atualiza o preview humanizado da dependência
        function atualizarPreviewDependencia() {
            const preview = document.getElementById('dependencia-preview');
            const variavel = document.getElementById('pergunta-depends-on').value;
            const operador = document.getElementById('pergunta-dependency-operator').value;
            const valor = document.getElementById('pergunta-dependency-value').value;

            if (!variavel) {
                preview.innerHTML = '<span class="text-gray-400 italic">Configure a dependência acima</span>';
                return;
            }

            const operadorTexto = {
                'equals': '=',
                'not_equals': '≠',
                'exists': 'existe',
                'not_exists': 'não existe',
                'contains': 'contém',
                'greater_than': '>',
                'less_than': '<'
            };

            let texto = `<span class="text-indigo-600">Esta pergunta será feita quando:</span> `;
            texto += `<span class="font-mono font-semibold text-purple-600">${variavel}</span> `;
            texto += `<span class="text-gray-600">${operadorTexto[operador] || operador}</span>`;

            if (!['exists', 'not_exists'].includes(operador)) {
                texto += ` <span class="font-semibold text-green-600">"${valor || '???'}"</span>`;
            }

            preview.innerHTML = texto;
        }

        // Carrega variáveis disponíveis do sistema
        async function carregarVariaveisDisponiveis() {
            try {
                const response = await fetch(`${API_EXTRACTION}/variaveis?apenas_ativos=true`, {
                    headers: getHeaders()
                });
                if (response.ok) {
                    variaveisDisponiveis = await response.json();
                }
            } catch (error) {
                console.error('Erro ao carregar variáveis:', error);
            }
        }

        // Variável global para variáveis disponíveis
        let variaveisDisponiveis = [];

        // Validar JSON
        function validarJSON() {
            const textarea = document.getElementById('categoria-formato-json');
            const status = document.getElementById('json-status');
            
            try {
                JSON.parse(textarea.value);
                status.textContent = '✓ JSON válido';
                status.className = 'text-xs mt-1 text-green-600';
            } catch (e) {
                status.textContent = `✗ Erro: ${e.message}`;
                status.className = 'text-xs mt-1 text-red-600';
            }
        }

        // Formatar JSON
        function formatarJSON() {
            const textarea = document.getElementById('categoria-formato-json');
            try {
                const json = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(json, null, 2);
                validarJSON();
            } catch (e) {
                alert('JSON inválido - corrija os erros antes de formatar');
            }
        }

        // Salvar categoria (sem fechar o modal)
        async function salvarCategoria() {
            const id = document.getElementById('categoria-id').value;
            const isEdit = !!id;

            const btnSalvar = document.getElementById('btn-salvar-categoria');
            const btnCancelar = document.getElementById('btn-cancelar-categoria');
            const errorMsg = document.getElementById('save-error-msg');
            const errorText = document.getElementById('save-error-text');

            // Esconde mensagem de erro anterior
            errorMsg.classList.add('hidden');

            // Valida JSON antes de salvar
            let formatoJson = document.getElementById('categoria-formato-json').value.trim();

            // Se estiver no modo IA e não tiver JSON, usa placeholder
            if (modoSelecionado === 'ia' && (!formatoJson || formatoJson === '')) {
                formatoJson = JSON.stringify({
                    "_modo": "ia_pendente",
                    "_info": "JSON será gerado pela IA após configurar as perguntas"
                }, null, 2);
                document.getElementById('categoria-formato-json').value = formatoJson;
            }

            try {
                JSON.parse(formatoJson);
            } catch (e) {
                errorText.textContent = 'JSON inválido. Corrija antes de salvar.';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Determina tipo de fonte selecionado
            const sourceType = document.querySelector('input[name="source_type"]:checked')?.value || 'code';
            const sourceSpecialType = sourceType === 'special'
                ? (document.getElementById('categoria-fonte-especial').value || null)
                : null;

            const dados = {
                nome: document.getElementById('categoria-nome').value.trim(),
                titulo: document.getElementById('categoria-titulo').value.trim(),
                descricao: document.getElementById('categoria-descricao').value.trim() || null,
                codigos_documento: codigosSelecionados,
                formato_json: formatoJson,
                instrucoes_extracao: document.getElementById('categoria-instrucoes').value.trim() || null,
                is_residual: document.getElementById('categoria-residual').checked,
                ativo: document.getElementById('categoria-ativo').checked,
                json_gerado_por_ia: jsonGeradoPorIA,
                source_type: sourceType,
                source_special_type: sourceSpecialType,
                fonte_verdade_codigo: document.getElementById('categoria-fonte-codigo').value || null,
                fonte_verdade_tipo: document.getElementById('categoria-fonte-tipo-llm').value.trim() || null
            };

            if (isEdit) {
                dados.motivo = document.getElementById('categoria-motivo').value.trim() || 'Atualização via interface';
            }

            if (!dados.nome || !dados.titulo) {
                errorText.textContent = 'Nome e título são obrigatórios';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Estado de loading
            btnSalvar.disabled = true;
            btnCancelar.disabled = true;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';

            try {
                const url = isEdit ? `${API_BASE}/${id}` : API_BASE;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: getHeaders(),
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar');
                }

                const categoriaSalva = await response.json();

                // Atualiza o ID se era uma criação (agora é edição)
                if (!isEdit) {
                    document.getElementById('categoria-id').value = categoriaSalva.id;
                    document.getElementById('editor-titulo').textContent = 'Editar Categoria';
                }

                // Se tem perguntas, salva elas também
                if (perguntasSelecionadas.length > 0) {
                    await salvarPerguntasNoServidor(categoriaSalva.id);
                }

                // Sucesso - mostra feedback
                btnSalvar.innerHTML = '<i class="fas fa-check mr-2"></i> Salvo!';
                btnSalvar.classList.remove('bg-primary-600', 'hover:bg-primary-700');
                btnSalvar.classList.add('bg-green-600');

                // Atualiza lista em background (sem fechar modal)
                carregarCategorias();

                // Volta ao estado normal após 2.5 segundos
                setTimeout(() => {
                    btnSalvar.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar';
                    btnSalvar.classList.add('bg-primary-600', 'hover:bg-primary-700');
                    btnSalvar.classList.remove('bg-green-600');
                    btnSalvar.disabled = false;
                    btnCancelar.disabled = false;
                }, 2500);

            } catch (error) {
                console.error('Erro ao salvar:', error);

                // Mostra erro inline
                errorText.textContent = error.message;
                errorMsg.classList.remove('hidden');

                // Restaura botão
                btnSalvar.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar';
                btnSalvar.disabled = false;
                btnCancelar.disabled = false;
            }
        }

        // Confirmar exclusão
        function confirmarExclusao(id, titulo) {
            if (confirm(`Deseja desativar a categoria "${titulo}"?`)) {
                excluirCategoria(id);
            }
        }

        // Excluir (desativar) categoria
        async function excluirCategoria(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao excluir');
                }
                
                carregarCategorias();
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert(`Erro ao excluir: ${error.message}`);
            }
        }

        // Abrir seletor de códigos
        async function abrirSeletorCodigos() {
            document.getElementById('modal-codigos').classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/codigos-disponiveis`, {
                    headers: getHeaders()
                });
                codigosDisponiveis = await response.json();
                renderizarCodigosDisponiveis();
            } catch (error) {
                console.error('Erro ao carregar códigos:', error);
            }
        }

        // Fechar seletor de códigos
        function fecharSeletorCodigos() {
            document.getElementById('modal-codigos').classList.add('hidden');
        }

        // Renderizar códigos disponíveis
        function renderizarCodigosDisponiveis() {
            const busca = document.getElementById('busca-codigo').value.toLowerCase();
            const container = document.getElementById('lista-codigos-disponiveis');
            
            const filtrados = codigosDisponiveis.filter(c => 
                String(c.codigo).includes(busca) || 
                c.descricao.toLowerCase().includes(busca)
            );
            
            container.innerHTML = filtrados.map(c => {
                const jaAdicionado = codigosSelecionados.includes(c.codigo);
                const emOutraCategoria = c.categoria && (!categoriaAtual || c.categoria.categoria_id !== categoriaAtual.id);
                
                return `
                    <div class="flex items-center justify-between py-2 px-3 hover:bg-gray-50 rounded border-b border-gray-100">
                        <div>
                            <span class="font-mono font-semibold">${c.codigo}</span>
                            <span class="text-gray-600 ml-2">${c.descricao}</span>
                            ${emOutraCategoria ? `<span class="ml-2 text-xs text-yellow-600"><i class="fas fa-exclamation-triangle"></i> Em: ${c.categoria.categoria_titulo}</span>` : ''}
                        </div>
                        <button onclick="adicionarCodigoLista(${c.codigo})" 
                            class="px-3 py-1 ${jaAdicionado ? 'bg-gray-100 text-gray-400' : 'bg-green-100 text-green-700 hover:bg-green-200'} rounded text-sm"
                            ${jaAdicionado ? 'disabled' : ''}>
                            ${jaAdicionado ? '<i class="fas fa-check"></i>' : '<i class="fas fa-plus"></i>'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Filtrar códigos
        function filtrarCodigos() {
            renderizarCodigosDisponiveis();
        }

        // Adicionar código da lista
        function adicionarCodigoLista(codigo) {
            if (!codigosSelecionados.includes(codigo)) {
                codigosSelecionados.push(codigo);
                atualizarListaCodigos();
                renderizarCodigosDisponiveis();
            }
        }

        // REFATORADO: Modais de ajuda unificados
        function abrirAjudaFonteVerdade() {
            document.getElementById('modal-ajuda-conceitos').classList.remove('hidden');
        }

        function fecharAjudaFonteVerdade() {
            document.getElementById('modal-ajuda-conceitos').classList.add('hidden');
        }

        // Modal de ajuda geral (conteúdo que estava no topo da página)
        function abrirModalAjudaGeral() {
            document.getElementById('modal-ajuda-geral').classList.remove('hidden');
        }

        function fecharModalAjudaGeral() {
            document.getElementById('modal-ajuda-geral').classList.add('hidden');
        }

        // Modal de ajuda do formato JSON
        function abrirModalAjudaJSON() {
            document.getElementById('modal-ajuda-json').classList.remove('hidden');
        }

        function fecharModalAjudaJSON() {
            document.getElementById('modal-ajuda-json').classList.add('hidden');
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            if (!getToken()) {
                window.location.href = '/login?redirect=/admin/categorias-resumo-json';
                return;
            }
            // Carrega dados em paralelo para melhor performance
            await Promise.all([
                carregarCategorias(),
                carregarVariaveisDisponiveis(),
                carregarFontesEspeciais()
            ]);
        });
    </script>

    <!-- REFATORADO: Modal de Ajuda Geral (conteúdo que estava no topo) -->
    <div id="modal-ajuda-geral" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-base font-semibold text-gray-800">Como funciona</h2>
                <button onclick="fecharModalAjudaGeral()" class="p-1 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <ul class="text-sm text-gray-600 space-y-2">
                    <li><i class="fas fa-check text-gray-400 mr-2"></i>Cada categoria define um formato JSON específico para resumos de documentos</li>
                    <li><i class="fas fa-check text-gray-400 mr-2"></i>Associe códigos de documento TJ-MS a cada categoria</li>
                    <li><i class="fas fa-check text-gray-400 mr-2"></i>A categoria <code class="bg-gray-100 px-1 rounded text-xs">residual</code> é usada para documentos sem categoria específica</li>
                    <li><i class="fas fa-check text-gray-400 mr-2"></i>A IA extrairá informações seguindo a estrutura JSON definida</li>
                </ul>
            </div>
            <div class="px-5 py-3 border-t border-gray-100 flex justify-end">
                <button onclick="fecharModalAjudaGeral()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- REFATORADO: Modal de Ajuda JSON -->
    <div id="modal-ajuda-json" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-base font-semibold text-gray-800">Formato JSON - Como usar</h2>
                <button onclick="fecharModalAjudaJSON()" class="p-1 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <ol class="text-sm text-gray-600 space-y-2 list-decimal list-inside">
                    <li>Escreva as perguntas que deseja extrair do documento</li>
                    <li>Clique em <strong>"Gerar JSON com IA"</strong></li>
                    <li>A IA gerará o schema JSON e criará as variáveis</li>
                    <li>Clique em <strong>"Aceitar e Usar"</strong> para aplicar</li>
                </ol>
                <p class="text-xs text-gray-500 mt-4">
                    <i class="fas fa-info-circle mr-1"></i>
                    Ou use o modo "JSON Manual" para controle total sobre a estrutura.
                </p>
            </div>
            <div class="px-5 py-3 border-t border-gray-100 flex justify-end">
                <button onclick="fecharModalAjudaJSON()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- REFATORADO: Modal de Ajuda Conceitos (simplificado, cores neutras) -->
    <div id="modal-ajuda-conceitos" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col m-4">
            <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-base font-semibold text-gray-800">Conceitos: Categorias e Extração</h2>
                <button onclick="fecharAjudaFonteVerdade()" class="p-1 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-5 space-y-4">
                <!-- Todos os blocos com estilo neutro e compacto -->
                <div class="border-l-2 border-gray-300 pl-4">
                    <h3 class="font-medium text-gray-800 mb-1">Categoria</h3>
                    <p class="text-sm text-gray-600">
                        Agrupa documentos pelo código TJ-MS. Define a estrutura de extração (perguntas e formato JSON).
                    </p>
                </div>

                <div class="border-l-2 border-gray-300 pl-4">
                    <h3 class="font-medium text-gray-800 mb-1">Perguntas de Extração</h3>
                    <p class="text-sm text-gray-600">
                        Definem o que será extraído. Podem ter dependências condicionais.
                    </p>
                </div>

                <div class="border-l-2 border-gray-300 pl-4">
                    <h3 class="font-medium text-gray-800 mb-1">Variáveis</h3>
                    <p class="text-sm text-gray-600">
                        Geradas a partir das perguntas. Cada variável pode ter sua própria fonte de verdade.
                        <a href="/admin/variaveis" class="text-primary-600 hover:underline ml-1">Ver variáveis →</a>
                    </p>
                </div>

                <div class="border-l-2 border-gray-300 pl-4">
                    <h3 class="font-medium text-gray-800 mb-1">Fonte de Verdade</h3>
                    <p class="text-sm text-gray-600">
                        Define DE QUAL documento específico a variável será extraída.
                        Ex: extrair "medicamento" apenas do "parecer NAT".
                    </p>
                </div>

                <div class="border-l-2 border-gray-300 pl-4">
                    <h3 class="font-medium text-gray-800 mb-1">Ordenação</h3>
                    <p class="text-sm text-gray-600">
                        Perguntas condicionais devem ficar logo abaixo de suas âncoras.
                        Use drag-and-drop ou "Reordenar" para organizar.
                    </p>
                </div>
            </div>
            <div class="px-5 py-3 border-t border-gray-100 flex justify-end">
                <button onclick="fecharAjudaFonteVerdade()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
