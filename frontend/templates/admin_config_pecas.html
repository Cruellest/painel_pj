<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração de Tipos de Peça - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .categoria-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
        .sortable-ghost { opacity: 0.4; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10 w-auto">
                    </a>
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="font-semibold text-gray-800">Configuração de Tipos de Peça</h1>
                        <p class="text-xs text-gray-500">Categorias de documentos por tipo de peça jurídica</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/admin/prompts-modulos" 
                       class="px-4 py-2 text-sm bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors flex items-center gap-2">
                        <i class="fas fa-puzzle-piece"></i>
                        Prompts Modulares
                    </a>
                    <button onclick="seedDados()" class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors flex items-center gap-2">
                        <i class="fas fa-database"></i>
                        Carregar Dados Iniciais
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex gap-6">
                <button onclick="showTab('categorias')" id="tab-categorias" 
                        class="tab-btn pb-3 text-blue-600 border-b-2 border-blue-600 font-medium">
                    <i class="fas fa-folder-open mr-2"></i>Categorias de Documentos
                </button>
                <button onclick="showTab('tipos')" id="tab-tipos" 
                        class="tab-btn pb-3 text-gray-500 hover:text-gray-700 font-medium">
                    <i class="fas fa-file-contract mr-2"></i>Tipos de Peça
                </button>
            </nav>
        </div>

        <!-- Tab: Categorias de Documentos -->
        <div id="panel-categorias" class="tab-panel">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800">
                    Categorias de Documentos do TJ-MS
                </h2>
                <button onclick="abrirModalCategoria()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">
                    <i class="fas fa-plus mr-2"></i>Nova Categoria
                </button>
            </div>

            <div id="lista-categorias" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Categorias carregadas via JS -->
            </div>
        </div>

        <!-- Tab: Tipos de Peça -->
        <div id="panel-tipos" class="tab-panel hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">
                        Tipos de Peça Jurídica
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">
                        Os tipos são baseados nos <a href="/admin/prompts-modulos" class="text-blue-600 hover:underline">Prompts Modulares</a> (tipo "peça")
                    </p>
                </div>
                <button onclick="sincronizarTipos()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">
                    <i class="fas fa-sync mr-2"></i>Sincronizar com Prompts
                </button>
            </div>

            <div id="lista-tipos" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tipos de peça carregados via JS -->
            </div>
        </div>
    </main>

    <!-- Modal Categoria -->
    <div id="modal-categoria" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modal-categoria-titulo" class="text-lg font-semibold">Nova Categoria</h3>
            </div>
            <form id="form-categoria" class="p-6 space-y-4">
                <input type="hidden" id="categoria-id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome (identificador)</label>
                    <input type="text" id="categoria-nome" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="laudos_medicos">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="categoria-titulo" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Laudos e Documentos Médicos">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="categoria-descricao" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="Descrição da categoria..."></textarea>
                </div>
                
                <!-- Seleção de documentos do JSON -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Documentos</label>
                    <p class="text-xs text-gray-500 mb-2">Selecione categorias inteiras ou documentos específicos</p>
                    
                    <!-- Filtro de busca -->
                    <input type="text" id="filtro-docs" placeholder="Buscar documento..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm"
                           onkeyup="filtrarDocumentos()">
                    
                    <div id="container-docs-json" class="border border-gray-300 rounded-lg max-h-64 overflow-y-auto">
                        <!-- Será preenchido via JS -->
                    </div>
                </div>
                
                <!-- Códigos selecionados (readonly) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Códigos Selecionados</label>
                    <input type="text" id="categoria-codigos" readonly
                           class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm font-mono"
                           placeholder="Selecione documentos acima">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cor</label>
                        <input type="color" id="categoria-cor" value="#3498db"
                               class="w-full h-10 rounded-lg cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                        <input type="number" id="categoria-ordem" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="categoria-ativo" checked
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="categoria-ativo" class="ml-2 text-sm text-gray-700">Ativo</label>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="fecharModalCategoria()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="salvarCategoria()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Tipo de Peça -->
    <div id="modal-tipo" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modal-tipo-titulo" class="text-lg font-semibold">Novo Tipo de Peça</h3>
            </div>
            <form id="form-tipo" class="p-6 space-y-4">
                <input type="hidden" id="tipo-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome (identificador)</label>
                        <input type="text" id="tipo-nome" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="contestacao">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="tipo-titulo" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Contestação">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="tipo-descricao" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="Descrição do tipo de peça..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ícone (Font Awesome)</label>
                        <input type="text" id="tipo-icone"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="file-text">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ordem</label>
                        <input type="number" id="tipo-ordem" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categorias de Documentos</label>
                    <p class="text-xs text-gray-500 mb-2">Selecione quais categorias de documentos serão analisadas para este tipo de peça</p>
                    <div id="tipo-categorias-container" class="border border-gray-300 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
                        <!-- Checkboxes de categorias -->
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="tipo-ativo" checked
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="tipo-ativo" class="ml-2 text-sm text-gray-700">Ativo</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="tipo-padrao"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="tipo-padrao" class="ml-2 text-sm text-gray-700">Tipo Padrão</label>
                    </div>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="fecharModalTipo()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="salvarTipo()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Função para escapar HTML e evitar XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        const API_BASE = '/api/gerador-pecas/config';
        let categoriasCache = [];
        let tiposCache = [];
        let tiposPromptsCache = [];  // Tipos dos prompts modulares (fonte de verdade)
        let categoriasJsonCache = [];  // Categorias do arquivo JSON
        let codigosSelecionados = new Set();  // Códigos selecionados no modal

        // ==========================================
        // Autenticação
        // ==========================================
        function getToken() {
            return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            };
        }

        // Verifica autenticação ao carregar
        (function checkAuth() {
            if (!getToken()) {
                window.location.href = '/login';
            }
        })();

        // ==========================================
        // Tabs
        // ==========================================
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            
            document.getElementById(`tab-${tab}`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
        }

        // ==========================================
        // Carregar Dados
        // ==========================================
        
        async function carregarCategoriasJson() {
            try {
                const resp = await fetch(`${API_BASE}/categorias-json`, { headers: getHeaders() });
                if (!resp.ok) throw new Error('Erro ao carregar categorias JSON');
                categoriasJsonCache = await resp.json();
            } catch (e) {
                console.error('Erro ao carregar categorias JSON:', e);
                categoriasJsonCache = [];
            }
        }
        
        async function carregarCategorias() {
            try {
                const resp = await fetch(`${API_BASE}/categorias`, { headers: getHeaders() });
                if (!resp.ok) throw new Error('Erro ao carregar categorias');
                categoriasCache = await resp.json();
                renderizarCategorias();
            } catch (e) {
                console.error(e);
                document.getElementById('lista-categorias').innerHTML = 
                    '<p class="text-red-500">Erro ao carregar categorias</p>';
            }
        }

        async function carregarTipos() {
            try {
                // Carrega tipos locais (com categorias de documento vinculadas)
                const resp = await fetch(`${API_BASE}/tipos-peca`, { headers: getHeaders() });
                if (!resp.ok) throw new Error('Erro ao carregar tipos');
                tiposCache = await resp.json();
                
                // Carrega tipos dos prompts modulares (fonte de verdade)
                const respPrompts = await fetch(`${API_BASE}/tipos-peca-prompts`, { headers: getHeaders() });
                if (respPrompts.ok) {
                    tiposPromptsCache = await respPrompts.json();
                }
                
                renderizarTipos();
            } catch (e) {
                console.error(e);
                document.getElementById('lista-tipos').innerHTML = 
                    '<p class="text-red-500">Erro ao carregar tipos de peça</p>';
            }
        }

        function renderizarCategorias() {
            const container = document.getElementById('lista-categorias');
            
            if (categoriasCache.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p>Nenhuma categoria cadastrada</p>
                        <p class="text-sm">Clique em "Carregar Dados Iniciais" para começar</p>
                    </div>`;
                return;
            }
            
            container.innerHTML = categoriasCache.map(cat => `
                <div class="bg-white rounded-lg shadow p-4 card-hover transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full" style="background: ${cat.cor || '#3498db'}"></span>
                            <h3 class="font-semibold text-gray-800">${escapeHtml(cat.titulo)}</h3>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editarCategoria(${cat.id})" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="excluirCategoria(${cat.id})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mb-2">${escapeHtml(cat.descricao || '')}</p>
                    <div class="text-xs text-gray-400 mb-2">
                        <span class="font-mono bg-gray-100 px-1 rounded">${escapeHtml(cat.nome)}</span>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${(cat.codigos_documento || []).slice(0, 8).map(cod => 
                            `<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs">${escapeHtml(cod)}</span>`
                        ).join('')}
                        ${(cat.codigos_documento || []).length > 8 ? 
                            `<span class="text-gray-400 text-xs">+${cat.codigos_documento.length - 8}</span>` : ''}
                    </div>
                    <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="${cat.ativo ? 'text-green-600' : 'text-red-600'}">
                            <i class="fas fa-${cat.ativo ? 'check' : 'times'}-circle"></i>
                            ${cat.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderizarTipos() {
            const container = document.getElementById('lista-tipos');
            
            // Usa tiposPromptsCache como referência principal e verifica se tem TipoPeca local vinculado
            const tiposParaMostrar = tiposPromptsCache.length > 0 ? tiposPromptsCache : tiposCache;
            
            if (tiposParaMostrar.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-file-contract text-4xl mb-4"></i>
                        <p>Nenhum tipo de peça cadastrado</p>
                        <p class="text-sm">Cadastre prompts do tipo "peça" em <a href="/admin/prompts-modulos" class="text-blue-600 hover:underline">Prompts Modulares</a></p>
                    </div>`;
                return;
            }
            
            // Se estamos usando tiposPromptsCache, precisamos verificar vinculação local
            if (tiposPromptsCache.length > 0) {
                container.innerHTML = tiposPromptsCache.map(tipoPrompt => {
                    // Procura TipoPeca local correspondente
                    const tipoLocal = tiposCache.find(t => t.nome === tipoPrompt.nome);
                    const temVinculo = !!tipoLocal;
                    
                    return `
                        <div class="bg-white rounded-lg shadow p-5 card-hover transition-all ${!temVinculo ? 'border-l-4 border-yellow-400' : ''}">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 ${temVinculo ? 'bg-blue-100' : 'bg-yellow-100'} rounded-lg flex items-center justify-center ${temVinculo ? 'text-blue-600' : 'text-yellow-600'}">
                                        <i class="fas fa-${tipoLocal?.icone || 'file'}"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${tipoPrompt.titulo}</h3>
                                        <span class="text-xs font-mono text-gray-400">${tipoPrompt.nome}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    ${temVinculo ? `
                                        <button onclick="editarTipo(${tipoLocal.id})" class="text-blue-600 hover:text-blue-800" title="Editar categorias">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    ` : `
                                        <button onclick="criarVinculoTipo('${tipoPrompt.nome}', '${tipoPrompt.titulo}')" 
                                                class="text-green-600 hover:text-green-800" title="Vincular categorias">
                                            <i class="fas fa-link"></i>
                                        </button>
                                    `}
                                </div>
                            </div>
                            
                            ${temVinculo ? `
                                <div class="mb-3">
                                    <p class="text-xs text-gray-500 mb-2">Categorias de documentos analisadas:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${(tipoLocal.categorias_documento || []).length > 0 ? 
                                            (tipoLocal.categorias_documento || []).map(cat => `
                                                <span class="categoria-badge" style="background: ${cat.cor || '#e5e7eb'}20; color: ${cat.cor || '#4b5563'}; border: 1px solid ${cat.cor || '#e5e7eb'}">
                                                    ${cat.titulo}
                                                </span>
                                            `).join('') :
                                            '<span class="text-gray-400 text-xs">Nenhuma categoria vinculada (analisa todos os documentos)</span>'
                                        }
                                    </div>
                                </div>
                            ` : `
                                <div class="mb-3 p-3 bg-yellow-50 rounded-lg">
                                    <p class="text-xs text-yellow-700">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Este tipo ainda não tem categorias de documentos definidas. 
                                        Clique no <i class="fas fa-link"></i> para configurar quais documentos a IA deve analisar.
                                    </p>
                                </div>
                            `}
                            
                            <div class="flex items-center gap-4 text-xs">
                                <span class="${tipoPrompt.ativo ? 'text-green-600' : 'text-red-600'}">
                                    <i class="fas fa-${tipoPrompt.ativo ? 'check' : 'times'}-circle"></i>
                                    ${tipoPrompt.ativo ? 'Ativo' : 'Inativo'}
                                </span>
                                ${temVinculo ? 
                                    '<span class="text-blue-600"><i class="fas fa-link"></i> Vinculado</span>' : 
                                    '<span class="text-yellow-600"><i class="fas fa-unlink"></i> Não vinculado</span>'
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Fallback: renderiza do cache local
                container.innerHTML = tiposCache.map(tipo => `
                    <div class="bg-white rounded-lg shadow p-5 card-hover transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                                    <i class="fas fa-${tipo.icone || 'file'}"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">${tipo.titulo}</h3>
                                    <span class="text-xs font-mono text-gray-400">${tipo.nome}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarTipo(${tipo.id})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="excluirTipo(${tipo.id})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">${tipo.descricao || ''}</p>
                        
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 mb-2">Categorias analisadas:</p>
                            <div class="flex flex-wrap gap-2">
                                ${(tipo.categorias_documento || []).map(cat => `
                                    <span class="categoria-badge" style="background: ${cat.cor || '#e5e7eb'}20; color: ${cat.cor || '#4b5563'}; border: 1px solid ${cat.cor || '#e5e7eb'}">
                                        ${cat.titulo}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4 text-xs">
                            <span class="${tipo.ativo ? 'text-green-600' : 'text-red-600'}">
                                <i class="fas fa-${tipo.ativo ? 'check' : 'times'}-circle"></i>
                                ${tipo.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                            ${tipo.is_padrao ? '<span class="text-purple-600"><i class="fas fa-star"></i> Padrão</span>' : ''}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        async function criarVinculoTipo(nome, titulo) {
            // Abre o modal para criar um TipoPeca local vinculado ao prompt
            document.getElementById('modal-tipo-titulo').textContent = `Configurar: ${titulo}`;
            document.getElementById('tipo-id').value = '';
            document.getElementById('tipo-nome').value = nome;
            document.getElementById('tipo-titulo').value = titulo;
            document.getElementById('tipo-descricao').value = '';
            document.getElementById('tipo-icone').value = 'file-alt';
            document.getElementById('tipo-ordem').value = 0;
            document.getElementById('tipo-ativo').checked = true;
            document.getElementById('tipo-padrao').checked = false;
            
            renderizarCategoriasCheckbox([]);
            
            document.getElementById('modal-tipo').classList.remove('hidden');
            document.getElementById('modal-tipo').classList.add('flex');
        }
        
        async function sincronizarTipos() {
            try {
                // Para cada tipo de prompt que não tem TipoPeca local, cria um
                let criados = 0;
                for (const tipoPrompt of tiposPromptsCache) {
                    const tipoLocal = tiposCache.find(t => t.nome === tipoPrompt.nome);
                    if (!tipoLocal) {
                        // Cria TipoPeca local
                        const resp = await fetch(`${API_BASE}/tipos-peca`, {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({
                                nome: tipoPrompt.nome,
                                titulo: tipoPrompt.titulo,
                                descricao: '',
                                icone: 'file-alt',
                                ordem: tipoPrompt.ordem || 0,
                                ativo: true,
                                is_padrao: false,
                                categorias_ids: []
                            })
                        });
                        if (resp.ok) criados++;
                    }
                }
                
                if (criados > 0) {
                    alert(`${criados} tipo(s) sincronizado(s) com sucesso!`);
                    await carregarTipos();
                } else {
                    alert('Todos os tipos já estão sincronizados!');
                }
            } catch (e) {
                alert('Erro ao sincronizar: ' + e.message);
            }
        }

        // ==========================================
        // Modal Categoria
        // ==========================================
        function abrirModalCategoria() {
            document.getElementById('modal-categoria-titulo').textContent = 'Nova Categoria';
            document.getElementById('form-categoria').reset();
            document.getElementById('categoria-id').value = '';
            document.getElementById('categoria-cor').value = '#3498db';
            codigosSelecionados = new Set();
            renderizarDocumentosJson();
            atualizarCodigosSelecionados();
            document.getElementById('modal-categoria').classList.remove('hidden');
            document.getElementById('modal-categoria').classList.add('flex');
        }

        function fecharModalCategoria() {
            document.getElementById('modal-categoria').classList.add('hidden');
            document.getElementById('modal-categoria').classList.remove('flex');
        }
        
        function renderizarDocumentosJson(filtro = '') {
            const container = document.getElementById('container-docs-json');
            filtro = filtro.toLowerCase();
            
            let html = '';
            
            // Categoria especial: Petição Inicial
            html += `
                <div class="p-2 bg-blue-50 border-b">
                    <label class="flex items-center gap-2 cursor-pointer font-medium text-blue-800">
                        <input type="checkbox" class="doc-especial-cb" data-codigos="9500,500"
                               onchange="toggleCategoriaEspecial(this)"
                               ${codigosSelecionados.has(9500) && codigosSelecionados.has(500) ? 'checked' : ''}>
                        <i class="fas fa-star text-yellow-500"></i>
                        Petição Inicial (primeiro doc 9500/500)
                    </label>
                </div>
            `;
            
            for (const catJson of categoriasJsonCache) {
                const docsVisiveis = catJson.documentos.filter(d => 
                    !filtro || d.nome.toLowerCase().includes(filtro) || String(d.codigo).includes(filtro)
                );
                
                if (docsVisiveis.length === 0 && filtro) continue;
                
                const todosSelecionados = catJson.codigos.every(c => codigosSelecionados.has(c));
                const algunsSelecionados = catJson.codigos.some(c => codigosSelecionados.has(c));
                
                html += `
                    <div class="border-b">
                        <div class="p-2 bg-gray-50 flex items-center gap-2">
                            <input type="checkbox" class="cat-json-cb" data-categoria="${catJson.nome_id}"
                                   onchange="toggleCategoriaJson('${catJson.nome_id}')"
                                   ${todosSelecionados ? 'checked' : ''} 
                                   ${algunsSelecionados && !todosSelecionados ? 'indeterminate' : ''}>
                            <span class="font-medium text-sm">${catJson.categoria}</span>
                            <span class="text-xs text-gray-500">(${catJson.codigos.length} docs)</span>
                            <button type="button" onclick="toggleExpandir('${catJson.nome_id}')" 
                                    class="ml-auto text-gray-500 hover:text-gray-700">
                                <i class="fas fa-chevron-down" id="icon-${catJson.nome_id}"></i>
                            </button>
                        </div>
                        <div id="docs-${catJson.nome_id}" class="hidden pl-6 py-1 max-h-40 overflow-y-auto">
                            ${docsVisiveis.map(doc => `
                                <label class="flex items-center gap-2 p-1 hover:bg-gray-50 cursor-pointer text-sm">
                                    <input type="checkbox" class="doc-cb" data-codigo="${doc.codigo}"
                                           onchange="toggleDocumento(${doc.codigo})"
                                           ${codigosSelecionados.has(doc.codigo) ? 'checked' : ''}>
                                    <span class="font-mono text-xs text-gray-500">${doc.codigo}</span>
                                    <span>${doc.nome}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Ajustar checkboxes indeterminadas
            setTimeout(() => {
                categoriasJsonCache.forEach(catJson => {
                    const todosSelecionados = catJson.codigos.every(c => codigosSelecionados.has(c));
                    const algunsSelecionados = catJson.codigos.some(c => codigosSelecionados.has(c));
                    const cb = document.querySelector(`input[data-categoria="${catJson.nome_id}"]`);
                    if (cb) cb.indeterminate = algunsSelecionados && !todosSelecionados;
                });
            }, 0);
        }
        
        function toggleExpandir(catId) {
            const docs = document.getElementById(`docs-${catId}`);
            const icon = document.getElementById(`icon-${catId}`);
            docs.classList.toggle('hidden');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }
        
        function toggleCategoriaJson(catId) {
            const cat = categoriasJsonCache.find(c => c.nome_id === catId);
            if (!cat) return;
            
            const todosSelecionados = cat.codigos.every(c => codigosSelecionados.has(c));
            
            if (todosSelecionados) {
                cat.codigos.forEach(c => codigosSelecionados.delete(c));
            } else {
                cat.codigos.forEach(c => codigosSelecionados.add(c));
            }
            
            renderizarDocumentosJson(document.getElementById('filtro-docs')?.value || '');
            atualizarCodigosSelecionados();
        }
        
        function toggleCategoriaEspecial(cb) {
            const codigos = cb.dataset.codigos.split(',').map(c => parseInt(c));
            if (cb.checked) {
                codigos.forEach(c => codigosSelecionados.add(c));
            } else {
                codigos.forEach(c => codigosSelecionados.delete(c));
            }
            atualizarCodigosSelecionados();
        }
        
        function toggleDocumento(codigo) {
            if (codigosSelecionados.has(codigo)) {
                codigosSelecionados.delete(codigo);
            } else {
                codigosSelecionados.add(codigo);
            }
            renderizarDocumentosJson(document.getElementById('filtro-docs')?.value || '');
            atualizarCodigosSelecionados();
        }
        
        function atualizarCodigosSelecionados() {
            const input = document.getElementById('categoria-codigos');
            input.value = [...codigosSelecionados].sort((a, b) => a - b).join(', ');
        }
        
        function filtrarDocumentos() {
            const filtro = document.getElementById('filtro-docs').value;
            renderizarDocumentosJson(filtro);
        }

        async function editarCategoria(id) {
            const cat = categoriasCache.find(c => c.id === id);
            if (!cat) return;
            
            document.getElementById('modal-categoria-titulo').textContent = 'Editar Categoria';
            document.getElementById('categoria-id').value = cat.id;
            document.getElementById('categoria-nome').value = cat.nome;
            document.getElementById('categoria-titulo').value = cat.titulo;
            document.getElementById('categoria-descricao').value = cat.descricao || '';
            document.getElementById('categoria-cor').value = cat.cor || '#3498db';
            document.getElementById('categoria-ordem').value = cat.ordem || 0;
            document.getElementById('categoria-ativo').checked = cat.ativo;
            
            // Carregar códigos selecionados
            codigosSelecionados = new Set(cat.codigos_documento || []);
            renderizarDocumentosJson();
            atualizarCodigosSelecionados();
            
            document.getElementById('modal-categoria').classList.remove('hidden');
            document.getElementById('modal-categoria').classList.add('flex');
        }

        async function salvarCategoria() {
            const id = document.getElementById('categoria-id').value;
            const codigos = [...codigosSelecionados];
            
            const dados = {
                nome: document.getElementById('categoria-nome').value,
                titulo: document.getElementById('categoria-titulo').value,
                descricao: document.getElementById('categoria-descricao').value,
                codigos_documento: codigos,
                cor: document.getElementById('categoria-cor').value,
                ordem: parseInt(document.getElementById('categoria-ordem').value) || 0,
                ativo: document.getElementById('categoria-ativo').checked
            };
            
            try {
                const url = id ? `${API_BASE}/categorias/${id}` : `${API_BASE}/categorias`;
                const method = id ? 'PUT' : 'POST';
                
                const resp = await fetch(url, {
                    method,
                    headers: getHeaders(),
                    body: JSON.stringify(dados)
                });
                
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Erro ao salvar');
                }
                
                fecharModalCategoria();
                await carregarCategorias();
                await carregarTipos(); // Atualiza tipos que usam categorias
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        }

        async function excluirCategoria(id) {
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;
            
            try {
                const resp = await fetch(`${API_BASE}/categorias/${id}`, { method: 'DELETE', headers: getHeaders() });
                if (!resp.ok) throw new Error('Erro ao excluir');
                await carregarCategorias();
                await carregarTipos();
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        }

        // ==========================================
        // Modal Tipo de Peça
        // ==========================================
        function abrirModalTipo() {
            document.getElementById('modal-tipo-titulo').textContent = 'Novo Tipo de Peça';
            document.getElementById('form-tipo').reset();
            document.getElementById('tipo-id').value = '';
            renderizarCategoriasCheckbox([]);
            document.getElementById('modal-tipo').classList.remove('hidden');
            document.getElementById('modal-tipo').classList.add('flex');
        }

        function fecharModalTipo() {
            document.getElementById('modal-tipo').classList.add('hidden');
            document.getElementById('modal-tipo').classList.remove('flex');
        }

        function renderizarCategoriasCheckbox(selecionadas = []) {
            const container = document.getElementById('tipo-categorias-container');
            const selIds = selecionadas.map(c => c.id);
            
            container.innerHTML = categoriasCache.map(cat => `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${cat.id}" 
                           ${selIds.includes(cat.id) ? 'checked' : ''}
                           class="tipo-categoria-cb w-4 h-4 text-blue-600 border-gray-300 rounded">
                    <span class="w-3 h-3 rounded-full" style="background: ${cat.cor || '#3498db'}"></span>
                    <span class="text-sm">${cat.titulo}</span>
                    <span class="text-xs text-gray-400">(${(cat.codigos_documento || []).length} códigos)</span>
                </label>
            `).join('');
        }

        async function editarTipo(id) {
            const tipo = tiposCache.find(t => t.id === id);
            if (!tipo) return;
            
            document.getElementById('modal-tipo-titulo').textContent = 'Editar Tipo de Peça';
            document.getElementById('tipo-id').value = tipo.id;
            document.getElementById('tipo-nome').value = tipo.nome;
            document.getElementById('tipo-titulo').value = tipo.titulo;
            document.getElementById('tipo-descricao').value = tipo.descricao || '';
            document.getElementById('tipo-icone').value = tipo.icone || '';
            document.getElementById('tipo-ordem').value = tipo.ordem || 0;
            document.getElementById('tipo-ativo').checked = tipo.ativo;
            document.getElementById('tipo-padrao').checked = tipo.is_padrao;
            
            renderizarCategoriasCheckbox(tipo.categorias_documento || []);
            
            document.getElementById('modal-tipo').classList.remove('hidden');
            document.getElementById('modal-tipo').classList.add('flex');
        }

        async function salvarTipo() {
            const id = document.getElementById('tipo-id').value;
            const categoriasIds = [...document.querySelectorAll('.tipo-categoria-cb:checked')]
                .map(cb => parseInt(cb.value));
            
            const dados = {
                nome: document.getElementById('tipo-nome').value,
                titulo: document.getElementById('tipo-titulo').value,
                descricao: document.getElementById('tipo-descricao').value,
                icone: document.getElementById('tipo-icone').value,
                ordem: parseInt(document.getElementById('tipo-ordem').value) || 0,
                ativo: document.getElementById('tipo-ativo').checked,
                is_padrao: document.getElementById('tipo-padrao').checked,
                categorias_ids: categoriasIds
            };
            
            try {
                const url = id ? `${API_BASE}/tipos-peca/${id}` : `${API_BASE}/tipos-peca`;
                const method = id ? 'PUT' : 'POST';
                
                const resp = await fetch(url, {
                    method,
                    headers: getHeaders(),
                    body: JSON.stringify(dados)
                });
                
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Erro ao salvar');
                }
                
                fecharModalTipo();
                await carregarTipos();
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        }

        async function excluirTipo(id) {
            if (!confirm('Tem certeza que deseja excluir este tipo de peça?')) return;
            
            try {
                const resp = await fetch(`${API_BASE}/tipos-peca/${id}`, { method: 'DELETE', headers: getHeaders() });
                if (!resp.ok) throw new Error('Erro ao excluir');
                await carregarTipos();
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        }

        // ==========================================
        // Seed
        // ==========================================
        async function seedDados() {
            if (!confirm('Isso irá carregar as categorias e tipos de peça padrão. Continuar?')) return;
            
            try {
                const resp = await fetch(`${API_BASE}/seed`, { method: 'POST', headers: getHeaders() });
                const data = await resp.json();
                
                if (!resp.ok) throw new Error(data.detail || 'Erro ao executar seed');
                
                alert(`Seed executado!\nCategorias criadas: ${data.categorias_criadas}\nTipos criados: ${data.tipos_criados}`);
                await carregarCategorias();
                await carregarTipos();
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        }

        // ==========================================
        // Init
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarCategoriasJson();  // Carrega categorias do arquivo JSON primeiro
            await carregarCategorias();
            await carregarTipos();
        });
    </script>
</body>
</html>
