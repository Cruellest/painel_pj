<!DOCTYPE html>
<!-- v2 - URLs corrigidas para /admin/api/performance/* -->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance & Logs - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/timezone.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .tab-active {
            border-bottom: 3px solid #0ea5e9;
            color: #0ea5e9;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10 w-auto">
                    </a>
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="font-semibold text-gray-800">Performance & Logs</h1>
                        <p class="text-xs text-gray-500">Monitoramento de sistema e IA</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-xs text-green-600 flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Sempre ativo
                    </span>
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex gap-8">
                <button onclick="switchTab('sistema')" id="tab-sistema"
                    class="py-4 px-1 font-medium text-gray-700 hover:text-primary-600 tab-active transition-colors">
                    <i class="fas fa-server mr-2"></i>Performance Sistema
                </button>
                <button onclick="switchTab('gemini')" id="tab-gemini"
                    class="py-4 px-1 font-medium text-gray-500 hover:text-primary-600 transition-colors">
                    <i class="fas fa-robot mr-2"></i>Logs Gemini API
                </button>
                <button onclick="switchTab('avancado')" id="tab-avancado"
                    class="py-4 px-1 font-medium text-gray-500 hover:text-primary-600 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Logs Avancados
                </button>
            </nav>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- ================================================== -->
        <!-- TAB: PERFORMANCE SISTEMA -->
        <!-- ================================================== -->
        <div id="content-sistema" class="tab-content active">

            <!-- Cards de Gargalo -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div id="card-llm" class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500 cursor-pointer hover:bg-purple-50" onclick="filterByBottleneck('LLM')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Gargalo LLM</h3>
                            <p id="count-llm" class="text-2xl font-bold text-purple-600">-</p>
                        </div>
                        <i class="fas fa-robot text-2xl text-purple-300"></i>
                    </div>
                    <p id="avg-llm" class="text-xs text-gray-500 mt-1">avg: - ms</p>
                </div>
                <div id="card-db" class="bg-white rounded-lg shadow-md p-4 border-l-4 border-yellow-500 cursor-pointer hover:bg-yellow-50" onclick="filterByBottleneck('DB')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Gargalo DB</h3>
                            <p id="count-db" class="text-2xl font-bold text-yellow-600">-</p>
                        </div>
                        <i class="fas fa-database text-2xl text-yellow-300"></i>
                    </div>
                    <p id="avg-db" class="text-xs text-gray-500 mt-1">avg: - ms</p>
                </div>
                <div id="card-parse" class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500 cursor-pointer hover:bg-blue-50" onclick="filterByBottleneck('PARSE')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Gargalo Parse</h3>
                            <p id="count-parse" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                        <i class="fas fa-code text-2xl text-blue-300"></i>
                    </div>
                    <p id="avg-parse" class="text-xs text-gray-500 mt-1">avg: - ms</p>
                </div>
                <div id="card-outro" class="bg-white rounded-lg shadow-md p-4 border-l-4 border-gray-400 cursor-pointer hover:bg-gray-100" onclick="filterByBottleneck('OUTRO')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Outro</h3>
                            <p id="count-outro" class="text-2xl font-bold text-gray-600">-</p>
                        </div>
                        <i class="fas fa-question text-2xl text-gray-300"></i>
                    </div>
                    <p id="avg-total" class="text-xs text-gray-500 mt-1">total avg: - ms</p>
                </div>
            </div>

            <!-- Grafico de Pizza e Top Lentas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribuicao de Gargalos</h3>
                    <canvas id="chartBottleneck" height="200"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 3 Mais Lentas por Gargalo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-purple-600 mb-2"><i class="fas fa-robot mr-1"></i>LLM</h4>
                            <div id="top-llm" class="space-y-1 text-xs"></div>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-yellow-600 mb-2"><i class="fas fa-database mr-1"></i>DB</h4>
                            <div id="top-db" class="space-y-1 text-xs"></div>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-blue-600 mb-2"><i class="fas fa-code mr-1"></i>Parse</h4>
                            <div id="top-parse" class="space-y-1 text-xs"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapeamento de Rotas para Sistemas -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-route mr-2 text-indigo-500"></i>Mapeamento Rota â†’ Sistema
                    </h3>
                    <button onclick="toggleRouteMapSection()" id="btnToggleRouteMap" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-chevron-down mr-1"></i>Expandir
                    </button>
                </div>
                <div id="routeMapSection" class="hidden">
                    <!-- Formulario de novo mapeamento -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Novo Mapeamento</h4>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <div class="md:col-span-2">
                                <input type="text" id="newRoutePattern" placeholder="Padrao da rota (ex: /api/gerador-pecas)"
                                    class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <input type="text" id="newSystemName" placeholder="Nome do Sistema"
                                    class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <select id="newMatchType" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    <option value="prefix">Prefixo</option>
                                    <option value="exact">Exato</option>
                                    <option value="regex">Regex</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="createRouteMap()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-plus mr-1"></i>Adicionar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grid: Mapeamentos existentes + Rotas frequentes -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Mapeamentos existentes -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Mapeamentos Cadastrados</h4>
                            <div id="routeMappingsList" class="space-y-2 max-h-64 overflow-y-auto">
                                <p class="text-gray-400 text-sm">Carregando...</p>
                            </div>
                        </div>

                        <!-- Rotas mais frequentes sem mapeamento -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Rotas Frequentes (sem mapeamento)</h4>
                            <div id="topRoutesList" class="space-y-2 max-h-64 overflow-y-auto">
                                <p class="text-gray-400 text-sm">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros Sistema -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sistema</label>
                        <select id="filterSystem" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rota</label>
                        <input type="text" id="filterRoute" placeholder="/api/..."
                            class="w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                        <select id="filterAction" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gargalo</label>
                        <select id="filterBottleneck" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="LLM">LLM</option>
                            <option value="DB">DB</option>
                            <option value="PARSE">Parse</option>
                            <option value="OUTRO">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="filterStatus" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="ok">OK</option>
                            <option value="error">Erro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                        <select id="filterHours" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="1">1 hora</option>
                            <option value="6">6 horas</option>
                            <option value="24" selected>24 horas</option>
                            <option value="72">3 dias</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="loadSystemLogs()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            Filtrar
                        </button>
                        <button onclick="clearSystemFilters()" class="px-3 py-2 border rounded-lg text-sm hover:bg-gray-100">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Logs Sistema -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Logs de Performance</h2>
                    <button onclick="cleanupSystemLogs()" class="text-sm text-red-600 hover:text-red-800">
                        <i class="fas fa-trash mr-1"></i>Limpar antigos
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sistema</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rota</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">LLM</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">DB</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Parse</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Gargalo</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                                    Carregando logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Erros Recentes Sistema -->
            <div class="bg-white rounded-lg shadow-md p-4 mt-6">
                <h3 class="text-lg font-semibold text-red-600 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Erros Recentes</h3>
                <div id="recentErrors" class="space-y-2">
                    <p class="text-gray-500 text-sm">Carregando...</p>
                </div>
            </div>
        </div>

        <!-- ================================================== -->
        <!-- TAB: LOGS GEMINI API -->
        <!-- ================================================== -->
        <div id="content-gemini" class="tab-content">

            <!-- Cards Gemini - Linha 1: Principais -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Total Chamadas</h3>
                            <p id="gemini-total" class="text-2xl font-bold text-green-600">-</p>
                        </div>
                        <i class="fas fa-phone text-2xl text-green-300"></i>
                    </div>
                    <p class="text-xs mt-1">
                        <span id="gemini-success-count" class="text-green-600">-</span> ok /
                        <span id="gemini-error-count" class="text-red-600">-</span> erro
                    </p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Latencia Media</h3>
                            <p id="gemini-avg-latency" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                        <i class="fas fa-clock text-2xl text-blue-300"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        min: <span id="gemini-min-latency">-</span> / max: <span id="gemini-max-latency">-</span>
                    </p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Tokens Prompt</h3>
                            <p id="gemini-tokens-prompt" class="text-2xl font-bold text-purple-600">-</p>
                        </div>
                        <i class="fas fa-arrow-right text-2xl text-purple-300"></i>
                    </div>
                    <p id="gemini-tokens-response" class="text-xs text-gray-500 mt-1">response: -</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-teal-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Taxa Sucesso</h3>
                            <p id="gemini-success-rate" class="text-2xl font-bold text-teal-600">-</p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-teal-300"></i>
                    </div>
                    <p id="gemini-retries" class="text-xs text-gray-500 mt-1">retries: -</p>
                </div>
            </div>

            <!-- Cards Gemini - Linha 2: Timing e Features -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-3 border-l-4 border-indigo-400">
                    <h3 class="text-xs font-medium text-gray-500">TTFT Medio</h3>
                    <p id="gemini-ttft" class="text-lg font-bold text-indigo-600">-</p>
                    <p class="text-xs text-gray-400">Time to First Token</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-3 border-l-4 border-pink-400">
                    <h3 class="text-xs font-medium text-gray-500">Geracao</h3>
                    <p id="gemini-generation" class="text-lg font-bold text-pink-600">-</p>
                    <p class="text-xs text-gray-400">Tempo gerando</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-3 border-l-4 border-orange-400">
                    <h3 class="text-xs font-medium text-gray-500">Cache Hits</h3>
                    <p id="gemini-cache" class="text-lg font-bold text-orange-600">-</p>
                    <p id="gemini-cache-rate" class="text-xs text-gray-400">taxa: -</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-3 border-l-4 border-cyan-400">
                    <h3 class="text-xs font-medium text-gray-500">Com Imagens</h3>
                    <p id="gemini-images" class="text-lg font-bold text-cyan-600">-</p>
                    <p class="text-xs text-gray-400">chamadas</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-3 border-l-4 border-amber-400">
                    <h3 class="text-xs font-medium text-gray-500">Com Search</h3>
                    <p id="gemini-search" class="text-lg font-bold text-amber-600">-</p>
                    <p class="text-xs text-gray-400">grounding</p>
                </div>
            </div>

            <!-- Graficos Gemini -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Chamadas por Sistema</h3>
                    <canvas id="chartGeminiSistema" height="200"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Chamadas por Modelo</h3>
                    <canvas id="chartGeminiModelo" height="200"></canvas>
                </div>
            </div>

            <!-- Chamadas Mais Lentas -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Chamadas Mais Lentas</h3>
                <div id="gemini-slowest" class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <p class="text-gray-500 text-sm">Carregando...</p>
                </div>
            </div>

            <!-- Filtros Gemini -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sistema</label>
                        <select id="geminiFilterSistema" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                        <select id="geminiFilterModelo" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="geminiFilterSuccess" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="true">Sucesso</option>
                            <option value="false">Falha</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                        <select id="geminiFilterHours" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="1">1 hora</option>
                            <option value="6">6 horas</option>
                            <option value="24" selected>24 horas</option>
                            <option value="72">3 dias</option>
                            <option value="168">7 dias</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="loadGeminiLogs()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                            Filtrar
                        </button>
                        <button onclick="clearGeminiFilters()" class="px-3 py-2 border rounded-lg text-sm hover:bg-gray-100">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Logs Gemini -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Logs de Chamadas Gemini</h2>
                    <button onclick="cleanupGeminiLogs()" class="text-sm text-red-600 hover:text-red-800">
                        <i class="fas fa-trash mr-1"></i>Limpar antigos
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sistema</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rota</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Modelo</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Thinking</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tokens</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Latencia</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">TTFT</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cache</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
                            </tr>
                        </thead>
                        <tbody id="geminiLogsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                                    Carregando logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Erros Recentes Gemini -->
            <div class="bg-white rounded-lg shadow-md p-4 mt-6">
                <h3 class="text-lg font-semibold text-red-600 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Erros Gemini Recentes</h3>
                <div id="geminiRecentErrors" class="space-y-2">
                    <p class="text-gray-500 text-sm">Carregando...</p>
                </div>
            </div>
        </div>

        <!-- ================================================== -->
        <!-- TAB: LOGS AVANCADOS (REQUEST PERFORMANCE) -->
        <!-- ================================================== -->
        <div id="content-avancado" class="tab-content">

            <!-- Cards de Summary -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-emerald-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Total Requests</h3>
                            <p id="adv-total" class="text-2xl font-bold text-emerald-600">-</p>
                        </div>
                        <i class="fas fa-list text-2xl text-emerald-300"></i>
                    </div>
                    <p class="text-xs mt-1">
                        <span id="adv-success" class="text-green-600">-</span> ok /
                        <span id="adv-error" class="text-red-600">-</span> erro
                    </p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Latencia Media</h3>
                            <p id="adv-avg-total" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                        <i class="fas fa-clock text-2xl text-blue-300"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        min: <span id="adv-min-total">-</span> / max: <span id="adv-max-total">-</span>
                    </p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-indigo-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">TTFT Medio</h3>
                            <p id="adv-avg-ttft" class="text-2xl font-bold text-indigo-600">-</p>
                        </div>
                        <i class="fas fa-bolt text-2xl text-indigo-300"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Time to First Token</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-pink-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Geracao Media</h3>
                            <p id="adv-avg-gen" class="text-2xl font-bold text-pink-600">-</p>
                        </div>
                        <i class="fas fa-cog text-2xl text-pink-300"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Tempo gerando tokens</p>
                </div>
            </div>

            <!-- Breakdown por Etapa -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-layer-group mr-2"></i>Breakdown por Etapa (medias em ms)</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div class="text-center p-3 bg-orange-50 rounded-lg">
                        <p class="text-xs text-gray-500">Agente 1 (TJ-MS)</p>
                        <p id="adv-agente1" class="text-xl font-bold text-orange-600">-</p>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <p class="text-xs text-gray-500">Agente 2 (Detector)</p>
                        <p id="adv-agente2" class="text-xl font-bold text-purple-600">-</p>
                    </div>
                    <div class="text-center p-3 bg-cyan-50 rounded-lg">
                        <p class="text-xs text-gray-500">Prompt Build</p>
                        <p id="adv-prompt" class="text-xl font-bold text-cyan-600">-</p>
                    </div>
                    <div class="text-center p-3 bg-teal-50 rounded-lg">
                        <p class="text-xs text-gray-500">Pos-Processo</p>
                        <p id="adv-postproc" class="text-xl font-bold text-teal-600">-</p>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                        <p class="text-xs text-gray-500">DB Save</p>
                        <p id="adv-db" class="text-xl font-bold text-yellow-600">-</p>
                    </div>
                    <div class="text-center p-3 bg-gray-100 rounded-lg">
                        <p class="text-xs text-gray-500">Overhead</p>
                        <p id="adv-overhead" class="text-xl font-bold text-gray-600">-</p>
                    </div>
                </div>
            </div>

            <!-- Streaming Stats -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-stream mr-2"></i>Estatisticas de Streaming</h3>
                <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-gray-500">Chunks Medio</p>
                        <p id="adv-chunks" class="text-xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <p class="text-xs text-gray-500">Intervalo Medio entre Chunks</p>
                        <p id="adv-chunk-interval" class="text-xl font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sistema</label>
                        <select id="advFilterSistema" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="gerador_pecas">Gerador de Pecas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                        <select id="advFilterHours" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="1">1 hora</option>
                            <option value="6">6 horas</option>
                            <option value="24" selected>24 horas</option>
                            <option value="72">3 dias</option>
                            <option value="168">7 dias</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Latencia minima (ms)</label>
                        <input type="number" id="advFilterMinMs" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ex: 5000">
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="loadAdvancedLogs()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm">
                            Filtrar
                        </button>
                        <button onclick="clearAdvancedFilters()" class="px-3 py-2 border rounded-lg text-sm hover:bg-gray-100">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Requests Mais Lentos -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-hourglass-half mr-2"></i>Requests Mais Lentos</h3>
                <div id="advSlowest" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <p class="text-gray-500 text-sm">Carregando...</p>
                </div>
            </div>

            <!-- Tabela de Logs Detalhados -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Logs Detalhados de Requests</h2>
                    <button onclick="cleanupAdvancedLogs()" class="text-sm text-red-600 hover:text-red-800">
                        <i class="fas fa-trash mr-1"></i>Limpar antigos
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Request ID</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">CNJ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo Peca</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">TTFT</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ag1</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ag2</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Geracao</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Chunks</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="advLogsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                                    Carregando logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
    const token = localStorage.getItem('access_token');
    let chartBottleneck = null;
    let chartGeminiSistema = null;
    let chartGeminiModelo = null;

    // ========================================
    // TAB SWITCHING
    // ========================================
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('[id^="tab-"]').forEach(tab => {
            tab.classList.remove('tab-active', 'text-gray-700');
            tab.classList.add('text-gray-500');
        });
        document.getElementById(`tab-${tabName}`).classList.add('tab-active', 'text-gray-700');
        document.getElementById(`tab-${tabName}`).classList.remove('text-gray-500');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`content-${tabName}`).classList.add('active');

        // Load data for selected tab
        if (tabName === 'sistema') {
            loadSystemSummary();
            loadSystemLogs();
        } else if (tabName === 'gemini') {
            loadGeminiSummary();
            loadGeminiLogs();
        } else if (tabName === 'avancado') {
            loadAdvancedSummary();
            loadAdvancedLogs();
            loadAdvancedSlowest();
        }
    }

    // ========================================
    // SISTEMA - PERFORMANCE LOGS
    // ========================================

    async function loadSystemSummary() {
        const hours = document.getElementById('filterHours').value;
        try {
            console.log('[Performance] Carregando summary...', { hours, token: token ? 'presente' : 'ausente' });
            const response = await fetch(`/admin/api/performance/summary?hours=${hours}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('[Performance] Erro na API:', response.status, errorText);
                showNotification(`Erro ao carregar dados: ${response.status}`, 'error');
                return;
            }

            const data = await response.json();
            console.log('[Performance] Summary carregado:', data);

            // Atualiza cards
            document.getElementById('count-llm').textContent = data.bottleneck_summary.LLM || 0;
            document.getElementById('count-db').textContent = data.bottleneck_summary.DB || 0;
            document.getElementById('count-parse').textContent = data.bottleneck_summary.PARSE || 0;
            document.getElementById('count-outro').textContent = data.bottleneck_summary.OUTRO || 0;

            document.getElementById('avg-llm').textContent = `avg: ${data.avg_times.llm} ms`;
            document.getElementById('avg-db').textContent = `avg: ${data.avg_times.db} ms`;
            document.getElementById('avg-parse').textContent = `avg: ${data.avg_times.parse} ms`;
            document.getElementById('avg-total').textContent = `total avg: ${data.avg_times.total} ms`;

            // Grafico
            renderBottleneckChart(data.bottleneck_summary);

            // Top lentas
            renderTopSlowest(data.slowest_by_bottleneck);

            // Erros
            renderSystemErrors(data.recent_errors);

        } catch (error) {
            console.error('Erro ao carregar resumo sistema:', error);
        }
    }

    function renderBottleneckChart(bottleneck_summary) {
        const ctx = document.getElementById('chartBottleneck').getContext('2d');
        if (chartBottleneck) chartBottleneck.destroy();

        chartBottleneck = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['LLM', 'DB', 'Parse', 'Outro'],
                datasets: [{
                    data: [
                        bottleneck_summary.LLM || 0,
                        bottleneck_summary.DB || 0,
                        bottleneck_summary.PARSE || 0,
                        bottleneck_summary.OUTRO || 0
                    ],
                    backgroundColor: ['#9333ea', '#eab308', '#3b82f6', '#9ca3af'],
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderTopSlowest(data) {
        ['LLM', 'DB', 'PARSE'].forEach(type => {
            const container = document.getElementById(`top-${type.toLowerCase()}`);
            const items = data[type] || [];
            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-400">Sem dados</p>';
                return;
            }
            container.innerHTML = items.map(item => `
                <div class="p-2 bg-gray-50 rounded">
                    <div class="font-medium truncate" title="${item.route}">${item.action || item.route}</div>
                    <div class="text-gray-500">${Math.round(item.total_ms)} ms total</div>
                </div>
            `).join('');
        });
    }

    function renderSystemErrors(errors) {
        const container = document.getElementById('recentErrors');
        if (!errors || errors.length === 0) {
            container.innerHTML = '<p class="text-green-600 text-sm"><i class="fas fa-check mr-1"></i>Nenhum erro recente</p>';
            return;
        }
        container.innerHTML = errors.map(err => `
            <div class="p-2 bg-red-50 rounded text-sm">
                <div class="flex justify-between">
                    <span class="font-medium text-red-700">${err.action || err.route}</span>
                    <span class="text-xs text-gray-500">${err.created_at ? formatTime(err.created_at) : ''}</span>
                </div>
                <div class="text-xs text-red-600">
                    <span class="font-medium">${err.error_type || 'erro'}</span>: ${err.error_message || '-'}
                </div>
            </div>
        `).join('');
    }

    async function loadSystemLogs() {
        const system = document.getElementById('filterSystem').value;
        const route = document.getElementById('filterRoute').value;
        const action = document.getElementById('filterAction').value;
        const bottleneck = document.getElementById('filterBottleneck').value;
        const status = document.getElementById('filterStatus').value;
        const hours = document.getElementById('filterHours').value;

        const params = new URLSearchParams();
        if (system) params.append('system', system);
        if (route) params.append('route', route);
        if (action) params.append('action', action);
        if (bottleneck) params.append('bottleneck', bottleneck);
        if (status) params.append('status', status);
        params.append('hours', hours);
        params.append('limit', '100');

        try {
            const response = await fetch(`/admin/api/performance/logs?${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            renderSystemLogsTable(data.logs);
        } catch (error) {
            console.error('Erro ao carregar logs:', error);
        }
    }

    function renderSystemLogsTable(logs) {
        const tbody = document.getElementById('logsTable');
        if (!logs || logs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">Nenhum log encontrado</td></tr>`;
            return;
        }

        tbody.innerHTML = logs.map(log => {
            const time = log.created_at ? formatTime(log.created_at) : '-';
            const bottleneckClass = getBottleneckClass(log.bottleneck);
            const statusClass = log.status === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            const systemClass = log.system_name === 'unknown' ? 'bg-gray-100 text-gray-500' : 'bg-indigo-100 text-indigo-800';

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-gray-500">${time}</td>
                    <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs ${systemClass}">${log.system_name || 'unknown'}</span></td>
                    <td class="px-3 py-2 font-mono text-gray-700 truncate max-w-xs" title="${log.route}">${log.route}</td>
                    <td class="px-3 py-2 text-gray-600">${log.action || '-'}</td>
                    <td class="px-3 py-2 font-medium">${Math.round(log.total_ms || 0)} ms</td>
                    <td class="px-3 py-2 ${log.llm_request_ms ? 'text-purple-600 font-medium' : 'text-gray-400'}">${log.llm_request_ms ? Math.round(log.llm_request_ms) : '-'}</td>
                    <td class="px-3 py-2 ${log.db_total_ms ? 'text-yellow-600 font-medium' : 'text-gray-400'}">${log.db_total_ms ? Math.round(log.db_total_ms) : '-'}</td>
                    <td class="px-3 py-2 ${log.json_parse_ms ? 'text-blue-600 font-medium' : 'text-gray-400'}">${log.json_parse_ms ? Math.round(log.json_parse_ms) : '-'}</td>
                    <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs ${bottleneckClass}">${log.bottleneck}</span></td>
                    <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs ${statusClass}">${log.status}</span></td>
                </tr>
            `;
        }).join('');
    }

    function getBottleneckClass(bottleneck) {
        switch(bottleneck) {
            case 'LLM': return 'bg-purple-100 text-purple-800';
            case 'DB': return 'bg-yellow-100 text-yellow-800';
            case 'PARSE': return 'bg-blue-100 text-blue-800';
            default: return 'bg-gray-100 text-gray-600';
        }
    }

    async function loadSystemActions() {
        try {
            const response = await fetch('/admin/api/performance/actions', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const select = document.getElementById('filterAction');
            select.innerHTML = '<option value="">Todas</option>' +
                data.actions.map(a => `<option value="${a}">${a}</option>`).join('');
        } catch (error) {
            console.error('Erro ao carregar actions:', error);
        }
    }

    function filterByBottleneck(type) {
        document.getElementById('filterBottleneck').value = type;
        loadSystemLogs();
    }

    function clearSystemFilters() {
        document.getElementById('filterSystem').value = '';
        document.getElementById('filterRoute').value = '';
        document.getElementById('filterAction').value = '';
        document.getElementById('filterBottleneck').value = '';
        document.getElementById('filterStatus').value = '';
        loadSystemLogs();
    }

    // ========================================
    // ROUTE SYSTEM MAPPING
    // ========================================

    function toggleRouteMapSection() {
        const section = document.getElementById('routeMapSection');
        const btn = document.getElementById('btnToggleRouteMap');
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Recolher';
            loadRouteMappings();
            loadTopRoutes();
        } else {
            section.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Expandir';
        }
    }

    async function loadRouteMappings() {
        try {
            const response = await fetch('/admin/api/performance/route-maps', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            renderRouteMappings(data.mappings || []);
        } catch (error) {
            console.error('Erro ao carregar mapeamentos:', error);
        }
    }

    function renderRouteMappings(mappings) {
        const container = document.getElementById('routeMappingsList');
        if (!mappings || mappings.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm">Nenhum mapeamento cadastrado</p>';
            return;
        }

        container.innerHTML = mappings.map(m => {
            const typeLabel = { exact: 'Exato', prefix: 'Prefixo', regex: 'Regex' }[m.match_type] || m.match_type;
            return `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 group">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-xs text-gray-600 truncate" title="${m.route_pattern}">${m.route_pattern}</span>
                            <span class="text-xs px-1 py-0.5 bg-gray-200 rounded">${typeLabel}</span>
                        </div>
                        <div class="text-sm font-medium text-indigo-600">${m.system_name}</div>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editRouteMap(${m.id}, '${m.route_pattern}', '${m.system_name}', '${m.match_type}')"
                            class="p-1 text-blue-600 hover:bg-blue-100 rounded" title="Editar">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button onclick="deleteRouteMap(${m.id})"
                            class="p-1 text-red-600 hover:bg-red-100 rounded" title="Remover">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadTopRoutes() {
        const hours = document.getElementById('filterHours').value;
        try {
            const response = await fetch(`/admin/api/performance/top-routes?hours=${hours}&limit=15`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            renderTopRoutes(data.routes || []);
        } catch (error) {
            console.error('Erro ao carregar rotas frequentes:', error);
        }
    }

    function renderTopRoutes(routes) {
        const container = document.getElementById('topRoutesList');
        // Filtra apenas rotas sem mapeamento
        const unmapped = routes.filter(r => !r.has_mapping);

        if (!unmapped || unmapped.length === 0) {
            container.innerHTML = '<p class="text-green-600 text-sm"><i class="fas fa-check mr-1"></i>Todas as rotas frequentes possuem mapeamento</p>';
            return;
        }

        container.innerHTML = unmapped.map(r => `
            <div class="flex items-center justify-between p-2 bg-yellow-50 rounded hover:bg-yellow-100">
                <div class="flex-1 min-w-0">
                    <div class="font-mono text-xs text-gray-600 truncate" title="${r.route}">${r.route}</div>
                    <div class="text-xs text-gray-500">${r.count} chamadas</div>
                </div>
                <button onclick="quickMapRoute('${r.route.replace(/'/g, "\\'")}')"
                    class="px-2 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    <i class="fas fa-plus mr-1"></i>Mapear
                </button>
            </div>
        `).join('');
    }

    function quickMapRoute(route) {
        document.getElementById('newRoutePattern').value = route;
        document.getElementById('newSystemName').focus();
    }

    async function createRouteMap() {
        const routePattern = document.getElementById('newRoutePattern').value.trim();
        const systemName = document.getElementById('newSystemName').value.trim();
        const matchType = document.getElementById('newMatchType').value;

        if (!routePattern || !systemName) {
            showNotification('Preencha o padrao da rota e o nome do sistema', 'error');
            return;
        }

        try {
            const response = await fetch('/admin/api/performance/route-maps', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    route_pattern: routePattern,
                    system_name: systemName,
                    match_type: matchType,
                    priority: 0
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao criar mapeamento');
            }

            showNotification('Mapeamento criado com sucesso', 'success');
            document.getElementById('newRoutePattern').value = '';
            document.getElementById('newSystemName').value = '';
            loadRouteMappings();
            loadTopRoutes();
            loadSystemFilters();
            loadSystemLogs();
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    function editRouteMap(id, pattern, name, matchType) {
        const newName = prompt('Novo nome do sistema:', name);
        if (newName && newName !== name) {
            updateRouteMap(id, { system_name: newName });
        }
    }

    async function updateRouteMap(id, data) {
        try {
            const response = await fetch(`/admin/api/performance/route-maps/${id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao atualizar mapeamento');
            }

            showNotification('Mapeamento atualizado', 'success');
            loadRouteMappings();
            loadSystemFilters();
            loadSystemLogs();
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function deleteRouteMap(id) {
        if (!confirm('Remover este mapeamento?')) return;

        try {
            const response = await fetch(`/admin/api/performance/route-maps/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao remover mapeamento');
            }

            showNotification('Mapeamento removido', 'success');
            loadRouteMappings();
            loadTopRoutes();
            loadSystemFilters();
            loadSystemLogs();
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function loadSystemFilters() {
        try {
            const response = await fetch('/admin/api/performance/systems', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const select = document.getElementById('filterSystem');
            select.innerHTML = '<option value="">Todos</option>' +
                (data.systems || []).map(s => `<option value="${s}">${s}</option>`).join('');
        } catch (error) {
            console.error('Erro ao carregar sistemas:', error);
        }
    }

    async function cleanupSystemLogs() {
        if (!confirm('Remover logs com mais de 7 dias?')) return;
        try {
            const response = await fetch('/admin/api/performance/cleanup?days=7', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            showNotification(`${data.deleted_count} logs removidos`, 'success');
            loadSystemSummary();
            loadSystemLogs();
        } catch (error) {
            showNotification('Erro ao limpar logs', 'error');
        }
    }

    // ========================================
    // GEMINI - API LOGS
    // ========================================

    async function loadGeminiSummary() {
        const hours = document.getElementById('geminiFilterHours').value;
        try {
            console.log('[Gemini] Carregando summary...', { hours, token: token ? 'presente' : 'ausente' });
            const response = await fetch(`/admin/api/gemini-logs/summary?hours=${hours}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('[Gemini] Erro na API:', response.status, errorText);
                showNotification(`Erro ao carregar dados Gemini: ${response.status}`, 'error');
                return;
            }

            const data = await response.json();
            console.log('[Gemini] Summary carregado:', data);
            const stats = data.stats || {};

            // Cards Linha 1 - Principais
            document.getElementById('gemini-total').textContent = data.total_calls || 0;
            document.getElementById('gemini-success-count').textContent = stats.success_count || 0;
            document.getElementById('gemini-error-count').textContent = stats.error_count || 0;

            document.getElementById('gemini-avg-latency').textContent = `${Math.round(stats.avg_latency_ms || 0)} ms`;
            document.getElementById('gemini-min-latency').textContent = `${Math.round(stats.min_latency_ms || 0)} ms`;
            document.getElementById('gemini-max-latency').textContent = `${Math.round(stats.max_latency_ms || 0)} ms`;

            document.getElementById('gemini-tokens-prompt').textContent = formatNumber(stats.total_prompt_tokens || 0);
            document.getElementById('gemini-tokens-response').textContent = `response: ${formatNumber(stats.total_response_tokens || 0)}`;

            document.getElementById('gemini-success-rate').textContent = `${stats.success_rate || 0}%`;
            document.getElementById('gemini-retries').textContent = `retries: ${stats.total_retries || 0}`;

            // Cards Linha 2 - Timing e Features
            document.getElementById('gemini-ttft').textContent = `${Math.round(stats.avg_ttft_ms || 0)} ms`;
            document.getElementById('gemini-generation').textContent = `${Math.round(stats.avg_generation_ms || 0)} ms`;
            document.getElementById('gemini-cache').textContent = stats.cache_hits || 0;
            document.getElementById('gemini-cache-rate').textContent = `taxa: ${stats.cache_rate || 0}%`;
            document.getElementById('gemini-images').textContent = stats.image_calls || 0;
            document.getElementById('gemini-search').textContent = stats.search_calls || 0;

            // Charts
            renderGeminiSistemaChart(data.by_sistema || []);
            renderGeminiModeloChart(data.by_model || []);

            // Slowest calls
            renderGeminiSlowest(data.slowest_calls || []);

            // Errors
            renderGeminiErrors(data.recent_errors || []);

        } catch (error) {
            console.error('Erro ao carregar resumo Gemini:', error);
        }
    }

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function renderGeminiSistemaChart(data) {
        const ctx = document.getElementById('chartGeminiSistema').getContext('2d');
        if (chartGeminiSistema) chartGeminiSistema.destroy();

        const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

        chartGeminiSistema = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.sistema || 'unknown'),
                datasets: [{
                    label: 'Chamadas',
                    data: data.map(d => d.count),
                    backgroundColor: colors.slice(0, data.length),
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function renderGeminiModeloChart(data) {
        const ctx = document.getElementById('chartGeminiModelo').getContext('2d');
        if (chartGeminiModelo) chartGeminiModelo.destroy();

        chartGeminiModelo = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.model || 'unknown'),
                datasets: [{
                    data: data.map(d => d.count),
                    backgroundColor: ['#8b5cf6', '#3b82f6', '#22c55e', '#f59e0b', '#ef4444'],
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderGeminiSlowest(calls) {
        const container = document.getElementById('gemini-slowest');
        if (!calls || calls.length === 0) {
            container.innerHTML = '<p class="text-gray-400">Sem dados</p>';
            return;
        }
        container.innerHTML = calls.slice(0, 6).map(call => `
            <div class="p-3 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-medium text-gray-800">${call.sistema || 'unknown'}</span>
                    <span class="text-sm font-bold text-red-600">${Math.round(call.time_total_ms)} ms</span>
                </div>
                <div class="text-xs text-gray-500">
                    <span>${call.model || '-'}</span>
                    ${call.error ? `<span class="text-red-500 ml-2">Erro</span>` : ''}
                </div>
            </div>
        `).join('');
    }

    function renderGeminiErrors(errors) {
        const container = document.getElementById('geminiRecentErrors');
        if (!errors || errors.length === 0) {
            container.innerHTML = '<p class="text-green-600 text-sm"><i class="fas fa-check mr-1"></i>Nenhum erro recente</p>';
            return;
        }
        container.innerHTML = errors.map(err => `
            <div class="p-2 bg-red-50 rounded text-sm">
                <div class="flex justify-between">
                    <span class="font-medium text-red-700">${err.sistema || 'unknown'}</span>
                    <span class="text-xs text-gray-500">${err.created_at ? formatTime(err.created_at) : ''}</span>
                </div>
                <div class="text-xs text-red-600 truncate" title="${err.error || ''}">${err.error || 'Erro desconhecido'}</div>
            </div>
        `).join('');
    }

    async function loadGeminiLogs() {
        const sistema = document.getElementById('geminiFilterSistema').value;
        const model = document.getElementById('geminiFilterModelo').value;
        const success = document.getElementById('geminiFilterSuccess').value;
        const hours = document.getElementById('geminiFilterHours').value;

        const params = new URLSearchParams();
        if (sistema) params.append('sistema', sistema);
        if (model) params.append('model', model);
        if (success) params.append('success', success);
        params.append('hours', hours);
        params.append('limit', '100');

        try {
            const response = await fetch(`/admin/api/gemini-logs?${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            renderGeminiLogsTable(data.logs);
        } catch (error) {
            console.error('Erro ao carregar logs Gemini:', error);
        }
    }

    function renderGeminiLogsTable(logs) {
        const tbody = document.getElementById('geminiLogsTable');
        if (!logs || logs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">Nenhum log encontrado</td></tr>`;
            return;
        }

        tbody.innerHTML = logs.map(log => {
            const time = log.created_at ? formatTime(log.created_at) : '-';
            const statusClass = log.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const cacheClass = log.cached ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-600';
            // Formata a rota para exibiÃ§Ã£o (trunca se muito longa)
            const route = log.route ? (log.route.length > 35 ? log.route.substring(0, 35) + '...' : log.route) : '-';
            const routeTitle = log.route || '';
            // Marca "unknown" em vermelho para facilitar identificaÃ§Ã£o
            const sistemaClass = (log.sistema === 'unknown' || !log.sistema) ? 'text-red-500' : 'text-gray-700';

            // Cor do badge de thinking level
            const thinkingLevel = log.thinking_level || '-';
            const thinkingClass = {
                'minimal': 'bg-gray-100 text-gray-600',
                'low': 'bg-blue-100 text-blue-700',
                'medium': 'bg-yellow-100 text-yellow-700',
                'high': 'bg-red-100 text-red-700'
            }[log.thinking_level] || 'text-gray-400';

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-gray-500">${time}</td>
                    <td class="px-3 py-2 font-medium ${sistemaClass}">${log.sistema || 'unknown'}</td>
                    <td class="px-3 py-2 text-gray-500 text-xs" title="${routeTitle}">${route}</td>
                    <td class="px-3 py-2 text-gray-600 text-xs">${log.model || '-'}</td>
                    <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${thinkingClass}">${thinkingLevel}</span></td>
                    <td class="px-3 py-2 text-gray-600">
                        <span class="text-purple-600">${log.prompt_tokens_estimated || '-'}</span> /
                        <span class="text-blue-600">${log.response_tokens || '-'}</span>
                    </td>
                    <td class="px-3 py-2 font-medium">${Math.round(log.time_total_ms || 0)} ms</td>
                    <td class="px-3 py-2 text-gray-500">${log.time_ttft_ms ? Math.round(log.time_ttft_ms) + ' ms' : '-'}</td>
                    <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs ${cacheClass}">${log.cached ? 'Sim' : 'Nao'}</span></td>
                    <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs ${statusClass}">${log.success ? 'OK' : 'Erro'}</span></td>
                    <td class="px-3 py-2 text-gray-500 text-xs">${log.username || '-'}</td>
                </tr>
            `;
        }).join('');
    }

    async function loadGeminiFilters() {
        try {
            // Load systems
            const systemsRes = await fetch('/admin/api/gemini-logs/systems', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const systemsData = await systemsRes.json();
            const sistemasSelect = document.getElementById('geminiFilterSistema');
            sistemasSelect.innerHTML = '<option value="">Todos</option>' +
                (systemsData.systems || []).map(s => `<option value="${s}">${s}</option>`).join('');

            // Load models
            const modelsRes = await fetch('/admin/api/gemini-logs/models', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const modelsData = await modelsRes.json();
            const modelosSelect = document.getElementById('geminiFilterModelo');
            modelosSelect.innerHTML = '<option value="">Todos</option>' +
                (modelsData.models || []).map(m => `<option value="${m}">${m}</option>`).join('');
        } catch (error) {
            console.error('Erro ao carregar filtros Gemini:', error);
        }
    }

    function clearGeminiFilters() {
        document.getElementById('geminiFilterSistema').value = '';
        document.getElementById('geminiFilterModelo').value = '';
        document.getElementById('geminiFilterSuccess').value = '';
        loadGeminiLogs();
    }

    async function cleanupGeminiLogs() {
        if (!confirm('Remover logs com mais de 30 dias?')) return;
        try {
            const response = await fetch('/admin/api/gemini-logs/cleanup?days=30', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            showNotification(`${data.deleted_count} logs removidos`, 'success');
            loadGeminiSummary();
            loadGeminiLogs();
        } catch (error) {
            showNotification('Erro ao limpar logs', 'error');
        }
    }

    // ========================================
    // LOGS AVANCADOS (REQUEST PERFORMANCE)
    // ========================================

    async function loadAdvancedSummary() {
        const hours = document.getElementById('advFilterHours').value;
        const sistema = document.getElementById('advFilterSistema').value;

        try {
            let url = `/admin/api/gemini-logs/request-perf/summary?hours=${hours}`;
            if (sistema) url += `&sistema=${sistema}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                console.error('Erro ao carregar summary avancado:', response.status);
                return;
            }

            const data = await response.json();

            // Cards principais
            document.getElementById('adv-total').textContent = data.total || 0;
            document.getElementById('adv-success').textContent = data.success_count || 0;
            document.getElementById('adv-error').textContent = data.error_count || 0;
            document.getElementById('adv-avg-total').textContent = formatMs(data.avg_total_ms);
            document.getElementById('adv-min-total').textContent = formatMs(data.min_total_ms);
            document.getElementById('adv-max-total').textContent = formatMs(data.max_total_ms);
            document.getElementById('adv-avg-ttft').textContent = formatMs(data.avg_ttft_ms);
            document.getElementById('adv-avg-gen').textContent = formatMs(data.avg_generation_ms);

            // Breakdown
            const bd = data.breakdown || {};
            document.getElementById('adv-agente1').textContent = formatMs(bd.agente1_ms);
            document.getElementById('adv-agente2').textContent = formatMs(bd.agente2_ms);
            document.getElementById('adv-prompt').textContent = formatMs(bd.prompt_build_ms);
            document.getElementById('adv-postproc').textContent = formatMs(bd.postprocess_ms);
            document.getElementById('adv-db').textContent = formatMs(bd.db_save_ms);
            document.getElementById('adv-overhead').textContent = formatMs(bd.overhead_ms);

            // Streaming
            const st = data.streaming || {};
            document.getElementById('adv-chunks').textContent = st.avg_chunks || '-';
            document.getElementById('adv-chunk-interval').textContent = st.avg_chunk_interval_ms ? `${st.avg_chunk_interval_ms}ms` : '-';

        } catch (error) {
            console.error('Erro ao carregar summary avancado:', error);
        }
    }

    async function loadAdvancedLogs() {
        const hours = document.getElementById('advFilterHours').value;
        const sistema = document.getElementById('advFilterSistema').value;
        const minMs = document.getElementById('advFilterMinMs').value;

        try {
            let url = `/admin/api/gemini-logs/request-perf?hours=${hours}&limit=50`;
            if (sistema) url += `&sistema=${sistema}`;
            if (minMs) url += `&min_total_ms=${minMs}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                document.getElementById('advLogsTable').innerHTML =
                    `<tr><td colspan="11" class="px-4 py-8 text-center text-red-500">Erro ao carregar logs</td></tr>`;
                return;
            }

            const data = await response.json();
            const logs = data.logs || [];

            if (logs.length === 0) {
                document.getElementById('advLogsTable').innerHTML =
                    `<tr><td colspan="11" class="px-4 py-8 text-center text-gray-500">Nenhum log encontrado</td></tr>`;
                return;
            }

            document.getElementById('advLogsTable').innerHTML = logs.map(log => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-xs whitespace-nowrap">${formatTime(log.created_at)}</td>
                    <td class="px-3 py-2 text-xs font-mono">${log.request_id || '-'}</td>
                    <td class="px-3 py-2 text-xs">${log.numero_cnj || '-'}</td>
                    <td class="px-3 py-2 text-xs">${log.tipo_peca || '-'}</td>
                    <td class="px-3 py-2 text-xs font-medium ${log.total_ms > 15000 ? 'text-red-600' : log.total_ms > 10000 ? 'text-orange-600' : ''}">${formatMs(log.total_ms)}</td>
                    <td class="px-3 py-2 text-xs">${formatMs(log.ttft_ms)}</td>
                    <td class="px-3 py-2 text-xs">${formatMs(log.agente1_ms)}</td>
                    <td class="px-3 py-2 text-xs">${formatMs(log.agente2_ms)}</td>
                    <td class="px-3 py-2 text-xs">${formatMs(log.generation_ms)}</td>
                    <td class="px-3 py-2 text-xs">${log.streaming_chunks || '-'}</td>
                    <td class="px-3 py-2 text-xs">
                        ${log.success
                            ? '<span class="text-green-600"><i class="fas fa-check"></i></span>'
                            : '<span class="text-red-600"><i class="fas fa-times"></i></span>'
                        }
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Erro ao carregar logs avancados:', error);
            document.getElementById('advLogsTable').innerHTML =
                `<tr><td colspan="11" class="px-4 py-8 text-center text-red-500">Erro: ${error.message}</td></tr>`;
        }
    }

    async function loadAdvancedSlowest() {
        const hours = document.getElementById('advFilterHours').value;
        const sistema = document.getElementById('advFilterSistema').value;

        try {
            let url = `/admin/api/gemini-logs/request-perf/slowest?hours=${hours}&limit=6`;
            if (sistema) url += `&sistema=${sistema}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) return;

            const data = await response.json();
            const slowest = data.slowest || [];

            if (slowest.length === 0) {
                document.getElementById('advSlowest').innerHTML =
                    '<p class="text-gray-500 text-sm col-span-full">Nenhum request encontrado</p>';
                return;
            }

            document.getElementById('advSlowest').innerHTML = slowest.map(log => `
                <div class="bg-gray-50 rounded-lg p-3 border-l-4 ${log.success ? 'border-orange-400' : 'border-red-400'}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-gray-500">${log.request_id}</span>
                        <span class="text-sm font-bold ${log.total_ms > 20000 ? 'text-red-600' : 'text-orange-600'}">${formatMs(log.total_ms)}</span>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        <p><strong>CNJ:</strong> ${log.numero_cnj || '-'}</p>
                        <p><strong>Tipo:</strong> ${log.tipo_peca || '-'}</p>
                        <p><strong>TTFT:</strong> ${formatMs(log.ttft_ms)} | <strong>Gen:</strong> ${formatMs(log.generation_ms)}</p>
                        <p><strong>Ag1:</strong> ${formatMs(log.agente1_ms)} | <strong>Ag2:</strong> ${formatMs(log.agente2_ms)}</p>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error('Erro ao carregar slowest:', error);
        }
    }

    function clearAdvancedFilters() {
        document.getElementById('advFilterSistema').value = '';
        document.getElementById('advFilterMinMs').value = '';
        loadAdvancedSummary();
        loadAdvancedLogs();
        loadAdvancedSlowest();
    }

    async function cleanupAdvancedLogs() {
        if (!confirm('Remover logs de performance com mais de 7 dias?')) return;
        try {
            const response = await fetch('/admin/api/gemini-logs/request-perf/cleanup?days=7', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            showNotification(`${data.deleted_count} logs removidos`, 'success');
            loadAdvancedSummary();
            loadAdvancedLogs();
            loadAdvancedSlowest();
        } catch (error) {
            showNotification('Erro ao limpar logs', 'error');
        }
    }

    function formatMs(ms) {
        if (ms === null || ms === undefined) return '-';
        if (ms >= 1000) return `${(ms/1000).toFixed(1)}s`;
        return `${Math.round(ms)}ms`;
    }

    // ========================================
    // UTILS
    // ========================================

    function showNotification(message, type) {
        const colors = { success: 'bg-green-500', error: 'bg-red-500' };
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // ========================================
    // INICIALIZACAO
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        // Load sistema tab data
        loadSystemSummary();
        loadSystemLogs();
        loadSystemActions();
        loadSystemFilters();

        // Pre-load Gemini filters
        loadGeminiFilters();

        // Auto-refresh a cada 30s
        setInterval(() => {
            if (document.getElementById('content-sistema').classList.contains('active')) {
                loadSystemSummary();
                loadSystemLogs();
            } else {
                loadGeminiSummary();
                loadGeminiLogs();
            }
        }, 30000);
    });
    </script>
</body>
</html>
