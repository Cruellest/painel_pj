<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs de Performance - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10 w-auto">
                    </a>
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="font-semibold text-gray-800">Logs de Performance</h1>
                        <p class="text-xs text-gray-500">Diagnostico de latencia e chamadas de IA</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Abas de Navegacao -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="border-b">
                <nav class="flex -mb-px">
                    <button onclick="switchTab('http')" id="tab-http"
                        class="tab-btn px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                        <i class="fas fa-server mr-2"></i>Performance HTTP
                    </button>
                    <button onclick="switchTab('gemini')" id="tab-gemini"
                        class="tab-btn px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-robot mr-2"></i>Chamadas Gemini
                    </button>
                </nav>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB: Performance HTTP                      -->
        <!-- ========================================== -->
        <div id="content-http" class="tab-content">
            <!-- Toggle de Ativacao -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">Coleta de Logs HTTP</h2>
                        <p class="text-gray-600 text-sm mt-1">
                            Quando ativado, registra tempos de resposta de todas as requisicoes do admin logado.
                        </p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="statusIndicator" class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                            <span class="text-sm text-gray-600">Carregando...</span>
                        </div>
                        <button id="toggleBtn" onclick="togglePerformanceLogs()" disabled
                            class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-300 transition-colors">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                        </button>
                    </div>
                </div>
                <div id="activeInfo" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
                    <p class="text-sm text-blue-800">
                        <span class="font-medium">Ativo para:</span>
                        <span id="activeUser">-</span>
                    </p>
                </div>
            </div>

            <!-- Estatisticas HTTP -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Total de Logs</h3>
                    <p id="totalLogs" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Tempo Medio (middleware)</h3>
                    <p id="avgTime" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Rota Mais Lenta</h3>
                    <p id="slowestRoute" class="text-lg font-bold text-gray-800 mt-1 truncate">-</p>
                </div>
            </div>

            <!-- Filtros HTTP -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Rota</label>
                        <input type="text" id="routeFilter" placeholder="/admin/api/..."
                            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Camada</label>
                        <select id="layerFilter" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Todas</option>
                            <option value="middleware">Middleware (Total)</option>
                            <option value="controller">Controller</option>
                            <option value="service">Service</option>
                            <option value="db">Banco de Dados</option>
                            <option value="io">I/O Filesystem</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                        <select id="hoursFilter" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">Ultima hora</option>
                            <option value="6">Ultimas 6 horas</option>
                            <option value="24" selected>Ultimas 24 horas</option>
                            <option value="72">Ultimos 3 dias</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadLogs()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            Filtrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Logs HTTP -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Logs Recentes</h2>
                    <button onclick="cleanupLogs()" class="text-sm text-red-600 hover:text-red-800">
                        Limpar logs antigos
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rota</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Camada</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acao</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duracao</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                    Carregando logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Resumo por Camada -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Resumo por Camada</h2>
                <div id="layerSummary" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="text-center text-gray-500">Carregando...</div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB: Chamadas Gemini                       -->
        <!-- ========================================== -->
        <div id="content-gemini" class="tab-content hidden">
            <!-- Cards de Estatisticas Gemini -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Total de Chamadas</h3>
                    <p id="geminiTotalCalls" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Latencia Media</h3>
                    <p id="geminiAvgLatency" class="text-2xl font-bold text-gray-800 mt-1">-</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Taxa de Sucesso</h3>
                    <p id="geminiSuccessRate" class="text-2xl font-bold text-green-600 mt-1">-</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-sm font-medium text-gray-500">Cache Hits</h3>
                    <p id="geminiCacheRate" class="text-2xl font-bold text-blue-600 mt-1">-</p>
                </div>
            </div>

            <!-- Graficos Gemini -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Grafico por Sistema -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Chamadas por Sistema</h3>
                    <canvas id="chartBySistema" height="200"></canvas>
                </div>
                <!-- Grafico por Modelo -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Chamadas por Modelo</h3>
                    <canvas id="chartByModel" height="200"></canvas>
                </div>
            </div>

            <!-- Filtros Gemini -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sistema</label>
                        <select id="geminiSistemaFilter" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                        <select id="geminiModelFilter" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="geminiSuccessFilter" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="true">Sucesso</option>
                            <option value="false">Erro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                        <select id="geminiHoursFilter" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="1">Ultima hora</option>
                            <option value="6">Ultimas 6 horas</option>
                            <option value="24" selected>Ultimas 24 horas</option>
                            <option value="72">Ultimos 3 dias</option>
                            <option value="168">Ultima semana</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadGeminiLogs()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">
                            Filtrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Logs Gemini -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Chamadas Recentes</h2>
                    <button onclick="cleanupGeminiLogs()" class="text-sm text-red-600 hover:text-red-800">
                        Limpar logs antigos
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sistema</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modelo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prompt</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tokens</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Latencia</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="geminiLogsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    Carregando logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chamadas mais lentas e Erros recentes -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Chamadas Mais Lentas</h3>
                    <div id="slowestCalls" class="space-y-2">
                        <p class="text-gray-500 text-sm">Carregando...</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-red-600 mb-4">Erros Recentes</h3>
                    <div id="recentErrors" class="space-y-2">
                        <p class="text-gray-500 text-sm">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
    const token = localStorage.getItem('token');
    let isEnabled = false;
    let chartBySistema = null;
    let chartByModel = null;

    // ========================================
    // FUNCOES DE NAVEGACAO
    // ========================================

    function switchTab(tab) {
        // Atualiza classes das abas
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('border-blue-500', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-gray-500');
        });
        document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
        document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-600');

        // Mostra/oculta conteudo
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`content-${tab}`).classList.remove('hidden');

        // Carrega dados da aba se necessario
        if (tab === 'gemini') {
            loadGeminiSummary();
            loadGeminiLogs();
            loadGeminiFilters();
        }
    }

    // ========================================
    // FUNCOES HTTP (Existentes)
    // ========================================

    async function loadToggleStatus() {
        try {
            const response = await fetch('/admin/performance/toggle', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            isEnabled = data.enabled;
            updateToggleUI(data);
        } catch (error) {
            console.error('Erro ao carregar status:', error);
        }
    }

    function updateToggleUI(data) {
        const btn = document.getElementById('toggleBtn');
        const indicator = document.getElementById('statusIndicator');
        const activeInfo = document.getElementById('activeInfo');
        const activeUser = document.getElementById('activeUser');

        btn.disabled = false;

        if (data.enabled) {
            btn.classList.remove('bg-gray-300');
            btn.classList.add('bg-green-500');
            btn.querySelector('span').classList.remove('translate-x-1');
            btn.querySelector('span').classList.add('translate-x-6');

            indicator.innerHTML = `
                <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-sm text-green-600 font-medium">Coletando logs</span>
            `;

            activeInfo.classList.remove('hidden');
            activeUser.textContent = data.admin_username || 'Admin';
        } else {
            btn.classList.remove('bg-green-500');
            btn.classList.add('bg-gray-300');
            btn.querySelector('span').classList.remove('translate-x-6');
            btn.querySelector('span').classList.add('translate-x-1');

            indicator.innerHTML = `
                <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                <span class="text-sm text-gray-600">Desativado</span>
            `;

            activeInfo.classList.add('hidden');
        }
    }

    async function togglePerformanceLogs() {
        const btn = document.getElementById('toggleBtn');
        btn.disabled = true;

        try {
            const response = await fetch('/admin/performance/toggle', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled: !isEnabled })
            });

            const data = await response.json();
            isEnabled = data.enabled;
            updateToggleUI(data);

            showNotification(data.message, 'success');
        } catch (error) {
            console.error('Erro ao alternar toggle:', error);
            showNotification('Erro ao alternar logs', 'error');
        } finally {
            btn.disabled = false;
        }
    }

    async function loadLogs() {
        const route = document.getElementById('routeFilter').value;
        const layer = document.getElementById('layerFilter').value;
        const hours = document.getElementById('hoursFilter').value;

        const params = new URLSearchParams();
        if (route) params.append('route', route);
        if (layer) params.append('layer', layer);
        params.append('hours', hours);
        params.append('limit', '100');

        try {
            const response = await fetch(`/admin/performance/logs?${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            renderLogsTable(data.logs);
        } catch (error) {
            console.error('Erro ao carregar logs:', error);
        }
    }

    function renderLogsTable(logs) {
        const tbody = document.getElementById('logsTable');

        if (!logs || logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        Nenhum log encontrado. Ative a coleta para comecar.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleTimeString('pt-BR');
            const durationClass = log.duration_ms > 1000 ? 'text-red-600 font-bold' :
                                 log.duration_ms > 500 ? 'text-yellow-600' : 'text-green-600';

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
                    <td class="px-4 py-3 text-sm font-mono text-gray-800 truncate max-w-xs" title="${log.route}">
                        <span class="text-gray-400 text-xs">${log.method}</span> ${log.route}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${getLayerClass(log.layer)}">
                            ${log.layer}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${log.action || '-'}</td>
                    <td class="px-4 py-3 text-sm ${durationClass}">${log.duration_ms.toFixed(1)} ms</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${log.status_code || '-'}</td>
                </tr>
            `;
        }).join('');
    }

    function getLayerClass(layer) {
        const classes = {
            'middleware': 'bg-purple-100 text-purple-800',
            'controller': 'bg-blue-100 text-blue-800',
            'service': 'bg-green-100 text-green-800',
            'db': 'bg-yellow-100 text-yellow-800',
            'io': 'bg-orange-100 text-orange-800'
        };
        return classes[layer] || 'bg-gray-100 text-gray-800';
    }

    async function loadSummary() {
        const hours = document.getElementById('hoursFilter').value;

        try {
            const response = await fetch(`/admin/performance/summary?hours=${hours}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            // Atualiza cards de estatisticas
            document.getElementById('totalLogs').textContent = data.total_logs.toLocaleString();

            const middlewareStats = data.layers.find(l => l.layer === 'middleware');
            if (middlewareStats) {
                document.getElementById('avgTime').textContent = `${middlewareStats.avg_ms.toFixed(0)} ms`;
            } else {
                document.getElementById('avgTime').textContent = '-';
            }

            if (data.slowest_routes && data.slowest_routes.length > 0) {
                const slowest = data.slowest_routes[0];
                document.getElementById('slowestRoute').textContent = `${slowest.route} (${slowest.avg_ms.toFixed(0)}ms)`;
            } else {
                document.getElementById('slowestRoute').textContent = '-';
            }

            // Renderiza resumo por camada
            renderLayerSummary(data.layers);

        } catch (error) {
            console.error('Erro ao carregar resumo:', error);
        }
    }

    function renderLayerSummary(layers) {
        const container = document.getElementById('layerSummary');

        if (!layers || layers.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 col-span-5">Sem dados</div>';
            return;
        }

        container.innerHTML = layers.map(layer => `
            <div class="p-3 rounded-lg ${getLayerBgClass(layer.layer)}">
                <h4 class="font-medium text-sm capitalize">${layer.layer}</h4>
                <p class="text-lg font-bold">${layer.avg_ms.toFixed(0)} ms</p>
                <p class="text-xs opacity-75">
                    min: ${layer.min_ms.toFixed(0)} | max: ${layer.max_ms.toFixed(0)}
                </p>
                <p class="text-xs opacity-75">${layer.count} registros</p>
            </div>
        `).join('');
    }

    function getLayerBgClass(layer) {
        const classes = {
            'middleware': 'bg-purple-50 text-purple-800',
            'controller': 'bg-blue-50 text-blue-800',
            'service': 'bg-green-50 text-green-800',
            'db': 'bg-yellow-50 text-yellow-800',
            'io': 'bg-orange-50 text-orange-800'
        };
        return classes[layer] || 'bg-gray-50 text-gray-800';
    }

    async function cleanupLogs() {
        if (!confirm('Remover logs com mais de 7 dias?')) return;

        try {
            const response = await fetch('/admin/performance/cleanup?days=7', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            showNotification(`${data.deleted_count} logs removidos`, 'success');
            loadLogs();
            loadSummary();
        } catch (error) {
            console.error('Erro ao limpar logs:', error);
            showNotification('Erro ao limpar logs', 'error');
        }
    }

    // ========================================
    // FUNCOES GEMINI (Novas)
    // ========================================

    async function loadGeminiFilters() {
        try {
            // Carrega sistemas
            const sistemasResp = await fetch('/admin/api/gemini-logs/systems', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const sistemasData = await sistemasResp.json();
            const sistemaSelect = document.getElementById('geminiSistemaFilter');
            sistemaSelect.innerHTML = '<option value="">Todos</option>' +
                sistemasData.systems.map(s => `<option value="${s}">${s}</option>`).join('');

            // Carrega modelos
            const modelsResp = await fetch('/admin/api/gemini-logs/models', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const modelsData = await modelsResp.json();
            const modelSelect = document.getElementById('geminiModelFilter');
            modelSelect.innerHTML = '<option value="">Todos</option>' +
                modelsData.models.map(m => `<option value="${m}">${m}</option>`).join('');
        } catch (error) {
            console.error('Erro ao carregar filtros Gemini:', error);
        }
    }

    async function loadGeminiSummary() {
        const hours = document.getElementById('geminiHoursFilter').value;

        try {
            const response = await fetch(`/admin/api/gemini-logs/summary?hours=${hours}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            // Atualiza cards
            document.getElementById('geminiTotalCalls').textContent = data.total_calls.toLocaleString();
            document.getElementById('geminiAvgLatency').textContent = `${data.stats.avg_latency_ms.toFixed(0)} ms`;
            document.getElementById('geminiSuccessRate').textContent = `${data.stats.success_rate}%`;
            document.getElementById('geminiCacheRate').textContent = `${data.stats.cache_hit_rate}%`;

            // Renderiza graficos
            renderGeminiCharts(data);

            // Chamadas mais lentas
            renderSlowestCalls(data.slowest_calls);

            // Erros recentes
            renderRecentErrors(data.recent_errors);

        } catch (error) {
            console.error('Erro ao carregar resumo Gemini:', error);
        }
    }

    function renderGeminiCharts(data) {
        // Grafico por Sistema
        const ctxSistema = document.getElementById('chartBySistema').getContext('2d');
        if (chartBySistema) chartBySistema.destroy();

        const sistemaLabels = data.by_sistema.map(s => s.sistema);
        const sistemaValues = data.by_sistema.map(s => s.count);
        const sistemaColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

        chartBySistema = new Chart(ctxSistema, {
            type: 'doughnut',
            data: {
                labels: sistemaLabels,
                datasets: [{
                    data: sistemaValues,
                    backgroundColor: sistemaColors.slice(0, sistemaLabels.length),
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });

        // Grafico por Modelo
        const ctxModel = document.getElementById('chartByModel').getContext('2d');
        if (chartByModel) chartByModel.destroy();

        const modelLabels = data.by_model.map(m => m.model.replace('gemini-', ''));
        const modelValues = data.by_model.map(m => m.count);

        chartByModel = new Chart(ctxModel, {
            type: 'bar',
            data: {
                labels: modelLabels,
                datasets: [{
                    label: 'Chamadas',
                    data: modelValues,
                    backgroundColor: '#8B5CF6',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function renderSlowestCalls(calls) {
        const container = document.getElementById('slowestCalls');
        if (!calls || calls.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma chamada registrada</p>';
            return;
        }

        container.innerHTML = calls.map(call => `
            <div class="p-2 bg-gray-50 rounded text-sm">
                <div class="flex justify-between">
                    <span class="font-medium">${call.sistema}</span>
                    <span class="text-red-600 font-bold">${call.time_total_ms.toFixed(0)} ms</span>
                </div>
                <div class="text-xs text-gray-500">${call.model} | ${call.prompt_chars} chars</div>
            </div>
        `).join('');
    }

    function renderRecentErrors(errors) {
        const container = document.getElementById('recentErrors');
        if (!errors || errors.length === 0) {
            container.innerHTML = '<p class="text-green-600 text-sm">Nenhum erro recente</p>';
            return;
        }

        container.innerHTML = errors.map(err => `
            <div class="p-2 bg-red-50 rounded text-sm">
                <div class="flex justify-between">
                    <span class="font-medium text-red-700">${err.sistema}</span>
                    <span class="text-xs text-gray-500">${new Date(err.created_at).toLocaleTimeString('pt-BR')}</span>
                </div>
                <div class="text-xs text-red-600 truncate" title="${err.error}">${err.error || 'Erro desconhecido'}</div>
            </div>
        `).join('');
    }

    async function loadGeminiLogs() {
        const sistema = document.getElementById('geminiSistemaFilter').value;
        const model = document.getElementById('geminiModelFilter').value;
        const success = document.getElementById('geminiSuccessFilter').value;
        const hours = document.getElementById('geminiHoursFilter').value;

        const params = new URLSearchParams();
        if (sistema) params.append('sistema', sistema);
        if (model) params.append('model', model);
        if (success) params.append('success', success);
        params.append('hours', hours);
        params.append('limit', '100');

        try {
            const response = await fetch(`/admin/api/gemini-logs?${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            renderGeminiLogsTable(data.logs);
        } catch (error) {
            console.error('Erro ao carregar logs Gemini:', error);
        }
    }

    function renderGeminiLogsTable(logs) {
        const tbody = document.getElementById('geminiLogsTable');

        if (!logs || logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        Nenhuma chamada registrada no periodo.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleTimeString('pt-BR');
            const latencyClass = log.time_total_ms > 5000 ? 'text-red-600 font-bold' :
                                log.time_total_ms > 2000 ? 'text-yellow-600' : 'text-green-600';
            const statusClass = log.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = log.success ? (log.cached ? 'Cache' : 'OK') : 'Erro';

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-500">${time}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${log.sistema}</td>
                    <td class="px-4 py-3 text-sm font-mono text-gray-600">${log.model.replace('gemini-', '')}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${log.prompt_chars.toLocaleString()} chars</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${log.response_tokens || '-'}</td>
                    <td class="px-4 py-3 text-sm ${latencyClass}">${log.time_total_ms.toFixed(0)} ms</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function cleanupGeminiLogs() {
        if (!confirm('Remover logs de Gemini com mais de 30 dias?')) return;

        try {
            const response = await fetch('/admin/api/gemini-logs/cleanup?days=30', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();

            showNotification(`${data.deleted_count} logs removidos`, 'success');
            loadGeminiSummary();
            loadGeminiLogs();
        } catch (error) {
            console.error('Erro ao limpar logs Gemini:', error);
            showNotification('Erro ao limpar logs', 'error');
        }
    }

    // ========================================
    // FUNCOES UTILITARIAS
    // ========================================

    function showNotification(message, type) {
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };

        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 3000);
    }

    // ========================================
    // INICIALIZACAO
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        // Carrega dados da aba HTTP
        loadToggleStatus();
        loadLogs();
        loadSummary();

        // Auto-refresh a cada 30 segundos se ativo
        setInterval(() => {
            if (isEnabled) {
                loadLogs();
                loadSummary();
            }
        }, 30000);
    });
    </script>
</body>
</html>
