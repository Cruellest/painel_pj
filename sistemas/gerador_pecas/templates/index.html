<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pe√ßas Jur√≠dicas - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Marked.js para renderizar markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        pge: {
                            blue: '#1e3a5f',
                            orange: '#e67e22'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos para o markdown renderizado - Estilo conversacional (n√£o Word) */
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 15px;
            line-height: 1.7;
            color: #374151;
        }

        .markdown-body h1 {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .markdown-body h2 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
            color: #1f2937;
        }

        .markdown-body h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #374151;
        }

        .markdown-body p {
            margin-bottom: 1em;
            text-align: left;
        }

        .markdown-body blockquote {
            margin: 1em 0;
            padding: 0.75em 1em;
            border-left: 4px solid #3b82f6;
            background: #eff6ff;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #1e40af;
        }

        .markdown-body blockquote p {
            margin-bottom: 0.5em;
        }

        .markdown-body blockquote p:last-child {
            margin-bottom: 0;
        }

        .markdown-body strong {
            font-weight: 600;
            color: #111827;
        }

        .markdown-body em {
            font-style: italic;
        }

        .markdown-body hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5em 0;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin: 1em 0;
            padding-left: 1.5em;
        }

        .markdown-body li {
            margin-bottom: 0.5em;
        }

        .markdown-body code {
            background: #f3f4f6;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .markdown-body pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
        }

        .markdown-body pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .markdown-body a {
            color: #2563eb;
            text-decoration: underline;
        }

        .markdown-body a:hover {
            color: #1d4ed8;
        }

        /* Chat bubble styles */
        .chat-bubble-user {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 18px 18px 4px 18px;
        }

        .chat-bubble-ai {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 18px 18px 18px 4px;
        }

        /* Anima√ß√£o de digita√ß√£o */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }

        /* Scrollbar estilizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Glassmorphism effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Pulse animation for loading */
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(14, 165, 233, 0);
            }
        }

        /* Estilos para Diff */
        .diff-line {
            padding: 2px 6px;
            border-radius: 3px;
            margin: 1px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .diff-added {
            background-color: #dcfce7;
            color: #166534;
            border-left: 3px solid #22c55e;
        }

        .diff-removed {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 3px solid #ef4444;
        }

        .diff-context {
            background-color: #f8fafc;
            color: #64748b;
        }

        /* Vers√£o ativa na lista */
        .versao-item {
            transition: all 0.2s;
        }

        .versao-item:hover {
            transform: translateX(4px);
        }

        .versao-item.active {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        /* Badge de vers√£o */
        .versao-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: 600;
        }

        .versao-badge-inicial {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1d4ed8;
        }

        .versao-badge-edicao {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .versao-badge-restauracao {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4338ca;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-sky-50">

    <!-- Header -->
    <header class="glass-effect shadow-sm border-b border-gray-200/50 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-10 w-auto">
                    </a>
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="font-semibold text-gray-800">Gerador de Pe√ßas Jur√≠dicas</h1>
                        <p class="text-xs text-gray-500">Assistente de IA para minutas</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="toggleHistorico()"
                        class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Hist√≥rico">
                        <i class="fas fa-history"></i>
                    </button>
                    <a href="/dashboard" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors">
                        <i class="fas fa-th-large mr-1"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Formul√°rio Principal -->
        <div class="bg-white rounded-2xl shadow-lg shadow-gray-200/50 border border-gray-100 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-magic text-white"></i>
                </div>
                Gerar Nova Pe√ßa Jur√≠dica
            </h2>

            <form id="form-processo" class="space-y-4">
                <!-- Sele√ß√£o de Modo de Entrada -->
                <div class="flex gap-2 p-1 bg-gray-100 rounded-xl">
                    <button type="button" id="btn-modo-cnj" onclick="app.setModoEntrada('cnj')"
                        class="flex-1 py-2.5 px-4 rounded-lg font-medium transition-all bg-white shadow text-primary-700">
                        <i class="fas fa-search mr-2"></i>Buscar por N√∫mero CNJ
                    </button>
                    <button type="button" id="btn-modo-pdf" onclick="app.setModoEntrada('pdf')"
                        class="flex-1 py-2.5 px-4 rounded-lg font-medium transition-all text-gray-500 hover:text-gray-700">
                        <i class="fas fa-file-pdf mr-2"></i>Anexar PDFs
                    </button>
                </div>

                <!-- Observa√ß√£o informativa -->
                <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                    <div class="flex gap-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-lightbulb text-amber-500 text-lg"></i>
                        </div>
                        <div class="text-sm text-amber-800">
                            <p class="font-medium mb-1">Dicas para melhor desempenho:</p>
                            <ul class="space-y-1 text-amber-700">
                                <li><i class="fas fa-clock mr-1 text-xs"></i> A busca por CNJ de processos em <strong>grau recursal</strong> (exceto Agravos de Instrumento) pode ser mais lenta. Para maior agilidade, prefira anexar os PDFs dos documentos relevantes.</li>
                                <li><i class="fas fa-bullseye mr-1 text-xs"></i> Recomendamos indicar o tipo de pe√ßa a ser gerada no campo abaixo, pois a detec√ß√£o manual √© mais assertiva do que a autom√°tica.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Modo CNJ -->
                <div id="modo-cnj" class="space-y-4">
                    <div>
                        <label for="numero-cnj" class="block text-sm font-medium text-gray-700 mb-2">
                            N√∫mero do Processo (CNJ)
                        </label>
                        <input type="text" id="numero-cnj" name="numero_cnj" placeholder="0000000-00.2024.8.12.0001"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all shadow-sm" />
                        <p class="text-xs text-gray-500 mt-1">Digite o n√∫mero completo do processo no formato CNJ</p>
                    </div>
                </div>

                <!-- Modo PDF -->
                <div id="modo-pdf" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Arquivos PDF
                        </label>
                        <div id="dropzone" 
                            class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary-400 hover:bg-primary-50/50 transition-all cursor-pointer"
                            onclick="document.getElementById('input-pdfs').click()"
                            ondragover="event.preventDefault(); this.classList.add('border-primary-500', 'bg-primary-50')"
                            ondragleave="this.classList.remove('border-primary-500', 'bg-primary-50')"
                            ondrop="app.handleDrop(event)">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">Arraste arquivos PDF aqui</p>
                            <p class="text-sm text-gray-400 mt-1">ou clique para selecionar</p>
                        </div>
                        <input type="file" id="input-pdfs" name="arquivos" accept=".pdf" multiple class="hidden"
                            onchange="app.handleFileSelect(event)" />
                    </div>
                    
                    <!-- Lista de arquivos selecionados -->
                    <div id="lista-arquivos" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Arquivos selecionados:</span>
                            <button type="button" onclick="app.limparArquivos()" class="text-xs text-red-500 hover:text-red-700">
                                <i class="fas fa-trash-alt mr-1"></i>Limpar todos
                            </button>
                        </div>
                        <div id="arquivos-lista" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>

                <div id="grupo-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Grupo de Conteudo
                    </label>
                    <select id="grupo-principal" name="group_id"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 transition-all shadow-sm">
                        <option value="">Carregando grupos...</option>
                    </select>
                    <p id="grupo-hint" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <div id="subgrupo-container" class="space-y-2 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Subgrupos de Conteudo <span class="text-gray-400 font-normal">(opcional)</span>
                    </label>
                    <div id="subgrupo-opcoes" class="flex flex-wrap gap-2"></div>
                    <p id="subgrupo-hint" class="text-xs text-gray-500"></p>
                </div>

                <div id="subcategoria-container" class="space-y-2 hidden">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700">
                            Assuntos <span class="text-gray-400 font-normal">(opcional)</span>
                        </label>
                        <button type="button" onclick="app.abrirModalNovaSubcategoria()"
                            class="text-xs text-primary-600 hover:text-primary-700 font-medium flex items-center gap-1">
                            <i class="fas fa-plus"></i> Novo Assunto
                        </button>
                    </div>
                    <div id="subcategoria-opcoes" class="flex flex-wrap gap-2"></div>
                    <p id="subcategoria-hint" class="text-xs text-gray-500"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Pe√ßa
                    </label>
                    <select id="tipo-peca" name="tipo_peca"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 transition-all shadow-sm">
                        <option value="">ü§ñ Detectar automaticamente (IA decide)</option>
                        <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
                    </select>
                    <p class="text-xs text-gray-500 mt-1">A IA analiza os documentos e decide qual pe√ßa gerar, ou selecione manualmente</p>
                </div>

                <!-- Campo de Observa√ß√µes do Usu√°rio -->
                <div>
                    <label for="observacao-usuario" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment-dots text-primary-500 mr-1"></i>
                        Observa√ß√µes para a IA <span class="text-gray-400 font-normal">(opcional)</span>
                    </label>
                    <textarea id="observacao-usuario" name="observacao_usuario" rows="3"
                        placeholder="Ex: Dar √™nfase na tese de prescri√ß√£o; Mencionar que o autor n√£o comprovou o dano; Incluir argumento sobre ilegitimidade passiva..."
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all shadow-sm resize-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Informe observa√ß√µes relevantes que a IA deve considerar ao gerar a pe√ßa (teses espec√≠ficas, pontos de destaque, argumentos importantes, etc.)
                    </p>
                </div>

                <button type="submit" id="btn-gerar"
                    class="w-full bg-gradient-to-r from-primary-600 to-primary-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-primary-700 hover:to-primary-800 transition-all flex items-center justify-center gap-2 shadow-lg shadow-primary-500/25">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    Gerar Pe√ßa com IA
                </button>
            </form>
        </div>

        <!-- Hist√≥rico Recente -->
        <div id="historico-recente" class="bg-white rounded-2xl shadow-lg shadow-gray-200/50 border border-gray-100 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-history text-white text-sm"></i>
                    </div>
                    Suas Pe√ßas Recentes
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="app.limparTodoHistorico()" 
                        class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                        title="Limpar todo hist√≥rico">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </button>
                    <button onclick="toggleHistorico()" class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                        Ver todas <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
            <div id="historico-cards" class="grid gap-3">
                <p class="text-gray-500 text-sm text-center py-4">Carregando hist√≥rico...</p>
            </div>
        </div>

    </main>

    <!-- Modal de Progresso da Gera√ß√£o -->
    <div id="modal-progresso"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-cog fa-spin text-white"></i>
                    </div>
                    Gerando Pe√ßa
                </h2>
                <button id="btn-cancelar-geracao" onclick="app.cancelarGeracao()"
                    class="px-4 py-2 border border-red-300 text-red-600 rounded-xl hover:bg-red-50 transition-colors text-sm font-medium">
                    <i class="fas fa-stop mr-1"></i> Cancelar
                </button>
            </div>

            <div class="mb-4">
                <p id="progresso-mensagem" class="text-sm text-gray-600">Iniciando processamento...</p>
            </div>

            <!-- Progresso dos Agentes -->
            <div id="agentes-progresso" class="space-y-3">
                <div id="agente1-status" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-100">
                    <div id="agente1-icon" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-download text-gray-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-700">Agente 1: Coletor TJ-MS</p>
                        <p class="text-xs text-gray-500">Baixando documentos do processo</p>
                    </div>
                    <span id="agente1-badge"
                        class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-500 font-medium">Aguardando</span>
                </div>

                <div id="agente2-status" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-100">
                    <div id="agente2-icon" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-brain text-gray-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-700">Agente 2: Detector Inteligente</p>
                        <p class="text-xs text-gray-500">Detectando tipo de pe√ßa e ativando prompts</p>
                    </div>
                    <span id="agente2-badge"
                        class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-500 font-medium">Aguardando</span>
                </div>

                <div id="agente3-status" class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 border border-gray-100">
                    <div id="agente3-icon" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-file-alt text-gray-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-700">Agente 3: Gerador</p>
                        <p class="text-xs text-gray-500">Gerando pe√ßa jur√≠dica final</p>
                    </div>
                    <span id="agente3-badge"
                        class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-500 font-medium">Aguardando</span>
                </div>
            </div>

            <!-- Barra de progresso geral -->
            <div class="mt-4">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progresso-barra" class="h-full bg-gradient-to-r from-primary-500 to-primary-600 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultado de Erro (Toast) -->
    <div id="toast-erro"
        class="hidden fixed bottom-4 right-4 bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 max-w-lg animate-pulse">
        <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-2xl mt-0.5 text-yellow-300"></i>
            <div class="flex-1">
                <p class="font-bold text-lg">Erro ao processar</p>
                <p id="erro-mensagem" class="text-sm opacity-95 mt-1 whitespace-pre-line"></p>
                <p class="text-xs opacity-70 mt-2">
                    <i class="fas fa-lightbulb mr-1"></i>
                    Dica: Se o problema persistir, tente reduzir o tamanho das observa√ß√µes ou anexar menos documentos.
                </p>
            </div>
            <button onclick="document.getElementById('toast-erro').classList.add('hidden')" class="ml-2 opacity-70 hover:opacity-100 p-1">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
    </div>

        <!-- Painel Lateral de Hist√≥rico -->
        <div id="painel-historico"
            class="hidden fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-semibold text-gray-800">Hist√≥rico</h3>
                <div class="flex items-center gap-2">
                    <button onclick="app.limparTodoHistorico()"
                        class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                        title="Limpar todo hist√≥rico">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button onclick="toggleHistorico()"
                        class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="lista-historico" class="p-4 overflow-y-auto custom-scrollbar" style="height: calc(100vh - 60px);">
                <p class="text-gray-500 text-sm text-center py-8">Carregando...</p>
            </div>
        </div>

    </main>

    <!-- Modal de Pergunta -->
    <div id="modal-pergunta"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-question text-white"></i>
                </div>
                Informa√ß√£o Necess√°ria
            </h2>
            <p id="pergunta-texto" class="text-gray-700 mb-6"></p>

            <div id="opcoes-container" class="space-y-2 mb-6"></div>

            <textarea id="resposta-usuario" placeholder="Ou digite sua resposta aqui..."
                class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-primary-500 shadow-sm"
                rows="3"></textarea>

            <div class="flex justify-end gap-3">
                <button id="btn-cancelar-pergunta"
                    class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                    Cancelar
                </button>
                <button id="btn-enviar-resposta"
                    class="px-6 py-2.5 bg-gradient-to-r from-primary-600 to-primary-700 text-white rounded-xl hover:from-primary-700 hover:to-primary-800 transition-colors font-medium shadow-lg shadow-primary-500/25">
                    Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Editor de Minuta (NOVO DESIGN) -->
    <div id="modal-editor"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl max-w-7xl w-full mx-4 h-[90vh] flex flex-col shadow-2xl overflow-hidden">

            <!-- Header do Modal -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-slate-50 to-white">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-file-alt text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Editor de Minuta</h2>
                        <p class="text-xs text-gray-500">
                            <span id="editor-tipo-peca">Contesta√ß√£o</span>
                            <span id="editor-cnj" class="ml-2 text-gray-400"></span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-historico-versoes" onclick="app.toggleHistoricoVersoes()"
                        class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl hover:from-indigo-600 hover:to-indigo-700 transition-all flex items-center gap-2 text-sm font-medium shadow-lg shadow-indigo-500/25">
                        <i class="fas fa-code-branch"></i>
                        Vers√µes
                        <span id="versoes-count" class="hidden bg-white/20 px-1.5 py-0.5 rounded text-xs">0</span>
                    </button>
                    <button id="btn-acessar-autos" onclick="app.abrirAutos()"
                        class="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all flex items-center gap-2 text-sm font-medium shadow-lg shadow-amber-500/25">
                        <i class="fas fa-folder-open"></i>
                        Acessar Autos
                    </button>
                    <button id="btn-download-docx" onclick="app.downloadDocx()"
                        class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all flex items-center gap-2 text-sm font-medium shadow-lg shadow-purple-500/25">
                        <i class="fas fa-file-word"></i>
                        Baixar DOCX
                    </button>
                    <button id="btn-copiar-minuta"
                        class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl hover:from-emerald-600 hover:to-emerald-700 transition-all flex items-center gap-2 text-sm font-medium shadow-lg shadow-emerald-500/25">
                        <i class="fas fa-copy"></i>
                        Copiar Minuta
                    </button>
                    <button onclick="fecharModalEditor()"
                        class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Conte√∫do Principal -->
            <div class="flex-1 flex overflow-hidden">

                <!-- Painel de Visualiza√ß√£o da Minuta -->
                <div class="flex-1 flex flex-col bg-gray-50 border-r border-gray-100">
                    <div class="px-4 py-2 border-b border-gray-100 bg-white flex items-center justify-between">
                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <i class="fas fa-eye mr-1"></i> Visualiza√ß√£o
                        </span>
                        <span id="minuta-status" class="text-xs text-gray-400">
                            Atualizado agora
                        </span>
                    </div>
                    <div id="minuta-container" class="flex-1 overflow-y-auto custom-scrollbar p-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 min-h-full">
                            <div id="minuta-content" class="markdown-body">
                                <!-- Conte√∫do da minuta ser√° inserido aqui -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Chat -->
                <div class="w-96 flex flex-col bg-white">
                    <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-primary-50 to-sky-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-comments text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">Assistente de Edi√ß√£o</p>
                                    <p class="text-xs text-gray-500">Pe√ßa altera√ß√µes na minuta</p>
                                </div>
                            </div>
                            <button onclick="app.limparTodoHistoricoChat()" 
                                class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                title="Limpar todo hist√≥rico do chat">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Mensagens do Chat -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
                        <!-- Mensagem inicial do assistente -->
                        <div class="flex gap-3">
                            <div
                                class="w-8 h-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-white text-xs"></i>
                            </div>
                            <div class="chat-bubble-ai px-4 py-3 max-w-[85%]">
                                <p class="text-sm text-gray-700">
                                    Ol√°! Sou o assistente de edi√ß√£o. Voc√™ pode me pedir para fazer altera√ß√µes na minuta,
                                    como:
                                </p>
                                <ul class="text-xs text-gray-500 mt-2 space-y-1">
                                    <li>‚Ä¢ "Adicione um argumento sobre prescri√ß√£o"</li>
                                    <li>‚Ä¢ "Mude o tom do item II para ser mais assertivo"</li>
                                    <li>‚Ä¢ "Inclua jurisprud√™ncia do STJ"</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Input do Chat -->
                    <div class="p-4 border-t border-gray-100 bg-gray-50">
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" placeholder="Pe√ßa uma altera√ß√£o na minuta..."
                                class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm shadow-sm" />
                            <button id="btn-enviar-chat"
                                class="px-4 py-3 bg-gradient-to-r from-primary-600 to-primary-700 text-white rounded-xl hover:from-primary-700 hover:to-primary-800 transition-all shadow-lg shadow-primary-500/25">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-center">
                            Enter para enviar ‚Ä¢ Usando o mesmo modelo de IA
                        </p>
                    </div>
                </div>

                <!-- Painel de Hist√≥rico de Vers√µes (inicialmente oculto) -->
                <div id="painel-versoes" class="hidden w-80 flex flex-col bg-white border-l border-gray-100">
                    <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-indigo-50 to-purple-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-code-branch text-white text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">Hist√≥rico de Vers√µes</p>
                                    <p class="text-xs text-gray-500">Evolu√ß√£o do texto</p>
                                </div>
                            </div>
                            <button onclick="app.toggleHistoricoVersoes()"
                                class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Vers√µes -->
                    <div id="versoes-lista" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p class="text-sm">Carregando vers√µes...</p>
                        </div>
                    </div>

                    <!-- Painel de Detalhes da Vers√£o (aparece ao clicar) -->
                    <div id="versao-detalhe" class="hidden border-t border-gray-100">
                        <div class="px-4 py-3 bg-gray-50 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <i class="fas fa-code-compare mr-1"></i> Altera√ß√µes
                                </span>
                                <button onclick="app.fecharDetalheVersao()"
                                    class="text-xs text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="versao-diff" class="p-4 max-h-64 overflow-y-auto custom-scrollbar text-xs font-mono">
                            <!-- Diff ser√° inserido aqui -->
                        </div>
                        <div class="p-3 border-t border-gray-100 flex gap-2">
                            <button onclick="app.restaurarVersaoSelecionada()"
                                class="flex-1 px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-xs font-medium">
                                <i class="fas fa-undo mr-1"></i> Restaurar
                            </button>
                            <button onclick="app.verConteudoVersao()"
                                class="flex-1 px-3 py-2 border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors text-xs font-medium">
                                <i class="fas fa-eye mr-1"></i> Ver Completo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Feedback -->
    <div id="modal-feedback"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center">
                    <i class="fas fa-star text-white"></i>
                </div>
                Como foi a experi√™ncia?
            </h2>
            <p class="text-gray-500 mb-6">Seu feedback nos ajuda a melhorar o sistema</p>

            <!-- Estrelas -->
            <div class="flex justify-center gap-2 mb-6">
                <button class="estrela text-4xl text-gray-300 hover:text-yellow-400 transition-colors"
                    data-nota="1">ÔøΩ
</button>
                <button class="estrela text-4xl text-gray-300 hover:text-yellow-400 transition-colors"
                    data-nota="2">ÔøΩ
</button>
                <button class="estrela text-4xl text-gray-300 hover:text-yellow-400 transition-colors"
                    data-nota="3">ÔøΩ
</button>
                <button class="estrela text-4xl text-gray-300 hover:text-yellow-400 transition-colors"
                    data-nota="4">ÔøΩ
</button>
                <button class="estrela text-4xl text-gray-300 hover:text-yellow-400 transition-colors"
                    data-nota="5">ÔøΩ
</button>
            </div>

            <textarea id="feedback-comentario" placeholder="Coment√°rios adicionais (opcional)"
                class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-primary-500 shadow-sm"
                rows="3"></textarea>

            <div class="flex justify-end gap-3">
                <button id="btn-pular-feedback"
                    class="px-6 py-2.5 text-gray-600 hover:text-gray-800 transition-colors font-medium">
                    Pular
                </button>
                <button id="btn-enviar-feedback"
                    class="px-6 py-2.5 bg-gradient-to-r from-primary-600 to-primary-700 text-white rounded-xl hover:from-primary-700 hover:to-primary-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-lg shadow-primary-500/25"
                    disabled>
                    Enviar Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-4 right-4 z-50">
        <div class="bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3">
            <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
            <span id="toast-message">Mensagem</span>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o de Vers√£o -->
    <div id="modal-versao-completa"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60]">
        <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-indigo-50 to-purple-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock-rotate-left text-white"></i>
                    </div>
                    <div>
                        <h2 id="modal-versao-titulo" class="text-lg font-bold text-gray-800">Vers√£o 1</h2>
                        <p id="modal-versao-data" class="text-xs text-gray-500">Criado em...</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.restaurarVersaoDoModal()"
                        class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl hover:from-indigo-600 hover:to-indigo-700 transition-all flex items-center gap-2 text-sm font-medium">
                        <i class="fas fa-undo"></i>
                        Restaurar esta vers√£o
                    </button>
                    <button onclick="app.fecharModalVersao()"
                        class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Conte√∫do -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <div class="bg-gray-50 rounded-xl border border-gray-100 p-6">
                    <div id="modal-versao-conteudo" class="markdown-body">
                        <!-- Conte√∫do da vers√£o ser√° inserido aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gerenciar Assuntos -->
    <div id="modal-subcategoria"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-tags text-white"></i>
                </div>
                <span id="modal-subcategoria-titulo">Novo Assunto</span>
            </h2>

            <form id="form-subcategoria" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                    <input type="text" id="subcategoria-nome" required
                        placeholder="Ex: Servidor Publico, Fazendario..."
                        class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Slug (identificador)</label>
                    <input type="text" id="subcategoria-slug" required
                        placeholder="Ex: servidor_publico, fazendario..."
                        class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent" />
                    <p class="text-xs text-gray-400 mt-1">Identificador unico, sem espacos ou acentos</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descricao <span class="text-gray-400">(opcional)</span></label>
                    <input type="text" id="subcategoria-descricao"
                        placeholder="Descricao breve..."
                        class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent" />
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="app.fecharModalSubcategoria()"
                        class="flex-1 px-4 py-2 border border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all">
                        Salvar
                    </button>
                </div>
            </form>

            <!-- Lista de assuntos existentes -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Assuntos Existentes</h3>
                <div id="lista-subcategorias-modal" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                    <p class="text-gray-400 text-sm">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>

</html>
