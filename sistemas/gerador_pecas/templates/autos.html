<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autos do Processo - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- PDF.js para renderizar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        pge: {
                            blue: '#1e3a5f',
                            orange: '#e67e22'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar estilizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Glassmorphism effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Documento selecionado */
        .doc-item.selected {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .doc-item.selected .doc-date {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* PDF container */
        #pdf-container {
            background: #525659;
        }

        #pdf-container canvas {
            display: block;
            margin: 0 auto 20px auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="min-h-screen bg-slate-100">

    <!-- Header -->
    <header class="glass-effect shadow-sm border-b border-gray-200/50 sticky top-0 z-40">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">
                <div class="flex items-center gap-4">
                    <button onclick="window.close()" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-8 w-auto">
                        <div class="border-l border-gray-300 pl-3">
                            <h1 class="font-semibold text-gray-800 text-sm">Autos do Processo</h1>
                            <p id="header-cnj" class="text-xs text-gray-500 font-mono">Carregando...</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <span id="doc-counter" class="text-xs text-gray-500"></span>
                    <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                        <button onclick="zoomOut()" class="p-2 hover:bg-white rounded transition-colors"
                            title="Diminuir zoom">
                            <i class="fas fa-minus text-gray-600 text-sm"></i>
                        </button>
                        <span id="zoom-level" class="text-xs text-gray-600 w-12 text-center">100%</span>
                        <button onclick="zoomIn()" class="p-2 hover:bg-white rounded transition-colors"
                            title="Aumentar zoom">
                            <i class="fas fa-plus text-gray-600 text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex h-[calc(100vh-56px)]">

        <!-- Sidebar: Lista de Documentos -->
        <aside id="sidebar"
            class="w-72 bg-white border-r border-gray-200 flex flex-col overflow-hidden flex-shrink-0">

            <!-- Header da sidebar -->
            <div class="p-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800 text-sm">Documentos</h2>
                    <span id="total-docs" class="text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">
                        ...
                    </span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Ordenados cronologicamente</p>
            </div>

            <!-- Lista de documentos -->
            <div id="docs-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
                <!-- Skeleton loading -->
                <div class="skeleton h-16 rounded-lg mb-2"></div>
                <div class="skeleton h-16 rounded-lg mb-2"></div>
                <div class="skeleton h-16 rounded-lg mb-2"></div>
                <div class="skeleton h-16 rounded-lg mb-2"></div>
                <div class="skeleton h-16 rounded-lg mb-2"></div>
            </div>
        </aside>

        <!-- PDF Viewer -->
        <main class="flex-1 flex flex-col bg-slate-200 overflow-hidden">

            <!-- Toolbar do documento atual -->
            <div id="doc-toolbar"
                class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between hidden">
                <div class="flex items-center gap-3 min-w-0">
                    <span id="current-doc-order" class="bg-primary-100 text-primary-700 text-xs font-bold px-2 py-1 rounded">
                        1
                    </span>
                    <div class="min-w-0">
                        <p id="current-doc-title" class="text-sm font-medium text-gray-800 truncate">
                            Documento
                        </p>
                        <p id="current-doc-date" class="text-xs text-gray-500">
                            Data
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="prevDoc()" id="btn-prev"
                        class="p-2 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
                        title="Documento anterior">
                        <i class="fas fa-chevron-left text-gray-600"></i>
                    </button>
                    <button onclick="nextDoc()" id="btn-next"
                        class="p-2 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
                        title="Próximo documento">
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </button>
                    <div class="w-px h-6 bg-gray-200 mx-1"></div>
                    <a id="btn-download" href="#" target="_blank"
                        class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Abrir em nova aba">
                        <i class="fas fa-external-link-alt text-gray-600"></i>
                    </a>
                </div>
            </div>

            <!-- Container do PDF -->
            <div id="pdf-container" class="flex-1 overflow-auto p-4">
                <!-- Estado inicial -->
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400">
                    <i class="fas fa-file-pdf text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg">Selecione um documento para visualizar</p>
                    <p class="text-sm mt-1">Os documentos estão ordenados cronologicamente</p>
                </div>

                <!-- Loading -->
                <div id="pdf-loading" class="hidden h-full flex items-center justify-center">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-4xl text-primary-500 mb-4"></i>
                        <p class="text-gray-600">Carregando documento...</p>
                    </div>
                </div>

                <!-- Erro -->
                <div id="pdf-error" class="hidden h-full flex flex-col items-center justify-center text-red-500">
                    <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                    <p class="text-lg">Erro ao carregar documento</p>
                    <p id="pdf-error-msg" class="text-sm mt-1 text-gray-500"></p>
                    <button onclick="retryLoad()" class="mt-4 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                        Tentar novamente
                    </button>
                </div>

                <!-- Canvas do PDF -->
                <div id="pdf-pages"></div>
            </div>
        </main>
    </div>

    <script>
        // Configuração do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Estado da aplicação
        let state = {
            numeroCnj: null,
            token: null,
            documentos: [],
            documentoAtual: null,
            indiceAtual: -1,
            zoom: 1.0,
            pdfDoc: null
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Extrai parâmetros da URL
            const urlParams = new URLSearchParams(window.location.search);
            state.numeroCnj = urlParams.get('cnj');
            state.token = urlParams.get('token') || localStorage.getItem('access_token');

            if (!state.numeroCnj) {
                showError('Número do processo não informado');
                return;
            }

            if (!state.token) {
                window.location.href = '/login';
                return;
            }

            document.getElementById('header-cnj').textContent = state.numeroCnj;
            carregarDocumentos();
        });

        async function carregarDocumentos() {
            try {
                const response = await fetch(
                    `/gerador-pecas/api/autos/${encodeURIComponent(state.numeroCnj)}?token=${state.token}`
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao carregar documentos');
                }

                const data = await response.json();
                state.documentos = data.documentos;

                document.getElementById('total-docs').textContent = data.total_documentos;
                document.getElementById('doc-counter').textContent = `${data.total_documentos} documentos`;

                renderizarListaDocumentos();

                // Se veio com doc_id na URL, abre automaticamente
                const urlParams = new URLSearchParams(window.location.search);
                const docId = urlParams.get('doc_id');
                if (docId) {
                    const idx = state.documentos.findIndex(d => d.id === docId);
                    if (idx >= 0) {
                        selecionarDocumento(idx);
                    }
                }

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('docs-list').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderizarListaDocumentos() {
            const container = document.getElementById('docs-list');
            container.innerHTML = '';

            state.documentos.forEach((doc, index) => {
                const div = document.createElement('div');
                div.className = 'doc-item p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition-all border border-transparent hover:border-gray-200';
                div.onclick = () => selecionarDocumento(index);

                // Indicador de documento multi-parte
                const partesIndicator = doc.total_partes > 1 
                    ? `<span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded-full ml-1" title="${doc.total_partes} partes">${doc.total_partes}p</span>` 
                    : '';
                
                // Indicador se descrição veio da IA (diferente da original)
                const iaIndicator = doc.descricao_original && doc.descricao !== doc.descricao_original
                    ? `<i class="fas fa-robot text-[10px] text-purple-400 ml-1" title="Identificado pela IA (original: ${doc.descricao_original})"></i>`
                    : '';

                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded flex-shrink-0">
                            ${doc.ordem}
                        </span>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-800 truncate" title="${doc.descricao}${doc.descricao_original ? ' (Original: ' + doc.descricao_original + ')' : ''}">
                                ${doc.descricao}${iaIndicator}${partesIndicator}
                            </p>
                            <p class="doc-date text-xs text-gray-500 mt-0.5">
                                ${doc.data_formatada}
                            </p>
                        </div>
                    </div>
                `;

                container.appendChild(div);
            });
        }

        async function selecionarDocumento(index) {
            if (index < 0 || index >= state.documentos.length) return;

            // Atualiza seleção visual
            document.querySelectorAll('.doc-item').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });

            state.indiceAtual = index;
            state.documentoAtual = state.documentos[index];

            // Atualiza toolbar
            document.getElementById('doc-toolbar').classList.remove('hidden');
            document.getElementById('current-doc-order').textContent = state.documentoAtual.ordem;
            document.getElementById('current-doc-title').textContent = state.documentoAtual.descricao;
            document.getElementById('current-doc-date').textContent = state.documentoAtual.data_formatada;

            // Atualiza botões prev/next
            document.getElementById('btn-prev').disabled = index === 0;
            document.getElementById('btn-next').disabled = index === state.documentos.length - 1;

            // Monta URL com todos os IDs (para merge de PDFs)
            const ids = state.documentoAtual.ids || [state.documentoAtual.id];
            const idsParam = ids.length > 1 ? `&ids=${encodeURIComponent(ids.join(','))}` : '';
            const downloadUrl = `/gerador-pecas/api/autos/${encodeURIComponent(state.numeroCnj)}/documento/${state.documentoAtual.id}?token=${state.token}${idsParam}`;
            document.getElementById('btn-download').href = downloadUrl;

            // Carrega o PDF (passando IDs para merge)
            await carregarPDF(state.documentoAtual.id, ids);
        }

        async function carregarPDF(docId, ids = null) {
            const container = document.getElementById('pdf-pages');
            const loading = document.getElementById('pdf-loading');
            const error = document.getElementById('pdf-error');
            const empty = document.getElementById('empty-state');

            // Estados
            container.innerHTML = '';
            empty.classList.add('hidden');
            error.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                // Monta URL com IDs para merge se necessário
                const idsParam = ids && ids.length > 1 ? `&ids=${encodeURIComponent(ids.join(','))}` : '';
                const url = `/gerador-pecas/api/autos/${encodeURIComponent(state.numeroCnj)}/documento/${docId}?token=${state.token}${idsParam}`;

                const loadingTask = pdfjsLib.getDocument(url);
                state.pdfDoc = await loadingTask.promise;

                loading.classList.add('hidden');

                // Renderiza todas as páginas
                for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
                    await renderizarPagina(pageNum);
                }

            } catch (err) {
                console.error('Erro ao carregar PDF:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                document.getElementById('pdf-error-msg').textContent = err.message;
            }
        }

        async function renderizarPagina(pageNum) {
            const page = await state.pdfDoc.getPage(pageNum);
            const scale = state.zoom * 1.5; // Escala base
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;

            document.getElementById('pdf-pages').appendChild(canvas);
        }

        async function reRenderPDF() {
            if (!state.pdfDoc) return;

            const container = document.getElementById('pdf-pages');
            container.innerHTML = '';

            for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
                await renderizarPagina(pageNum);
            }
        }

        function zoomIn() {
            if (state.zoom < 2.5) {
                state.zoom += 0.25;
                document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
                reRenderPDF();
            }
        }

        function zoomOut() {
            if (state.zoom > 0.5) {
                state.zoom -= 0.25;
                document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
                reRenderPDF();
            }
        }

        function prevDoc() {
            if (state.indiceAtual > 0) {
                selecionarDocumento(state.indiceAtual - 1);
            }
        }

        function nextDoc() {
            if (state.indiceAtual < state.documentos.length - 1) {
                selecionarDocumento(state.indiceAtual + 1);
            }
        }

        function retryLoad() {
            if (state.documentoAtual) {
                const ids = state.documentoAtual.ids || [state.documentoAtual.id];
                carregarPDF(state.documentoAtual.id, ids);
            }
        }

        function showError(msg) {
            document.getElementById('docs-list').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p class="text-sm">${msg}</p>
                </div>
            `;
        }

        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                prevDoc();
            } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                nextDoc();
            } else if (e.key === '+' || e.key === '=') {
                zoomIn();
            } else if (e.key === '-') {
                zoomOut();
            }
        });
    </script>

</body>

</html>
