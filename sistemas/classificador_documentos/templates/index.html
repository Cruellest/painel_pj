<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classificador de Documentos - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- PDF.js para renderizacao de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        pge: {
                            blue: '#1e3a5f',
                            orange: '#e67e22'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .confianca-alta {
            background-color: #dcfce7;
            color: #166534;
        }

        .confianca-media {
            background-color: #fef9c3;
            color: #854d0e;
        }

        .confianca-baixa {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-pendente {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .status-processando {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-concluido {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-erro {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-travado {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">

    <!-- Header (Padrao PGE conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 7) -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo OFICIAL PGE -->
                <div class="flex items-center gap-3">
                    <a href="/dashboard">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-12 w-auto">
                    </a>
                    <span class="text-lg font-semibold text-gray-700">Classificador de Documentos</span>
                </div>
                <!-- Menu usuario -->
                <div class="flex items-center gap-4">
                    <div id="apiStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm">
                        <i class="fas fa-circle text-gray-400 text-xs"></i>
                        <span class="text-gray-500">Verificando API...</span>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700 transition-colors" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs (Renomeado conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 2.2) -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div class="border-b border-gray-200">
            <nav class="flex gap-8">
                <button onclick="showTab('novoLote')" id="tab-novoLote" class="py-3 px-1 text-sm font-medium tab-active">
                    <i class="fas fa-plus-circle mr-2"></i>Novo Lote
                </button>
                <button onclick="showTab('meusLotes')" id="tab-meusLotes" class="py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-folder-open mr-2"></i>Meus Lotes
                </button>
                <button onclick="showTab('prompts')" id="tab-prompts" class="py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-comment-dots mr-2"></i>Prompts
                </button>
                <button onclick="showTab('testeRapido')" id="tab-testeRapido" class="py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bolt mr-2"></i>Teste Rapido
                </button>
            </nav>
        </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Tab: Novo Lote (conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 5) -->
        <div id="content-novoLote" class="tab-content">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>Criar Novo Lote de Classificacao
                </h2>

                <!-- Nome do Lote -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Lote (opcional)</label>
                    <input type="text" id="nomeLote" placeholder="Ex: Classificacao Decisoes Janeiro 2026" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Adicionar Documentos -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-file-alt mr-2 text-gray-400"></i>Adicionar Documentos
                    </h3>

                    <!-- Sub-tabs: Upload / TJ-MS -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex gap-4">
                            <button onclick="showSubTab('upload')" id="subtab-upload" class="py-2 px-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                                <i class="fas fa-upload mr-2"></i>Upload de Arquivos
                            </button>
                            <button onclick="showSubTab('tjms')" id="subtab-tjms" class="py-2 px-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                <i class="fas fa-gavel mr-2"></i>Importar do TJ-MS
                            </button>
                        </nav>
                    </div>

                    <!-- Sub-content: Upload -->
                    <div id="subcontent-upload" class="subtab-content">
                        <div id="dropZoneLote" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">Arraste arquivos aqui</p>
                            <p class="text-gray-500 mt-1">ou clique para selecionar</p>
                            <p class="text-sm text-gray-400 mt-2">PDF, TXT ou ZIP (max 2.000 arquivos, 50MB cada)</p>
                            <input type="file" id="arquivosLote" accept=".pdf,.txt,.zip" multiple class="hidden">
                        </div>
                        <div id="listaArquivosLote" class="mt-4 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Arquivos selecionados: <span id="contadorArquivos">0</span></span>
                                <button onclick="limparArquivosLote()" class="text-sm text-red-600 hover:text-red-700">
                                    <i class="fas fa-trash mr-1"></i>Limpar
                                </button>
                            </div>
                            <div id="previewArquivos" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100"></div>
                        </div>
                    </div>

                    <!-- Sub-content: TJ-MS -->
                    <div id="subcontent-tjms" class="subtab-content hidden">
                        <div class="space-y-4">
                            <!-- Lista de processos -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cole a lista de processos (1 por linha)</label>
                                <textarea id="processosLote" rows="5" placeholder="0800123-45.2024.8.12.0001&#10;0800456-78.2024.8.12.0002&#10;0800789-01.2024.8.12.0003" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                                <p id="contadorProcessos" class="text-sm text-gray-500 mt-1">Total: 0 processos</p>
                            </div>

                            <!-- Tipos de documentos -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de documentos a baixar</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Disponiveis -->
                                    <div>
                                        <p class="text-xs text-gray-500 mb-2">Disponiveis</p>
                                        <div id="tiposDisponiveis" class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                            <!-- Populado via JS -->
                                        </div>
                                    </div>
                                    <!-- Selecionados -->
                                    <div>
                                        <p class="text-xs text-gray-500 mb-2">Selecionados</p>
                                        <div id="tiposSelecionados" class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-blue-50">
                                            <!-- Populado via JS -->
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="adicionarTipoSelecionado()" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Adicionar &rarr;</button>
                                    <button onclick="removerTipoSelecionado()" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">&larr; Remover</button>
                                    <button onclick="adicionarTodosTipos()" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Adicionar Todos</button>
                                </div>
                                <!-- Codigos em lote -->
                                <div class="mt-3">
                                    <label class="block text-xs text-gray-500 mb-1">Codigos em lote (opcional)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="codigosTiposLote" placeholder="8, 15, 34, 500, 9500" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <button onclick="adicionarCodigosLote()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Adicionar</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filtros opcionais -->
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" id="filtrarPorAno" class="rounded border-gray-300">
                                    <span class="text-gray-700">Filtrar por ano:</span>
                                </label>
                                <input type="text" id="anosFiltro" placeholder="2024, 2025" class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-32" disabled>
                                <select id="mesFiltro" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" disabled>
                                    <option value="">Todos os meses</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Marco</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuracao -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-cog mr-2 text-gray-400"></i>Configuracao
                    </h3>

                    <div class="grid grid-cols-2 gap-6">
                        <!-- Prompt -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                            <div class="flex gap-2">
                                <select id="promptLote" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Selecione um prompt...</option>
                                </select>
                                <button onclick="showTab('prompts')" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" title="Criar novo prompt">
                                    <i class="fas fa-plus text-gray-500"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Modelo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                            <input type="text" id="modeloLote" value="google/gemini-2.5-flash-lite" placeholder="Ex: google/gemini-2.5-flash-lite" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Formato: provedor/modelo (ex: anthropic/claude-sonnet-4, openai/gpt-4o-mini)</p>
                        </div>
                    </div>

                    <!-- Modo de processamento -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modo de Processamento</label>
                        <div class="flex items-center gap-6">
                            <label class="flex items-center gap-2">
                                <input type="radio" name="modoLote" value="chunk" checked class="text-blue-600">
                                <span class="text-sm text-gray-700">Chunk (mais rapido)</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="radio" name="modoLote" value="completo" class="text-blue-600">
                                <span class="text-sm text-gray-700">Documento completo</span>
                            </label>
                            <div class="flex items-center gap-2 ml-4">
                                <label class="text-sm text-gray-600">Tamanho chunk:</label>
                                <input type="number" id="tamanhoChunkLote" value="512" min="100" max="4000" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                                <span class="text-sm text-gray-500">tokens</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">Posicao:</label>
                                <select id="posicaoChunkLote" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="fim">Fim</option>
                                    <option value="inicio">Inicio</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botao Iniciar -->
                <div class="flex justify-center">
                    <button id="btnIniciarLote" onclick="iniciarClassificacaoLote()" disabled class="px-8 py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium rounded-xl text-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Iniciar Classificacao
                    </button>
                </div>

                <!-- Area de Progresso (inicialmente oculta) -->
                <div id="areaProgressoLote" class="mt-6 hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Progresso</h3>
                            <div class="flex gap-2">
                                <button onclick="pausarLote()" id="btnPausarLote" class="px-3 py-1 text-sm bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200">
                                    <i class="fas fa-pause mr-1"></i>Pausar
                                </button>
                                <button onclick="cancelarLote()" id="btnCancelarLote" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    <i class="fas fa-times mr-1"></i>Cancelar
                                </button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span id="statusProgressoLote">Processando...</span>
                                <span id="contadorProgressoLote">0 / 0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="barraProgressoLote" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="logProgressoLote" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 font-mono text-xs">
                            <!-- Logs em tempo real -->
                        </div>
                    </div>
                </div>

                <!-- Area de Resultados (inicialmente oculta) -->
                <div id="areaResultadosLote" class="mt-6 hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Resultados</h3>
                            <div class="flex gap-2">
                                <button onclick="exportarResultadosLote('excel')" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                </button>
                                <button onclick="exportarResultadosLote('csv')" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                                    <i class="fas fa-file-csv mr-1"></i>CSV
                                </button>
                                <button onclick="exportarResultadosLote('json')" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                                    <i class="fas fa-file-code mr-1"></i>JSON
                                </button>
                            </div>
                        </div>
                        <div id="resumoResultadosLote" class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <!-- Resumo: X sucesso, Y erros -->
                        </div>
                        <div id="tabelaResultadosLote" class="overflow-x-auto">
                            <!-- Tabela de resultados -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Meus Lotes (antigo Projetos) -->
        <div id="content-meusLotes" class="tab-content hidden">
            <!-- Execuções em Andamento (mostrado dinamicamente) -->
            <div id="execucoesEmAndamentoContainer" class="mb-6 hidden">
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="animate-pulse">
                            <i class="fas fa-cog fa-spin text-yellow-600 text-xl"></i>
                        </div>
                        <h3 class="font-semibold text-yellow-800">Classificação em Andamento</h3>
                    </div>
                    <div id="execucoesEmAndamentoLista">
                        <!-- Lista de execuções em andamento será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Header da lista de lotes -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Meus Lotes</h2>
                <div class="flex items-center gap-4">
                    <input type="text" id="buscaLotes" placeholder="Buscar lotes..." class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button onclick="showTab('novoLote')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Novo Lote
                    </button>
                </div>
            </div>

            <!-- Lista de Lotes -->
            <div id="listaProjetos" class="grid gap-4">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                    <p>Carregando lotes...</p>
                </div>
            </div>

            <!-- Area de Progresso (Meus Lotes) -->
            <div id="areaProgressoMeusLotes" class="mt-6 hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Progresso da Classificacao</h3>
                        <span id="rotaOrigemMeusLotes" class="text-xs text-gray-400 font-mono"></span>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span id="statusProgressoMeusLotes">Processando...</span>
                            <span id="contadorProgressoMeusLotes">0 / 0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="barraProgressoMeusLotes" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Alerta de Travamento (ADR-0010) -->
                    <div id="alertaTravamentoMeusLotes" class="hidden mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-amber-500 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <h4 class="font-medium text-amber-800">Execucao Travada</h4>
                                <p id="mensagemTravamentoMeusLotes" class="text-sm text-amber-700 mt-1">A execucao parou de responder. O progresso foi salvo.</p>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="retomarExecucaoMeusLotes()" id="btnRetomarMeusLotes" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-play mr-2"></i>Continuar de onde parou
                                    </button>
                                    <button onclick="reprocessarErrosMeusLotes()" id="btnReprocessarErrosMeusLotes" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-redo mr-2"></i>Reprocessar apenas erros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Alerta de Erro (ADR-0010) -->
                    <div id="alertaErroMeusLotes" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-times-circle text-red-500 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <h4 class="font-medium text-red-800">Erro na Execucao</h4>
                                <p id="mensagemErroMeusLotes" class="text-sm text-red-700 mt-1"></p>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="verErrosExecucaoMeusLotes()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-list mr-2"></i>Ver detalhes dos erros
                                    </button>
                                    <button onclick="reprocessarErrosMeusLotes()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                                        <i class="fas fa-redo mr-2"></i>Reprocessar erros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="logProgressoMeusLotes" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 font-mono text-xs">
                        <!-- Logs em tempo real -->
                    </div>
                </div>
            </div>

            <!-- Area de Resultados (Meus Lotes) -->
            <div id="areaResultadosMeusLotes" class="mt-6 hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Resultados</h3>
                    </div>
                    <div id="resumoResultadosMeusLotes" class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <!-- Resumo -->
                    </div>
                    <div id="tabelaResultadosMeusLotes" class="overflow-x-auto hidden">
                        <!-- Tabela de resultados -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Prompts -->
        <div id="content-prompts" class="tab-content hidden">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Prompts de Classificacao</h2>
                <button onclick="showModalCriarPrompt()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Novo Prompt
                </button>
            </div>

            <!-- Lista de Prompts -->
            <div id="listaPrompts" class="grid gap-4">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                    <p>Carregando prompts...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Teste Rapido (redesenhado com TJ-MS + visualizacao PDF) -->
        <div id="content-testeRapido" class="tab-content hidden">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-bolt mr-2 text-yellow-500"></i>Teste Rapido
                </h2>
                <p class="text-gray-600 mb-6">Teste um prompt com um documento e visualize o resultado antes de criar um lote.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Coluna Esquerda: Entrada -->
                    <div class="space-y-4">
                        <!-- Card: Origem do Documento -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Origem do Documento</h3>

                            <!-- Sub-tabs: Upload / TJ-MS -->
                            <div class="border-b border-gray-200 mb-4">
                                <nav class="flex gap-4">
                                    <button onclick="showTesteSubTab('upload')" id="teste-subtab-upload" class="py-2 px-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                                        <i class="fas fa-upload mr-2"></i>Upload
                                    </button>
                                    <button onclick="showTesteSubTab('tjms')" id="teste-subtab-tjms" class="py-2 px-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                        <i class="fas fa-gavel mr-2"></i>TJ-MS
                                    </button>
                                </nav>
                            </div>

                            <!-- Sub-content: Upload -->
                            <div id="teste-subcontent-upload" class="teste-subtab-content">
                                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 text-sm">Arraste um arquivo ou clique</p>
                                    <p class="text-xs text-gray-400 mt-1">PDF ate 50MB</p>
                                    <input type="file" id="arquivoAvulso" accept=".pdf" class="hidden">
                                </div>
                                <p id="nomeArquivoAvulso" class="text-sm text-blue-600 mt-2 hidden"></p>
                            </div>

                            <!-- Sub-content: TJ-MS -->
                            <div id="teste-subcontent-tjms" class="teste-subtab-content hidden">
                                <div class="space-y-3">
                                    <!-- Numero do processo -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Numero do Processo (CNJ)</label>
                                        <input type="text" id="testeProcessoCNJ" placeholder="0800001-00.2024.8.12.0001" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono">
                                    </div>

                                    <!-- Tipos de documentos -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tipos de Documentos</label>
                                        <div class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="8" checked>
                                                <span>8 - Sentenca</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="15" checked>
                                                <span>15 - Decisao Interl.</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="34">
                                                <span>34 - Acordao</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="44">
                                                <span>44 - Decisao Mono.</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="500">
                                                <span>500 - Peticao Inicial</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="9500">
                                                <span>9500 - Peticao</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="8320">
                                                <span>8320 - Contestacao</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="8335">
                                                <span>8335 - Apelacao</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Botao Buscar -->
                                    <button onclick="buscarDocumentosTJMSTeste()" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>Buscar Documentos
                                    </button>

                                    <!-- Lista de documentos encontrados -->
                                    <div id="testeDocsTJMS" class="hidden">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Documentos Encontrados</label>
                                        <div id="testeDocsTJMSLista" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100">
                                            <!-- Populado via JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card: Configuracao -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Configuracao</h3>

                            <div class="space-y-3">
                                <!-- Prompt -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Prompt</label>
                                    <select id="promptAvulso" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Selecione um prompt...</option>
                                    </select>
                                </div>

                                <!-- Modelo -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Modelo</label>
                                    <input type="text" id="modeloAvulso" value="google/gemini-2.5-flash-lite" placeholder="provedor/modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Modo e Tokens em linha -->
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Modo</label>
                                        <select id="modoAvulso" class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                                            <option value="chunk">Chunk</option>
                                            <option value="completo">Completo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Posicao</label>
                                        <select id="posicaoAvulso" class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                                            <option value="fim">Fim</option>
                                            <option value="inicio">Inicio</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tokens</label>
                                        <input type="number" id="tokensAvulso" value="512" min="100" max="4000" class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                                    </div>
                                </div>
                            </div>

                            <!-- Botao Classificar -->
                            <button onclick="classificarTesteRapido()" id="btnClassificarAvulso" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-magic mr-2"></i>Classificar
                            </button>
                        </div>
                    </div>

                    <!-- Coluna Direita: Visualizacao PDF + Resultado -->
                    <div class="space-y-4">
                        <!-- Card: Visualizacao PDF -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <!-- Header com controles -->
                            <div class="flex flex-wrap justify-between items-center gap-2 mb-3">
                                <h3 class="text-sm font-medium text-gray-900">Visualizacao do Documento</h3>

                                <!-- Controles do PDF (aparecem quando ha documento) -->
                                <div id="pdfControles" class="hidden flex flex-wrap items-center gap-1 sm:gap-2">
                                    <!-- Navegacao de paginas -->
                                    <div class="flex items-center gap-1 border-r border-gray-200 pr-2">
                                        <button onclick="pdfPaginaAnterior()" class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Pagina anterior">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span id="pdfPaginaInfo" class="text-xs text-gray-600 min-w-[40px] text-center">1 / 1</span>
                                        <button onclick="pdfProximaPagina()" class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Proxima pagina">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>

                                    <!-- Controles de zoom -->
                                    <div class="flex items-center gap-1 border-r border-gray-200 pr-2">
                                        <button onclick="pdfZoomOut()" class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Diminuir zoom">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <span id="pdfZoomInfo" class="text-xs text-gray-600 min-w-[45px] text-center">100%</span>
                                        <button onclick="pdfZoomIn()" class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Aumentar zoom">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button onclick="pdfZoomFit()" class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Ajustar ao container">
                                            <i class="fas fa-compress-arrows-alt"></i>
                                        </button>
                                    </div>

                                    <!-- Acoes extras -->
                                    <div class="flex items-center gap-1">
                                        <button onclick="pdfFullscreen()" class="p-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs" title="Tela cheia">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                        <button onclick="pdfAbrirNovaAba()" class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Abrir em nova aba">
                                            <i class="fas fa-external-link-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Container do PDF com altura maior -->
                            <div id="pdfViewer" class="border border-gray-200 rounded-lg bg-gray-50 flex items-center justify-center overflow-auto cursor-grab active:cursor-grabbing" style="height: 500px;">
                                <div class="text-center text-gray-400">
                                    <i class="fas fa-file-pdf text-4xl mb-2"></i>
                                    <p class="text-sm">Nenhum documento carregado</p>
                                </div>
                            </div>

                            <!-- Dica de uso (aparece quando ha documento) -->
                            <p id="pdfDica" class="hidden text-xs text-gray-400 mt-2 text-center">
                                <i class="fas fa-lightbulb mr-1"></i>Use scroll do mouse para zoom, arraste para mover
                            </p>
                        </div>

                        <!-- Card: Resultado da Classificacao -->
                        <div id="resultadoAvulso" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hidden">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Resultado da Classificacao</h3>
                            <div id="resultadoAvulsoContent" class="space-y-3">
                                <!-- Populado via JS -->
                            </div>
                        </div>

                        <!-- Card: Lista de Documentos Classificados (quando multiplos) -->
                        <div id="listaResultadosTeste" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hidden">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Documentos Classificados</h3>
                            <div id="listaResultadosTesteContent" class="max-h-60 overflow-y-auto divide-y divide-gray-100">
                                <!-- Populado via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Criar/Editar Projeto -->
    <div id="modalProjeto" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modalProjetoTitulo" class="text-lg font-semibold text-gray-900">Novo Lote</h3>
            </div>
            <form id="formProjeto" class="p-6 space-y-4">
                <input type="hidden" id="projetoId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                    <input type="text" id="projetoNome" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descricao</label>
                    <textarea id="projetoDescricao" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                    <select id="projetoPrompt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecione um prompt...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo OpenRouter</label>
                    <input type="text" id="projetoModelo" value="google/gemini-2.5-flash-lite" placeholder="Ex: google/gemini-2.5-flash-lite" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Formato: provedor/modelo (ex: minimax/minimax-m2-her, google/gemini-3-flash-preview)</p>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modo</label>
                        <select id="projetoModo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="chunk">Chunk</option>
                            <option value="completo">Completo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Posicao</label>
                        <select id="projetoPosicao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="fim">Fim</option>
                            <option value="inicio">Inicio</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tokens</label>
                        <input type="number" id="projetoTokens" value="512" min="100" max="4000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideModalProjeto()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Criar/Editar Prompt -->
    <div id="modalPrompt" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modalPromptTitulo" class="text-lg font-semibold text-gray-900">Novo Prompt</h3>
            </div>
            <form id="formPrompt" class="p-6 space-y-4">
                <input type="hidden" id="promptId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                    <input type="text" id="promptNome" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descricao</label>
                    <input type="text" id="promptDescricao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conteudo do Prompt</label>
                    <textarea id="promptConteudo" rows="12" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Codigos de Tipos de Documento (TJ-MS)
                        <span class="text-gray-400 font-normal ml-1">(opcional)</span>
                    </label>
                    <textarea id="promptCodigosDocumento" rows="3" placeholder="Digite os codigos separados por virgula ou um por linha. Ex:&#10;8, 15, 34&#10;ou&#10;8&#10;15&#10;34" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Codigos comuns: 8 (Sentenca), 15 (Decisao Interlocutoria), 34 (Acordao), 44 (Decisao Monocratica), 500 (Peticao Inicial)
                    </p>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideModalPrompt()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Detalhe do Projeto -->
    <div id="modalDetalheProjeto" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 id="detalheTitulo" class="text-lg font-semibold text-gray-900">Lote</h3>
                <button onclick="hideModalDetalheProjeto()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detalheContent" class="p-6">
                <!-- Conteudo carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Codigos do TJ-MS -->
    <div id="modalAdicionarCodigos" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Adicionar Documentos</h3>
                <button onclick="hideModalAdicionarCodigos()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Busca no TJ-MS -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-2"></i>Buscar no TJ-MS
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="buscaTJMS" placeholder="Numero do processo CNJ (ex: 0800123-45.2024.8.12.0001)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button type="button" onclick="buscarDocumentosTJMS()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="resultadosBuscaTJMS" class="mt-3">
                        <!-- Resultados da busca aparecem aqui -->
                    </div>
                </div>

                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500 mb-3">Ou adicione codigos manualmente:</p>
                </div>

                <!-- Codigos manuais -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-keyboard mr-2"></i>Codigos manuais
                    </label>
                    <textarea id="codigosManuais" rows="3" placeholder="Cole codigos separados por virgula, ponto-e-virgula ou quebra de linha"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Numero do processo (para codigos manuais)</label>
                    <input type="text" id="processoManual" placeholder="Deixe vazio se nao aplicavel"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="hideModalAdicionarCodigos()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="button" onclick="adicionarCodigosSelecionados()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Adicionar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: PDF Fullscreen -->
    <div id="modalPdfFullscreen" class="fixed inset-0 bg-black/90 hidden z-[60] flex flex-col">
        <!-- Header do modal -->
        <div class="flex justify-between items-center p-4 bg-gray-900/80 backdrop-blur">
            <div class="flex items-center gap-4">
                <h3 class="text-white font-medium">Visualizacao do Documento</h3>
                <!-- Navegacao -->
                <div class="flex items-center gap-2">
                    <button onclick="pdfFullscreenPaginaAnterior()" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white rounded text-sm">
                        <i class="fas fa-chevron-left mr-1"></i>Anterior
                    </button>
                    <span id="pdfFullscreenPaginaInfo" class="text-white text-sm min-w-[60px] text-center">1 / 1</span>
                    <button onclick="pdfFullscreenProximaPagina()" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white rounded text-sm">
                        Proxima<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
                <!-- Zoom -->
                <div class="flex items-center gap-2 border-l border-white/20 pl-4">
                    <button onclick="pdfFullscreenZoomOut()" class="p-2 bg-white/10 hover:bg-white/20 text-white rounded" title="Diminuir">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span id="pdfFullscreenZoomInfo" class="text-white text-sm min-w-[50px] text-center">100%</span>
                    <button onclick="pdfFullscreenZoomIn()" class="p-2 bg-white/10 hover:bg-white/20 text-white rounded" title="Aumentar">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button onclick="pdfFullscreenZoomFit()" class="p-2 bg-white/10 hover:bg-white/20 text-white rounded" title="Ajustar">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <button onclick="fecharPdfFullscreen()" class="p-2 bg-white/10 hover:bg-red-500 text-white rounded transition-colors" title="Fechar (ESC)">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <!-- Container do PDF fullscreen -->
        <div id="pdfFullscreenViewer" class="flex-1 overflow-auto flex items-center justify-center p-4 cursor-grab active:cursor-grabbing">
            <!-- Canvas sera inserido aqui -->
        </div>
    </div>

    <script src="/static/js/security.js"></script>
    <script>
        // ====================================
        // Estado Global
        // ====================================
        let token = localStorage.getItem('access_token');
        let projetos = [];
        let prompts = [];
        let projetoAtual = null;

        // ====================================
        // Autenticacao
        // ====================================
        if (!token) {
            window.location.href = '/login';
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        }

        async function fetchAPI(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            const response = await fetch(url, { ...defaultOptions, ...options });
            if (response.status === 401) {
                logout();
                throw new Error('Nao autorizado');
            }
            return response;
        }

        // ====================================
        // Tabs
        // ====================================
        function showTab(tabName) {
            // Esconde todos os conteudos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active de todas as tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-500');
            });
            // Mostra conteudo selecionado
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            // Ativa tab selecionada
            const tab = document.getElementById(`tab-${tabName}`);
            tab.classList.add('tab-active');
            tab.classList.remove('text-gray-500');
        }

        // ====================================
        // API Status
        // ====================================
        async function verificarStatusAPI() {
            try {
                const response = await fetchAPI('/classificador/api/status');
                const data = await response.json();
                const statusEl = document.getElementById('apiStatus');
                if (data.disponivel) {
                    statusEl.innerHTML = `
                        <i class="fas fa-circle text-green-500 text-xs"></i>
                        <span class="text-green-600">API Online</span>
                    `;
                    statusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-green-50';
                } else {
                    statusEl.innerHTML = `
                        <i class="fas fa-circle text-red-500 text-xs"></i>
                        <span class="text-red-600">API Offline</span>
                    `;
                    statusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-red-50';
                }
            } catch (e) {
                console.error('Erro ao verificar status:', e);
            }
        }

        // ====================================
        // Prompts
        // ====================================
        async function carregarPrompts() {
            try {
                const response = await fetchAPI('/classificador/api/prompts');
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                prompts = await response.json();
                renderizarPrompts();
                atualizarSelectsPrompt();
            } catch (e) {
                console.error('Erro ao carregar prompts:', e);
                const container = document.getElementById('listaPrompts');
                container.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Erro ao carregar prompts</p>
                        <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                        <button onclick="carregarPrompts()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        function renderizarPrompts() {
            const container = document.getElementById('listaPrompts');
            if (prompts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-comment-slash text-4xl mb-4"></i>
                        <p>Nenhum prompt cadastrado</p>
                        <p class="text-sm mt-2">Crie seu primeiro prompt para comecar a classificar documentos.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = prompts.map(p => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${SecurityUtils.escapeHtml(p.nome)}</h3>
                            ${p.descricao ? `<p class="text-sm text-gray-500 mt-1">${SecurityUtils.escapeHtml(p.descricao)}</p>` : ''}
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fas fa-clock mr-1"></i>
                                ${new Date(p.criado_em).toLocaleDateString('pt-BR')}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editarPrompt(${p.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletarPrompt(${p.id})" class="text-red-600 hover:text-red-800 px-2 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function atualizarSelectsPrompt() {
            const options = prompts.map(p => `<option value="${p.id}">${SecurityUtils.escapeHtml(p.nome)}</option>`).join('');
            document.getElementById('projetoPrompt').innerHTML = `<option value="">Selecione um prompt...</option>${options}`;
            document.getElementById('promptAvulso').innerHTML = `<option value="">Selecione um prompt...</option>${options}`;
        }

        function showModalCriarPrompt() {
            document.getElementById('modalPromptTitulo').textContent = 'Novo Prompt';
            document.getElementById('promptId').value = '';
            document.getElementById('promptNome').value = '';
            document.getElementById('promptDescricao').value = '';
            document.getElementById('promptConteudo').value = '';
            document.getElementById('promptCodigosDocumento').value = '';
            document.getElementById('modalPrompt').classList.remove('hidden');
        }

        function hideModalPrompt() {
            document.getElementById('modalPrompt').classList.add('hidden');
        }

        async function editarPrompt(id) {
            const prompt = prompts.find(p => p.id === id);
            if (!prompt) return;
            document.getElementById('modalPromptTitulo').textContent = 'Editar Prompt';
            document.getElementById('promptId').value = prompt.id;
            document.getElementById('promptNome').value = prompt.nome;
            document.getElementById('promptDescricao').value = prompt.descricao || '';
            document.getElementById('promptConteudo').value = prompt.conteudo;
            document.getElementById('promptCodigosDocumento').value = prompt.codigos_documento || '';
            document.getElementById('modalPrompt').classList.remove('hidden');
        }

        async function salvarPrompt(e) {
            e.preventDefault();
            const id = document.getElementById('promptId').value;

            // Normaliza codigos: remove espacos, converte quebras de linha para virgula
            let codigosRaw = document.getElementById('promptCodigosDocumento').value || '';
            let codigos = codigosRaw
                .replace(/\n/g, ',')  // quebras de linha para virgula
                .split(',')
                .map(c => c.trim())
                .filter(c => c.length > 0)
                .join(',');

            const data = {
                nome: document.getElementById('promptNome').value,
                descricao: document.getElementById('promptDescricao').value,
                conteudo: document.getElementById('promptConteudo').value,
                codigos_documento: codigos || null
            };
            try {
                if (id) {
                    await fetchAPI(`/classificador/api/prompts/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await fetchAPI('/classificador/api/prompts', { method: 'POST', body: JSON.stringify(data) });
                }
                hideModalPrompt();
                carregarPrompts();
            } catch (e) {
                alert('Erro ao salvar prompt');
            }
        }

        async function deletarPrompt(id) {
            if (!confirm('Deseja realmente excluir este prompt?')) return;
            try {
                await fetchAPI(`/classificador/api/prompts/${id}`, { method: 'DELETE' });
                carregarPrompts();
            } catch (e) {
                alert('Erro ao excluir prompt');
            }
        }

        // ====================================
        // Execuções em Andamento
        // ====================================
        let execucoesEmAndamento = [];
        let intervaloAtualizacaoExecucoes = null;

        async function verificarExecucoesEmAndamento() {
            try {
                const response = await fetchAPI('/classificador/api/execucoes-em-andamento');
                if (!response.ok) return;

                execucoesEmAndamento = await response.json();
                renderizarExecucoesEmAndamento();

                // Se há execuções em andamento, inicia polling para atualização
                if (execucoesEmAndamento.length > 0 && !intervaloAtualizacaoExecucoes) {
                    intervaloAtualizacaoExecucoes = setInterval(verificarExecucoesEmAndamento, 3000);
                } else if (execucoesEmAndamento.length === 0 && intervaloAtualizacaoExecucoes) {
                    clearInterval(intervaloAtualizacaoExecucoes);
                    intervaloAtualizacaoExecucoes = null;
                    // Recarrega a lista de projetos para atualizar contadores
                    carregarProjetos();
                }
            } catch (e) {
                console.error('[EXEC] Erro ao verificar execuções em andamento:', e);
            }
        }

        function renderizarExecucoesEmAndamento() {
            const container = document.getElementById('execucoesEmAndamentoContainer');
            const lista = document.getElementById('execucoesEmAndamentoLista');

            if (!container || !lista) return;

            if (execucoesEmAndamento.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            lista.innerHTML = execucoesEmAndamento.map(e => {
                const pct = e.total_arquivos > 0 ? Math.round((e.arquivos_processados / e.total_arquivos) * 100) : 0;
                // Detecta se está travada (status TRAVADO ou esta_travada=true)
                const estaTravada = e.status === 'travado' || e.esta_travada;
                // Cores baseadas no status
                const borderColor = estaTravada ? 'border-orange-300' : 'border-yellow-100';
                const bgColor = estaTravada ? 'bg-orange-50' : 'bg-white';
                const barColor = estaTravada ? 'bg-orange-500' : 'bg-yellow-500';
                const statusText = estaTravada ? 'Travada' : 'Em andamento';
                const statusColor = estaTravada ? 'text-orange-700' : 'text-yellow-700';

                return `
                    <div class="${bgColor} rounded-lg p-3 mb-2 last:mb-0 border ${borderColor}">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <span class="font-medium text-gray-900">${SecurityUtils.escapeHtml(e.projeto_nome || 'Lote #' + e.projeto_id)}</span>
                                <span class="text-sm text-gray-500 ml-2">(Execução #${e.id})</span>
                                ${estaTravada ? '<span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full"><i class="fas fa-exclamation-triangle mr-1"></i>Travada</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm ${statusColor} font-medium">${e.arquivos_processados} / ${e.total_arquivos} arquivos</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full transition-all" style="width: ${pct}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span><i class="fas fa-check-circle text-green-500 mr-1"></i>${e.arquivos_sucesso || 0} sucesso</span>
                            <span><i class="fas fa-times-circle text-red-500 mr-1"></i>${e.arquivos_erro || 0} erros</span>
                            <span>${pct}%</span>
                        </div>
                        <!-- Botões de ação -->
                        <div class="flex items-center gap-2 mt-3 pt-2 border-t border-gray-100">
                            <button onclick="acompanharExecucao(${e.projeto_id}, ${e.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                                <i class="fas fa-eye mr-1"></i>Ver Detalhes
                            </button>
                            ${estaTravada && e.pode_retomar ? `
                                <button onclick="retomarExecucaoCard(${e.id})" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm">
                                    <i class="fas fa-play mr-1"></i>Retomar
                                </button>
                            ` : ''}
                            ${estaTravada || e.status === 'em_andamento' ? `
                                <button onclick="cancelarExecucaoCard(${e.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm">
                                    <i class="fas fa-times mr-1"></i>Cancelar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Cancela uma execução diretamente do card
        async function cancelarExecucaoCard(execucaoId) {
            if (!confirm('Tem certeza que deseja cancelar esta execução?')) {
                return;
            }

            try {
                const response = await fetchAPI(`/classificador/api/execucoes/${execucaoId}/cancelar`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const erro = await response.json();
                    throw new Error(erro.detail || 'Erro ao cancelar execução');
                }

                alert('Execução cancelada com sucesso!');
                // Atualiza a lista
                await verificarExecucoesEmAndamento();
            } catch (e) {
                console.error('[CANCELAR] Erro:', e);
                alert('Erro ao cancelar execução: ' + e.message);
            }
        }

        // Retoma uma execução diretamente do card
        async function retomarExecucaoCard(execucaoId) {
            // Busca a execução para obter o projeto_id
            const exec = execucoesEmAndamento.find(e => e.id === execucaoId);
            if (!exec) {
                alert('Execução não encontrada na lista');
                return;
            }

            // Abre o modal do projeto e inicia a retomada
            await abrirProjeto(exec.projeto_id);

            // Mostra a área de progresso
            const areaProgresso = document.getElementById('areaProgressoMeusLotes');
            if (areaProgresso) {
                areaProgresso.classList.remove('hidden');
            }

            // Chama a função de retomada existente
            retomarExecucaoMeusLotes(execucaoId);
        }

        async function acompanharExecucao(projetoId, execucaoId) {
            // Abre o modal de detalhes do projeto
            await abrirProjeto(projetoId);

            // Mostra a área de progresso
            const areaProgresso = document.getElementById('areaProgressoMeusLotes');
            if (areaProgresso) {
                areaProgresso.classList.remove('hidden');

                // Busca status atual da execução
                try {
                    const response = await fetchAPI(`/classificador/api/execucoes/${execucaoId}`);
                    if (response.ok) {
                        const exec = await response.json();
                        const pct = exec.total_arquivos > 0 ? Math.round((exec.arquivos_processados / exec.total_arquivos) * 100) : 0;

                        document.getElementById('statusProgressoMeusLotes').textContent = 'Em andamento...';
                        document.getElementById('contadorProgressoMeusLotes').textContent = `${exec.arquivos_processados} / ${exec.total_arquivos}`;
                        document.getElementById('barraProgressoMeusLotes').style.width = `${pct}%`;
                        document.getElementById('logProgressoMeusLotes').innerHTML = `
                            <div class="text-gray-600">[${new Date().toLocaleTimeString()}] Reconectado à execução #${execucaoId}</div>
                            <div class="text-gray-600">[${new Date().toLocaleTimeString()}] Progresso: ${exec.arquivos_processados}/${exec.total_arquivos} (${pct}%)</div>
                            <div class="text-green-600">[${new Date().toLocaleTimeString()}] ${exec.arquivos_sucesso || 0} arquivos classificados com sucesso</div>
                            ${exec.arquivos_erro > 0 ? `<div class="text-red-600">[${new Date().toLocaleTimeString()}] ${exec.arquivos_erro} arquivos com erro</div>` : ''}
                        `;
                    }
                } catch (e) {
                    console.error('[EXEC] Erro ao buscar status da execução:', e);
                }
            }
        }

        // ====================================
        // Projetos
        // ====================================
        async function carregarProjetos() {
            try {
                const response = await fetchAPI('/classificador/api/projetos');
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                projetos = await response.json();
                renderizarProjetos();
            } catch (e) {
                console.error('Erro ao carregar projetos:', e);
                const container = document.getElementById('listaProjetos');
                container.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Erro ao carregar lotes</p>
                        <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                        <button onclick="carregarProjetos()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        function renderizarProjetos() {
            const container = document.getElementById('listaProjetos');
            if (projetos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p>Nenhum lote cadastrado</p>
                        <p class="text-sm mt-2">Crie seu primeiro lote para organizar suas classificacoes.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = projetos.map(p => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 hover:shadow-md transition-shadow cursor-pointer" onclick="abrirProjeto(${p.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 text-lg">${SecurityUtils.escapeHtml(p.nome)}</h3>
                            ${p.descricao ? `<p class="text-sm text-gray-500 mt-1">${SecurityUtils.escapeHtml(p.descricao)}</p>` : ''}
                            <div class="flex gap-4 mt-3 text-sm text-gray-500">
                                <span><i class="fas fa-file-alt mr-1"></i>${p.total_codigos} documentos</span>
                                <span><i class="fas fa-play mr-1"></i>${p.total_execucoes} execucoes</span>
                                <span><i class="fas fa-robot mr-1"></i>${p.modelo.includes('/') ? p.modelo.split('/')[1] : p.modelo}</span>
                            </div>
                        </div>
                        <div class="flex gap-2" onclick="event.stopPropagation()">
                            <button onclick="editarProjeto(${p.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletarProjeto(${p.id})" class="text-red-600 hover:text-red-800 px-2 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showModalCriarProjeto() {
            document.getElementById('modalProjetoTitulo').textContent = 'Novo Lote';
            document.getElementById('projetoId').value = '';
            document.getElementById('projetoNome').value = '';
            document.getElementById('projetoDescricao').value = '';
            document.getElementById('projetoPrompt').value = '';
            document.getElementById('projetoModelo').value = 'google/gemini-2.5-flash-lite';
            document.getElementById('projetoModo').value = 'chunk';
            document.getElementById('projetoPosicao').value = 'fim';
            document.getElementById('projetoTokens').value = '512';
            document.getElementById('modalProjeto').classList.remove('hidden');
        }

        function hideModalProjeto() {
            document.getElementById('modalProjeto').classList.add('hidden');
        }

        async function editarProjeto(id) {
            const projeto = projetos.find(p => p.id === id);
            if (!projeto) return;
            document.getElementById('modalProjetoTitulo').textContent = 'Editar Lote';
            document.getElementById('projetoId').value = projeto.id;
            document.getElementById('projetoNome').value = projeto.nome;
            document.getElementById('projetoDescricao').value = projeto.descricao || '';
            document.getElementById('projetoPrompt').value = projeto.prompt_id || '';
            document.getElementById('projetoModelo').value = projeto.modelo;
            document.getElementById('projetoModo').value = projeto.modo_processamento;
            document.getElementById('projetoPosicao').value = projeto.posicao_chunk;
            document.getElementById('projetoTokens').value = projeto.tamanho_chunk;
            document.getElementById('modalProjeto').classList.remove('hidden');
        }

        async function salvarProjeto(e) {
            e.preventDefault();
            const id = document.getElementById('projetoId').value;
            const data = {
                nome: document.getElementById('projetoNome').value,
                descricao: document.getElementById('projetoDescricao').value,
                prompt_id: document.getElementById('projetoPrompt').value || null,
                modelo: document.getElementById('projetoModelo').value,
                modo_processamento: document.getElementById('projetoModo').value,
                posicao_chunk: document.getElementById('projetoPosicao').value,
                tamanho_chunk: parseInt(document.getElementById('projetoTokens').value)
            };
            try {
                if (id) {
                    await fetchAPI(`/classificador/api/projetos/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await fetchAPI('/classificador/api/projetos', { method: 'POST', body: JSON.stringify(data) });
                }
                hideModalProjeto();
                carregarProjetos();
            } catch (e) {
                alert('Erro ao salvar lote');
            }
        }

        async function deletarProjeto(id) {
            if (!confirm('Deseja realmente excluir este lote?')) return;
            try {
                await fetchAPI(`/classificador/api/projetos/${id}`, { method: 'DELETE' });
                carregarProjetos();
            } catch (e) {
                alert('Erro ao excluir lote');
            }
        }

        // Variável para armazenar execuções do projeto atual
        let execucoesProjetoAtual = [];

        async function abrirProjeto(id) {
            try {
                // Carrega projeto e execuções em paralelo
                const [projetoResponse, execucoesResponse] = await Promise.all([
                    fetchAPI(`/classificador/api/projetos/${id}`),
                    fetchAPI(`/classificador/api/projetos/${id}/execucoes`)
                ]);

                projetoAtual = await projetoResponse.json();
                execucoesProjetoAtual = await execucoesResponse.json();

                document.getElementById('detalheTitulo').textContent = projetoAtual.nome;
                renderizarDetalheProjeto();
                document.getElementById('modalDetalheProjeto').classList.remove('hidden');
            } catch (e) {
                alert('Erro ao carregar lote');
            }
        }

        function hideModalDetalheProjeto() {
            document.getElementById('modalDetalheProjeto').classList.add('hidden');
            projetoAtual = null;
        }

        function renderizarDetalheProjeto() {
            const container = document.getElementById('detalheContent');
            const p = projetoAtual;
            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Info do Projeto -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Modelo</p>
                            <p class="font-medium">${SecurityUtils.escapeHtml(p.modelo.includes('/') ? p.modelo.split('/')[1] : p.modelo)}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Modo</p>
                            <p class="font-medium">${p.modo_processamento}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Tokens</p>
                            <p class="font-medium">${p.tamanho_chunk}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Posicao</p>
                            <p class="font-medium">${p.posicao_chunk}</p>
                        </div>
                    </div>

                    <!-- Codigos -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-900">Codigos de Documentos (${p.codigos.length})</h4>
                            <button onclick="showModalAdicionarCodigos()" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-plus mr-1"></i>Adicionar
                            </button>
                        </div>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            ${p.codigos.length > 0 ? `
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left px-4 py-2">Codigo</th>
                                            <th class="text-left px-4 py-2">Processo</th>
                                            <th class="text-left px-4 py-2">Fonte</th>
                                            <th class="px-4 py-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${p.codigos.map(c => `
                                            <tr class="border-t border-gray-100">
                                                <td class="px-4 py-2 font-mono">${SecurityUtils.escapeHtml(c.codigo)}</td>
                                                <td class="px-4 py-2">${c.numero_processo || '-'}</td>
                                                <td class="px-4 py-2">${c.fonte}</td>
                                                <td class="px-4 py-2 text-right">
                                                    <button onclick="removerCodigo(${c.id})" class="text-red-600 hover:text-red-800">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <p class="text-center py-8 text-gray-500">Nenhum codigo adicionado</p>
                            `}
                        </div>
                    </div>

                    <!-- Acoes -->
                    <div class="flex gap-3">
                        <button onclick="executarProjeto()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50" ${p.codigos.length === 0 || !p.prompt_id ? 'disabled' : ''}>
                            <i class="fas fa-play mr-2"></i>Executar Classificacao
                        </button>
                        <button onclick="verExecucoes()" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">
                            <i class="fas fa-history mr-2"></i>Historico
                        </button>
                    </div>

                    ${renderizarUltimaExecucao()}
                </div>
            `;
        }

        // Renderiza seção da última execução concluída (se houver)
        function renderizarUltimaExecucao() {
            // Filtra execuções concluídas e pega a mais recente
            const execucoesConcluidas = execucoesProjetoAtual.filter(e => e.status === 'concluido');

            if (execucoesConcluidas.length === 0) {
                return '';
            }

            // Ordena por ID decrescente (mais recente primeiro)
            execucoesConcluidas.sort((a, b) => b.id - a.id);
            const ultimaExecucao = execucoesConcluidas[0];

            return `
                <!-- Última Execução Concluída -->
                <div class="border-t pt-4 mt-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-600"></i>
                                <span class="font-medium text-green-800">Última Classificação (Execução #${ultimaExecucao.id})</span>
                            </div>
                            <span class="text-xs text-green-600">
                                ${ultimaExecucao.arquivos_sucesso || 0} sucesso, ${ultimaExecucao.arquivos_erro || 0} erros
                            </span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="verResultadosExecucaoModal(${ultimaExecucao.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eye mr-2"></i>Visualizar Classificação
                            </button>
                            <button onclick="exportarResultados(${ultimaExecucao.id}, 'excel')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-file-excel mr-2"></i>Baixar Excel
                            </button>
                            <button onclick="exportarResultados(${ultimaExecucao.id}, 'csv')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-file-csv mr-2"></i>CSV
                            </button>
                            <button onclick="exportarResultados(${ultimaExecucao.id}, 'json')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-file-code mr-2"></i>JSON
                            </button>
                        </div>
                        ${execucoesConcluidas.length > 1 ? `
                            <p class="text-xs text-green-600 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Há ${execucoesConcluidas.length} execuções concluídas. Clique em "Histórico" para ver todas.
                            </p>
                        ` : ''}
                    </div>
                </div>

                <!-- Área para exibir resultados inline -->
                <div id="resultadosInlineModal" class="hidden mt-4">
                    <div class="border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-center p-3 bg-gray-50 border-b">
                            <h4 class="font-semibold text-gray-900">Resultados da Classificação</h4>
                            <button onclick="ocultarResultadosInlineModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="tabelaResultadosInlineModal" class="p-3 max-h-80 overflow-auto">
                            <!-- Tabela de resultados será inserida aqui -->
                        </div>
                    </div>
                </div>
            `;
        }

        // Mostra resultados inline no modal de detalhes do lote
        async function verResultadosExecucaoModal(execucaoId) {
            const area = document.getElementById('resultadosInlineModal');
            const tabela = document.getElementById('tabelaResultadosInlineModal');

            if (!area || !tabela) return;

            area.classList.remove('hidden');
            tabela.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando resultados...</div>';

            try {
                const response = await fetchAPI(`/classificador/api/execucoes/${execucaoId}/resultados`);
                if (!response.ok) throw new Error('Erro ao carregar resultados');

                const resultados = await response.json();

                if (!resultados || resultados.length === 0) {
                    tabela.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum resultado encontrado.</div>';
                    return;
                }

                tabela.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Documento</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subcategoria</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Confiança</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Justificativa</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${resultados.map(r => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-gray-900">
                                        <div class="max-w-[120px] truncate" title="${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}">
                                            ${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-gray-700">${SecurityUtils.escapeHtml(r.categoria || '-')}</td>
                                    <td class="px-3 py-2 text-gray-700">${SecurityUtils.escapeHtml(r.subcategoria || '-')}</td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium confianca-${r.confianca || 'baixa'}">
                                            ${SecurityUtils.escapeHtml(r.confianca || '-')}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-gray-600">
                                        <div class="max-w-[180px] truncate" title="${SecurityUtils.escapeHtml(r.justificativa || '-')}">
                                            ${SecurityUtils.escapeHtml(r.justificativa || '-')}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-xs text-gray-500 text-right">${resultados.length} resultado(s)</div>
                `;

                // Scroll para a área de resultados
                area.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (e) {
                tabela.innerHTML = `<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Erro: ${SecurityUtils.escapeHtml(e.message)}</div>`;
            }
        }

        function ocultarResultadosInlineModal() {
            const area = document.getElementById('resultadosInlineModal');
            if (area) area.classList.add('hidden');
        }

        async function removerCodigo(id) {
            if (!confirm('Remover este codigo?')) return;
            try {
                await fetchAPI(`/classificador/api/codigos/${id}`, { method: 'DELETE' });
                abrirProjeto(projetoAtual.id);
            } catch (e) {
                alert('Erro ao remover codigo');
            }
        }

        function showModalAdicionarCodigos() {
            document.getElementById('modalAdicionarCodigos').classList.remove('hidden');
            document.getElementById('buscaTJMS').value = '';
            document.getElementById('resultadosBuscaTJMS').innerHTML = '';
            document.getElementById('codigosManuais').value = '';
            document.getElementById('processoManual').value = '';
        }

        function hideModalAdicionarCodigos() {
            document.getElementById('modalAdicionarCodigos').classList.add('hidden');
        }

        async function buscarDocumentosTJMS() {
            const numeroCNJ = document.getElementById('buscaTJMS').value.trim();
            if (!numeroCNJ) {
                alert('Digite o numero do processo CNJ');
                return;
            }

            const container = document.getElementById('resultadosBuscaTJMS');
            container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-600"></i> Consultando TJ-MS...</div>';

            try {
                const response = await fetchAPI('/classificador/api/tjms/consultar-processo', {
                    method: 'POST',
                    body: JSON.stringify({ numero_cnj: numeroCNJ })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Erro ao consultar');
                }

                const data = await response.json();

                if (data.documentos.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum documento encontrado neste processo</div>';
                    return;
                }

                container.innerHTML = `
                    <div class="text-sm text-gray-600 mb-2">${data.total_documentos} documento(s) encontrado(s)</div>
                    <div class="max-h-48 overflow-y-auto border rounded-lg">
                        ${data.documentos.map(doc => `
                            <label class="flex items-center gap-3 p-2 hover:bg-gray-50 border-b last:border-b-0 cursor-pointer">
                                <input type="checkbox" value="${doc.id}" data-processo="${numeroCNJ}" class="docTJMS rounded">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm truncate">${SecurityUtils.escapeHtml(doc.tipo || 'Documento')}</div>
                                    <div class="text-xs text-gray-500 truncate">${SecurityUtils.escapeHtml(doc.descricao || doc.id)}</div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button" onclick="selecionarTodosTJMS(true)" class="text-xs text-blue-600 hover:underline">Selecionar todos</button>
                        <button type="button" onclick="selecionarTodosTJMS(false)" class="text-xs text-gray-600 hover:underline">Desmarcar todos</button>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>${SecurityUtils.escapeHtml(e.message)}</div>`;
            }
        }

        function selecionarTodosTJMS(selecionar) {
            document.querySelectorAll('.docTJMS').forEach(cb => cb.checked = selecionar);
        }

        async function adicionarCodigosSelecionados() {
            // Coleta documentos selecionados do TJ-MS
            const selecionados = [];
            let processoCNJ = null;
            document.querySelectorAll('.docTJMS:checked').forEach(cb => {
                selecionados.push(cb.value);
                processoCNJ = cb.dataset.processo;
            });

            // Coleta codigos manuais
            const manuais = document.getElementById('codigosManuais').value;
            const processoManual = document.getElementById('processoManual').value.trim();
            const codigosManuais = manuais.split(/[,;\n]/).map(c => c.trim()).filter(c => c);

            if (selecionados.length === 0 && codigosManuais.length === 0) {
                alert('Selecione documentos do TJ-MS ou digite codigos manualmente');
                return;
            }

            try {
                // Adiciona selecionados do TJ-MS
                if (selecionados.length > 0 && processoCNJ) {
                    await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/codigos-tjms`, {
                        method: 'POST',
                        body: JSON.stringify({
                            numero_cnj: processoCNJ,
                            ids_documentos: selecionados
                        })
                    });
                }

                // Adiciona manuais
                if (codigosManuais.length > 0) {
                    await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/codigos`, {
                        method: 'POST',
                        body: JSON.stringify({
                            codigos: codigosManuais,
                            numero_processo: processoManual || null,
                            fonte: 'tjms'
                        })
                    });
                }

                hideModalAdicionarCodigos();
                abrirProjeto(projetoAtual.id);
            } catch (e) {
                alert('Erro ao adicionar codigos: ' + e.message);
            }
        }

        async function adicionarCodigos(codigosTexto, processo) {
            const codigos = codigosTexto.split(/[,;\n]/).map(c => c.trim()).filter(c => c);
            if (codigos.length === 0) return;
            try {
                await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/codigos`, {
                    method: 'POST',
                    body: JSON.stringify({
                        codigos: codigos,
                        numero_processo: processo || null,
                        fonte: 'tjms'
                    })
                });
                abrirProjeto(projetoAtual.id);
            } catch (e) {
                alert('Erro ao adicionar codigos');
            }
        }

        // Variaveis de estado para recuperacao (ADR-0010)
        let execucaoAtualId = null;
        let projetoExecucaoAtualId = null;
        let timeoutTravamento = null;
        const TIMEOUT_TRAVAMENTO_MS = 60000; // 60 segundos sem eventos = travamento

        async function executarProjeto() {
            if (!projetoAtual) return;

            // IMPORTANTE: Salva o ID ANTES de fechar o modal (hideModal seta projetoAtual = null)
            const projetoId = projetoAtual.id;
            const projetoNome = projetoAtual.nome;
            projetoExecucaoAtualId = projetoId;

            // Fecha o modal de detalhes
            hideModalDetalheProjeto();

            // Mostra area de progresso e esconde alertas
            iniciarAreaProgresso();

            // Inicia SSE
            iniciarSSEClassificacao(`/classificador/api/projetos/${projetoId}/executar`, projetoId);
        }

        function iniciarAreaProgresso() {
            const areaProgresso = document.getElementById('areaProgressoMeusLotes');
            if (areaProgresso) {
                areaProgresso.classList.remove('hidden');
                document.getElementById('logProgressoMeusLotes').innerHTML = '';
                document.getElementById('barraProgressoMeusLotes').style.width = '0%';
                document.getElementById('contadorProgressoMeusLotes').textContent = '0 / 0';
                document.getElementById('statusProgressoMeusLotes').textContent = 'Iniciando...';
                document.getElementById('rotaOrigemMeusLotes').textContent = '';
                // Esconde alertas de erro/travamento
                document.getElementById('alertaTravamentoMeusLotes').classList.add('hidden');
                document.getElementById('alertaErroMeusLotes').classList.add('hidden');
            }
        }

        function iniciarSSEClassificacao(url, projetoId) {
            const eventSource = new EventSource(`${url}?token=${token}`);
            let ultimoErro = null;
            let recebeuEvento = false;

            // Timer de timeout para detectar travamento (ADR-0010)
            function resetarTimeoutTravamento() {
                if (timeoutTravamento) clearTimeout(timeoutTravamento);
                timeoutTravamento = setTimeout(() => {
                    console.warn('[SSE] Timeout: sem eventos por 60s - possivel travamento');
                    eventSource.close();
                    mostrarAlertaTravamento('A execucao parou de responder. Sem eventos por mais de 60 segundos.');
                }, TIMEOUT_TRAVAMENTO_MS);
            }

            resetarTimeoutTravamento();

            eventSource.onmessage = (event) => {
                recebeuEvento = true;
                resetarTimeoutTravamento();

                try {
                    const data = JSON.parse(event.data);

                    if (data.mensagem) {
                        adicionarLogMeusLotes(data.mensagem, data.tipo === 'erro' ? 'error' : 'info');
                    }

                    // Salva ID da execucao
                    if (data.execucao_id) {
                        execucaoAtualId = data.execucao_id;
                    }

                    // Mostra rota de origem
                    if (data.rota_origem) {
                        document.getElementById('rotaOrigemMeusLotes').textContent = `Rota: ${data.rota_origem}`;
                    }

                    if (data.processados !== undefined && data.total !== undefined) {
                        atualizarBarraProgressoMeusLotes(data.processados, data.total);
                    }

                    if (data.tipo === 'concluido') {
                        clearTimeout(timeoutTravamento);
                        adicionarLogMeusLotes(`Sucesso: ${data.sucesso || 0} | Erros: ${data.erros || 0}`, 'success');
                        eventSource.close();
                        document.getElementById('statusProgressoMeusLotes').textContent = 'Concluido!';
                        // Se teve erros, mostra alerta com opcao de reprocessar
                        if (data.erros > 0) {
                            mostrarAlertaComErros(data.erros);
                        }
                        // Mostra resultados
                        if (data.execucao_id) {
                            mostrarResultadosMeusLotes(projetoId, data.execucao_id);
                        }
                    } else if (data.tipo === 'erro') {
                        clearTimeout(timeoutTravamento);
                        ultimoErro = data.mensagem;
                        eventSource.close();
                        document.getElementById('statusProgressoMeusLotes').textContent = 'Erro';
                        mostrarAlertaErro(data.mensagem);
                    } else if (data.tipo === 'inicio' || data.tipo === 'retomada' || data.tipo === 'reprocessamento') {
                        document.getElementById('statusProgressoMeusLotes').textContent = 'Processando...';
                    }
                } catch (e) {
                    console.error('[SSE MeusLotes] Erro ao processar evento:', e);
                }
            };

            eventSource.onerror = (e) => {
                console.error('[SSE MeusLotes] Erro na conexao:', e);
                clearTimeout(timeoutTravamento);
                eventSource.close();
                if (!recebeuEvento) {
                    adicionarLogMeusLotes('Erro: Conexao falhou. Verifique autenticacao.', 'error');
                    mostrarAlertaErro('Conexao falhou. Verifique se esta autenticado.');
                } else if (ultimoErro) {
                    adicionarLogMeusLotes(`Conexao encerrada: ${ultimoErro}`, 'error');
                } else {
                    // Conexao fechada sem erro explicito - possivel travamento
                    mostrarAlertaTravamento('A conexao foi interrompida inesperadamente. O progresso foi salvo.');
                }
            };

            eventSource.onopen = () => {
                console.log('[SSE MeusLotes] Conexao aberta');
                adicionarLogMeusLotes('Conexao estabelecida, processando...', 'info');
            };
        }

        function mostrarAlertaTravamento(mensagem) {
            document.getElementById('statusProgressoMeusLotes').textContent = 'Travado';
            document.getElementById('barraProgressoMeusLotes').classList.remove('bg-blue-600');
            document.getElementById('barraProgressoMeusLotes').classList.add('bg-amber-500');
            document.getElementById('mensagemTravamentoMeusLotes').textContent = mensagem;
            document.getElementById('alertaTravamentoMeusLotes').classList.remove('hidden');
            adicionarLogMeusLotes('TRAVAMENTO DETECTADO: ' + mensagem, 'error');
        }

        function mostrarAlertaErro(mensagem) {
            document.getElementById('statusProgressoMeusLotes').textContent = 'Erro';
            document.getElementById('barraProgressoMeusLotes').classList.remove('bg-blue-600');
            document.getElementById('barraProgressoMeusLotes').classList.add('bg-red-500');
            document.getElementById('mensagemErroMeusLotes').textContent = mensagem;
            document.getElementById('alertaErroMeusLotes').classList.remove('hidden');
        }

        function mostrarAlertaComErros(qtdErros) {
            document.getElementById('mensagemErroMeusLotes').textContent =
                `${qtdErros} documento(s) falharam. Voce pode tentar reprocessar os erros.`;
            document.getElementById('alertaErroMeusLotes').classList.remove('hidden');
        }

        async function retomarExecucaoMeusLotes(execId = null) {
            // Usa parâmetro ou variável global
            const idRetomar = execId || execucaoAtualId;
            if (!idRetomar) {
                alert('Nenhuma execucao para retomar');
                return;
            }

            // Se passou execId explícito, atualiza a variável global
            if (execId) {
                execucaoAtualId = execId;
            }

            adicionarLogMeusLotes('Retomando execucao...', 'info');
            document.getElementById('alertaTravamentoMeusLotes').classList.add('hidden');
            document.getElementById('barraProgressoMeusLotes').classList.remove('bg-amber-500', 'bg-red-500');
            document.getElementById('barraProgressoMeusLotes').classList.add('bg-blue-600');
            document.getElementById('statusProgressoMeusLotes').textContent = 'Retomando...';

            iniciarSSEClassificacao(`/classificador/api/execucoes/${idRetomar}/retomar`, projetoExecucaoAtualId);
        }

        async function reprocessarErrosMeusLotes() {
            if (!execucaoAtualId) {
                alert('Nenhuma execucao para reprocessar');
                return;
            }

            adicionarLogMeusLotes('Reprocessando erros...', 'info');
            document.getElementById('alertaTravamentoMeusLotes').classList.add('hidden');
            document.getElementById('alertaErroMeusLotes').classList.add('hidden');
            document.getElementById('barraProgressoMeusLotes').classList.remove('bg-amber-500', 'bg-red-500');
            document.getElementById('barraProgressoMeusLotes').classList.add('bg-blue-600');
            document.getElementById('statusProgressoMeusLotes').textContent = 'Reprocessando erros...';

            iniciarSSEClassificacao(`/classificador/api/execucoes/${execucaoAtualId}/reprocessar-erros`, projetoExecucaoAtualId);
        }

        async function verErrosExecucaoMeusLotes() {
            if (!execucaoAtualId) {
                alert('Nenhuma execucao selecionada');
                return;
            }

            try {
                const response = await fetchAPI(`/classificador/api/execucoes/${execucaoAtualId}/erros`);
                if (!response.ok) throw new Error('Erro ao buscar erros');

                const data = await response.json();

                // Mostra erros no log
                adicionarLogMeusLotes(`--- Detalhes dos ${data.total_erros} erro(s) ---`, 'error');
                for (const erro of data.erros) {
                    const msg = `[${erro.codigo_documento}] ${erro.erro_mensagem} (tentativas: ${erro.tentativas})`;
                    adicionarLogMeusLotes(msg, 'error');
                }
            } catch (e) {
                console.error('Erro ao buscar erros:', e);
                alert('Erro ao buscar detalhes dos erros');
            }
        }

        function adicionarLogMeusLotes(msg, tipo = 'info') {
            const log = document.getElementById('logProgressoMeusLotes');
            if (!log) return;
            const timestamp = new Date().toLocaleTimeString();
            const cor = tipo === 'error' ? 'text-red-600' : (tipo === 'success' ? 'text-green-600' : 'text-gray-600');
            log.innerHTML += `<div class="${cor}">[${timestamp}] ${SecurityUtils.escapeHtml(msg)}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function atualizarBarraProgressoMeusLotes(atual, total) {
            const barra = document.getElementById('barraProgressoMeusLotes');
            const contador = document.getElementById('contadorProgressoMeusLotes');
            if (!barra || !contador) return;
            const pct = total > 0 ? (atual / total * 100) : 0;
            barra.style.width = `${pct}%`;
            contador.textContent = `${atual} / ${total}`;
        }

        async function mostrarResultadosMeusLotes(projetoId, execucaoId) {
            const areaResultados = document.getElementById('areaResultadosMeusLotes');
            if (!areaResultados) return;

            areaResultados.classList.remove('hidden');

            document.getElementById('resumoResultadosMeusLotes').innerHTML = `
                <p class="text-gray-600 mb-3">Execucao #${execucaoId} concluida.</p>
                <div class="flex gap-3 flex-wrap">
                    <button onclick="exportarResultados(${execucaoId}, 'excel')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                    </button>
                    <button onclick="toggleTabelaResultadosMeusLotes(${execucaoId})" id="btnToggleTabelaMeusLotes" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-table mr-2"></i>Ver Classificacoes
                    </button>
                    <button onclick="exportarResultados(${execucaoId}, 'csv')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-file-csv mr-2"></i>CSV
                    </button>
                    <button onclick="exportarResultados(${execucaoId}, 'json')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-file-code mr-2"></i>JSON
                    </button>
                </div>
            `;

            // Pre-carrega resultados
            await carregarResultadosTabelaMeusLotes(execucaoId);
        }

        let tabelaResultadosMeusLotesVisivel = false;
        let execucaoIdMeusLotesAtual = null;

        async function toggleTabelaResultadosMeusLotes(execucaoId) {
            const tabela = document.getElementById('tabelaResultadosMeusLotes');
            const btn = document.getElementById('btnToggleTabelaMeusLotes');
            if (!tabela) return;

            tabelaResultadosMeusLotesVisivel = !tabelaResultadosMeusLotesVisivel;

            if (tabelaResultadosMeusLotesVisivel) {
                if (execucaoIdMeusLotesAtual !== execucaoId) {
                    await carregarResultadosTabelaMeusLotes(execucaoId);
                }
                tabela.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-table mr-2"></i>Ocultar Classificacoes';
            } else {
                tabela.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-table mr-2"></i>Ver Classificacoes';
            }
        }

        async function carregarResultadosTabelaMeusLotes(execucaoId) {
            execucaoIdMeusLotesAtual = execucaoId;
            const tabela = document.getElementById('tabelaResultadosMeusLotes');
            if (!tabela) return;

            tabela.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando resultados...</div>';

            try {
                const response = await fetchAPI(`/classificador/api/execucoes/${execucaoId}/resultados`);
                if (!response.ok) throw new Error('Erro ao carregar resultados');

                const resultados = await response.json();

                if (!resultados || resultados.length === 0) {
                    tabela.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum resultado encontrado.</div>';
                    return;
                }

                tabela.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subcategoria</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confianca</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Justificativa</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${resultados.map(r => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        <div class="max-w-xs truncate" title="${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}">
                                            ${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${SecurityUtils.escapeHtml(r.categoria || '-')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${SecurityUtils.escapeHtml(r.subcategoria || '-')}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium confianca-${r.confianca || 'baixa'}">
                                            ${SecurityUtils.escapeHtml(r.confianca || '-')}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        <div class="max-w-md truncate" title="${SecurityUtils.escapeHtml(r.justificativa || '-')}">
                                            ${SecurityUtils.escapeHtml(r.justificativa || '-')}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-xs text-gray-500 text-right">${resultados.length} resultado(s)</div>
                `;
            } catch (e) {
                tabela.innerHTML = `<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Erro ao carregar: ${SecurityUtils.escapeHtml(e.message)}</div>`;
            }
        }

        async function verExecucoes() {
            if (!projetoAtual) return;

            try {
                const response = await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/execucoes`);
                if (!response.ok) throw new Error('Erro ao carregar execucoes');

                const execucoes = await response.json();

                // Mostra modal com lista de execucoes
                mostrarListaExecucoes(execucoes);
            } catch (e) {
                alert('Erro ao carregar historico: ' + e.message);
            }
        }

        function mostrarListaExecucoes(execucoes) {
            const container = document.getElementById('detalheContent');
            if (!container) return;

            const p = projetoAtual;

            // Monta HTML com lista de execucoes
            let execucoesHTML = '';
            if (execucoes.length === 0) {
                execucoesHTML = '<p class="text-center py-8 text-gray-500">Nenhuma execucao realizada ainda.</p>';
            } else {
                execucoesHTML = `
                    <div class="space-y-3">
                        ${execucoes.map(e => `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <span class="font-medium text-gray-900">Execucao #${e.id}</span>
                                            <span class="px-2 py-0.5 rounded-full text-xs font-medium status-${e.status}">${e.status}</span>
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">
                                            <span><i class="fas fa-file-alt mr-1"></i>${e.arquivos_processados || 0}/${e.total_arquivos || 0} arquivos</span>
                                            <span class="ml-3"><i class="fas fa-check-circle text-green-500 mr-1"></i>${e.arquivos_sucesso || 0} sucesso</span>
                                            <span class="ml-3"><i class="fas fa-times-circle text-red-500 mr-1"></i>${e.arquivos_erro || 0} erros</span>
                                        </div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            ${e.iniciado_em ? `Iniciado: ${new Date(e.iniciado_em).toLocaleString()}` : ''}
                                            ${e.finalizado_em ? ` | Finalizado: ${new Date(e.finalizado_em).toLocaleString()}` : ''}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="verResultadosExecucao(${e.id})" class="px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-sm" title="Ver resultados">
                                            <i class="fas fa-eye mr-1"></i>Ver
                                        </button>
                                        <button onclick="exportarResultados(${e.id}, 'excel')" class="px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded text-sm" title="Exportar Excel">
                                            <i class="fas fa-file-excel"></i>
                                        </button>
                                        <button onclick="exportarResultados(${e.id}, 'csv')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm" title="Exportar CSV">
                                            <i class="fas fa-file-csv"></i>
                                        </button>
                                    </div>
                                </div>
                                ${e.progresso_percentual !== null && e.progresso_percentual !== undefined ? `
                                    <div class="mt-2">
                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                            <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${e.progresso_percentual}%"></div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Botao Voltar -->
                    <div class="flex items-center gap-3">
                        <button onclick="abrirProjeto(${p.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar aos detalhes
                        </button>
                        <span class="text-gray-400">|</span>
                        <h4 class="font-semibold text-gray-900">Historico de Execucoes</h4>
                    </div>

                    <!-- Lista de Execucoes -->
                    <div>
                        ${execucoesHTML}
                    </div>

                    <!-- Area de Resultados (inicialmente oculta) -->
                    <div id="areaResultadosExecucao" class="hidden">
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-900">Resultados da Classificacao</h4>
                                <button onclick="ocultarResultadosExecucao()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="tabelaResultadosExecucao" class="overflow-x-auto max-h-96">
                                <!-- Tabela de resultados -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function verResultadosExecucao(execucaoId) {
            const area = document.getElementById('areaResultadosExecucao');
            const tabela = document.getElementById('tabelaResultadosExecucao');

            if (!area || !tabela) return;

            area.classList.remove('hidden');
            tabela.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando resultados...</div>';

            try {
                const response = await fetchAPI(`/classificador/api/execucoes/${execucaoId}/resultados`);
                if (!response.ok) throw new Error('Erro ao carregar resultados');

                const resultados = await response.json();

                if (!resultados || resultados.length === 0) {
                    tabela.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum resultado encontrado.</div>';
                    return;
                }

                tabela.innerHTML = `
                    <div class="mb-3 flex gap-2">
                        <button onclick="exportarResultados(${execucaoId}, 'excel')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-sm">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                        <button onclick="exportarResultados(${execucaoId}, 'csv')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">
                            <i class="fas fa-file-csv mr-1"></i>CSV
                        </button>
                        <button onclick="exportarResultados(${execucaoId}, 'json')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">
                            <i class="fas fa-file-code mr-1"></i>JSON
                        </button>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Documento</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subcategoria</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Confianca</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Justificativa</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${resultados.map(r => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-sm text-gray-900">
                                        <div class="max-w-[150px] truncate" title="${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}">
                                            ${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-700">${SecurityUtils.escapeHtml(r.categoria || '-')}</td>
                                    <td class="px-3 py-2 text-sm text-gray-700">${SecurityUtils.escapeHtml(r.subcategoria || '-')}</td>
                                    <td class="px-3 py-2 text-sm">
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium confianca-${r.confianca || 'baixa'}">
                                            ${SecurityUtils.escapeHtml(r.confianca || '-')}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-600">
                                        <div class="max-w-[200px] truncate" title="${SecurityUtils.escapeHtml(r.justificativa || '-')}">
                                            ${SecurityUtils.escapeHtml(r.justificativa || '-')}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-xs text-gray-500 text-right">${resultados.length} resultado(s)</div>
                `;

                // Scroll para a area de resultados
                area.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                tabela.innerHTML = `<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Erro: ${SecurityUtils.escapeHtml(e.message)}</div>`;
            }
        }

        function ocultarResultadosExecucao() {
            const area = document.getElementById('areaResultadosExecucao');
            if (area) area.classList.add('hidden');
        }

        // ====================================
        // Classificacao Avulsa
        // ====================================
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const input = document.getElementById('arquivoAvulso');
            const nomeEl = document.getElementById('nomeArquivoAvulso');

            dropZone.addEventListener('click', () => input.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    atualizarNomeArquivo();
                }
            });
            input.addEventListener('change', atualizarNomeArquivo);

            function atualizarNomeArquivo() {
                if (input.files.length > 0) {
                    nomeEl.textContent = `Arquivo: ${input.files[0].name}`;
                    nomeEl.classList.remove('hidden');
                    // Preview o PDF no viewer
                    previewPdfUpload(input.files[0]);
                } else {
                    nomeEl.classList.add('hidden');
                    limparPdfViewer();
                }
            }
        }

        async function previewPdfUpload(file) {
            if (!file || file.type !== 'application/pdf') return;

            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = `<div class="text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p class="text-sm">Carregando PDF...</p>
            </div>`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfData = new Uint8Array(arrayBuffer);

                // Armazena como base64 para poder abrir em nova aba
                pdfBase64Data = btoa(String.fromCharCode.apply(null, pdfData));

                pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
                pdfTotalPaginas = pdfDoc.numPages;
                pdfPaginaAtual = 1;
                pdfZoomLevel = 0; // Fit inicial

                mostrarControlesPdf();
                atualizarInfoPagina();
                await renderizarPagina(pdfPaginaAtual);

            } catch (e) {
                console.error('Erro ao carregar PDF:', e);
                viewer.innerHTML = `<div class="text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">Erro ao carregar PDF</p>
                </div>`;
            }
        }

        async function classificarAvulso(e) {
            e.preventDefault();
            const arquivo = document.getElementById('arquivoAvulso').files[0];
            const promptId = document.getElementById('promptAvulso').value;
            const modelo = document.getElementById('modeloAvulso').value;
            const modo = document.getElementById('modoAvulso').value;
            const posicao = document.getElementById('posicaoAvulso').value;
            const tokens = document.getElementById('tokensAvulso').value;

            if (!arquivo) {
                alert('Selecione um arquivo PDF');
                return;
            }
            if (!promptId) {
                alert('Selecione um prompt');
                return;
            }

            const btn = document.getElementById('btnClassificarAvulso');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Classificando...';

            try {
                const formData = new FormData();
                formData.append('arquivo', arquivo);
                formData.append('prompt_id', promptId);
                formData.append('modelo', modelo);
                formData.append('modo_processamento', modo);
                formData.append('posicao_chunk', posicao);
                formData.append('tamanho_chunk', tokens);

                const response = await fetch('/classificador/api/classificar-avulso', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const resultado = await response.json();
                mostrarResultadoAvulso(resultado);

            } catch (e) {
                alert('Erro ao classificar documento');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Classificar Documento';
            }
        }

        function mostrarResultadoAvulso(resultado) {
            const container = document.getElementById('resultadoAvulso');
            const content = document.getElementById('resultadoAvulsoContent');

            if (resultado.sucesso) {
                // Info adicional do TJ-MS se disponivel
                const tjmsInfo = resultado.numero_processo ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 mb-3">
                        <p class="text-xs text-blue-800">
                            <i class="fas fa-gavel mr-1"></i>
                            <strong>Processo:</strong> ${SecurityUtils.escapeHtml(resultado.numero_processo)}
                            ${resultado.tipo_documento ? ` | <strong>Tipo:</strong> ${SecurityUtils.escapeHtml(resultado.tipo_documento)}` : ''}
                        </p>
                    </div>
                ` : '';

                content.innerHTML = `
                    <div class="space-y-3">
                        ${tjmsInfo}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Categoria:</span>
                            <span class="font-semibold">${SecurityUtils.escapeHtml(resultado.categoria || '-')}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Subcategoria:</span>
                            <span class="font-semibold">${SecurityUtils.escapeHtml(resultado.subcategoria || '-')}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Confianca:</span>
                            <span class="px-2 py-1 rounded text-sm font-medium confianca-${resultado.confianca}">${resultado.confianca}</span>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <p class="text-gray-600 text-sm mb-1">Justificativa:</p>
                            <p class="text-gray-900">${SecurityUtils.escapeHtml(resultado.justificativa || '-')}</p>
                        </div>
                        <div class="border-t pt-3 mt-3 text-xs text-gray-500">
                            <span>Extracao: ${resultado.texto_via || 'pdf'}</span>
                            <span class="ml-4">Tokens: ${resultado.tokens_usados || '-'}</span>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        ${SecurityUtils.escapeHtml(resultado.erro || 'Erro desconhecido')}
                    </div>
                `;
            }

            container.classList.remove('hidden');
        }

        // ====================================
        // Sub-Tabs (Novo Lote)
        // ====================================
        function showSubTab(subtabName) {
            // Esconde todos os sub-conteudos
            document.querySelectorAll('.subtab-content').forEach(el => el.classList.add('hidden'));
            // Remove active de todas as sub-tabs
            document.querySelectorAll('[id^="subtab-"]').forEach(el => {
                el.classList.remove('border-blue-500', 'text-blue-600');
                el.classList.add('text-gray-500', 'border-transparent');
            });
            // Mostra sub-conteudo selecionado
            document.getElementById(`subcontent-${subtabName}`).classList.remove('hidden');
            // Ativa sub-tab selecionada
            const subtab = document.getElementById(`subtab-${subtabName}`);
            subtab.classList.add('border-blue-500', 'text-blue-600');
            subtab.classList.remove('text-gray-500', 'border-transparent');
        }

        // ====================================
        // Novo Lote - Upload de Arquivos
        // ====================================
        let arquivosParaLote = [];

        function setupDropZoneLote() {
            const dropZone = document.getElementById('dropZoneLote');
            const input = document.getElementById('arquivosLote');

            if (!dropZone || !input) return;

            dropZone.addEventListener('click', () => input.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = Array.from(e.dataTransfer.files);
                adicionarArquivosLote(files);
            });

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                adicionarArquivosLote(files);
            });
        }

        function adicionarArquivosLote(files) {
            const validExtensions = ['.pdf', '.txt', '.zip'];
            const maxFileSize = 50 * 1024 * 1024; // 50MB
            const maxFiles = 2000;

            for (const file of files) {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(ext)) {
                    console.warn(`Arquivo ignorado (extensao invalida): ${file.name}`);
                    continue;
                }
                if (file.size > maxFileSize) {
                    console.warn(`Arquivo ignorado (muito grande): ${file.name}`);
                    continue;
                }
                if (arquivosParaLote.length >= maxFiles) {
                    alert(`Limite de ${maxFiles} arquivos atingido.`);
                    break;
                }
                // Evita duplicatas
                if (!arquivosParaLote.find(f => f.name === file.name && f.size === file.size)) {
                    arquivosParaLote.push(file);
                }
            }

            atualizarListaArquivosLote();
            atualizarBotaoIniciar();
        }

        function atualizarListaArquivosLote() {
            const container = document.getElementById('listaArquivosLote');
            const preview = document.getElementById('previewArquivos');
            const contador = document.getElementById('contadorArquivos');

            if (arquivosParaLote.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            contador.textContent = arquivosParaLote.length;

            preview.innerHTML = arquivosParaLote.map((file, idx) => `
                <div class="flex items-center justify-between p-2 hover:bg-gray-50">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-file-${file.name.endsWith('.pdf') ? 'pdf text-red-500' : 'alt text-gray-400'}"></i>
                        <span class="text-sm text-gray-700">${SecurityUtils.escapeHtml(file.name)}</span>
                        <span class="text-xs text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removerArquivoLote(${idx})" class="text-gray-400 hover:text-red-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removerArquivoLote(idx) {
            arquivosParaLote.splice(idx, 1);
            atualizarListaArquivosLote();
            atualizarBotaoIniciar();
        }

        function limparArquivosLote() {
            arquivosParaLote = [];
            atualizarListaArquivosLote();
            atualizarBotaoIniciar();
        }

        // ====================================
        // Novo Lote - TJ-MS
        // ====================================
        // Mapa de categorias de documentos do TJ-MS (conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 4.2)
        const CATEGORIAS_TJMS = {
            "8": "Sentenca",
            "15": "Decisoes Interlocutorias",
            "34": "Acordaos",
            "44": "Decisoes Monocraticas",
            "137": "Decisao Interlocutoria",
            "500": "Peticao Inicial",
            "510": "Peticao Intermediaria",
            "8305": "Contrarrazoes de Apelacao",
            "8320": "Contestacao",
            "8335": "Recurso de Apelacao",
            "8369": "Laudo Pericial",
            "9500": "Peticao",
            "1": "Mandado",
            "2": "Certidao",
            "6": "Despacho",
            "7": "Oficio"
        };

        let tiposSelecionadosTJMS = new Set(["8", "15", "34", "500", "9500"]); // Default

        function popularTiposDocumentos() {
            const disponiveis = document.getElementById('tiposDisponiveis');
            const selecionados = document.getElementById('tiposSelecionados');

            if (!disponiveis || !selecionados) return;

            disponiveis.innerHTML = Object.entries(CATEGORIAS_TJMS)
                .filter(([cod]) => !tiposSelecionadosTJMS.has(cod))
                .map(([cod, nome]) => `
                    <div class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded cursor-pointer" onclick="selecionarTipo('${cod}')">
                        <span class="text-xs text-gray-500">${cod}</span>
                        <span class="text-sm">${SecurityUtils.escapeHtml(nome)}</span>
                    </div>
                `).join('');

            selecionados.innerHTML = Array.from(tiposSelecionadosTJMS)
                .map(cod => `
                    <div class="flex items-center gap-2 p-1 hover:bg-blue-100 rounded cursor-pointer" onclick="desselecionarTipo('${cod}')">
                        <span class="text-xs text-blue-600">${cod}</span>
                        <span class="text-sm">${SecurityUtils.escapeHtml(CATEGORIAS_TJMS[cod] || cod)}</span>
                    </div>
                `).join('');
        }

        function selecionarTipo(cod) {
            tiposSelecionadosTJMS.add(cod);
            popularTiposDocumentos();
        }

        function desselecionarTipo(cod) {
            tiposSelecionadosTJMS.delete(cod);
            popularTiposDocumentos();
        }

        function adicionarTipoSelecionado() {
            // Seleciona o primeiro disponivel
            const disponiveis = Object.keys(CATEGORIAS_TJMS).filter(cod => !tiposSelecionadosTJMS.has(cod));
            if (disponiveis.length > 0) {
                selecionarTipo(disponiveis[0]);
            }
        }

        function removerTipoSelecionado() {
            // Remove o ultimo selecionado
            const arr = Array.from(tiposSelecionadosTJMS);
            if (arr.length > 0) {
                desselecionarTipo(arr[arr.length - 1]);
            }
        }

        function adicionarTodosTipos() {
            Object.keys(CATEGORIAS_TJMS).forEach(cod => tiposSelecionadosTJMS.add(cod));
            popularTiposDocumentos();
        }

        function adicionarCodigosLote() {
            const input = document.getElementById('codigosTiposLote');
            const codigos = input.value.split(/[,\s;]+/).map(c => c.trim()).filter(c => c);
            codigos.forEach(cod => {
                if (CATEGORIAS_TJMS[cod] || cod.match(/^\d+$/)) {
                    tiposSelecionadosTJMS.add(cod);
                }
            });
            input.value = '';
            popularTiposDocumentos();
        }

        function contarProcessos() {
            const textarea = document.getElementById('processosLote');
            const contador = document.getElementById('contadorProcessos');
            if (!textarea || !contador) return 0;

            const processos = textarea.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            contador.textContent = `Total: ${processos.length} processos`;
            return processos.length;
        }

        // ====================================
        // Novo Lote - Validacao e Inicio
        // ====================================
        function atualizarBotaoIniciar() {
            const btn = document.getElementById('btnIniciarLote');
            const promptSelect = document.getElementById('promptLote');
            if (!btn || !promptSelect) return;

            const temArquivos = arquivosParaLote.length > 0;
            const temProcessos = contarProcessos() > 0;
            const temPrompt = promptSelect.value !== '';

            btn.disabled = !(temPrompt && (temArquivos || temProcessos));
        }

        async function iniciarClassificacaoLote() {
            const btn = document.getElementById('btnIniciarLote');
            const areaProgresso = document.getElementById('areaProgressoLote');
            const logProgresso = document.getElementById('logProgressoLote');

            btn.disabled = true;
            areaProgresso.classList.remove('hidden');
            logProgresso.innerHTML = '';

            const nomeLote = document.getElementById('nomeLote').value || `Lote ${new Date().toLocaleString()}`;
            const promptId = document.getElementById('promptLote').value;
            const modelo = document.getElementById('modeloLote').value;
            const modo = document.querySelector('input[name="modoLote"]:checked').value;
            const tamanhoChunk = document.getElementById('tamanhoChunkLote').value;
            const posicaoChunk = document.getElementById('posicaoChunkLote').value;

            // Log inicio
            adicionarLogLote(`Iniciando lote: ${nomeLote}`);
            adicionarLogLote(`Prompt ID: ${promptId} | Modelo: ${modelo}`);

            try {
                // 1. Criar o lote (projeto)
                adicionarLogLote('Criando lote...');
                const response = await fetchAPI('/classificador/api/projetos', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome: nomeLote,
                        prompt_id: parseInt(promptId),
                        modelo: modelo,
                        modo_processamento: modo,
                        tamanho_chunk: parseInt(tamanhoChunk),
                        posicao_chunk: posicaoChunk
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro ao criar lote: ${response.status}`);
                }

                const lote = await response.json();
                adicionarLogLote(`Lote criado: ID ${lote.id}`);

                // 2. Adicionar arquivos (se houver upload)
                if (arquivosParaLote.length > 0) {
                    adicionarLogLote(`Enviando ${arquivosParaLote.length} arquivos...`);
                    await uploadArquivosParaLote(lote.id);
                }

                // 3. Adicionar processos TJ-MS (se houver)
                const processos = document.getElementById('processosLote').value.split('\n').map(l => l.trim()).filter(l => l);
                if (processos.length > 0) {
                    adicionarLogLote(`Adicionando ${processos.length} processos do TJ-MS...`);
                    await adicionarProcessosTJMS(lote.id, processos);
                }

                // 4. Executar classificacao
                adicionarLogLote('Iniciando classificacao...');
                await executarClassificacaoLote(lote.id);

            } catch (e) {
                adicionarLogLote(`ERRO: ${e.message}`, 'error');
                btn.disabled = false;
            }
        }

        async function uploadArquivosParaLote(loteId) {
            // Upload real dos arquivos para o backend
            const formData = new FormData();
            for (const file of arquivosParaLote) {
                formData.append('arquivos', file);
                adicionarLogLote(`  - ${file.name}`);
            }

            try {
                const response = await fetch(`/classificador/api/lotes/${loteId}/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'  // Inclui cookie de autenticacao
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Erro HTTP ${response.status}`);
                }

                const result = await response.json();
                adicionarLogLote(`${result.adicionados || arquivosParaLote.length} arquivos enviados com sucesso.`, 'success');

                if (result.erros && result.erros > 0) {
                    adicionarLogLote(`${result.erros} arquivo(s) com erro.`, 'error');
                    if (result.detalhes_erros) {
                        result.detalhes_erros.forEach(e => {
                            adicionarLogLote(`  ! ${e.arquivo}: ${e.erro}`, 'error');
                        });
                    }
                }

                return result;
            } catch (e) {
                adicionarLogLote(`Erro no upload: ${e.message}`, 'error');
                throw e;
            }
        }

        async function adicionarProcessosTJMS(loteId, processos) {
            const tipos = Array.from(tiposSelecionadosTJMS);
            adicionarLogLote(`Tipos de documentos: ${tipos.join(', ')}`);

            // TODO: Implementar adicao de processos TJ-MS no backend
            // Por enquanto, adiciona como codigos manuais
            for (const processo of processos) {
                try {
                    await fetchAPI(`/classificador/api/projetos/${loteId}/codigos`, {
                        method: 'POST',
                        body: JSON.stringify({
                            codigos: [{ codigo: processo, numero_processo: processo, fonte: 'tjms' }]
                        })
                    });
                    adicionarLogLote(`  + ${processo}`);
                } catch (e) {
                    adicionarLogLote(`  ! Erro: ${processo}`, 'error');
                }
            }
        }

        async function executarClassificacaoLote(loteId) {
            // Usa SSE para progresso em tempo real
            // IMPORTANTE: O token é armazenado como 'access_token' no localStorage
            const eventSource = new EventSource(`/classificador/api/projetos/${loteId}/executar?token=${localStorage.getItem('access_token')}`);
            let recebeuEvento = false;
            let ultimoErro = null;

            eventSource.onmessage = (event) => {
                recebeuEvento = true;
                try {
                    const data = JSON.parse(event.data);
                    console.log('[SSE] Evento recebido:', data);

                    // Log da mensagem
                    if (data.mensagem) {
                        const tipo = data.tipo === 'erro' ? 'error' : (data.tipo === 'concluido' ? 'success' : 'info');
                        adicionarLogLote(data.mensagem, tipo);
                    }

                    // Atualiza progresso - backend envia processados/total diretamente
                    if (data.processados !== undefined && data.total !== undefined) {
                        atualizarBarraProgresso(data.processados, data.total);
                    }

                    // Eventos de conclusao ou erro
                    if (data.tipo === 'concluido') {
                        adicionarLogLote(`Sucesso: ${data.sucesso || 0} | Erros: ${data.erros || 0}`, 'success');
                        eventSource.close();
                        document.getElementById('statusProgressoLote').textContent = 'Concluido!';
                        mostrarResultadosLote(loteId, data.execucao_id);
                    } else if (data.tipo === 'erro') {
                        ultimoErro = data.mensagem;
                        eventSource.close();
                        document.getElementById('statusProgressoLote').textContent = 'Erro';
                        mostrarResultadosLote(loteId);
                    } else if (data.tipo === 'inicio') {
                        // Inicializa o total na barra de progresso
                        document.getElementById('statusProgressoLote').textContent = 'Processando...';
                    }
                } catch (e) {
                    console.error('[SSE] Erro ao processar evento:', e, event.data);
                    adicionarLogLote(`Erro ao processar evento: ${e.message}`, 'error');
                }
            };

            eventSource.onerror = (e) => {
                console.error('[SSE] Erro na conexao:', e);
                eventSource.close();

                if (!recebeuEvento) {
                    // Conexao falhou antes de receber qualquer evento - provavelmente erro de auth ou servidor
                    adicionarLogLote('Erro: Conexao falhou antes de iniciar. Verifique se voce esta autenticado.', 'error');
                    document.getElementById('statusProgressoLote').textContent = 'Erro de conexao';
                } else if (ultimoErro) {
                    adicionarLogLote(`Conexao encerrada: ${ultimoErro}`, 'error');
                } else {
                    adicionarLogLote('Conexao encerrada.', 'info');
                }
                mostrarResultadosLote(loteId);
            };

            eventSource.onopen = () => {
                console.log('[SSE] Conexao aberta com sucesso');
                adicionarLogLote('Conexao estabelecida, aguardando eventos...', 'info');
            };
        }

        function adicionarLogLote(msg, tipo = 'info') {
            const log = document.getElementById('logProgressoLote');
            const timestamp = new Date().toLocaleTimeString();
            const cor = tipo === 'error' ? 'text-red-600' : (tipo === 'success' ? 'text-green-600' : 'text-gray-600');
            log.innerHTML += `<div class="${cor}">[${timestamp}] ${SecurityUtils.escapeHtml(msg)}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function atualizarBarraProgresso(atual, total) {
            const barra = document.getElementById('barraProgressoLote');
            const contador = document.getElementById('contadorProgressoLote');
            const pct = total > 0 ? (atual / total * 100) : 0;
            barra.style.width = `${pct}%`;
            contador.textContent = `${atual} / ${total}`;
        }

        async function mostrarResultadosLote(loteId, execucaoId = null) {
            const areaResultados = document.getElementById('areaResultadosLote');
            areaResultados.classList.remove('hidden');
            document.getElementById('btnIniciarLote').disabled = false;

            // Armazena o execucaoId para exportacao
            execucaoIdAtual = execucaoId;

            if (execucaoId) {
                document.getElementById('resumoResultadosLote').innerHTML = `
                    <p class="text-gray-600 mb-3">Lote #${loteId} concluido (execucao #${execucaoId}).</p>
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="showTab('meusLotes'); carregarProjetos();" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>Ver em Meus Lotes
                        </button>
                        <button onclick="exportarResultados(${execucaoId}, 'excel')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                        </button>
                        <button onclick="toggleTabelaResultados()" id="btnToggleTabela" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            <i class="fas fa-table mr-2"></i>Ver Classificacoes
                        </button>
                    </div>
                `;
                // Carrega os resultados para a tabela
                await carregarResultadosTabela(execucaoId);
            } else {
                document.getElementById('resumoResultadosLote').innerHTML = `
                    <p class="text-gray-600">Lote #${loteId} processado. Veja os resultados em "Meus Lotes".</p>
                    <button onclick="showTab('meusLotes'); carregarProjetos();" class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>Ver em Meus Lotes
                    </button>
                `;
            }
        }

        let tabelaResultadosVisivel = false;

        function toggleTabelaResultados() {
            const tabela = document.getElementById('tabelaResultadosLote');
            const btn = document.getElementById('btnToggleTabela');
            tabelaResultadosVisivel = !tabelaResultadosVisivel;

            if (tabelaResultadosVisivel) {
                tabela.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-table mr-2"></i>Ocultar Classificacoes';
            } else {
                tabela.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-table mr-2"></i>Ver Classificacoes';
            }
        }

        async function carregarResultadosTabela(execucaoId) {
            const tabela = document.getElementById('tabelaResultadosLote');
            tabela.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando resultados...</div>';
            tabela.classList.add('hidden'); // Comeca oculta
            tabelaResultadosVisivel = false;

            try {
                const response = await fetch(`/classificador/api/execucoes/${execucaoId}/resultados`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Erro ao carregar resultados');

                const resultados = await response.json();

                if (!resultados || resultados.length === 0) {
                    tabela.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum resultado encontrado.</div>';
                    return;
                }

                // Monta a tabela
                tabela.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subcategoria</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confianca</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Justificativa</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${resultados.map(r => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        <div class="max-w-xs truncate" title="${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}">
                                            ${SecurityUtils.escapeHtml(r.nome_arquivo || r.codigo_documento || '-')}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${SecurityUtils.escapeHtml(r.categoria || '-')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${SecurityUtils.escapeHtml(r.subcategoria || '-')}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium confianca-${r.confianca || 'baixa'}">
                                            ${SecurityUtils.escapeHtml(r.confianca || '-')}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        <div class="max-w-md truncate" title="${SecurityUtils.escapeHtml(r.justificativa || '-')}">
                                            ${SecurityUtils.escapeHtml(r.justificativa || '-')}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-xs text-gray-500 text-right">${resultados.length} resultado(s)</div>
                `;
            } catch (e) {
                tabela.innerHTML = `<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Erro ao carregar: ${SecurityUtils.escapeHtml(e.message)}</div>`;
            }
        }

        async function exportarResultados(execucaoId, formato) {
            try {
                const response = await fetch(`/classificador/api/execucoes/${execucaoId}/exportar/${formato}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Erro ao exportar');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `classificacao_${execucaoId}.${formato === 'excel' ? 'xlsx' : formato}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (e) {
                alert('Erro ao exportar: ' + e.message);
            }
        }

        function pausarLote() {
            adicionarLogLote('Pausar ainda nao implementado.', 'info');
        }

        function cancelarLote() {
            if (confirm('Tem certeza que deseja cancelar?')) {
                adicionarLogLote('Cancelado pelo usuario.', 'error');
                document.getElementById('btnIniciarLote').disabled = false;
            }
        }

        // Armazena o ID da execucao atual para exportacao
        let execucaoIdAtual = null;

        function exportarResultadosLote(formato) {
            if (!execucaoIdAtual) {
                alert('Nenhuma execucao disponivel para exportar. Execute uma classificacao primeiro.');
                return;
            }
            exportarResultados(execucaoIdAtual, formato);
        }

        // ====================================
        // Filtro de ano (TJ-MS)
        // ====================================
        function setupFiltroAno() {
            const checkbox = document.getElementById('filtrarPorAno');
            const inputAnos = document.getElementById('anosFiltro');
            const selectMes = document.getElementById('mesFiltro');

            if (!checkbox) return;

            checkbox.addEventListener('change', () => {
                inputAnos.disabled = !checkbox.checked;
                selectMes.disabled = !checkbox.checked;
            });
        }

        // ====================================
        // Atualizar selects de prompt
        // ====================================
        function atualizarSelectsPromptLote() {
            const selectLote = document.getElementById('promptLote');
            if (!selectLote) return;

            selectLote.innerHTML = '<option value="">Selecione um prompt...</option>';
            prompts.forEach(p => {
                selectLote.innerHTML += `<option value="${p.id}">${SecurityUtils.escapeHtml(p.nome)}</option>`;
            });
        }

        // ====================================
        // Teste Rapido: Sub-tabs e TJ-MS
        // ====================================

        // Estado do PDF viewer
        let pdfDoc = null;
        let pdfPaginaAtual = 1;
        let pdfTotalPaginas = 0;
        let pdfZoomLevel = 1.0;           // Nivel de zoom atual (1.0 = 100%)
        let pdfZoomMin = 0.5;             // Zoom minimo (50%)
        let pdfZoomMax = 3.0;             // Zoom maximo (300%)
        let pdfZoomStep = 0.25;           // Incremento do zoom
        let pdfFullscreenZoomLevel = 1.0; // Zoom separado para fullscreen
        let pdfBase64Data = null;         // Armazena o PDF em base64 para abrir em nova aba
        let testeDocumentoSelecionado = null;  // {id_documento, numero_processo, tipo, base64}
        let testeDocumentosTJMS = [];  // Lista de documentos encontrados

        function showTesteSubTab(tab) {
            // Atualiza botoes das sub-tabs
            document.getElementById('teste-subtab-upload').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('teste-subtab-upload').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('teste-subtab-tjms').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('teste-subtab-tjms').classList.add('border-transparent', 'text-gray-500');

            // Oculta todos os conteudos
            document.getElementById('teste-subcontent-upload').classList.add('hidden');
            document.getElementById('teste-subcontent-tjms').classList.add('hidden');

            // Mostra o selecionado
            if (tab === 'upload') {
                document.getElementById('teste-subtab-upload').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('teste-subtab-upload').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('teste-subcontent-upload').classList.remove('hidden');
            } else {
                document.getElementById('teste-subtab-tjms').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('teste-subtab-tjms').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('teste-subcontent-tjms').classList.remove('hidden');
            }

            // Limpa visualizacao ao trocar de tab
            limparPdfViewer();
        }

        async function buscarDocumentosTJMSTeste() {
            const numProcesso = document.getElementById('testeProcessoCNJ').value.trim();
            if (!numProcesso) {
                alert('Digite o numero do processo');
                return;
            }

            // Coleta tipos selecionados
            const tiposSelecionados = [];
            document.querySelectorAll('.teste-tipo-doc:checked').forEach(cb => {
                tiposSelecionados.push(cb.value);
            });

            if (tiposSelecionados.length === 0) {
                alert('Selecione pelo menos um tipo de documento');
                return;
            }

            try {
                // Busca documentos do processo
                const response = await fetch('/classificador/api/tjms/consultar-processo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ numero_cnj: numProcesso })
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'Erro ao consultar processo');
                    return;
                }

                // Filtra por tipos selecionados
                testeDocumentosTJMS = data.documentos.filter(doc =>
                    tiposSelecionados.includes(String(doc.tipoDocumento))
                );

                // Popula lista
                const container = document.getElementById('testeDocsTJMS');
                const lista = document.getElementById('testeDocsTJMSLista');

                if (testeDocumentosTJMS.length === 0) {
                    lista.innerHTML = `<div class="p-3 text-gray-500 text-sm text-center">
                        Nenhum documento encontrado com os tipos selecionados
                    </div>`;
                } else {
                    lista.innerHTML = testeDocumentosTJMS.map((doc, idx) => `
                        <div class="p-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2" onclick="selecionarDocumentoTeste(${idx})">
                            <input type="radio" name="docTesteRadio" id="docTeste${idx}" class="text-blue-600">
                            <label for="docTeste${idx}" class="flex-1 cursor-pointer">
                                <span class="text-xs font-medium text-gray-900">${SecurityUtils.escapeHtml(doc.descricaoTipoDocumento || 'Documento')}</span>
                                <span class="text-xs text-gray-500 ml-2">ID: ${doc.idDocumento}</span>
                            </label>
                        </div>
                    `).join('');
                }

                container.classList.remove('hidden');

            } catch (e) {
                console.error('Erro ao buscar documentos:', e);
                alert('Erro ao buscar documentos do TJ-MS');
            }
        }

        async function selecionarDocumentoTeste(idx) {
            const doc = testeDocumentosTJMS[idx];
            if (!doc) return;

            // Marca o radio
            document.getElementById(`docTeste${idx}`).checked = true;

            // Armazena documento selecionado
            testeDocumentoSelecionado = {
                id_documento: doc.idDocumento,
                numero_processo: document.getElementById('testeProcessoCNJ').value.trim(),
                tipo: doc.tipoDocumento,
                descricao: doc.descricaoTipoDocumento
            };

            // Baixa e exibe o PDF
            await carregarPdfTJMS(testeDocumentoSelecionado.numero_processo, testeDocumentoSelecionado.id_documento);
        }

        async function carregarPdfTJMS(numProcesso, idDocumento) {
            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = `<div class="text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p class="text-sm">Baixando documento...</p>
            </div>`;

            try {
                const response = await fetch('/classificador/api/tjms/baixar-documento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        numero_cnj: numProcesso,
                        id_documento: idDocumento
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Erro ao baixar documento');
                }

                // Armazena base64 para classificacao
                testeDocumentoSelecionado.base64 = data.conteudo_base64;

                // Renderiza o PDF
                await renderizarPdfBase64(data.conteudo_base64);

            } catch (e) {
                console.error('Erro ao carregar PDF:', e);
                viewer.innerHTML = `<div class="text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">${SecurityUtils.escapeHtml(e.message)}</p>
                </div>`;
            }
        }

        async function renderizarPdfBase64(base64) {
            const viewer = document.getElementById('pdfViewer');

            try {
                // Armazena base64 para poder abrir em nova aba
                pdfBase64Data = base64;

                // Decodifica base64 para Uint8Array
                const pdfData = atob(base64);
                const pdfArray = new Uint8Array(pdfData.length);
                for (let i = 0; i < pdfData.length; i++) {
                    pdfArray[i] = pdfData.charCodeAt(i);
                }

                // Carrega o documento com PDF.js
                pdfDoc = await pdfjsLib.getDocument({ data: pdfArray }).promise;
                pdfTotalPaginas = pdfDoc.numPages;
                pdfPaginaAtual = 1;
                pdfZoomLevel = 0; // Fit inicial

                // Mostra controles
                mostrarControlesPdf();
                atualizarInfoPagina();

                // Renderiza primeira pagina
                await renderizarPagina(pdfPaginaAtual);

            } catch (e) {
                console.error('Erro ao renderizar PDF:', e);
                viewer.innerHTML = `<div class="text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">Erro ao renderizar PDF</p>
                </div>`;
            }
        }

        async function renderizarPagina(numPagina, targetViewer = 'pdfViewer', customZoom = null) {
            const viewer = document.getElementById(targetViewer);
            if (!pdfDoc || !viewer) return;

            try {
                const page = await pdfDoc.getPage(numPagina);
                const originalViewport = page.getViewport({ scale: 1 });

                // Determina o zoom a usar
                let zoom = customZoom;
                if (zoom === null) {
                    zoom = targetViewer === 'pdfFullscreenViewer' ? pdfFullscreenZoomLevel : pdfZoomLevel;
                }

                // Se zoom = 0, calcula para ajustar ao container (fit)
                if (zoom === 0) {
                    const containerWidth = viewer.clientWidth - 32;
                    const containerHeight = viewer.clientHeight - 32;
                    const scaleWidth = containerWidth / originalViewport.width;
                    const scaleHeight = containerHeight / originalViewport.height;
                    zoom = Math.min(scaleWidth, scaleHeight);

                    // Atualiza o nivel de zoom para refletir o fit
                    if (targetViewer === 'pdfFullscreenViewer') {
                        pdfFullscreenZoomLevel = zoom;
                    } else {
                        pdfZoomLevel = zoom;
                    }
                }

                const viewport = page.getViewport({ scale: zoom });

                // Cria canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.display = 'block';
                canvas.style.margin = 'auto';
                canvas.style.maxWidth = 'none'; // Permite que ultrapasse o container com zoom

                viewer.innerHTML = '';
                viewer.appendChild(canvas);

                // Renderiza
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                // Atualiza indicador de zoom
                atualizarInfoZoom(targetViewer);

            } catch (e) {
                console.error('Erro ao renderizar pagina:', e);
            }
        }

        function atualizarInfoPagina() {
            document.getElementById('pdfPaginaInfo').textContent = `${pdfPaginaAtual} / ${pdfTotalPaginas}`;
            const fullscreenInfo = document.getElementById('pdfFullscreenPaginaInfo');
            if (fullscreenInfo) {
                fullscreenInfo.textContent = `${pdfPaginaAtual} / ${pdfTotalPaginas}`;
            }
        }

        function atualizarInfoZoom(targetViewer = 'pdfViewer') {
            const zoom = targetViewer === 'pdfFullscreenViewer' ? pdfFullscreenZoomLevel : pdfZoomLevel;
            const percentage = Math.round(zoom * 100);
            const infoId = targetViewer === 'pdfFullscreenViewer' ? 'pdfFullscreenZoomInfo' : 'pdfZoomInfo';
            const info = document.getElementById(infoId);
            if (info) {
                info.textContent = `${percentage}%`;
            }
        }

        function pdfPaginaAnterior() {
            if (pdfPaginaAtual > 1) {
                pdfPaginaAtual--;
                atualizarInfoPagina();
                renderizarPagina(pdfPaginaAtual);
            }
        }

        function pdfProximaPagina() {
            if (pdfPaginaAtual < pdfTotalPaginas) {
                pdfPaginaAtual++;
                atualizarInfoPagina();
                renderizarPagina(pdfPaginaAtual);
            }
        }

        // ====================================
        // Controles de Zoom
        // ====================================
        function pdfZoomIn() {
            if (pdfZoomLevel < pdfZoomMax) {
                pdfZoomLevel = Math.min(pdfZoomLevel + pdfZoomStep, pdfZoomMax);
                renderizarPagina(pdfPaginaAtual);
            }
        }

        function pdfZoomOut() {
            if (pdfZoomLevel > pdfZoomMin) {
                pdfZoomLevel = Math.max(pdfZoomLevel - pdfZoomStep, pdfZoomMin);
                renderizarPagina(pdfPaginaAtual);
            }
        }

        function pdfZoomFit() {
            pdfZoomLevel = 0; // 0 = fit to container
            renderizarPagina(pdfPaginaAtual);
        }

        // ====================================
        // Fullscreen
        // ====================================
        function pdfFullscreen() {
            if (!pdfDoc) return;

            const modal = document.getElementById('modalPdfFullscreen');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Reseta zoom do fullscreen e renderiza
            pdfFullscreenZoomLevel = 0; // Fit inicial
            atualizarInfoPagina();
            renderizarPagina(pdfPaginaAtual, 'pdfFullscreenViewer');

            // Listener para tecla ESC
            document.addEventListener('keydown', fecharPdfFullscreenEsc);
        }

        function fecharPdfFullscreen() {
            const modal = document.getElementById('modalPdfFullscreen');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            document.removeEventListener('keydown', fecharPdfFullscreenEsc);
        }

        function fecharPdfFullscreenEsc(e) {
            if (e.key === 'Escape') {
                fecharPdfFullscreen();
            }
        }

        function pdfFullscreenPaginaAnterior() {
            if (pdfPaginaAtual > 1) {
                pdfPaginaAtual--;
                atualizarInfoPagina();
                renderizarPagina(pdfPaginaAtual, 'pdfFullscreenViewer');
                renderizarPagina(pdfPaginaAtual, 'pdfViewer'); // Sincroniza viewer principal
            }
        }

        function pdfFullscreenProximaPagina() {
            if (pdfPaginaAtual < pdfTotalPaginas) {
                pdfPaginaAtual++;
                atualizarInfoPagina();
                renderizarPagina(pdfPaginaAtual, 'pdfFullscreenViewer');
                renderizarPagina(pdfPaginaAtual, 'pdfViewer'); // Sincroniza viewer principal
            }
        }

        function pdfFullscreenZoomIn() {
            if (pdfFullscreenZoomLevel < pdfZoomMax) {
                pdfFullscreenZoomLevel = Math.min(pdfFullscreenZoomLevel + pdfZoomStep, pdfZoomMax);
                renderizarPagina(pdfPaginaAtual, 'pdfFullscreenViewer');
            }
        }

        function pdfFullscreenZoomOut() {
            if (pdfFullscreenZoomLevel > pdfZoomMin) {
                pdfFullscreenZoomLevel = Math.max(pdfFullscreenZoomLevel - pdfZoomStep, pdfZoomMin);
                renderizarPagina(pdfPaginaAtual, 'pdfFullscreenViewer');
            }
        }

        function pdfFullscreenZoomFit() {
            pdfFullscreenZoomLevel = 0;
            renderizarPagina(pdfPaginaAtual, 'pdfFullscreenViewer');
        }

        // ====================================
        // Abrir em nova aba
        // ====================================
        function pdfAbrirNovaAba() {
            if (!pdfBase64Data) {
                alert('Nenhum documento carregado');
                return;
            }

            // Cria blob a partir do base64
            const byteCharacters = atob(pdfBase64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);

            window.open(url, '_blank');
        }

        // ====================================
        // Mostrar controles do PDF
        // ====================================
        function mostrarControlesPdf() {
            document.getElementById('pdfControles').classList.remove('hidden');
            document.getElementById('pdfDica').classList.remove('hidden');
            // Remove navegacao antiga se existir
            const navAntiga = document.getElementById('pdfNavegacao');
            if (navAntiga) navAntiga.classList.add('hidden');
        }

        function esconderControlesPdf() {
            document.getElementById('pdfControles').classList.add('hidden');
            document.getElementById('pdfDica').classList.add('hidden');
        }

        function limparPdfViewer() {
            pdfDoc = null;
            pdfPaginaAtual = 1;
            pdfTotalPaginas = 0;
            pdfZoomLevel = 1.0;
            pdfBase64Data = null;
            testeDocumentoSelecionado = null;
            esconderControlesPdf();
            document.getElementById('pdfViewer').innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fas fa-file-pdf text-4xl mb-2"></i>
                    <p class="text-sm">Nenhum documento carregado</p>
                </div>
            `;
        }

        // ====================================
        // Scroll para zoom (mouse wheel)
        // ====================================
        function setupPdfWheelZoom() {
            const viewer = document.getElementById('pdfViewer');
            if (viewer) {
                viewer.addEventListener('wheel', (e) => {
                    if (e.ctrlKey && pdfDoc) {
                        e.preventDefault();
                        if (e.deltaY < 0) {
                            pdfZoomIn();
                        } else {
                            pdfZoomOut();
                        }
                    }
                }, { passive: false });
            }

            const fullscreenViewer = document.getElementById('pdfFullscreenViewer');
            if (fullscreenViewer) {
                fullscreenViewer.addEventListener('wheel', (e) => {
                    if (e.ctrlKey && pdfDoc) {
                        e.preventDefault();
                        if (e.deltaY < 0) {
                            pdfFullscreenZoomIn();
                        } else {
                            pdfFullscreenZoomOut();
                        }
                    }
                }, { passive: false });
            }
        }

        // Inicializa wheel zoom quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', setupPdfWheelZoom);

        async function classificarTesteRapido() {
            const promptId = document.getElementById('promptAvulso').value;
            const modelo = document.getElementById('modeloAvulso').value;
            const modo = document.getElementById('modoAvulso').value;
            const posicao = document.getElementById('posicaoAvulso').value;
            const tokens = document.getElementById('tokensAvulso').value;

            if (!promptId) {
                alert('Selecione um prompt');
                return;
            }

            const btn = document.getElementById('btnClassificarAvulso');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Classificando...';

            try {
                // Verifica se esta usando upload ou TJ-MS
                const uploadVisible = !document.getElementById('teste-subcontent-upload').classList.contains('hidden');

                if (uploadVisible) {
                    // Modo upload - usa o form original
                    const arquivo = document.getElementById('arquivoAvulso').files[0];
                    if (!arquivo) {
                        alert('Selecione um arquivo PDF');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('arquivo', arquivo);
                    formData.append('prompt_id', promptId);
                    formData.append('modelo', modelo);
                    formData.append('modo_processamento', modo);
                    formData.append('posicao_chunk', posicao);
                    formData.append('tamanho_chunk', tokens);

                    const response = await fetch('/classificador/api/classificar-avulso', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    const resultado = await response.json();
                    mostrarResultadoAvulso(resultado);

                } else {
                    // Modo TJ-MS - envia base64
                    if (!testeDocumentoSelecionado || !testeDocumentoSelecionado.base64) {
                        alert('Selecione um documento da lista');
                        return;
                    }

                    // Converte base64 para blob e envia como arquivo
                    const byteCharacters = atob(testeDocumentoSelecionado.base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const file = new File([blob], `${testeDocumentoSelecionado.id_documento}.pdf`, { type: 'application/pdf' });

                    const formData = new FormData();
                    formData.append('arquivo', file);
                    formData.append('prompt_id', promptId);
                    formData.append('modelo', modelo);
                    formData.append('modo_processamento', modo);
                    formData.append('posicao_chunk', posicao);
                    formData.append('tamanho_chunk', tokens);

                    const response = await fetch('/classificador/api/classificar-avulso', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    const resultado = await response.json();
                    resultado.numero_processo = testeDocumentoSelecionado.numero_processo;
                    resultado.id_documento = testeDocumentoSelecionado.id_documento;
                    resultado.tipo_documento = testeDocumentoSelecionado.descricao;
                    mostrarResultadoAvulso(resultado);
                }

            } catch (e) {
                console.error('Erro ao classificar:', e);
                alert('Erro ao classificar documento');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Classificar';
            }
        }

        // ====================================
        // Event Listeners
        // ====================================
        document.getElementById('formPrompt')?.addEventListener('submit', salvarPrompt);
        document.getElementById('formProjeto')?.addEventListener('submit', salvarProjeto);
        document.getElementById('formAvulso')?.addEventListener('submit', classificarAvulso);

        // Novos event listeners para Novo Lote
        document.getElementById('promptLote')?.addEventListener('change', () => {
            atualizarBotaoIniciar();
            preSelectTiposDocumentoPrompt();
        });
        document.getElementById('processosLote')?.addEventListener('input', () => {
            contarProcessos();
            atualizarBotaoIniciar();
        });

        // Event listener para Teste Rapido
        document.getElementById('promptAvulso')?.addEventListener('change', preSelectTiposDocumentoTesteRapido);

        // Pre-seleciona tipos de documento no Teste Rapido baseado nos codigos do prompt
        function preSelectTiposDocumentoTesteRapido() {
            const promptId = document.getElementById('promptAvulso').value;
            if (!promptId) return;

            const prompt = prompts.find(p => p.id === parseInt(promptId));
            if (!prompt || !prompt.codigos_documento) return;

            // Parseia os codigos do prompt
            const codigos = prompt.codigos_documento.split(',').map(c => c.trim()).filter(c => c);
            if (codigos.length === 0) return;

            // Desmarca todos os checkboxes primeiro
            document.querySelectorAll('.teste-tipo-doc').forEach(cb => {
                cb.checked = false;
            });

            // Marca os checkboxes dos codigos do prompt
            let nomesAdicionados = [];
            codigos.forEach(codigo => {
                const checkbox = document.querySelector(`.teste-tipo-doc[value="${codigo}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    const nome = CATEGORIAS_TJMS[codigo] || codigo;
                    nomesAdicionados.push(`${codigo} - ${nome}`);
                }
            });

            // Mostra popup informando os codigos pre-selecionados
            if (nomesAdicionados.length > 0) {
                alert(`O prompt "${prompt.nome}" esta configurado para classificar os seguintes tipos de documento:\n\n${nomesAdicionados.join('\n')}\n\nOs tipos foram pre-selecionados automaticamente.`);
            }
        }

        // Pre-seleciona tipos de documento baseado nos codigos do prompt
        function preSelectTiposDocumentoPrompt() {
            const promptId = document.getElementById('promptLote').value;
            if (!promptId) return;

            const prompt = prompts.find(p => p.id === parseInt(promptId));
            if (!prompt || !prompt.codigos_documento) return;

            // Parseia os codigos do prompt
            const codigos = prompt.codigos_documento.split(',').map(c => c.trim()).filter(c => c);
            if (codigos.length === 0) return;

            // Limpa e adiciona os tipos do prompt
            tiposSelecionadosTJMS.clear();
            let nomesAdicionados = [];
            codigos.forEach(codigo => {
                tiposSelecionadosTJMS.add(codigo);
                const nome = CATEGORIAS_TJMS[codigo] || codigo;
                nomesAdicionados.push(`${codigo} - ${nome}`);
            });

            // Atualiza a UI
            popularTiposDocumentos();

            // Mostra popup informando os codigos pre-selecionados
            if (nomesAdicionados.length > 0) {
                alert(`O prompt "${prompt.nome}" esta configurado para classificar os seguintes tipos de documento:\n\n${nomesAdicionados.join('\n')}\n\nOs tipos foram pre-selecionados automaticamente.`);
            }
        }

        // ====================================
        // Inicializacao
        // ====================================

        // Helper para adicionar timeout em promises
        function withTimeout(promise, ms, errorMsg = 'Timeout') {
            return Promise.race([
                promise,
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(errorMsg)), ms)
                )
            ]);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[INIT] Iniciando classificador...');

            // Setup das dropzones e filtros (com tratamento de erro)
            try {
                setupDropZone();
                setupDropZoneLote();
                setupFiltroAno();
                popularTiposDocumentos();
            } catch (e) {
                console.error('[INIT] Erro no setup inicial:', e);
            }

            // Carregar dados da API com timeout de 15s
            try {
                await Promise.all([
                    withTimeout(verificarStatusAPI(), 15000, 'Timeout ao verificar status da API'),
                    withTimeout(carregarPrompts(), 15000, 'Timeout ao carregar prompts'),
                    withTimeout(carregarProjetos(), 15000, 'Timeout ao carregar lotes'),
                    withTimeout(verificarExecucoesEmAndamento(), 15000, 'Timeout ao verificar execuções')
                ]);
            } catch (e) {
                console.error('[INIT] Erro ao carregar dados:', e);
                // Em caso de timeout ou erro, garantir que a UI mostre estado de erro
                const promptsContainer = document.getElementById('listaPrompts');
                if (promptsContainer && (promptsContainer.innerHTML.includes('Carregando') || promptsContainer.innerHTML.includes('fa-spinner'))) {
                    promptsContainer.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Erro ao carregar prompts</p>
                            <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                            <button onclick="carregarPrompts()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Tentar novamente
                            </button>
                        </div>
                    `;
                }
                const projetosContainer = document.getElementById('listaProjetos');
                if (projetosContainer && (projetosContainer.innerHTML.includes('Carregando') || projetosContainer.innerHTML.includes('fa-spinner'))) {
                    projetosContainer.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Erro ao carregar lotes</p>
                            <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                            <button onclick="carregarProjetos()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Tentar novamente
                            </button>
                        </div>
                    `;
                }
            }

            try {
                atualizarSelectsPromptLote();
            } catch (e) {
                console.error('[INIT] Erro ao atualizar selects:', e);
            }

            console.log('[INIT] Inicializacao concluida');
        });
    </script>
</body>
</html>
