<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classificador de Documentos - Portal PGE-MS</title>
    <link rel="icon" type="image/png" href="/logo/logo-pge.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- PDF.js para renderizacao de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        pge: {
                            blue: '#1e3a5f',
                            orange: '#e67e22'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .confianca-alta {
            background-color: #dcfce7;
            color: #166534;
        }

        .confianca-media {
            background-color: #fef9c3;
            color: #854d0e;
        }

        .confianca-baixa {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-pendente {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .status-processando {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-concluido {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-erro {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">

    <!-- Header (Padrao PGE conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 7) -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo OFICIAL PGE -->
                <div class="flex items-center gap-3">
                    <a href="/dashboard">
                        <img src="/logo/logo-pge.png" alt="PGE-MS" class="h-12 w-auto">
                    </a>
                    <span class="text-lg font-semibold text-gray-700">Classificador de Documentos</span>
                </div>
                <!-- Menu usuario -->
                <div class="flex items-center gap-4">
                    <div id="apiStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm">
                        <i class="fas fa-circle text-gray-400 text-xs"></i>
                        <span class="text-gray-500">Verificando API...</span>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700 transition-colors" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs (Renomeado conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 2.2) -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div class="border-b border-gray-200">
            <nav class="flex gap-8">
                <button onclick="showTab('novoLote')" id="tab-novoLote" class="py-3 px-1 text-sm font-medium tab-active">
                    <i class="fas fa-plus-circle mr-2"></i>Novo Lote
                </button>
                <button onclick="showTab('meusLotes')" id="tab-meusLotes" class="py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-folder-open mr-2"></i>Meus Lotes
                </button>
                <button onclick="showTab('prompts')" id="tab-prompts" class="py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-comment-dots mr-2"></i>Prompts
                </button>
                <button onclick="showTab('testeRapido')" id="tab-testeRapido" class="py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bolt mr-2"></i>Teste Rapido
                </button>
            </nav>
        </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Tab: Novo Lote (conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 5) -->
        <div id="content-novoLote" class="tab-content">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>Criar Novo Lote de Classificacao
                </h2>

                <!-- Nome do Lote -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Lote (opcional)</label>
                    <input type="text" id="nomeLote" placeholder="Ex: Classificacao Decisoes Janeiro 2026" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Adicionar Documentos -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-file-alt mr-2 text-gray-400"></i>Adicionar Documentos
                    </h3>

                    <!-- Sub-tabs: Upload / TJ-MS -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex gap-4">
                            <button onclick="showSubTab('upload')" id="subtab-upload" class="py-2 px-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                                <i class="fas fa-upload mr-2"></i>Upload de Arquivos
                            </button>
                            <button onclick="showSubTab('tjms')" id="subtab-tjms" class="py-2 px-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                <i class="fas fa-gavel mr-2"></i>Importar do TJ-MS
                            </button>
                        </nav>
                    </div>

                    <!-- Sub-content: Upload -->
                    <div id="subcontent-upload" class="subtab-content">
                        <div id="dropZoneLote" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">Arraste arquivos aqui</p>
                            <p class="text-gray-500 mt-1">ou clique para selecionar</p>
                            <p class="text-sm text-gray-400 mt-2">PDF, TXT ou ZIP (max 500 arquivos, 50MB cada)</p>
                            <input type="file" id="arquivosLote" accept=".pdf,.txt,.zip" multiple class="hidden">
                        </div>
                        <div id="listaArquivosLote" class="mt-4 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Arquivos selecionados: <span id="contadorArquivos">0</span></span>
                                <button onclick="limparArquivosLote()" class="text-sm text-red-600 hover:text-red-700">
                                    <i class="fas fa-trash mr-1"></i>Limpar
                                </button>
                            </div>
                            <div id="previewArquivos" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100"></div>
                        </div>
                    </div>

                    <!-- Sub-content: TJ-MS -->
                    <div id="subcontent-tjms" class="subtab-content hidden">
                        <div class="space-y-4">
                            <!-- Lista de processos -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cole a lista de processos (1 por linha)</label>
                                <textarea id="processosLote" rows="5" placeholder="0800123-45.2024.8.12.0001&#10;0800456-78.2024.8.12.0002&#10;0800789-01.2024.8.12.0003" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                                <p id="contadorProcessos" class="text-sm text-gray-500 mt-1">Total: 0 processos</p>
                            </div>

                            <!-- Tipos de documentos -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de documentos a baixar</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Disponiveis -->
                                    <div>
                                        <p class="text-xs text-gray-500 mb-2">Disponiveis</p>
                                        <div id="tiposDisponiveis" class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                            <!-- Populado via JS -->
                                        </div>
                                    </div>
                                    <!-- Selecionados -->
                                    <div>
                                        <p class="text-xs text-gray-500 mb-2">Selecionados</p>
                                        <div id="tiposSelecionados" class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-blue-50">
                                            <!-- Populado via JS -->
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="adicionarTipoSelecionado()" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Adicionar &rarr;</button>
                                    <button onclick="removerTipoSelecionado()" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">&larr; Remover</button>
                                    <button onclick="adicionarTodosTipos()" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Adicionar Todos</button>
                                </div>
                                <!-- Codigos em lote -->
                                <div class="mt-3">
                                    <label class="block text-xs text-gray-500 mb-1">Codigos em lote (opcional)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="codigosTiposLote" placeholder="8, 15, 34, 500, 9500" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <button onclick="adicionarCodigosLote()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Adicionar</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filtros opcionais -->
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" id="filtrarPorAno" class="rounded border-gray-300">
                                    <span class="text-gray-700">Filtrar por ano:</span>
                                </label>
                                <input type="text" id="anosFiltro" placeholder="2024, 2025" class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-32" disabled>
                                <select id="mesFiltro" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" disabled>
                                    <option value="">Todos os meses</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Marco</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuracao -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-cog mr-2 text-gray-400"></i>Configuracao
                    </h3>

                    <div class="grid grid-cols-2 gap-6">
                        <!-- Prompt -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                            <div class="flex gap-2">
                                <select id="promptLote" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Selecione um prompt...</option>
                                </select>
                                <button onclick="showTab('prompts')" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" title="Criar novo prompt">
                                    <i class="fas fa-plus text-gray-500"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Modelo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                            <input type="text" id="modeloLote" value="google/gemini-2.5-flash-lite" placeholder="Ex: google/gemini-2.5-flash-lite" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Formato: provedor/modelo (ex: anthropic/claude-sonnet-4, openai/gpt-4o-mini)</p>
                        </div>
                    </div>

                    <!-- Modo de processamento -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modo de Processamento</label>
                        <div class="flex items-center gap-6">
                            <label class="flex items-center gap-2">
                                <input type="radio" name="modoLote" value="chunk" checked class="text-blue-600">
                                <span class="text-sm text-gray-700">Chunk (mais rapido)</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="radio" name="modoLote" value="completo" class="text-blue-600">
                                <span class="text-sm text-gray-700">Documento completo</span>
                            </label>
                            <div class="flex items-center gap-2 ml-4">
                                <label class="text-sm text-gray-600">Tamanho chunk:</label>
                                <input type="number" id="tamanhoChunkLote" value="512" min="100" max="4000" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                                <span class="text-sm text-gray-500">tokens</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">Posicao:</label>
                                <select id="posicaoChunkLote" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="fim">Fim</option>
                                    <option value="inicio">Inicio</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botao Iniciar -->
                <div class="flex justify-center">
                    <button id="btnIniciarLote" onclick="iniciarClassificacaoLote()" disabled class="px-8 py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium rounded-xl text-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Iniciar Classificacao
                    </button>
                </div>

                <!-- Area de Progresso (inicialmente oculta) -->
                <div id="areaProgressoLote" class="mt-6 hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Progresso</h3>
                            <div class="flex gap-2">
                                <button onclick="pausarLote()" id="btnPausarLote" class="px-3 py-1 text-sm bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200">
                                    <i class="fas fa-pause mr-1"></i>Pausar
                                </button>
                                <button onclick="cancelarLote()" id="btnCancelarLote" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    <i class="fas fa-times mr-1"></i>Cancelar
                                </button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span id="statusProgressoLote">Processando...</span>
                                <span id="contadorProgressoLote">0 / 0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="barraProgressoLote" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="logProgressoLote" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 font-mono text-xs">
                            <!-- Logs em tempo real -->
                        </div>
                    </div>
                </div>

                <!-- Area de Resultados (inicialmente oculta) -->
                <div id="areaResultadosLote" class="mt-6 hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Resultados</h3>
                            <div class="flex gap-2">
                                <button onclick="exportarResultadosLote('excel')" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                </button>
                                <button onclick="exportarResultadosLote('csv')" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                                    <i class="fas fa-file-csv mr-1"></i>CSV
                                </button>
                                <button onclick="exportarResultadosLote('json')" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                                    <i class="fas fa-file-code mr-1"></i>JSON
                                </button>
                            </div>
                        </div>
                        <div id="resumoResultadosLote" class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <!-- Resumo: X sucesso, Y erros -->
                        </div>
                        <div id="tabelaResultadosLote" class="overflow-x-auto">
                            <!-- Tabela de resultados -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Meus Lotes (antigo Projetos) -->
        <div id="content-meusLotes" class="tab-content hidden">
            <!-- Header da lista de lotes -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Meus Lotes</h2>
                <div class="flex items-center gap-4">
                    <input type="text" id="buscaLotes" placeholder="Buscar lotes..." class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button onclick="showTab('novoLote')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Novo Lote
                    </button>
                </div>
            </div>

            <!-- Lista de Lotes -->
            <div id="listaProjetos" class="grid gap-4">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                    <p>Carregando lotes...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Prompts -->
        <div id="content-prompts" class="tab-content hidden">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Prompts de Classificacao</h2>
                <button onclick="showModalCriarPrompt()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Novo Prompt
                </button>
            </div>

            <!-- Lista de Prompts -->
            <div id="listaPrompts" class="grid gap-4">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                    <p>Carregando prompts...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Teste Rapido (redesenhado com TJ-MS + visualizacao PDF) -->
        <div id="content-testeRapido" class="tab-content hidden">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-bolt mr-2 text-yellow-500"></i>Teste Rapido
                </h2>
                <p class="text-gray-600 mb-6">Teste um prompt com um documento e visualize o resultado antes de criar um lote.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Coluna Esquerda: Entrada -->
                    <div class="space-y-4">
                        <!-- Card: Origem do Documento -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Origem do Documento</h3>

                            <!-- Sub-tabs: Upload / TJ-MS -->
                            <div class="border-b border-gray-200 mb-4">
                                <nav class="flex gap-4">
                                    <button onclick="showTesteSubTab('upload')" id="teste-subtab-upload" class="py-2 px-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                                        <i class="fas fa-upload mr-2"></i>Upload
                                    </button>
                                    <button onclick="showTesteSubTab('tjms')" id="teste-subtab-tjms" class="py-2 px-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                        <i class="fas fa-gavel mr-2"></i>TJ-MS
                                    </button>
                                </nav>
                            </div>

                            <!-- Sub-content: Upload -->
                            <div id="teste-subcontent-upload" class="teste-subtab-content">
                                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 text-sm">Arraste um arquivo ou clique</p>
                                    <p class="text-xs text-gray-400 mt-1">PDF ate 50MB</p>
                                    <input type="file" id="arquivoAvulso" accept=".pdf" class="hidden">
                                </div>
                                <p id="nomeArquivoAvulso" class="text-sm text-blue-600 mt-2 hidden"></p>
                            </div>

                            <!-- Sub-content: TJ-MS -->
                            <div id="teste-subcontent-tjms" class="teste-subtab-content hidden">
                                <div class="space-y-3">
                                    <!-- Numero do processo -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Numero do Processo (CNJ)</label>
                                        <input type="text" id="testeProcessoCNJ" placeholder="0800001-00.2024.8.12.0001" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono">
                                    </div>

                                    <!-- Tipos de documentos -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tipos de Documentos</label>
                                        <div class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="8" checked>
                                                <span>8 - Sentenca</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="15" checked>
                                                <span>15 - Decisao Interl.</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="34">
                                                <span>34 - Acordao</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="44">
                                                <span>44 - Decisao Mono.</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="500">
                                                <span>500 - Peticao Inicial</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="9500">
                                                <span>9500 - Peticao</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="8320">
                                                <span>8320 - Contestacao</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs">
                                                <input type="checkbox" class="teste-tipo-doc rounded" value="8335">
                                                <span>8335 - Apelacao</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Botao Buscar -->
                                    <button onclick="buscarDocumentosTJMSTeste()" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>Buscar Documentos
                                    </button>

                                    <!-- Lista de documentos encontrados -->
                                    <div id="testeDocsTJMS" class="hidden">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Documentos Encontrados</label>
                                        <div id="testeDocsTJMSLista" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100">
                                            <!-- Populado via JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card: Configuracao -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Configuracao</h3>

                            <div class="space-y-3">
                                <!-- Prompt -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Prompt</label>
                                    <select id="promptAvulso" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Selecione um prompt...</option>
                                    </select>
                                </div>

                                <!-- Modelo -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Modelo</label>
                                    <input type="text" id="modeloAvulso" value="google/gemini-2.5-flash-lite" placeholder="provedor/modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Modo e Tokens em linha -->
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Modo</label>
                                        <select id="modoAvulso" class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                                            <option value="chunk">Chunk</option>
                                            <option value="completo">Completo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Posicao</label>
                                        <select id="posicaoAvulso" class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                                            <option value="fim">Fim</option>
                                            <option value="inicio">Inicio</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tokens</label>
                                        <input type="number" id="tokensAvulso" value="512" min="100" max="4000" class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                                    </div>
                                </div>
                            </div>

                            <!-- Botao Classificar -->
                            <button onclick="classificarTesteRapido()" id="btnClassificarAvulso" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-magic mr-2"></i>Classificar
                            </button>
                        </div>
                    </div>

                    <!-- Coluna Direita: Visualizacao PDF + Resultado -->
                    <div class="space-y-4">
                        <!-- Card: Visualizacao PDF -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-medium text-gray-900">Visualizacao do Documento</h3>
                                <div id="pdfNavegacao" class="hidden flex items-center gap-2">
                                    <button onclick="pdfPaginaAnterior()" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="pdfPaginaInfo" class="text-xs text-gray-600">1 / 1</span>
                                    <button onclick="pdfProximaPagina()" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="pdfViewer" class="border border-gray-200 rounded-lg bg-gray-100 flex items-center justify-center" style="height: 400px;">
                                <div class="text-center text-gray-400">
                                    <i class="fas fa-file-pdf text-4xl mb-2"></i>
                                    <p class="text-sm">Nenhum documento carregado</p>
                                </div>
                            </div>
                        </div>

                        <!-- Card: Resultado da Classificacao -->
                        <div id="resultadoAvulso" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hidden">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Resultado da Classificacao</h3>
                            <div id="resultadoAvulsoContent" class="space-y-3">
                                <!-- Populado via JS -->
                            </div>
                        </div>

                        <!-- Card: Lista de Documentos Classificados (quando multiplos) -->
                        <div id="listaResultadosTeste" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 hidden">
                            <h3 class="text-sm font-medium text-gray-900 mb-3">Documentos Classificados</h3>
                            <div id="listaResultadosTesteContent" class="max-h-60 overflow-y-auto divide-y divide-gray-100">
                                <!-- Populado via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Criar/Editar Projeto -->
    <div id="modalProjeto" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modalProjetoTitulo" class="text-lg font-semibold text-gray-900">Novo Lote</h3>
            </div>
            <form id="formProjeto" class="p-6 space-y-4">
                <input type="hidden" id="projetoId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                    <input type="text" id="projetoNome" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descricao</label>
                    <textarea id="projetoDescricao" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                    <select id="projetoPrompt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecione um prompt...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo OpenRouter</label>
                    <input type="text" id="projetoModelo" value="google/gemini-2.5-flash-lite" placeholder="Ex: google/gemini-2.5-flash-lite" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Formato: provedor/modelo (ex: minimax/minimax-m2-her, google/gemini-3-flash-preview)</p>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modo</label>
                        <select id="projetoModo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="chunk">Chunk</option>
                            <option value="completo">Completo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Posicao</label>
                        <select id="projetoPosicao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="fim">Fim</option>
                            <option value="inicio">Inicio</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tokens</label>
                        <input type="number" id="projetoTokens" value="512" min="100" max="4000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideModalProjeto()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Criar/Editar Prompt -->
    <div id="modalPrompt" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modalPromptTitulo" class="text-lg font-semibold text-gray-900">Novo Prompt</h3>
            </div>
            <form id="formPrompt" class="p-6 space-y-4">
                <input type="hidden" id="promptId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                    <input type="text" id="promptNome" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descricao</label>
                    <input type="text" id="promptDescricao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conteudo do Prompt</label>
                    <textarea id="promptConteudo" rows="12" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Codigos de Tipos de Documento (TJ-MS)
                        <span class="text-gray-400 font-normal ml-1">(opcional)</span>
                    </label>
                    <textarea id="promptCodigosDocumento" rows="3" placeholder="Digite os codigos separados por virgula ou um por linha. Ex:&#10;8, 15, 34&#10;ou&#10;8&#10;15&#10;34" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Codigos comuns: 8 (Sentenca), 15 (Decisao Interlocutoria), 34 (Acordao), 44 (Decisao Monocratica), 500 (Peticao Inicial)
                    </p>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideModalPrompt()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Detalhe do Projeto -->
    <div id="modalDetalheProjeto" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 id="detalheTitulo" class="text-lg font-semibold text-gray-900">Lote</h3>
                <button onclick="hideModalDetalheProjeto()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detalheContent" class="p-6">
                <!-- Conteudo carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Codigos do TJ-MS -->
    <div id="modalAdicionarCodigos" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Adicionar Documentos</h3>
                <button onclick="hideModalAdicionarCodigos()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Busca no TJ-MS -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-2"></i>Buscar no TJ-MS
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="buscaTJMS" placeholder="Numero do processo CNJ (ex: 0800123-45.2024.8.12.0001)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button type="button" onclick="buscarDocumentosTJMS()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="resultadosBuscaTJMS" class="mt-3">
                        <!-- Resultados da busca aparecem aqui -->
                    </div>
                </div>

                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500 mb-3">Ou adicione codigos manualmente:</p>
                </div>

                <!-- Codigos manuais -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-keyboard mr-2"></i>Codigos manuais
                    </label>
                    <textarea id="codigosManuais" rows="3" placeholder="Cole codigos separados por virgula, ponto-e-virgula ou quebra de linha"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Numero do processo (para codigos manuais)</label>
                    <input type="text" id="processoManual" placeholder="Deixe vazio se nao aplicavel"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="hideModalAdicionarCodigos()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="button" onclick="adicionarCodigosSelecionados()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Adicionar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/security.js"></script>
    <script>
        // ====================================
        // Estado Global
        // ====================================
        let token = localStorage.getItem('access_token');
        let projetos = [];
        let prompts = [];
        let projetoAtual = null;

        // ====================================
        // Autenticacao
        // ====================================
        if (!token) {
            window.location.href = '/login';
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        }

        async function fetchAPI(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            const response = await fetch(url, { ...defaultOptions, ...options });
            if (response.status === 401) {
                logout();
                throw new Error('Nao autorizado');
            }
            return response;
        }

        // ====================================
        // Tabs
        // ====================================
        function showTab(tabName) {
            // Esconde todos os conteudos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active de todas as tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-500');
            });
            // Mostra conteudo selecionado
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            // Ativa tab selecionada
            const tab = document.getElementById(`tab-${tabName}`);
            tab.classList.add('tab-active');
            tab.classList.remove('text-gray-500');
        }

        // ====================================
        // API Status
        // ====================================
        async function verificarStatusAPI() {
            try {
                const response = await fetchAPI('/classificador/api/status');
                const data = await response.json();
                const statusEl = document.getElementById('apiStatus');
                if (data.disponivel) {
                    statusEl.innerHTML = `
                        <i class="fas fa-circle text-green-500 text-xs"></i>
                        <span class="text-green-600">API Online</span>
                    `;
                    statusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-green-50';
                } else {
                    statusEl.innerHTML = `
                        <i class="fas fa-circle text-red-500 text-xs"></i>
                        <span class="text-red-600">API Offline</span>
                    `;
                    statusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm bg-red-50';
                }
            } catch (e) {
                console.error('Erro ao verificar status:', e);
            }
        }

        // ====================================
        // Prompts
        // ====================================
        async function carregarPrompts() {
            try {
                const response = await fetchAPI('/classificador/api/prompts');
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                prompts = await response.json();
                renderizarPrompts();
                atualizarSelectsPrompt();
            } catch (e) {
                console.error('Erro ao carregar prompts:', e);
                const container = document.getElementById('listaPrompts');
                container.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Erro ao carregar prompts</p>
                        <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                        <button onclick="carregarPrompts()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        function renderizarPrompts() {
            const container = document.getElementById('listaPrompts');
            if (prompts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-comment-slash text-4xl mb-4"></i>
                        <p>Nenhum prompt cadastrado</p>
                        <p class="text-sm mt-2">Crie seu primeiro prompt para comecar a classificar documentos.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = prompts.map(p => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${SecurityUtils.escapeHtml(p.nome)}</h3>
                            ${p.descricao ? `<p class="text-sm text-gray-500 mt-1">${SecurityUtils.escapeHtml(p.descricao)}</p>` : ''}
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fas fa-clock mr-1"></i>
                                ${new Date(p.criado_em).toLocaleDateString('pt-BR')}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editarPrompt(${p.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletarPrompt(${p.id})" class="text-red-600 hover:text-red-800 px-2 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function atualizarSelectsPrompt() {
            const options = prompts.map(p => `<option value="${p.id}">${SecurityUtils.escapeHtml(p.nome)}</option>`).join('');
            document.getElementById('projetoPrompt').innerHTML = `<option value="">Selecione um prompt...</option>${options}`;
            document.getElementById('promptAvulso').innerHTML = `<option value="">Selecione um prompt...</option>${options}`;
        }

        function showModalCriarPrompt() {
            document.getElementById('modalPromptTitulo').textContent = 'Novo Prompt';
            document.getElementById('promptId').value = '';
            document.getElementById('promptNome').value = '';
            document.getElementById('promptDescricao').value = '';
            document.getElementById('promptConteudo').value = '';
            document.getElementById('promptCodigosDocumento').value = '';
            document.getElementById('modalPrompt').classList.remove('hidden');
        }

        function hideModalPrompt() {
            document.getElementById('modalPrompt').classList.add('hidden');
        }

        async function editarPrompt(id) {
            const prompt = prompts.find(p => p.id === id);
            if (!prompt) return;
            document.getElementById('modalPromptTitulo').textContent = 'Editar Prompt';
            document.getElementById('promptId').value = prompt.id;
            document.getElementById('promptNome').value = prompt.nome;
            document.getElementById('promptDescricao').value = prompt.descricao || '';
            document.getElementById('promptConteudo').value = prompt.conteudo;
            document.getElementById('promptCodigosDocumento').value = prompt.codigos_documento || '';
            document.getElementById('modalPrompt').classList.remove('hidden');
        }

        async function salvarPrompt(e) {
            e.preventDefault();
            const id = document.getElementById('promptId').value;

            // Normaliza codigos: remove espacos, converte quebras de linha para virgula
            let codigosRaw = document.getElementById('promptCodigosDocumento').value || '';
            let codigos = codigosRaw
                .replace(/\n/g, ',')  // quebras de linha para virgula
                .split(',')
                .map(c => c.trim())
                .filter(c => c.length > 0)
                .join(',');

            const data = {
                nome: document.getElementById('promptNome').value,
                descricao: document.getElementById('promptDescricao').value,
                conteudo: document.getElementById('promptConteudo').value,
                codigos_documento: codigos || null
            };
            try {
                if (id) {
                    await fetchAPI(`/classificador/api/prompts/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await fetchAPI('/classificador/api/prompts', { method: 'POST', body: JSON.stringify(data) });
                }
                hideModalPrompt();
                carregarPrompts();
            } catch (e) {
                alert('Erro ao salvar prompt');
            }
        }

        async function deletarPrompt(id) {
            if (!confirm('Deseja realmente excluir este prompt?')) return;
            try {
                await fetchAPI(`/classificador/api/prompts/${id}`, { method: 'DELETE' });
                carregarPrompts();
            } catch (e) {
                alert('Erro ao excluir prompt');
            }
        }

        // ====================================
        // Projetos
        // ====================================
        async function carregarProjetos() {
            try {
                const response = await fetchAPI('/classificador/api/projetos');
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                projetos = await response.json();
                renderizarProjetos();
            } catch (e) {
                console.error('Erro ao carregar projetos:', e);
                const container = document.getElementById('listaProjetos');
                container.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Erro ao carregar lotes</p>
                        <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                        <button onclick="carregarProjetos()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        function renderizarProjetos() {
            const container = document.getElementById('listaProjetos');
            if (projetos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p>Nenhum lote cadastrado</p>
                        <p class="text-sm mt-2">Crie seu primeiro lote para organizar suas classificacoes.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = projetos.map(p => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 hover:shadow-md transition-shadow cursor-pointer" onclick="abrirProjeto(${p.id})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 text-lg">${SecurityUtils.escapeHtml(p.nome)}</h3>
                            ${p.descricao ? `<p class="text-sm text-gray-500 mt-1">${SecurityUtils.escapeHtml(p.descricao)}</p>` : ''}
                            <div class="flex gap-4 mt-3 text-sm text-gray-500">
                                <span><i class="fas fa-file-alt mr-1"></i>${p.total_codigos} documentos</span>
                                <span><i class="fas fa-play mr-1"></i>${p.total_execucoes} execucoes</span>
                                <span><i class="fas fa-robot mr-1"></i>${p.modelo.includes('/') ? p.modelo.split('/')[1] : p.modelo}</span>
                            </div>
                        </div>
                        <div class="flex gap-2" onclick="event.stopPropagation()">
                            <button onclick="editarProjeto(${p.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletarProjeto(${p.id})" class="text-red-600 hover:text-red-800 px-2 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showModalCriarProjeto() {
            document.getElementById('modalProjetoTitulo').textContent = 'Novo Lote';
            document.getElementById('projetoId').value = '';
            document.getElementById('projetoNome').value = '';
            document.getElementById('projetoDescricao').value = '';
            document.getElementById('projetoPrompt').value = '';
            document.getElementById('projetoModelo').value = 'google/gemini-2.5-flash-lite';
            document.getElementById('projetoModo').value = 'chunk';
            document.getElementById('projetoPosicao').value = 'fim';
            document.getElementById('projetoTokens').value = '512';
            document.getElementById('modalProjeto').classList.remove('hidden');
        }

        function hideModalProjeto() {
            document.getElementById('modalProjeto').classList.add('hidden');
        }

        async function editarProjeto(id) {
            const projeto = projetos.find(p => p.id === id);
            if (!projeto) return;
            document.getElementById('modalProjetoTitulo').textContent = 'Editar Lote';
            document.getElementById('projetoId').value = projeto.id;
            document.getElementById('projetoNome').value = projeto.nome;
            document.getElementById('projetoDescricao').value = projeto.descricao || '';
            document.getElementById('projetoPrompt').value = projeto.prompt_id || '';
            document.getElementById('projetoModelo').value = projeto.modelo;
            document.getElementById('projetoModo').value = projeto.modo_processamento;
            document.getElementById('projetoPosicao').value = projeto.posicao_chunk;
            document.getElementById('projetoTokens').value = projeto.tamanho_chunk;
            document.getElementById('modalProjeto').classList.remove('hidden');
        }

        async function salvarProjeto(e) {
            e.preventDefault();
            const id = document.getElementById('projetoId').value;
            const data = {
                nome: document.getElementById('projetoNome').value,
                descricao: document.getElementById('projetoDescricao').value,
                prompt_id: document.getElementById('projetoPrompt').value || null,
                modelo: document.getElementById('projetoModelo').value,
                modo_processamento: document.getElementById('projetoModo').value,
                posicao_chunk: document.getElementById('projetoPosicao').value,
                tamanho_chunk: parseInt(document.getElementById('projetoTokens').value)
            };
            try {
                if (id) {
                    await fetchAPI(`/classificador/api/projetos/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await fetchAPI('/classificador/api/projetos', { method: 'POST', body: JSON.stringify(data) });
                }
                hideModalProjeto();
                carregarProjetos();
            } catch (e) {
                alert('Erro ao salvar lote');
            }
        }

        async function deletarProjeto(id) {
            if (!confirm('Deseja realmente excluir este lote?')) return;
            try {
                await fetchAPI(`/classificador/api/projetos/${id}`, { method: 'DELETE' });
                carregarProjetos();
            } catch (e) {
                alert('Erro ao excluir lote');
            }
        }

        async function abrirProjeto(id) {
            try {
                const response = await fetchAPI(`/classificador/api/projetos/${id}`);
                projetoAtual = await response.json();
                document.getElementById('detalheTitulo').textContent = projetoAtual.nome;
                renderizarDetalheProjeto();
                document.getElementById('modalDetalheProjeto').classList.remove('hidden');
            } catch (e) {
                alert('Erro ao carregar lote');
            }
        }

        function hideModalDetalheProjeto() {
            document.getElementById('modalDetalheProjeto').classList.add('hidden');
            projetoAtual = null;
        }

        function renderizarDetalheProjeto() {
            const container = document.getElementById('detalheContent');
            const p = projetoAtual;
            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Info do Projeto -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Modelo</p>
                            <p class="font-medium">${SecurityUtils.escapeHtml(p.modelo.includes('/') ? p.modelo.split('/')[1] : p.modelo)}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Modo</p>
                            <p class="font-medium">${p.modo_processamento}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Tokens</p>
                            <p class="font-medium">${p.tamanho_chunk}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Posicao</p>
                            <p class="font-medium">${p.posicao_chunk}</p>
                        </div>
                    </div>

                    <!-- Codigos -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-900">Codigos de Documentos (${p.codigos.length})</h4>
                            <button onclick="showModalAdicionarCodigos()" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-plus mr-1"></i>Adicionar
                            </button>
                        </div>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            ${p.codigos.length > 0 ? `
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left px-4 py-2">Codigo</th>
                                            <th class="text-left px-4 py-2">Processo</th>
                                            <th class="text-left px-4 py-2">Fonte</th>
                                            <th class="px-4 py-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${p.codigos.map(c => `
                                            <tr class="border-t border-gray-100">
                                                <td class="px-4 py-2 font-mono">${SecurityUtils.escapeHtml(c.codigo)}</td>
                                                <td class="px-4 py-2">${c.numero_processo || '-'}</td>
                                                <td class="px-4 py-2">${c.fonte}</td>
                                                <td class="px-4 py-2 text-right">
                                                    <button onclick="removerCodigo(${c.id})" class="text-red-600 hover:text-red-800">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <p class="text-center py-8 text-gray-500">Nenhum codigo adicionado</p>
                            `}
                        </div>
                    </div>

                    <!-- Acoes -->
                    <div class="flex gap-3">
                        <button onclick="executarProjeto()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50" ${p.codigos.length === 0 || !p.prompt_id ? 'disabled' : ''}>
                            <i class="fas fa-play mr-2"></i>Executar Classificacao
                        </button>
                        <button onclick="verExecucoes()" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">
                            <i class="fas fa-history mr-2"></i>Historico
                        </button>
                    </div>
                </div>
            `;
        }

        async function removerCodigo(id) {
            if (!confirm('Remover este codigo?')) return;
            try {
                await fetchAPI(`/classificador/api/codigos/${id}`, { method: 'DELETE' });
                abrirProjeto(projetoAtual.id);
            } catch (e) {
                alert('Erro ao remover codigo');
            }
        }

        function showModalAdicionarCodigos() {
            document.getElementById('modalAdicionarCodigos').classList.remove('hidden');
            document.getElementById('buscaTJMS').value = '';
            document.getElementById('resultadosBuscaTJMS').innerHTML = '';
            document.getElementById('codigosManuais').value = '';
            document.getElementById('processoManual').value = '';
        }

        function hideModalAdicionarCodigos() {
            document.getElementById('modalAdicionarCodigos').classList.add('hidden');
        }

        async function buscarDocumentosTJMS() {
            const numeroCNJ = document.getElementById('buscaTJMS').value.trim();
            if (!numeroCNJ) {
                alert('Digite o numero do processo CNJ');
                return;
            }

            const container = document.getElementById('resultadosBuscaTJMS');
            container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-600"></i> Consultando TJ-MS...</div>';

            try {
                const response = await fetchAPI('/classificador/api/tjms/consultar-processo', {
                    method: 'POST',
                    body: JSON.stringify({ numero_cnj: numeroCNJ })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Erro ao consultar');
                }

                const data = await response.json();

                if (data.documentos.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum documento encontrado neste processo</div>';
                    return;
                }

                container.innerHTML = `
                    <div class="text-sm text-gray-600 mb-2">${data.total_documentos} documento(s) encontrado(s)</div>
                    <div class="max-h-48 overflow-y-auto border rounded-lg">
                        ${data.documentos.map(doc => `
                            <label class="flex items-center gap-3 p-2 hover:bg-gray-50 border-b last:border-b-0 cursor-pointer">
                                <input type="checkbox" value="${doc.id}" data-processo="${numeroCNJ}" class="docTJMS rounded">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm truncate">${SecurityUtils.escapeHtml(doc.tipo || 'Documento')}</div>
                                    <div class="text-xs text-gray-500 truncate">${SecurityUtils.escapeHtml(doc.descricao || doc.id)}</div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button" onclick="selecionarTodosTJMS(true)" class="text-xs text-blue-600 hover:underline">Selecionar todos</button>
                        <button type="button" onclick="selecionarTodosTJMS(false)" class="text-xs text-gray-600 hover:underline">Desmarcar todos</button>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>${SecurityUtils.escapeHtml(e.message)}</div>`;
            }
        }

        function selecionarTodosTJMS(selecionar) {
            document.querySelectorAll('.docTJMS').forEach(cb => cb.checked = selecionar);
        }

        async function adicionarCodigosSelecionados() {
            // Coleta documentos selecionados do TJ-MS
            const selecionados = [];
            let processoCNJ = null;
            document.querySelectorAll('.docTJMS:checked').forEach(cb => {
                selecionados.push(cb.value);
                processoCNJ = cb.dataset.processo;
            });

            // Coleta codigos manuais
            const manuais = document.getElementById('codigosManuais').value;
            const processoManual = document.getElementById('processoManual').value.trim();
            const codigosManuais = manuais.split(/[,;\n]/).map(c => c.trim()).filter(c => c);

            if (selecionados.length === 0 && codigosManuais.length === 0) {
                alert('Selecione documentos do TJ-MS ou digite codigos manualmente');
                return;
            }

            try {
                // Adiciona selecionados do TJ-MS
                if (selecionados.length > 0 && processoCNJ) {
                    await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/codigos-tjms`, {
                        method: 'POST',
                        body: JSON.stringify({
                            numero_cnj: processoCNJ,
                            ids_documentos: selecionados
                        })
                    });
                }

                // Adiciona manuais
                if (codigosManuais.length > 0) {
                    await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/codigos`, {
                        method: 'POST',
                        body: JSON.stringify({
                            codigos: codigosManuais,
                            numero_processo: processoManual || null,
                            fonte: 'tjms'
                        })
                    });
                }

                hideModalAdicionarCodigos();
                abrirProjeto(projetoAtual.id);
            } catch (e) {
                alert('Erro ao adicionar codigos: ' + e.message);
            }
        }

        async function adicionarCodigos(codigosTexto, processo) {
            const codigos = codigosTexto.split(/[,;\n]/).map(c => c.trim()).filter(c => c);
            if (codigos.length === 0) return;
            try {
                await fetchAPI(`/classificador/api/projetos/${projetoAtual.id}/codigos`, {
                    method: 'POST',
                    body: JSON.stringify({
                        codigos: codigos,
                        numero_processo: processo || null,
                        fonte: 'tjms'
                    })
                });
                abrirProjeto(projetoAtual.id);
            } catch (e) {
                alert('Erro ao adicionar codigos');
            }
        }

        async function executarProjeto() {
            alert('Funcionalidade de execucao sera implementada na proxima fase. Por enquanto, use a classificacao avulsa.');
        }

        async function verExecucoes() {
            alert('Funcionalidade de historico sera implementada na proxima fase.');
        }

        // ====================================
        // Classificacao Avulsa
        // ====================================
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const input = document.getElementById('arquivoAvulso');
            const nomeEl = document.getElementById('nomeArquivoAvulso');

            dropZone.addEventListener('click', () => input.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    atualizarNomeArquivo();
                }
            });
            input.addEventListener('change', atualizarNomeArquivo);

            function atualizarNomeArquivo() {
                if (input.files.length > 0) {
                    nomeEl.textContent = `Arquivo: ${input.files[0].name}`;
                    nomeEl.classList.remove('hidden');
                    // Preview o PDF no viewer
                    previewPdfUpload(input.files[0]);
                } else {
                    nomeEl.classList.add('hidden');
                    limparPdfViewer();
                }
            }
        }

        async function previewPdfUpload(file) {
            if (!file || file.type !== 'application/pdf') return;

            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = `<div class="text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p class="text-sm">Carregando PDF...</p>
            </div>`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfData = new Uint8Array(arrayBuffer);

                pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
                pdfTotalPaginas = pdfDoc.numPages;
                pdfPaginaAtual = 1;

                document.getElementById('pdfNavegacao').classList.remove('hidden');
                atualizarInfoPagina();
                await renderizarPagina(pdfPaginaAtual);

            } catch (e) {
                console.error('Erro ao carregar PDF:', e);
                viewer.innerHTML = `<div class="text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">Erro ao carregar PDF</p>
                </div>`;
            }
        }

        async function classificarAvulso(e) {
            e.preventDefault();
            const arquivo = document.getElementById('arquivoAvulso').files[0];
            const promptId = document.getElementById('promptAvulso').value;
            const modelo = document.getElementById('modeloAvulso').value;
            const modo = document.getElementById('modoAvulso').value;
            const posicao = document.getElementById('posicaoAvulso').value;
            const tokens = document.getElementById('tokensAvulso').value;

            if (!arquivo) {
                alert('Selecione um arquivo PDF');
                return;
            }
            if (!promptId) {
                alert('Selecione um prompt');
                return;
            }

            const btn = document.getElementById('btnClassificarAvulso');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Classificando...';

            try {
                const formData = new FormData();
                formData.append('arquivo', arquivo);
                formData.append('prompt_id', promptId);
                formData.append('modelo', modelo);
                formData.append('modo_processamento', modo);
                formData.append('posicao_chunk', posicao);
                formData.append('tamanho_chunk', tokens);

                const response = await fetch('/classificador/api/classificar-avulso', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const resultado = await response.json();
                mostrarResultadoAvulso(resultado);

            } catch (e) {
                alert('Erro ao classificar documento');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Classificar Documento';
            }
        }

        function mostrarResultadoAvulso(resultado) {
            const container = document.getElementById('resultadoAvulso');
            const content = document.getElementById('resultadoAvulsoContent');

            if (resultado.sucesso) {
                // Info adicional do TJ-MS se disponivel
                const tjmsInfo = resultado.numero_processo ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 mb-3">
                        <p class="text-xs text-blue-800">
                            <i class="fas fa-gavel mr-1"></i>
                            <strong>Processo:</strong> ${SecurityUtils.escapeHtml(resultado.numero_processo)}
                            ${resultado.tipo_documento ? ` | <strong>Tipo:</strong> ${SecurityUtils.escapeHtml(resultado.tipo_documento)}` : ''}
                        </p>
                    </div>
                ` : '';

                content.innerHTML = `
                    <div class="space-y-3">
                        ${tjmsInfo}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Categoria:</span>
                            <span class="font-semibold">${SecurityUtils.escapeHtml(resultado.categoria || '-')}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Subcategoria:</span>
                            <span class="font-semibold">${SecurityUtils.escapeHtml(resultado.subcategoria || '-')}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Confianca:</span>
                            <span class="px-2 py-1 rounded text-sm font-medium confianca-${resultado.confianca}">${resultado.confianca}</span>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <p class="text-gray-600 text-sm mb-1">Justificativa:</p>
                            <p class="text-gray-900">${SecurityUtils.escapeHtml(resultado.justificativa || '-')}</p>
                        </div>
                        <div class="border-t pt-3 mt-3 text-xs text-gray-500">
                            <span>Extracao: ${resultado.texto_via || 'pdf'}</span>
                            <span class="ml-4">Tokens: ${resultado.tokens_usados || '-'}</span>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        ${SecurityUtils.escapeHtml(resultado.erro || 'Erro desconhecido')}
                    </div>
                `;
            }

            container.classList.remove('hidden');
        }

        // ====================================
        // Sub-Tabs (Novo Lote)
        // ====================================
        function showSubTab(subtabName) {
            // Esconde todos os sub-conteudos
            document.querySelectorAll('.subtab-content').forEach(el => el.classList.add('hidden'));
            // Remove active de todas as sub-tabs
            document.querySelectorAll('[id^="subtab-"]').forEach(el => {
                el.classList.remove('border-blue-500', 'text-blue-600');
                el.classList.add('text-gray-500', 'border-transparent');
            });
            // Mostra sub-conteudo selecionado
            document.getElementById(`subcontent-${subtabName}`).classList.remove('hidden');
            // Ativa sub-tab selecionada
            const subtab = document.getElementById(`subtab-${subtabName}`);
            subtab.classList.add('border-blue-500', 'text-blue-600');
            subtab.classList.remove('text-gray-500', 'border-transparent');
        }

        // ====================================
        // Novo Lote - Upload de Arquivos
        // ====================================
        let arquivosParaLote = [];

        function setupDropZoneLote() {
            const dropZone = document.getElementById('dropZoneLote');
            const input = document.getElementById('arquivosLote');

            if (!dropZone || !input) return;

            dropZone.addEventListener('click', () => input.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = Array.from(e.dataTransfer.files);
                adicionarArquivosLote(files);
            });

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                adicionarArquivosLote(files);
            });
        }

        function adicionarArquivosLote(files) {
            const validExtensions = ['.pdf', '.txt', '.zip'];
            const maxFileSize = 50 * 1024 * 1024; // 50MB
            const maxFiles = 500;

            for (const file of files) {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(ext)) {
                    console.warn(`Arquivo ignorado (extensao invalida): ${file.name}`);
                    continue;
                }
                if (file.size > maxFileSize) {
                    console.warn(`Arquivo ignorado (muito grande): ${file.name}`);
                    continue;
                }
                if (arquivosParaLote.length >= maxFiles) {
                    alert(`Limite de ${maxFiles} arquivos atingido.`);
                    break;
                }
                // Evita duplicatas
                if (!arquivosParaLote.find(f => f.name === file.name && f.size === file.size)) {
                    arquivosParaLote.push(file);
                }
            }

            atualizarListaArquivosLote();
            atualizarBotaoIniciar();
        }

        function atualizarListaArquivosLote() {
            const container = document.getElementById('listaArquivosLote');
            const preview = document.getElementById('previewArquivos');
            const contador = document.getElementById('contadorArquivos');

            if (arquivosParaLote.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            contador.textContent = arquivosParaLote.length;

            preview.innerHTML = arquivosParaLote.map((file, idx) => `
                <div class="flex items-center justify-between p-2 hover:bg-gray-50">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-file-${file.name.endsWith('.pdf') ? 'pdf text-red-500' : 'alt text-gray-400'}"></i>
                        <span class="text-sm text-gray-700">${SecurityUtils.escapeHtml(file.name)}</span>
                        <span class="text-xs text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button onclick="removerArquivoLote(${idx})" class="text-gray-400 hover:text-red-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removerArquivoLote(idx) {
            arquivosParaLote.splice(idx, 1);
            atualizarListaArquivosLote();
            atualizarBotaoIniciar();
        }

        function limparArquivosLote() {
            arquivosParaLote = [];
            atualizarListaArquivosLote();
            atualizarBotaoIniciar();
        }

        // ====================================
        // Novo Lote - TJ-MS
        // ====================================
        // Mapa de categorias de documentos do TJ-MS (conforme docs/REDESIGN_CLASSIFICADOR_v2.md secao 4.2)
        const CATEGORIAS_TJMS = {
            "8": "Sentenca",
            "15": "Decisoes Interlocutorias",
            "34": "Acordaos",
            "44": "Decisoes Monocraticas",
            "137": "Decisao Interlocutoria",
            "500": "Peticao Inicial",
            "510": "Peticao Intermediaria",
            "8305": "Contrarrazoes de Apelacao",
            "8320": "Contestacao",
            "8335": "Recurso de Apelacao",
            "8369": "Laudo Pericial",
            "9500": "Peticao",
            "1": "Mandado",
            "2": "Certidao",
            "6": "Despacho",
            "7": "Oficio"
        };

        let tiposSelecionadosTJMS = new Set(["8", "15", "34", "500", "9500"]); // Default

        function popularTiposDocumentos() {
            const disponiveis = document.getElementById('tiposDisponiveis');
            const selecionados = document.getElementById('tiposSelecionados');

            if (!disponiveis || !selecionados) return;

            disponiveis.innerHTML = Object.entries(CATEGORIAS_TJMS)
                .filter(([cod]) => !tiposSelecionadosTJMS.has(cod))
                .map(([cod, nome]) => `
                    <div class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded cursor-pointer" onclick="selecionarTipo('${cod}')">
                        <span class="text-xs text-gray-500">${cod}</span>
                        <span class="text-sm">${SecurityUtils.escapeHtml(nome)}</span>
                    </div>
                `).join('');

            selecionados.innerHTML = Array.from(tiposSelecionadosTJMS)
                .map(cod => `
                    <div class="flex items-center gap-2 p-1 hover:bg-blue-100 rounded cursor-pointer" onclick="desselecionarTipo('${cod}')">
                        <span class="text-xs text-blue-600">${cod}</span>
                        <span class="text-sm">${SecurityUtils.escapeHtml(CATEGORIAS_TJMS[cod] || cod)}</span>
                    </div>
                `).join('');
        }

        function selecionarTipo(cod) {
            tiposSelecionadosTJMS.add(cod);
            popularTiposDocumentos();
        }

        function desselecionarTipo(cod) {
            tiposSelecionadosTJMS.delete(cod);
            popularTiposDocumentos();
        }

        function adicionarTipoSelecionado() {
            // Seleciona o primeiro disponivel
            const disponiveis = Object.keys(CATEGORIAS_TJMS).filter(cod => !tiposSelecionadosTJMS.has(cod));
            if (disponiveis.length > 0) {
                selecionarTipo(disponiveis[0]);
            }
        }

        function removerTipoSelecionado() {
            // Remove o ultimo selecionado
            const arr = Array.from(tiposSelecionadosTJMS);
            if (arr.length > 0) {
                desselecionarTipo(arr[arr.length - 1]);
            }
        }

        function adicionarTodosTipos() {
            Object.keys(CATEGORIAS_TJMS).forEach(cod => tiposSelecionadosTJMS.add(cod));
            popularTiposDocumentos();
        }

        function adicionarCodigosLote() {
            const input = document.getElementById('codigosTiposLote');
            const codigos = input.value.split(/[,\s;]+/).map(c => c.trim()).filter(c => c);
            codigos.forEach(cod => {
                if (CATEGORIAS_TJMS[cod] || cod.match(/^\d+$/)) {
                    tiposSelecionadosTJMS.add(cod);
                }
            });
            input.value = '';
            popularTiposDocumentos();
        }

        function contarProcessos() {
            const textarea = document.getElementById('processosLote');
            const contador = document.getElementById('contadorProcessos');
            if (!textarea || !contador) return 0;

            const processos = textarea.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            contador.textContent = `Total: ${processos.length} processos`;
            return processos.length;
        }

        // ====================================
        // Novo Lote - Validacao e Inicio
        // ====================================
        function atualizarBotaoIniciar() {
            const btn = document.getElementById('btnIniciarLote');
            const promptSelect = document.getElementById('promptLote');
            if (!btn || !promptSelect) return;

            const temArquivos = arquivosParaLote.length > 0;
            const temProcessos = contarProcessos() > 0;
            const temPrompt = promptSelect.value !== '';

            btn.disabled = !(temPrompt && (temArquivos || temProcessos));
        }

        async function iniciarClassificacaoLote() {
            const btn = document.getElementById('btnIniciarLote');
            const areaProgresso = document.getElementById('areaProgressoLote');
            const logProgresso = document.getElementById('logProgressoLote');

            btn.disabled = true;
            areaProgresso.classList.remove('hidden');
            logProgresso.innerHTML = '';

            const nomeLote = document.getElementById('nomeLote').value || `Lote ${new Date().toLocaleString()}`;
            const promptId = document.getElementById('promptLote').value;
            const modelo = document.getElementById('modeloLote').value;
            const modo = document.querySelector('input[name="modoLote"]:checked').value;
            const tamanhoChunk = document.getElementById('tamanhoChunkLote').value;
            const posicaoChunk = document.getElementById('posicaoChunkLote').value;

            // Log inicio
            adicionarLogLote(`Iniciando lote: ${nomeLote}`);
            adicionarLogLote(`Prompt ID: ${promptId} | Modelo: ${modelo}`);

            try {
                // 1. Criar o lote (projeto)
                adicionarLogLote('Criando lote...');
                const response = await fetchAPI('/classificador/api/projetos', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome: nomeLote,
                        prompt_id: parseInt(promptId),
                        modelo: modelo,
                        modo_processamento: modo,
                        tamanho_chunk: parseInt(tamanhoChunk),
                        posicao_chunk: posicaoChunk
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro ao criar lote: ${response.status}`);
                }

                const lote = await response.json();
                adicionarLogLote(`Lote criado: ID ${lote.id}`);

                // 2. Adicionar arquivos (se houver upload)
                if (arquivosParaLote.length > 0) {
                    adicionarLogLote(`Enviando ${arquivosParaLote.length} arquivos...`);
                    await uploadArquivosParaLote(lote.id);
                }

                // 3. Adicionar processos TJ-MS (se houver)
                const processos = document.getElementById('processosLote').value.split('\n').map(l => l.trim()).filter(l => l);
                if (processos.length > 0) {
                    adicionarLogLote(`Adicionando ${processos.length} processos do TJ-MS...`);
                    await adicionarProcessosTJMS(lote.id, processos);
                }

                // 4. Executar classificacao
                adicionarLogLote('Iniciando classificacao...');
                await executarClassificacaoLote(lote.id);

            } catch (e) {
                adicionarLogLote(`ERRO: ${e.message}`, 'error');
                btn.disabled = false;
            }
        }

        async function uploadArquivosParaLote(loteId) {
            // Upload real dos arquivos para o backend
            const formData = new FormData();
            for (const file of arquivosParaLote) {
                formData.append('arquivos', file);
                adicionarLogLote(`  - ${file.name}`);
            }

            try {
                const response = await fetch(`/classificador/api/lotes/${loteId}/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'  // Inclui cookie de autenticacao
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Erro HTTP ${response.status}`);
                }

                const result = await response.json();
                adicionarLogLote(`${result.adicionados || arquivosParaLote.length} arquivos enviados com sucesso.`, 'success');

                if (result.erros && result.erros > 0) {
                    adicionarLogLote(`${result.erros} arquivo(s) com erro.`, 'error');
                    if (result.detalhes_erros) {
                        result.detalhes_erros.forEach(e => {
                            adicionarLogLote(`  ! ${e.arquivo}: ${e.erro}`, 'error');
                        });
                    }
                }

                return result;
            } catch (e) {
                adicionarLogLote(`Erro no upload: ${e.message}`, 'error');
                throw e;
            }
        }

        async function adicionarProcessosTJMS(loteId, processos) {
            const tipos = Array.from(tiposSelecionadosTJMS);
            adicionarLogLote(`Tipos de documentos: ${tipos.join(', ')}`);

            // TODO: Implementar adicao de processos TJ-MS no backend
            // Por enquanto, adiciona como codigos manuais
            for (const processo of processos) {
                try {
                    await fetchAPI(`/classificador/api/projetos/${loteId}/codigos`, {
                        method: 'POST',
                        body: JSON.stringify({
                            codigos: [{ codigo: processo, numero_processo: processo, fonte: 'tjms' }]
                        })
                    });
                    adicionarLogLote(`  + ${processo}`);
                } catch (e) {
                    adicionarLogLote(`  ! Erro: ${processo}`, 'error');
                }
            }
        }

        async function executarClassificacaoLote(loteId) {
            // Usa SSE para progresso em tempo real
            // IMPORTANTE: O token  armazenado como 'access_token' no localStorage
            const eventSource = new EventSource(`/classificador/api/projetos/${loteId}/executar?token=${localStorage.getItem('access_token')}`);
            let recebeuEvento = false;
            let ultimoErro = null;

            eventSource.onmessage = (event) => {
                recebeuEvento = true;
                try {
                    const data = JSON.parse(event.data);
                    console.log('[SSE] Evento recebido:', data);

                    // Log da mensagem
                    if (data.mensagem) {
                        const tipo = data.tipo === 'erro' ? 'error' : (data.tipo === 'concluido' ? 'success' : 'info');
                        adicionarLogLote(data.mensagem, tipo);
                    }

                    // Atualiza progresso - backend envia processados/total diretamente
                    if (data.processados !== undefined && data.total !== undefined) {
                        atualizarBarraProgresso(data.processados, data.total);
                    }

                    // Eventos de conclusao ou erro
                    if (data.tipo === 'concluido') {
                        adicionarLogLote(`Sucesso: ${data.sucesso || 0} | Erros: ${data.erros || 0}`, 'success');
                        eventSource.close();
                        document.getElementById('statusProgressoLote').textContent = 'Concluido!';
                        mostrarResultadosLote(loteId, data.execucao_id);
                    } else if (data.tipo === 'erro') {
                        ultimoErro = data.mensagem;
                        eventSource.close();
                        document.getElementById('statusProgressoLote').textContent = 'Erro';
                        mostrarResultadosLote(loteId);
                    } else if (data.tipo === 'inicio') {
                        // Inicializa o total na barra de progresso
                        document.getElementById('statusProgressoLote').textContent = 'Processando...';
                    }
                } catch (e) {
                    console.error('[SSE] Erro ao processar evento:', e, event.data);
                    adicionarLogLote(`Erro ao processar evento: ${e.message}`, 'error');
                }
            };

            eventSource.onerror = (e) => {
                console.error('[SSE] Erro na conexao:', e);
                eventSource.close();

                if (!recebeuEvento) {
                    // Conexao falhou antes de receber qualquer evento - provavelmente erro de auth ou servidor
                    adicionarLogLote('Erro: Conexao falhou antes de iniciar. Verifique se voce esta autenticado.', 'error');
                    document.getElementById('statusProgressoLote').textContent = 'Erro de conexao';
                } else if (ultimoErro) {
                    adicionarLogLote(`Conexao encerrada: ${ultimoErro}`, 'error');
                } else {
                    adicionarLogLote('Conexao encerrada.', 'info');
                }
                mostrarResultadosLote(loteId);
            };

            eventSource.onopen = () => {
                console.log('[SSE] Conexao aberta com sucesso');
                adicionarLogLote('Conexao estabelecida, aguardando eventos...', 'info');
            };
        }

        function adicionarLogLote(msg, tipo = 'info') {
            const log = document.getElementById('logProgressoLote');
            const timestamp = new Date().toLocaleTimeString();
            const cor = tipo === 'error' ? 'text-red-600' : (tipo === 'success' ? 'text-green-600' : 'text-gray-600');
            log.innerHTML += `<div class="${cor}">[${timestamp}] ${SecurityUtils.escapeHtml(msg)}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function atualizarBarraProgresso(atual, total) {
            const barra = document.getElementById('barraProgressoLote');
            const contador = document.getElementById('contadorProgressoLote');
            const pct = total > 0 ? (atual / total * 100) : 0;
            barra.style.width = `${pct}%`;
            contador.textContent = `${atual} / ${total}`;
        }

        function mostrarResultadosLote(loteId, execucaoId = null) {
            const areaResultados = document.getElementById('areaResultadosLote');
            areaResultados.classList.remove('hidden');
            document.getElementById('btnIniciarLote').disabled = false;

            if (execucaoId) {
                document.getElementById('resumoResultadosLote').innerHTML = `
                    <p class="text-gray-600 mb-3">Lote #${loteId} concluido (execucao #${execucaoId}).</p>
                    <div class="flex gap-3">
                        <button onclick="showTab('meusLotes'); carregarProjetos();" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>Ver em Meus Lotes
                        </button>
                        <button onclick="exportarResultados(${execucaoId}, 'excel')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                        </button>
                    </div>
                `;
            } else {
                document.getElementById('resumoResultadosLote').innerHTML = `
                    <p class="text-gray-600">Lote #${loteId} processado. Veja os resultados em "Meus Lotes".</p>
                    <button onclick="showTab('meusLotes'); carregarProjetos();" class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>Ver em Meus Lotes
                    </button>
                `;
            }
        }

        async function exportarResultados(execucaoId, formato) {
            try {
                const response = await fetch(`/classificador/api/execucoes/${execucaoId}/exportar/${formato}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Erro ao exportar');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `classificacao_${execucaoId}.${formato === 'excel' ? 'xlsx' : formato}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (e) {
                alert('Erro ao exportar: ' + e.message);
            }
        }

        function pausarLote() {
            adicionarLogLote('Pausar ainda nao implementado.', 'info');
        }

        function cancelarLote() {
            if (confirm('Tem certeza que deseja cancelar?')) {
                adicionarLogLote('Cancelado pelo usuario.', 'error');
                document.getElementById('btnIniciarLote').disabled = false;
            }
        }

        function exportarResultadosLote(formato) {
            alert(`Exportar ${formato} - Use a aba "Meus Lotes" para exportar resultados completos.`);
        }

        // ====================================
        // Filtro de ano (TJ-MS)
        // ====================================
        function setupFiltroAno() {
            const checkbox = document.getElementById('filtrarPorAno');
            const inputAnos = document.getElementById('anosFiltro');
            const selectMes = document.getElementById('mesFiltro');

            if (!checkbox) return;

            checkbox.addEventListener('change', () => {
                inputAnos.disabled = !checkbox.checked;
                selectMes.disabled = !checkbox.checked;
            });
        }

        // ====================================
        // Atualizar selects de prompt
        // ====================================
        function atualizarSelectsPromptLote() {
            const selectLote = document.getElementById('promptLote');
            if (!selectLote) return;

            selectLote.innerHTML = '<option value="">Selecione um prompt...</option>';
            prompts.forEach(p => {
                selectLote.innerHTML += `<option value="${p.id}">${SecurityUtils.escapeHtml(p.nome)}</option>`;
            });
        }

        // ====================================
        // Teste Rapido: Sub-tabs e TJ-MS
        // ====================================

        // Estado do PDF viewer
        let pdfDoc = null;
        let pdfPaginaAtual = 1;
        let pdfTotalPaginas = 0;
        let testeDocumentoSelecionado = null;  // {id_documento, numero_processo, tipo, base64}
        let testeDocumentosTJMS = [];  // Lista de documentos encontrados

        function showTesteSubTab(tab) {
            // Atualiza botoes das sub-tabs
            document.getElementById('teste-subtab-upload').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('teste-subtab-upload').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('teste-subtab-tjms').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('teste-subtab-tjms').classList.add('border-transparent', 'text-gray-500');

            // Oculta todos os conteudos
            document.getElementById('teste-subcontent-upload').classList.add('hidden');
            document.getElementById('teste-subcontent-tjms').classList.add('hidden');

            // Mostra o selecionado
            if (tab === 'upload') {
                document.getElementById('teste-subtab-upload').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('teste-subtab-upload').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('teste-subcontent-upload').classList.remove('hidden');
            } else {
                document.getElementById('teste-subtab-tjms').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('teste-subtab-tjms').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('teste-subcontent-tjms').classList.remove('hidden');
            }

            // Limpa visualizacao ao trocar de tab
            limparPdfViewer();
        }

        async function buscarDocumentosTJMSTeste() {
            const numProcesso = document.getElementById('testeProcessoCNJ').value.trim();
            if (!numProcesso) {
                alert('Digite o numero do processo');
                return;
            }

            // Coleta tipos selecionados
            const tiposSelecionados = [];
            document.querySelectorAll('.teste-tipo-doc:checked').forEach(cb => {
                tiposSelecionados.push(cb.value);
            });

            if (tiposSelecionados.length === 0) {
                alert('Selecione pelo menos um tipo de documento');
                return;
            }

            try {
                // Busca documentos do processo
                const response = await fetch('/classificador/api/tjms/consultar-processo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ numero_cnj: numProcesso })
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'Erro ao consultar processo');
                    return;
                }

                // Filtra por tipos selecionados
                testeDocumentosTJMS = data.documentos.filter(doc =>
                    tiposSelecionados.includes(String(doc.tipoDocumento))
                );

                // Popula lista
                const container = document.getElementById('testeDocsTJMS');
                const lista = document.getElementById('testeDocsTJMSLista');

                if (testeDocumentosTJMS.length === 0) {
                    lista.innerHTML = `<div class="p-3 text-gray-500 text-sm text-center">
                        Nenhum documento encontrado com os tipos selecionados
                    </div>`;
                } else {
                    lista.innerHTML = testeDocumentosTJMS.map((doc, idx) => `
                        <div class="p-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2" onclick="selecionarDocumentoTeste(${idx})">
                            <input type="radio" name="docTesteRadio" id="docTeste${idx}" class="text-blue-600">
                            <label for="docTeste${idx}" class="flex-1 cursor-pointer">
                                <span class="text-xs font-medium text-gray-900">${SecurityUtils.escapeHtml(doc.descricaoTipoDocumento || 'Documento')}</span>
                                <span class="text-xs text-gray-500 ml-2">ID: ${doc.idDocumento}</span>
                            </label>
                        </div>
                    `).join('');
                }

                container.classList.remove('hidden');

            } catch (e) {
                console.error('Erro ao buscar documentos:', e);
                alert('Erro ao buscar documentos do TJ-MS');
            }
        }

        async function selecionarDocumentoTeste(idx) {
            const doc = testeDocumentosTJMS[idx];
            if (!doc) return;

            // Marca o radio
            document.getElementById(`docTeste${idx}`).checked = true;

            // Armazena documento selecionado
            testeDocumentoSelecionado = {
                id_documento: doc.idDocumento,
                numero_processo: document.getElementById('testeProcessoCNJ').value.trim(),
                tipo: doc.tipoDocumento,
                descricao: doc.descricaoTipoDocumento
            };

            // Baixa e exibe o PDF
            await carregarPdfTJMS(testeDocumentoSelecionado.numero_processo, testeDocumentoSelecionado.id_documento);
        }

        async function carregarPdfTJMS(numProcesso, idDocumento) {
            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = `<div class="text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p class="text-sm">Baixando documento...</p>
            </div>`;

            try {
                const response = await fetch('/classificador/api/tjms/baixar-documento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        numero_cnj: numProcesso,
                        id_documento: idDocumento
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Erro ao baixar documento');
                }

                // Armazena base64 para classificacao
                testeDocumentoSelecionado.base64 = data.conteudo_base64;

                // Renderiza o PDF
                await renderizarPdfBase64(data.conteudo_base64);

            } catch (e) {
                console.error('Erro ao carregar PDF:', e);
                viewer.innerHTML = `<div class="text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">${SecurityUtils.escapeHtml(e.message)}</p>
                </div>`;
            }
        }

        async function renderizarPdfBase64(base64) {
            const viewer = document.getElementById('pdfViewer');

            try {
                // Decodifica base64 para Uint8Array
                const pdfData = atob(base64);
                const pdfArray = new Uint8Array(pdfData.length);
                for (let i = 0; i < pdfData.length; i++) {
                    pdfArray[i] = pdfData.charCodeAt(i);
                }

                // Carrega o documento com PDF.js
                pdfDoc = await pdfjsLib.getDocument({ data: pdfArray }).promise;
                pdfTotalPaginas = pdfDoc.numPages;
                pdfPaginaAtual = 1;

                // Mostra navegacao
                document.getElementById('pdfNavegacao').classList.remove('hidden');
                atualizarInfoPagina();

                // Renderiza primeira pagina
                await renderizarPagina(pdfPaginaAtual);

            } catch (e) {
                console.error('Erro ao renderizar PDF:', e);
                viewer.innerHTML = `<div class="text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">Erro ao renderizar PDF</p>
                </div>`;
            }
        }

        async function renderizarPagina(numPagina) {
            const viewer = document.getElementById('pdfViewer');

            if (!pdfDoc) return;

            try {
                const page = await pdfDoc.getPage(numPagina);
                const scale = 1.2;
                const viewport = page.getViewport({ scale });

                // Cria canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.maxWidth = '100%';
                canvas.style.height = 'auto';

                viewer.innerHTML = '';
                viewer.appendChild(canvas);

                // Renderiza
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

            } catch (e) {
                console.error('Erro ao renderizar pagina:', e);
            }
        }

        function atualizarInfoPagina() {
            document.getElementById('pdfPaginaInfo').textContent = `${pdfPaginaAtual} / ${pdfTotalPaginas}`;
        }

        function pdfPaginaAnterior() {
            if (pdfPaginaAtual > 1) {
                pdfPaginaAtual--;
                atualizarInfoPagina();
                renderizarPagina(pdfPaginaAtual);
            }
        }

        function pdfProximaPagina() {
            if (pdfPaginaAtual < pdfTotalPaginas) {
                pdfPaginaAtual++;
                atualizarInfoPagina();
                renderizarPagina(pdfPaginaAtual);
            }
        }

        function limparPdfViewer() {
            pdfDoc = null;
            pdfPaginaAtual = 1;
            pdfTotalPaginas = 0;
            testeDocumentoSelecionado = null;
            document.getElementById('pdfNavegacao').classList.add('hidden');
            document.getElementById('pdfViewer').innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fas fa-file-pdf text-4xl mb-2"></i>
                    <p class="text-sm">Nenhum documento carregado</p>
                </div>
            `;
        }

        async function classificarTesteRapido() {
            const promptId = document.getElementById('promptAvulso').value;
            const modelo = document.getElementById('modeloAvulso').value;
            const modo = document.getElementById('modoAvulso').value;
            const posicao = document.getElementById('posicaoAvulso').value;
            const tokens = document.getElementById('tokensAvulso').value;

            if (!promptId) {
                alert('Selecione um prompt');
                return;
            }

            const btn = document.getElementById('btnClassificarAvulso');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Classificando...';

            try {
                // Verifica se esta usando upload ou TJ-MS
                const uploadVisible = !document.getElementById('teste-subcontent-upload').classList.contains('hidden');

                if (uploadVisible) {
                    // Modo upload - usa o form original
                    const arquivo = document.getElementById('arquivoAvulso').files[0];
                    if (!arquivo) {
                        alert('Selecione um arquivo PDF');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('arquivo', arquivo);
                    formData.append('prompt_id', promptId);
                    formData.append('modelo', modelo);
                    formData.append('modo_processamento', modo);
                    formData.append('posicao_chunk', posicao);
                    formData.append('tamanho_chunk', tokens);

                    const response = await fetch('/classificador/api/classificar-avulso', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    const resultado = await response.json();
                    mostrarResultadoAvulso(resultado);

                } else {
                    // Modo TJ-MS - envia base64
                    if (!testeDocumentoSelecionado || !testeDocumentoSelecionado.base64) {
                        alert('Selecione um documento da lista');
                        return;
                    }

                    // Converte base64 para blob e envia como arquivo
                    const byteCharacters = atob(testeDocumentoSelecionado.base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const file = new File([blob], `${testeDocumentoSelecionado.id_documento}.pdf`, { type: 'application/pdf' });

                    const formData = new FormData();
                    formData.append('arquivo', file);
                    formData.append('prompt_id', promptId);
                    formData.append('modelo', modelo);
                    formData.append('modo_processamento', modo);
                    formData.append('posicao_chunk', posicao);
                    formData.append('tamanho_chunk', tokens);

                    const response = await fetch('/classificador/api/classificar-avulso', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    const resultado = await response.json();
                    resultado.numero_processo = testeDocumentoSelecionado.numero_processo;
                    resultado.id_documento = testeDocumentoSelecionado.id_documento;
                    resultado.tipo_documento = testeDocumentoSelecionado.descricao;
                    mostrarResultadoAvulso(resultado);
                }

            } catch (e) {
                console.error('Erro ao classificar:', e);
                alert('Erro ao classificar documento');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Classificar';
            }
        }

        // ====================================
        // Event Listeners
        // ====================================
        document.getElementById('formPrompt')?.addEventListener('submit', salvarPrompt);
        document.getElementById('formProjeto')?.addEventListener('submit', salvarProjeto);
        document.getElementById('formAvulso')?.addEventListener('submit', classificarAvulso);

        // Novos event listeners para Novo Lote
        document.getElementById('promptLote')?.addEventListener('change', () => {
            atualizarBotaoIniciar();
            preSelectTiposDocumentoPrompt();
        });
        document.getElementById('processosLote')?.addEventListener('input', () => {
            contarProcessos();
            atualizarBotaoIniciar();
        });

        // Event listener para Teste Rapido
        document.getElementById('promptAvulso')?.addEventListener('change', preSelectTiposDocumentoTesteRapido);

        // Pre-seleciona tipos de documento no Teste Rapido baseado nos codigos do prompt
        function preSelectTiposDocumentoTesteRapido() {
            const promptId = document.getElementById('promptAvulso').value;
            if (!promptId) return;

            const prompt = prompts.find(p => p.id === parseInt(promptId));
            if (!prompt || !prompt.codigos_documento) return;

            // Parseia os codigos do prompt
            const codigos = prompt.codigos_documento.split(',').map(c => c.trim()).filter(c => c);
            if (codigos.length === 0) return;

            // Desmarca todos os checkboxes primeiro
            document.querySelectorAll('.teste-tipo-doc').forEach(cb => {
                cb.checked = false;
            });

            // Marca os checkboxes dos codigos do prompt
            let nomesAdicionados = [];
            codigos.forEach(codigo => {
                const checkbox = document.querySelector(`.teste-tipo-doc[value="${codigo}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    const nome = CATEGORIAS_TJMS[codigo] || codigo;
                    nomesAdicionados.push(`${codigo} - ${nome}`);
                }
            });

            // Mostra popup informando os codigos pre-selecionados
            if (nomesAdicionados.length > 0) {
                alert(`O prompt "${prompt.nome}" esta configurado para classificar os seguintes tipos de documento:\n\n${nomesAdicionados.join('\n')}\n\nOs tipos foram pre-selecionados automaticamente.`);
            }
        }

        // Pre-seleciona tipos de documento baseado nos codigos do prompt
        function preSelectTiposDocumentoPrompt() {
            const promptId = document.getElementById('promptLote').value;
            if (!promptId) return;

            const prompt = prompts.find(p => p.id === parseInt(promptId));
            if (!prompt || !prompt.codigos_documento) return;

            // Parseia os codigos do prompt
            const codigos = prompt.codigos_documento.split(',').map(c => c.trim()).filter(c => c);
            if (codigos.length === 0) return;

            // Limpa e adiciona os tipos do prompt
            tiposSelecionadosTJMS.clear();
            let nomesAdicionados = [];
            codigos.forEach(codigo => {
                tiposSelecionadosTJMS.add(codigo);
                const nome = CATEGORIAS_TJMS[codigo] || codigo;
                nomesAdicionados.push(`${codigo} - ${nome}`);
            });

            // Atualiza a UI
            popularTiposDocumentos();

            // Mostra popup informando os codigos pre-selecionados
            if (nomesAdicionados.length > 0) {
                alert(`O prompt "${prompt.nome}" esta configurado para classificar os seguintes tipos de documento:\n\n${nomesAdicionados.join('\n')}\n\nOs tipos foram pre-selecionados automaticamente.`);
            }
        }

        // ====================================
        // Inicializacao
        // ====================================

        // Helper para adicionar timeout em promises
        function withTimeout(promise, ms, errorMsg = 'Timeout') {
            return Promise.race([
                promise,
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(errorMsg)), ms)
                )
            ]);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[INIT] Iniciando classificador...');

            // Setup das dropzones e filtros (com tratamento de erro)
            try {
                setupDropZone();
                setupDropZoneLote();
                setupFiltroAno();
                popularTiposDocumentos();
            } catch (e) {
                console.error('[INIT] Erro no setup inicial:', e);
            }

            // Carregar dados da API com timeout de 15s
            try {
                await Promise.all([
                    withTimeout(verificarStatusAPI(), 15000, 'Timeout ao verificar status da API'),
                    withTimeout(carregarPrompts(), 15000, 'Timeout ao carregar prompts'),
                    withTimeout(carregarProjetos(), 15000, 'Timeout ao carregar lotes')
                ]);
            } catch (e) {
                console.error('[INIT] Erro ao carregar dados:', e);
                // Em caso de timeout ou erro, garantir que a UI mostre estado de erro
                const promptsContainer = document.getElementById('listaPrompts');
                if (promptsContainer && (promptsContainer.innerHTML.includes('Carregando') || promptsContainer.innerHTML.includes('fa-spinner'))) {
                    promptsContainer.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Erro ao carregar prompts</p>
                            <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                            <button onclick="carregarPrompts()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Tentar novamente
                            </button>
                        </div>
                    `;
                }
                const projetosContainer = document.getElementById('listaProjetos');
                if (projetosContainer && (projetosContainer.innerHTML.includes('Carregando') || projetosContainer.innerHTML.includes('fa-spinner'))) {
                    projetosContainer.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Erro ao carregar lotes</p>
                            <p class="text-sm mt-2">${SecurityUtils.escapeHtml(e.message)}</p>
                            <button onclick="carregarProjetos()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Tentar novamente
                            </button>
                        </div>
                    `;
                }
            }

            try {
                atualizarSelectsPromptLote();
            } catch (e) {
                console.error('[INIT] Erro ao atualizar selects:', e);
            }

            console.log('[INIT] Inicializacao concluida');
        });
    </script>
</body>
</html>
